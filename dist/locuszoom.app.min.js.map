{"version":3,"sources":["webpack://[name]/./node_modules/@hapi/hoek/lib/assert.js","webpack://[name]/./node_modules/@hapi/hoek/lib/error.js","webpack://[name]/./node_modules/@hapi/hoek/lib/stringify.js","webpack://[name]/./node_modules/@hapi/topo/lib/index.js","webpack://[name]/./node_modules/just-clone/index.js","webpack://[name]/webpack/bootstrap","webpack://[name]/webpack/runtime/compat get default export","webpack://[name]/webpack/runtime/define property getters","webpack://[name]/webpack/runtime/hasOwnProperty shorthand","webpack://[name]/webpack/runtime/make namespace object","webpack://[name]/./esm/version.js","webpack://[name]/./esm/registry/base.js","webpack://[name]/./esm/data/undercomplicate/lru_cache.js","webpack://[name]/./esm/data/undercomplicate/util.js","webpack://[name]/./esm/data/undercomplicate/requests.js","webpack://[name]/./esm/data/undercomplicate/joins.js","webpack://[name]/./esm/helpers/parse.js","webpack://[name]/./esm/data/adapters.js","webpack://[name]/./esm/data/undercomplicate/adapter.js","webpack://[name]/./esm/registry/adapters.js","webpack://[name]/external \"d3\"","webpack://[name]/./esm/components/constants.js","webpack://[name]/./esm/helpers/transforms.js","webpack://[name]/./esm/registry/transforms.js","webpack://[name]/./esm/data/field.js","webpack://[name]/./esm/helpers/jsonpath.js","webpack://[name]/./esm/helpers/layouts.js","webpack://[name]/./esm/data/requester.js","webpack://[name]/./esm/helpers/common.js","webpack://[name]/./esm/components/toolbar/widgets.js","webpack://[name]/./esm/registry/widgets.js","webpack://[name]/./esm/components/toolbar/index.js","webpack://[name]/./esm/components/legend.js","webpack://[name]/./esm/components/panel.js","webpack://[name]/./esm/helpers/display.js","webpack://[name]/./esm/components/plot.js","webpack://[name]/./esm/registry/matchers.js","webpack://[name]/./esm/helpers/scalable.js","webpack://[name]/./esm/registry/scalable.js","webpack://[name]/./esm/components/data_layer/base.js","webpack://[name]/./esm/components/data_layer/annotation_track.js","webpack://[name]/./esm/components/data_layer/highlight_regions.js","webpack://[name]/./esm/components/data_layer/arcs.js","webpack://[name]/./esm/components/data_layer/genes.js","webpack://[name]/./esm/components/data_layer/line.js","webpack://[name]/./esm/components/data_layer/scatter.js","webpack://[name]/./esm/helpers/render.js","webpack://[name]/./esm/registry/data_layers.js","webpack://[name]/./esm/layouts/index.js","webpack://[name]/./esm/registry/layouts.js","webpack://[name]/./esm/registry/data_ops.js","webpack://[name]/./esm/data/sources.js","webpack://[name]/./esm/index.js"],"names":["AssertError","module","exports","condition","args","length","Error","Stringify","super","filter","arg","map","message","join","captureStackTrace","this","assert","JSON","stringify","apply","err","Assert","internals","_items","nodes","options","before","concat","after","group","sort","includes","Array","isArray","node","item","seq","push","manual","valid","_sort","others","other","Object","assign","mergeSort","i","graph","graphAfters","create","groups","expandedGroups","graphNodeItem","ancestors","children","child","visited","sorted","next","j","shouldSeeCount","seenCount","k","seqIndex","value","sortedItem","a","b","getRegExpFlags","regExp","source","flags","global","ignoreCase","multiline","sticky","unicode","clone","obj","result","key","type","toString","call","slice","Date","getTime","RegExp","__webpack_module_cache__","__webpack_require__","moduleId","__webpack_modules__","n","getter","__esModule","d","definition","o","defineProperty","enumerable","get","prop","prototype","hasOwnProperty","r","Symbol","toStringTag","RegistryBase","Map","name","has","override","set","delete","from","keys","ClassRegistry","parent_name","source_name","overrides","console","warn","arguments","base","sub","add","LLNode","metadata","prev","LRUCache","max_size","_max_size","_cur_size","_store","_head","_tail","cached","prior","_remove","old","match_callback","data","getLinkedData","shared_options","entities","dependencies","consolidate","parsed","spec","exec","name_alone","name_deps","deps","split","_parse_declaration","dag","toposort","entries","e","order","responses","provider","depends_on","this_result","Promise","all","then","prior_results","_provider_name","getData","values","all_results","groupBy","records","group_key","item_group","_any_match","left","right","left_key","right_key","right_index","results","left_match_value","right_matches","right_item","left_index","right_match_value","left_match","REGEX_MARKER","parseMarker","test","match","BaseApiAdapter","BaseLZAdapter","config","_config","cache_enabled","cache_size","_enable_cache","_cache","dependent_data","response_text","_buildRequestOptions","cache_key","_getCacheKey","resolve","_performRequest","text","_normalizeResponse","_cache_meta","catch","remove","_annotateRecords","_postProcessResponse","_url","url","_getURL","fetch","response","ok","statusText","parse","params","prefix_namespace","limit_fields","_prefix_namespace","_limit_fields","Set","chr","start","end","superset","find","md","row","reduce","acc","label","a_record","fieldname","suffixer","BaseUMAdapter","_genome_build","genome_build","build","constructor","N","every","fields","record","AssociationLZ","_source_id","request_options","GwasCatalogLZ","_validateBuildSource","source_query","GeneLZ","GeneConstraintLZ","state","genes_data","unique_gene_names","gene","gene_name","query","replace","body","method","headers","LDServer","assoc_data","assoc_variant_name","_findPrefixedKey","assoc_logp_name","refvar","best_hit","ldrefvar","best_logp","variant","log_pvalue","lz_is_ld_refvar","chrom","pos","ref","alt","coord","String","__find_ld_refvar","_skip_request","ld_refvar","ld_source","ld_population","ld_pop","population","encodeURIComponent","combined","chainRequests","payload","forEach","RecombLZ","StaticSource","_data","PheWASLZ","registry","d3","STATUSES","verbs","adjectives","log10","isNaN","Math","log","LN10","neglog10","logtoscinotation","exp","ceil","diff","pow","toFixed","scinotation","abs","floor","toExponential","htmlescape","s","is_numeric","urlencode","template_string","funcs","substring","func","_collectTransforms","Field","field","transforms","full_name","field_name","transformations","val","transform","extra","undefined","_applyTransformations","ATTR_REGEX","EXPR_REGEX","get_next_token","q","substr","attr","depth","m","attrs","get_item_at_deep_path","path","parent","tokens_to_keys","selectors","sel","remaining_selectors","paths","p","_","__","subject","uniqPaths","arr","elem","localeCompare","_query","matches","items","get_items_from_tokens","normalize_query","selector","tokenize","sqrt3","sqrt","triangledown","context","size","y","moveTo","lineTo","closePath","applyNamespaces","layout","shared_namespaces","requested_ns","merge","custom_layout","default_layout","property","custom_type","default_type","deepCopy","nameToSymbol","shape","factory_name","charAt","toUpperCase","findFields","prefixes","field_finder","all_ns","value_type","a_match","renameField","old_name","new_name","warn_transforms","this_type","escaped","filter_regex","match_val","regex","mutate_attrs","value_or_callable","value_or_callback","old_value","new_value","mutate","query_attrs","DataOperation","join_type","initiator","_callable","_initiator","_params","plot_state","dependent_recordsets","data_layer","sources","_sources","namespace_options","data_operations","namespace_local_names","dependency_order","unshift","ns_pattern","local_name","global_name","dep_spec","requires","namecount","require_name","task","generateCurtain","showing","content_selector","hide_delay","show","content","css","curtain","parent_plot","svg","parentNode","insert","id","append","html","on","hide","update","clearTimeout","applyStyles","page_origin","_getPageOrigin","height","_total_height","style","x","width","delay","setTimeout","generateLoader","progress_selector","cancel_selector","loader","percent","loader_boundrect","getBoundingClientRect","min","max","animate","classed","setPercentCompleted","selection","styles","BaseWidget","color","parent_panel","parent_svg","button","persist","position","group_position","initialize","status","menu","shouldPersist","force","destroy","Button","parent_toolbar","tag","title","permanent","outer_selector","inner_selector","scroll_position","hidden","getBaseId","scrollTop","populate","page_scroll_top","document","documentElement","container_offset","getContainerOffset","toolbar_client_rect","button_client_rect","menu_client_rect","total_content_height","scrollHeight","top","bottom","base_max_width","container_max_width","content_max_width","base_max_height","setPopulate","menu_populate_function","setOnclick","highlight","bool","Boolean","setStatus","onmouseover","onmouseout","onclick","getClass","preUpdate","postUpdate","Title","div_selector","title_selector","subtitle","RegionScale","positionIntToString","class","FilterField","_data_layer","data_layers","layer_name","_event_name","custom_event_name","_field","_field_display_html","field_display_html","_operator","operator","_filter_id","_data_type","data_type","_value_selector","filters","index","indexOf","_getTarget","splice","_clearFilter","emit","filter_id","Number","input_size","timer","debounce","_getValue","_setFilter","render","DownloadSVG","_filename","filename","_button_html","button_html","_button_title","button_title","setColor","setHtml","setTitle","setOnMouseover","_getBlobUrl","URL","revokeObjectURL","setOnMouseout","root","ancestor_pattern","extractedCSSText","styleSheets","cssRules","rule","selectorText","cssText","element","styleElement","createElement","setAttribute","innerHTML","refNode","hasChildNodes","insertBefore","rescale","copy","cloneNode","selectAll","each","dy","serializer","XMLSerializer","_getDimensions","_appendCSS","_getCSS","serializeToString","_generateSVG","markup","blob","Blob","createObjectURL","DownloadPNG","svg_url","canvas","getContext","reject","image","Image","onload","drawImage","toBlob","png","src","RemovePanel","suppress_confirm","confirm","panel","toolbar","removePanel","MovePanelUp","is_at_top","y_index","disable","moveUp","MovePanelDown","is_at_bottom","_panel_ids_by_y_index","moveDown","ShiftRegion","step","applyState","ZoomRegion","can_zoom","current_region_scale","max_region_scale","min_region_scale","new_region_scale","delta","Menu","menu_html","ResizeToData","scaleHeightToData","ToggleLegend","legend","DisplayOptions","allowed_fields","fields_whitelist","dataLayer","dataLayerLayout","defaultConfig","configSlot","_selected_item","uniqueID","random","table","menuLayout","renderRow","display_name","display_options","row_id","radioId","has_option","choice","defaultName","default_config_display_name","display","SetState","state_field","show_selected","new_state","choice_name","choice_value","Toolbar","widgets","hide_timeout","addWidget","widget","error","_panel_boundaries","dragging","_interaction","orientation","origin","padding","label_size","Legend","background_rect","elements","elements_group","line_height","_data_layer_ids_by_z_index","reverse","layer_legend","label_x","label_y","shape_factory","path_y","is_horizontal","color_stops","all_elements","ribbon_group","axis_group","axis_offset","tick_labels","range","scale","domain","axis","tickSize","tickValues","tickFormat","v","to_next_marking","radius","PI","bcr","right_x","pad_from_bottom","pad_from_right","min_height","margin","background_click","cliparea","axes","y1","y2","interaction","drag_background_to_pan","drag_x_ticks_to_scale","drag_y1_ticks_to_scale","drag_y2_ticks_to_scale","scroll_to_zoom","x_linked","y1_linked","y2_linked","show_loading_indicator","Panel","panels","_initialized","_layout_idx","_state_id","_data_promises","x_scale","y1_scale","y2_scale","x_extent","y1_extent","y2_extent","x_ticks","y1_ticks","y2_ticks","_zoom_timeout","_event_hooks","initializeLayout","event","hook","theseHooks","hookMatch","eventData","bubble","eventContext","sourceID","target","hookToRun","parseFloat","y_axis","z_index","dlid","idx","layout_idx","data_layer_layout","target_layer","destroyAllTooltips","container","applyDataLayerZIndexesToDataLayerLayouts","setAllElementStatus","clipRect","inner_border","generateExtents","constrain","limit_exponent","neg_min","neg_max","pos_min","pos_max","Infinity","ranges","axes_config","base_x_range","x_shifted","base_y1_range","y1_shifted","base_y2_range","y2_shifted","current_drag","panel_id","linked_panel_ids","anchor","scalar","zooming","current_extent_size","current_scaled_extent_size","round","invert","zoom_factor","potential_extent_size","new_extent_size","center","offset_ratio","new_x_extent_start","dragged_x","start_x","y_shifted","dragged_y","start_y","renderAxis","zoom_handler","_canInteract","coords","getLinkedPanelIds","data_layer_id","draw","show_immediately","plot_origin","setDimensions","setOrigin","setMargin","x_range","y1_range","y2_range","addDataLayer","base_id","clipPath","addBasicLoader","clearSelections","x_axis","x_axis_label","y1_axis","y1_axis_label","y2_axis","y2_axis_label","namespace","mousedown","startDrag","select","applyPanelYIndexesToPanelLayouts","positionPanels","reMap","decoupled","getAxisExtent","extent","ticks","baseTickConfig","self","nextLayer","getTicks","itemConfig","clip_range","target_tick_count","parseInt","min_n","shrink_sml","high_u_bias","u5_bias","c","base_toFixed","unit","pop","prettyTicks","canRender","axis_params","label_offset","label_rotate","generateTicks","ticksAreAllNumbers","axis_factory","tickPadding","tick_format","t","tick_selector","parseFields","tick_mouseover","focus","cursor","target_height","dh","getAbsoluteDataHeight","toggle","verb","adjective","antiverb","min_width","responsive_resize","panel_boundaries","mouse_guide","Plot","datasource","_remap_promises","_base_layout","lzd","_external_listeners","these_hooks","anyEventData","event_name","panel_layout","panelId","mode","panelsList","pid","layer","_layer_state","_setDefaultState","target_panel","clearPanelData","opts","success_callback","from_layer","onerror","error_callback","base_prefix","layer_target","startsWith","is_valid_layer","some","listener","config_to_sources","new_data","state_changes","mods","attempted_scale","validated_region","attempted_midpoint","temp","_updateStatePosition","loading_data","applyAllElementStatus","tracker","registered_events","listeners","removeEventListener","lastElementChild","removeChild","outerHTML","mutateLayout","bounding_client_rect","x_offset","scrollLeft","y_offset","offset","offsetParent","offsetTop","offsetLeft","clientRect","addPanel","height_scaling_factor","panel_width","panel_height","final_height","x_linked_margins","resize_listener","window","requestAnimationFrame","rescaleSVG","addEventListener","trackExternalListener","IntersectionObserver","threshold","observer","entry","intersectionRatio","observe","load_listener","mouse_guide_svg","mouse_guide_vertical_svg","mouse_guide_horizontal_svg","_mouse_guide","vertical","horizontal","corner_selector","panel_idx","panel_resize_drag","this_panel","original_panel_height","panel_height_change","loop_panel_id","loop_panel_idx","loop_panel","corner_drag","plot_page_origin","panel_page_origin","mouseout_mouse_guide","mousemove_mouse_guide","mouseup","stopDrag","mousemove","body_node","to_send","active","emitted_by","lz_match_value","client_rect","overrideAxisLayout","axis_number","axis_layout","ceiling","lower_buffer","upper_buffer","min_extent","y_axis_number","suffix","exp_symbols","0","3","6","9","places_exp","min_exp","places","ret","positionStringToInt","suffixre","mult","tokens","variable","branch","close","astify","token","shift","dest","else","ast","cache","render_node","item_value","target_value","if_value","parameters","field_value","numerical_bin","breaks","null_value","curr","categorical_bin","categories","ordinal_cycle","stable_choice","max_cache_size","clear","hash","charCodeAt","interpolate","nullval","upper_idx","brk","normalized_input","isFinite","effect_direction","input","beta_field","stderr_beta_field","plus_result","neg_result","beta_val","se_val","id_field","tooltip","tooltip_positioning","behaviors","BaseDataLayer","_base_id","_filter_func","_tooltips","_global_statuses","_data_contract","_entities","_dependencies","layer_order","current_index","resortDataLayers","getElementId","extra_fields","axis_config","id_key","for","element_id","empty","field_to_match","receive","match_function","broadcast_value","field_resolver","fields_unseen","debug","lz_is_match","getDataLayer","getPanel","getPlot","applyCustomDataMethods","option_layout","element_data","data_index","resolveScalableParameter","scale_function","f","getElementAnnotation","dimension","axis_name","data_extent","_getDataExtent","original_extent_span","range_min","range_max","y_scale","y_extent","x_min","x_max","y_min","y_max","plot_layout","layer_layout","tooltip_box","data_layer_height","data_layer_width","x_center","y_center","tooltip_top","tooltip_left","arrow_type","arrow_top","arrow_left","placement","arrow_size","offset_right","offset_left","arrow","filter_rules","array","is_match","test_func","bind","status_flags","updateTooltip","positionTooltip","closable","destroyTooltip","element_or_id","temporary","_getTooltipPosition","_drawTooltip","first_time","tooltip_layout","resolveStatus","statuses","directive","previousValue","currentValue","sub_status","sub_operator","show_directive","and","hide_directive","antistatus","show_resolved","hide_resolved","has_tooltip","createTooltip","exclusive","get_element_id_error","element_status_node_id","getElementStatusNodeId","added_status","showOrHideTooltip","is_selected","value_to_broadcast","send","setElementStatus","getElementById","event_match","executeBehaviors","requiredKeyStates","datum","behavior","action","current_status_boolean","href","open","location","panel_origin","positionAllTooltips","applyDataMethods","hitarea_width","AnnotationTrack","_hitareas_group","_visible_lines_group","track_data","_applyFilters","hit_areas_selection","_getX","x_left","left_node","left_node_x_center","enter","crds","exit","applyBehaviors","fill_opacity","regions","start_field","end_field","merge_field","HighlightRegions","cur_item","prev_item","new_start","new_end","_mergeNodes","fill","Arcs","_make_line","x1","field1","x2","field2","xmid","curve","line","hitareas","stroke","label_font_size","label_exon_spacing","exon_height","bounding_box_padding","track_vertical_spacing","Genes","transcript_idx","tracks","gene_track_index","1","_getLabelWidth","font_size","temp_text","label_width","getBBox","gene_id","gene_version","transcript_id","transcripts","display_range","text_anchor","centered_margin","display_domain","track","potential_track","collision_on_potential_track","placed_gene","min_start","exons","assignTracks","bboxes","getTrackHeight","boundaries","labels","strand","exon_id","clickareas","gene_bbox_id","gene_bbox","Line","x_field","y_field","y0","path_class","global_status","default_orthogonal_layout","OrthogonalLine","default_y","point_size","point_shape","coalesce","max_points","x_gap","y_gap","Scatter","spacing","handle_lines","lines","min_x","max_x","flip","dn","dnl","dnx","text_swing","dnlx2","line_swing","_label_texts","da","dal","_label_lines","dax","abound","bbound","_label_iterations","again","db","adjust","new_a_y","new_b_y","min_y","max_y","label_elements","separate_labels","xcs","ycs","final_data","x_start","y_start","current_group","_combine","_start_run","in_combine_region","coalesce_scatter_points","label_data","_label_groups","style_class","groups_enter","flip_labels","item_data","CategoryScatter","_categories","xField","category_field","sourceData","ak","bk","av","toLowerCase","bv","uniqueCategories","category","bounds","categoryNames","_setDynamicColorScheme","from_source","color_params","colorParams","_getColorScale","baseParams","parameters_categories_hash","colors","categoryBounds","knownCategories","knownColors","xPos","_prepareData","_generateCategoryBounds","LZ_SIG_THRESHOLD_LOGP","standard_association_tooltip","or","standard_association_tooltip_with_label","standard_genes_tooltip","catalog_variant_tooltip","coaccessibility_tooltip","significance_layer","recomb_rate_layer","association_pvalues_layer","coaccessibility_layer","association_pvalues_catalog_layer","catalog","phewas_pvalues_layer","genes_layer","genes_layer_filtered","annotation_catalog_layer","ldlz2_pop_selector_menu","gene_selector_menu","standard_panel_toolbar","standard_plot_toolbar","standard_association_toolbar","region_nav_plot_toolbar","association_panel","coaccessibility_panel","association_catalog_panel","genes_panel","phewas_panel","annotation_catalog_panel","standard_association_plot","association_catalog_plot","standard_phewas_plot","coaccessibility_plot","color_config","standard_association","standard_association_with_label","standard_genes","catalog_variant","coaccessibility","toolbar_widgets","ldlz2_pop_selector","standard_panel","standard_plot","region_nav_plot","significance","recomb_rate","association_pvalues","association_pvalues_catalog","phewas_pvalues","genes","genes_filtered","annotation_catalog","association","association_catalog","phewas","plot","standard_phewas","custom_namespaces","_auto_fields","contents","list","_wrap_join","handle","catalog_data","assoc_key","catalog_key","catalog_logp_name","catalog_by_variant","catalog_flat","claims","best_variant","best","n_catalog_matches","constraint_data","alias","constraint","LocusZoom","version","iterator","dataset","region","parsed_state","chrpos","parsePositionQuery","refresh","DataSources","_registry","source_id","Adapters","DataLayers","DataFunctions","Layouts","MatchFunctions","ScaleFunctions","TransformationFunctions","Widgets","INSTALLED_PLUGINS","use","plugin","install"],"mappings":"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","file":"locuszoom.app.min.js","sourcesContent":["'use strict';\n\nconst AssertError = require('./error');\n\nconst internals = {};\n\n\nmodule.exports = function (condition, ...args) {\n\n    if (condition) {\n        return;\n    }\n\n    if (args.length === 1 &&\n        args[0] instanceof Error) {\n\n        throw args[0];\n    }\n\n    throw new AssertError(args);\n};\n","'use strict';\n\nconst Stringify = require('./stringify');\n\n\nconst internals = {};\n\n\nmodule.exports = class extends Error {\n\n    constructor(args) {\n\n        const msgs = args\n            .filter((arg) => arg !== '')\n            .map((arg) => {\n\n                return typeof arg === 'string' ? arg : arg instanceof Error ? arg.message : Stringify(arg);\n            });\n\n        super(msgs.join(' ') || 'Unknown error');\n\n        if (typeof Error.captureStackTrace === 'function') {            // $lab:coverage:ignore$\n            Error.captureStackTrace(this, exports.assert);\n        }\n    }\n};\n","'use strict';\n\nconst internals = {};\n\n\nmodule.exports = function (...args) {\n\n    try {\n        return JSON.stringify.apply(null, args);\n    }\n    catch (err) {\n        return '[Cannot display object: ' + err.message + ']';\n    }\n};\n","'use strict';\n\nconst Assert = require('@hapi/hoek/lib/assert');\n\n\nconst internals = {};\n\n\nexports.Sorter = class {\n\n    constructor() {\n\n        this._items = [];\n        this.nodes = [];\n    }\n\n    add(nodes, options) {\n\n        options = options || {};\n\n        // Validate rules\n\n        const before = [].concat(options.before || []);\n        const after = [].concat(options.after || []);\n        const group = options.group || '?';\n        const sort = options.sort || 0;                   // Used for merging only\n\n        Assert(!before.includes(group), `Item cannot come before itself: ${group}`);\n        Assert(!before.includes('?'), 'Item cannot come before unassociated items');\n        Assert(!after.includes(group), `Item cannot come after itself: ${group}`);\n        Assert(!after.includes('?'), 'Item cannot come after unassociated items');\n\n        if (!Array.isArray(nodes)) {\n            nodes = [nodes];\n        }\n\n        for (const node of nodes) {\n            const item = {\n                seq: this._items.length,\n                sort,\n                before,\n                after,\n                group,\n                node\n            };\n\n            this._items.push(item);\n        }\n\n        // Insert event\n\n        if (!options.manual) {\n            const valid = this._sort();\n            Assert(valid, 'item', group !== '?' ? `added into group ${group}` : '', 'created a dependencies error');\n        }\n\n        return this.nodes;\n    }\n\n    merge(others) {\n\n        if (!Array.isArray(others)) {\n            others = [others];\n        }\n\n        for (const other of others) {\n            if (other) {\n                for (const item of other._items) {\n                    this._items.push(Object.assign({}, item));      // Shallow cloned\n                }\n            }\n        }\n\n        // Sort items\n\n        this._items.sort(internals.mergeSort);\n        for (let i = 0; i < this._items.length; ++i) {\n            this._items[i].seq = i;\n        }\n\n        const valid = this._sort();\n        Assert(valid, 'merge created a dependencies error');\n\n        return this.nodes;\n    }\n\n    sort() {\n\n        const valid = this._sort();\n        Assert(valid, 'sort created a dependencies error');\n\n        return this.nodes;\n    }\n\n    _sort() {\n\n        // Construct graph\n\n        const graph = {};\n        const graphAfters = Object.create(null);            // A prototype can bungle lookups w/ false positives\n        const groups = Object.create(null);\n\n        for (const item of this._items) {\n            const seq = item.seq;                           // Unique across all items\n            const group = item.group;\n\n            // Determine Groups\n\n            groups[group] = groups[group] || [];\n            groups[group].push(seq);\n\n            // Build intermediary graph using 'before'\n\n            graph[seq] = item.before;\n\n            // Build second intermediary graph with 'after'\n\n            for (const after of item.after) {\n                graphAfters[after] = graphAfters[after] || [];\n                graphAfters[after].push(seq);\n            }\n        }\n\n        // Expand intermediary graph\n\n        for (const node in graph) {\n            const expandedGroups = [];\n\n            for (const graphNodeItem in graph[node]) {\n                const group = graph[node][graphNodeItem];\n                groups[group] = groups[group] || [];\n                expandedGroups.push(...groups[group]);\n            }\n\n            graph[node] = expandedGroups;\n        }\n\n        // Merge intermediary graph using graphAfters into final graph\n\n        for (const group in graphAfters) {\n            if (groups[group]) {\n                for (const node of groups[group]) {\n                    graph[node].push(...graphAfters[group]);\n                }\n            }\n        }\n\n        // Compile ancestors\n\n        const ancestors = {};\n        for (const node in graph) {\n            const children = graph[node];\n            for (const child of children) {\n                ancestors[child] = ancestors[child] || [];\n                ancestors[child].push(node);\n            }\n        }\n\n        // Topo sort\n\n        const visited = {};\n        const sorted = [];\n\n        for (let i = 0; i < this._items.length; ++i) {          // Looping through item.seq values out of order\n            let next = i;\n\n            if (ancestors[i]) {\n                next = null;\n                for (let j = 0; j < this._items.length; ++j) {  // As above, these are item.seq values\n                    if (visited[j] === true) {\n                        continue;\n                    }\n\n                    if (!ancestors[j]) {\n                        ancestors[j] = [];\n                    }\n\n                    const shouldSeeCount = ancestors[j].length;\n                    let seenCount = 0;\n                    for (let k = 0; k < shouldSeeCount; ++k) {\n                        if (visited[ancestors[j][k]]) {\n                            ++seenCount;\n                        }\n                    }\n\n                    if (seenCount === shouldSeeCount) {\n                        next = j;\n                        break;\n                    }\n                }\n            }\n\n            if (next !== null) {\n                visited[next] = true;\n                sorted.push(next);\n            }\n        }\n\n        if (sorted.length !== this._items.length) {\n            return false;\n        }\n\n        const seqIndex = {};\n        for (const item of this._items) {\n            seqIndex[item.seq] = item;\n        }\n\n        this._items = [];\n        this.nodes = [];\n\n        for (const value of sorted) {\n            const sortedItem = seqIndex[value];\n            this.nodes.push(sortedItem.node);\n            this._items.push(sortedItem);\n        }\n\n        return true;\n    }\n};\n\n\ninternals.mergeSort = (a, b) => {\n\n    return a.sort === b.sort ? 0 : (a.sort < b.sort ? -1 : 1);\n};\n","module.exports = clone;\n\n/*\n  Deep clones all properties except functions\n\n  var arr = [1, 2, 3];\n  var subObj = {aa: 1};\n  var obj = {a: 3, b: 5, c: arr, d: subObj};\n  var objClone = clone(obj);\n  arr.push(4);\n  subObj.bb = 2;\n  obj; // {a: 3, b: 5, c: [1, 2, 3, 4], d: {aa: 1}}\n  objClone; // {a: 3, b: 5, c: [1, 2, 3], d: {aa: 1, bb: 2}}\n*/\n\nfunction clone(obj) {\n  if (typeof obj == 'function') {\n    return obj;\n  }\n  var result = Array.isArray(obj) ? [] : {};\n  for (var key in obj) {\n    // include prototype properties\n    var value = obj[key];\n    var type = {}.toString.call(value).slice(8, -1);\n    if (type == 'Array' || type == 'Object') {\n      result[key] = clone(value);\n    } else if (type == 'Date') {\n      result[key] = new Date(value.getTime());\n    } else if (type == 'RegExp') {\n      result[key] = RegExp(value.source, getRegExpFlags(value));\n    } else {\n      result[key] = value;\n    }\n  }\n  return result;\n}\n\nfunction getRegExpFlags(regExp) {\n  if (typeof regExp.source.flags == 'string') {\n    return regExp.source.flags;\n  } else {\n    var flags = [];\n    regExp.global && flags.push('g');\n    regExp.ignoreCase && flags.push('i');\n    regExp.multiline && flags.push('m');\n    regExp.sticky && flags.push('y');\n    regExp.unicode && flags.push('u');\n    return flags.join('');\n  }\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tif(__webpack_module_cache__[moduleId]) {\n\t\treturn __webpack_module_cache__[moduleId].exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export default '0.14.0';\n","/**\n * @module\n * @private\n */\n\n/**\n * Base class for all registries.\n *\n * LocusZoom is plugin-extensible, and layouts are JSON-serializable objects that refer to desired features by name (not by class).\n * This is achieved through the use of a central registry that holds a reference to each possible feature.\n *\n * Each registry has some syntactical sugar to make it easier to, eg, modify layouts or create classes.\n * This class is documented solely so that those helper methods can be referenced.\n */\nclass RegistryBase {\n    constructor() {\n        this._items = new Map();\n    }\n\n    /**\n     * Return the registry member. If the registry stores classes, this returns the class, not the instance.\n     * @param {String} name\n     * @returns {Function}\n     */\n    get(name) {\n        if (!this._items.has(name)) {\n            throw new Error(`Item not found: ${name}`);\n        }\n        return this._items.get(name);\n    }\n\n    /**\n     * Add a new item to the registry\n     * @param {String} name The name of the item to add to the registry\n     * @param {*} item The item to be added (constructor, value, etc)\n     * @param {boolean} [override=false] Allow redefining an existing item?\n     * @return {*} The actual object as added to the registry\n     */\n    add(name, item, override = false) {\n        if (!override && this._items.has(name)) {\n            throw new Error(`Item ${name} is already defined`);\n        }\n        this._items.set(name, item);\n        return item;\n    }\n\n    /**\n     * Remove a datasource from the registry (if present)\n     * @param {String} name\n     * @returns {boolean} True if item removed, false if item was never present\n     */\n    remove(name) {\n        return this._items.delete(name);\n    }\n\n    /**\n     * Check whether the specified item is registered\n     * @param {String} name\n     * @returns {boolean}\n     */\n    has(name) {\n        return this._items.has(name);\n    }\n\n    /**\n     * Names of each allowed\n     * @returns {String[]}\n     */\n    list() {\n        return Array.from(this._items.keys());\n    }\n}\n\n/**\n * A specialized registry whose members are class constructors. Contains helper methods for creating instances\n *  and subclasses.\n * @ignore\n */\nclass ClassRegistry extends RegistryBase {\n    /**\n     * Create an instance of the specified class from the registry\n     * @param {String} name\n     * @param {*} args Any additional arguments to be passed to the constructor\n     * @returns {*}\n     */\n    create(name, ...args) {\n        const base = this.get(name);\n        return new base(...args);\n    }\n\n    /**\n     * Create a new child class for an item in the registry.\n     *\n     * This is (almost, but not quite) a compatibility layer for old sites that used locuszoom\n     *\n     * This is primarily aimed at low-tooling environments. It is syntactic sugar, roughly equivalent to:\n     *   `registry.get(base); registry.add(name, class A extends base {});`\n     *\n     * Because this bypasses es6 class mechanics, certain things, esp super calls, may not work as well as using the\n     *   \"real\" class expression. This method is provided solely for convenience.\n     *\n     * This method is a compatibility layer for old versions. Born to be deprecated!\n     * @deprecated\n     * @param {string} parent_name The name of the desired parent class as represented in the registry\n     * @param {string} source_name The desired name of the class to be created, as it will be named in the registry\n     * @param {object} overrides An object\n     * @return {*}\n     */\n    extend(parent_name, source_name, overrides) {\n        console.warn('Deprecation warning: .extend method will be removed in future versions, in favor of explicit ES6 subclasses');\n        if (arguments.length !== 3) {\n            throw new Error('Invalid arguments to .extend');\n        }\n\n        const base = this.get(parent_name);\n        class sub extends base {}\n        Object.assign(sub.prototype, overrides, base);\n        this.add(source_name, sub);\n        return sub;\n    }\n}\n\n\nexport default RegistryBase;\nexport {RegistryBase, ClassRegistry};\n","/**\n * Implement an LRU Cache\n */\n\n\nclass LLNode {\n    /**\n     * A single node in the linked list. Users will only need to deal with this class if using \"approximate match\" (`cache.find()`)\n     * @memberOf module:undercomplicate\n     * @param {string} key\n     * @param {*} value\n     * @param {object} metadata\n     * @param {LLNode} prev\n     * @param {LLNode} next\n     */\n    constructor(key, value, metadata = {}, prev = null, next = null) {\n        this.key = key;\n        this.value = value;\n        this.metadata = metadata;\n        this.prev = prev;\n        this.next = next;\n    }\n}\n\nclass LRUCache {\n    /**\n     * Least-recently used cache implementation, with \"approximate match\" semantics\n     * @memberOf module:undercomplicate\n     * @param {number} [max_size=3]\n     */\n    constructor(max_size = 3) {\n        this._max_size = max_size;\n        this._cur_size = 0; // replace with map.size so we aren't managing manually?\n        this._store = new Map();\n\n        // Track LRU state\n        this._head = null;\n        this._tail = null;\n\n        // Validate options\n        if (max_size === null || max_size < 0) {\n            throw new Error('Cache \"max_size\" must be >= 0');\n        }\n    }\n\n    /**\n     * Check key membership without updating LRU\n     * @param key\n     * @returns {boolean}\n     */\n    has(key) {\n        return this._store.has(key);\n    }\n\n    /**\n     * Retrieve value from cache (if present) and update LRU cache to say an item was recently used\n     * @param key\n     * @returns {null|*}\n     */\n    get(key) {\n        const cached = this._store.get(key);\n        if (!cached) {\n            return null;\n        }\n        if (this._head !== cached) {\n            // Rewrite the cached value to ensure it is head of the list\n            this.add(key, cached.value);\n        }\n        return cached.value;\n    }\n\n    /**\n     * Add an item. Forcibly replaces the existing cached value for the same key.\n     * @param key\n     * @param value\n     * @param {Object} [metadata={}) Metadata associated with an item. Metadata can be used for lookups (`cache.find`) to test for a cache hit based on non-exact match\n     */\n    add(key, value, metadata = {}) {\n        if (this._max_size === 0) {\n            // Don't cache items if cache has 0 size.\n            return;\n        }\n\n        const prior = this._store.get(key);\n        if (prior) {\n            this._remove(prior);\n        }\n\n        const node = new LLNode(key, value, metadata, null, this._head);\n\n        if (this._head) {\n            this._head.prev = node;\n        } else {\n            this._tail = node;\n        }\n\n        this._head = node;\n        this._store.set(key, node);\n\n        if (this._max_size >= 0 && this._cur_size >= this._max_size) {\n            const old = this._tail;\n            this._tail = this._tail.prev;\n            this._remove(old);\n        }\n        this._cur_size += 1;\n    }\n\n\n    // Cache manipulation methods\n    clear() {\n        this._head = null;\n        this._tail = null;\n        this._cur_size = 0;\n        this._store = new Map();\n    }\n\n    // Public method, remove by key\n    remove(key) {\n        const cached = this._store.get(key);\n        if (!cached) {\n            return false;\n        }\n        this._remove(cached);\n        return true;\n    }\n\n    // Internal implementation, useful when working on list\n    _remove(node) {\n        if (node.prev !== null) {\n            node.prev.next = node.next;\n        } else {\n            this._head = node.next;\n        }\n\n        if (node.next !== null) {\n            node.next.prev = node.prev;\n        } else {\n            this._tail = node.prev;\n        }\n        this._store.delete(node.key);\n        this._cur_size -= 1;\n    }\n\n    /**\n     * Find a matching item in the cache, or return null. This is useful for \"approximate match\" semantics,\n     *  to check if something qualifies as a cache hit despite not having the exact same key.\n     *  (Example: zooming into a region, where the smaller region is a subset of something already cached)\n     * @param {function} match_callback A function to be used to test the node as a possible match (returns true or false)\n     * @returns {null|LLNode}\n     */\n    find(match_callback) {\n        let node = this._head;\n        while (node) {\n            const next = node.next;\n            if (match_callback(node)) {\n                return node;\n            }\n            node = next;\n        }\n    }\n}\n\nexport { LRUCache };\n","/**\n * @private\n */\n\nimport justclone from 'just-clone';\n\n/**\n * The \"just-clone\" library only really works for objects and arrays. If given a string, it would mess things up quite a lot.\n * @param {object} data\n * @returns {*}\n */\nfunction clone(data) {\n    if (typeof data !== 'object') {\n        return data;\n    }\n    return justclone(data);\n}\n\nexport { clone };\n","/**\n * Perform a series of requests, respecting order of operations\n * @private\n */\n\nimport {Sorter} from '@hapi/topo';\n\n\nfunction _parse_declaration(spec) {\n    // Parse a dependency declaration like `assoc` or `ld(assoc)` or `join(assoc, ld)`. Return node and edges that can be used to build a graph.\n    const parsed = /^(?<name_alone>\\w+)$|((?<name_deps>\\w+)+\\(\\s*(?<deps>[^)]+?)\\s*\\))/.exec(spec);\n    if (!parsed) {\n        throw new Error(`Unable to parse dependency specification: ${spec}`);\n    }\n\n    let {name_alone, name_deps, deps} = parsed.groups;\n    if (name_alone) {\n        return [name_alone, []];\n    }\n\n    deps = deps.split(/\\s*,\\s*/);\n    return [name_deps, deps];\n}\n\n/**\n * Perform a request for data from a set of providers, taking into account dependencies between requests.\n *  This can be a mix of network requests or other actions (like join tasks), provided that the provider be some\n *  object that implements a method `instance.getData`\n *\n * Each data layer in LocusZoom will translate the internal configuration into a format used by this function.\n *  This function is never called directly in custom user code. In locuszoom, Requester Handles You\n *\n * TODO Future: It would be great to add a warning if the final element in the DAG does not reference all dependencies. This is a limitation of the current toposort library we use.\n *\n * @param {object} shared_options Options passed globally to all requests. In LocusZoom, this is often a copy of \"plot.state\"\n * @param {Map} entities A lookup of named entities that implement the method `instance.getData -> Promise`\n * @param {String[]} dependencies A description of how to fetch entities, and what they depend on, like `['assoc', 'ld(assoc)']`.\n *   **Order will be determined by a DAG and the last item in the DAG is all that is returned.**\n * @param {boolean} [consolidate=true] Whether to return all results (almost never used), or just the last item in the resolved DAG.\n *   This can be a pitfall in common usage: if you forget a \"join/consolidate\" task, the last result may appear to be missing some data.\n * @returns {Promise<Object[]>}\n */\nfunction getLinkedData(shared_options, entities, dependencies, consolidate = true) {\n    if (!dependencies.length) {\n        return [];\n    }\n\n    const parsed = dependencies.map((spec) => _parse_declaration(spec));\n    const dag = new Map(parsed);\n\n    // Define the order to perform requests in, based on a DAG\n    const toposort = new Sorter();\n    for (let [name, deps] of dag.entries()) {\n        try {\n            toposort.add(name, {after: deps, group: name});\n        } catch (e) {\n            throw new Error(`Invalid or possible circular dependency specification for: ${name}`);\n        }\n    }\n    const order = toposort.nodes;\n\n    // Verify that all requested entities exist by name!\n    const responses = new Map();\n    for (let name of order) {\n        const provider = entities.get(name);\n        if (!provider) {\n            throw new Error(`Data has been requested from source '${name}', but no matching source was provided`);\n        }\n\n        // Each promise should only be triggered when the things it depends on have been resolved\n        const depends_on = dag.get(name) || [];\n        const prereq_promises = Promise.all(depends_on.map((name) => responses.get(name)));\n\n        const this_result = prereq_promises.then((prior_results) => {\n            // Each request will be told the name of the provider that requested it. This can be used during post-processing,\n            //   eg to use the same endpoint adapter twice and label where the fields came from (assoc.id, assoc2.id)\n            // This has a secondary effect: it ensures that any changes made to \"shared\" options in one adapter will\n            //  not leak out to others via a mutable shared object reference.\n            const options = Object.assign({_provider_name: name}, shared_options);\n            return provider.getData(options, ...prior_results);\n        });\n        responses.set(name, this_result);\n    }\n    return Promise.all([...responses.values()])\n        .then((all_results) => {\n            if (consolidate) {\n                // Some usages- eg fetch + data join tasks- will only require the last response in the sequence\n                // Consolidate mode is the common use case, since returning a list of responses is not so helpful (depends on order of request, not order specified)\n                return all_results[all_results.length - 1];\n            }\n            return all_results;\n        });\n}\n\n\nexport {getLinkedData};\n\n// For testing only\nexport {_parse_declaration};\n","/**\n * Very simple client-side data joins. Useful for aligning records from two datasets based on a common key.\n */\nimport { clone } from './util';\n\n\n/**\n * Simple grouping function, used to identify sets of records for joining.\n *\n * Used internally by join helpers, exported mainly for unit testing\n * @memberOf module:undercomplicate\n * @param {object[]} records\n * @param {string} group_key\n * @returns {Map<any, any>}\n */\nfunction groupBy(records, group_key) {\n    const result = new Map();\n    for (let item of records) {\n        const item_group = item[group_key];\n\n        if (typeof item_group === 'undefined') {\n            throw new Error(`All records must specify a value for the field \"${group_key}\"`);\n        }\n        if (typeof item_group === 'object') {\n            // If we can't group this item, then don't (exclude object, array, map, null, etc from grouping keys)\n            throw new Error('Attempted to group on a field with non-primitive values');\n        }\n\n        let group = result.get(item_group);\n        if (!group) {\n            group = [];\n            result.set(item_group, group);\n        }\n        group.push(item);\n    }\n    return result;\n}\n\n\nfunction _any_match(type, left, right, left_key, right_key) {\n    // Helper that consolidates logic for all three join types\n    const right_index = groupBy(right, right_key);\n    const results = [];\n    for (let item of left) {\n        const left_match_value = item[left_key];\n        const right_matches = right_index.get(left_match_value) || [];\n        if (right_matches.length) {\n            // Record appears on both left and right; equiv to an inner join\n            results.push(...right_matches.map((right_item) => Object.assign({}, clone(right_item), clone(item))));\n        } else if (type !== 'inner') {\n            // Record appears on left but not right\n            results.push(clone(item));\n        }\n    }\n\n    if (type === 'outer') {\n        // Outer join part! We've already added all left-only and left-right matches; all that's left is the items that only appear on right side\n        const left_index = groupBy(left, left_key);\n        for (let item of right) {\n            const right_match_value = item[right_key];\n            const left_matches = left_index.get(right_match_value) || [];\n            if (!left_matches.length) {\n                results.push(clone(item));\n            }\n        }\n    }\n    return results;\n}\n\n/**\n * Equivalent to LEFT OUTER JOIN in SQL. Return all left records, joined to matching right data where appropriate.\n * @memberOf module:undercomplicate\n * @param {Object[]} left The left side recordset\n * @param {Object[]} right The right side recordset\n * @param {string} left_key The join field in left records\n * @param {string} right_key The join field in right records\n * @returns {Object[]}\n */\nfunction left_match(left, right, left_key, right_key) {\n    return _any_match('left', ...arguments);\n}\n\n/**\n * Equivalent to INNER JOIN in SQL. Only return record joins if the key field has a match on both left and right.\n * @memberOf module:undercomplicate\n * @param {object[]} left The left side recordset\n * @param {object[]} right The right side recordset\n * @param {string} left_key The join field in left records\n * @param {string} right_key The join field in right records\n * @returns {Object[]}\n */\nfunction inner_match(left, right, left_key, right_key) {\n    return _any_match('inner', ...arguments);\n}\n\n/**\n * Equivalent to FULL OUTER JOIN in SQL. Return records in either recordset, joined where appropriate.\n * @memberOf module:undercomplicate\n * @param {object[]} left The left side recordset\n * @param  {object[]} right The right side recordset\n * @param {string} left_key The join field in left records\n * @param {string} right_key The join field in right records\n * @returns {Object[]}\n */\nfunction full_outer_match(left, right, left_key, right_key) {\n    return _any_match('outer', ...arguments);\n}\n\nexport {left_match, inner_match, full_outer_match, groupBy};\n","/**\n * Parse useful entities\n */\n\n/**\n * @private\n */\nconst REGEX_MARKER = /^(?:chr)?([a-zA-Z0-9]+?)[_:-](\\d+)[_:|-]?(\\w+)?[/_:|-]?([^_]+)?_?(.*)?/;\n\n/**\n * Parse a single marker, cleaning up values as necessary\n * @private\n * @param {String} value\n * @param {boolean} test If called in testing mode, do not throw an exception\n * @returns {Array} chr, pos, ref, alt (if match found; ref and alt optional)\n */\nfunction parseMarker(value, test = false) {\n    const match = value && value.match(REGEX_MARKER);\n    if (match) {\n        return match.slice(1);\n    }\n    if (!test) {\n        throw new Error(`Could not understand marker format for ${value}. Should be of format chr:pos or chr:pos_ref/alt`);\n    } else {\n        return null;\n    }\n}\n\n/**\n * Normalize a provided variant string into the EPACTS-style `chrom:pos_ref/alt` format expected by LocusZoom and the Michigan LD Server\n *   This allows harmonizing various input data to a consistent format\n * @private\n * @param {String} variant A string that specifies variant information in one of several common formats (like chr1:99_A/C, 1-99-A-C, 1:99:A:C, etc)\n */\nfunction normalizeMarker(variant) {\n    const match = parseMarker(variant);\n    if (!match) {\n        throw new Error(`Unable to normalize marker format for variant: ${variant}`);\n    }\n    const [chrom, pos, ref, alt] = match;\n    let normalized = `${chrom}:${pos}`;\n    if (ref && alt) {\n        normalized += `_${ref}/${alt}`;\n    }\n    return normalized;\n}\n\n\nexport {\n    parseMarker,\n    normalizeMarker,\n};\n","/**\n * Define standard data adapters used to retrieve data (usually from REST APIs)\n *\n * ## Adapters are responsible for retrieving data\n * In LocusZoom, the act of fetching data (from API, JSON file, or Tabix) is separate from the act of rendering data.\n * Adapters are used to handle retrieving from different sources, and can provide various advanced functionality such\n *  as caching, data harmonization, and annotating API responses with calculated fields. They can also be used to join\n *  two data sources, such as annotating association summary statistics with LD information.\n *\n * Most of LocusZoom's builtin layouts and adapters are written for the field names and data formats of the\n *  UMich [PortalDev API](https://portaldev.sph.umich.edu/docs/api/v1/#introduction):\n *  if your data is in a different format, an adapter can be used to coerce or rename fields.\n *  Although it is possible to change every part of a rendering layout to expect different fields, this is often much\n *  more work than providing data in the expected format.\n *\n * ## Creating data adapters\n * The documentation in this section describes the available data types and adapters. Real LocusZoom usage almost never\n *  creates these classes directly: rather, they are defined from configuration objects that ask for a source by name.\n *\n * The below example creates an object responsible for fetching two different GWAS summary statistics datasets from two different API endpoints, for any data\n *  layer that asks for fields from `trait1:fieldname` or `trait2:fieldname`.\n *\n *  ```\n *  const data_sources = new LocusZoom.DataSources();\n *  data_sources.add(\"trait1\", [\"AssociationLZ\", { url: \"http://server.com/api/single/\", source: 1 }]);\n *  data_sources.add(\"trait2\", [\"AssociationLZ\", { url: \"http://server.com/api/single/\", source: 2 }]);\n *  ```\n *\n *  These data sources are then passed to the plot when data is to be rendered:\n *  `const plot = LocusZoom.populate(\"#lz-plot\", data_sources, layout);`\n *\n * @module LocusZoom_Adapters\n */\n\nimport {BaseUrlAdapter} from './undercomplicate';\n\nimport {parseMarker} from '../helpers/parse';\n\n/**\n * Replaced with the BaseLZAdapter class.\n * @public\n * @deprecated\n */\nclass BaseAdapter {\n    constructor() {\n        throw new Error('The \"BaseAdapter\" and \"BaseApiAdapter\" classes have been replaced in LocusZoom 0.14. See migration guide for details.');\n    }\n}\n\n/**\n * Removed class for LocusZoom data adapters that receive their data over the web. Adds default config parameters\n *  (and potentially other behavior) that are relevant to URL-based requests.\n * @extends module:LocusZoom_Adapters~BaseAdapter\n * @deprecated\n * @param {string} config.url The URL for the remote dataset. By default, most adapters perform a GET request.\n * @inheritDoc\n */\nclass BaseApiAdapter extends BaseAdapter {}\n\n\n/**\n * @extends module:undercomplicate.BaseUrlAdapter\n * @inheritDoc\n */\nclass BaseLZAdapter extends BaseUrlAdapter {\n    /**\n     * @param [config.cache_enabled=true]\n     * @param [config.cache_size=3]\n     * @param [config.url]\n     * @param [config.prefix_namespace=true] Whether to modify the API response by prepending namespace to each field name.\n     *   Most adapters will do this by default, so that each field is unambiguously defined based on where it comes from. (this helps to disambiguate two providers that return similar field names, like assoc:variant and catalog:variant)\n     *   Typically, this is only disabled if the response payload is very unusual\n     * @param {String[]} [config.limit_fields=null] If an API returns far more data than is needed, this can be used to simplify\n     *   the payload by excluding unused fields. This can help to reduce memory usage for really big server responses like LD.\n     */\n    constructor(config = {}) {\n        if (config.params) {\n            // Backwards-compat: prevent old sources from breaking in subtle ways because config options are no longer split between two places.\n            console.warn('Deprecation warning: all options in \"config.params\" should now be specified as top level keys.');\n            Object.assign(config, config.params || {});\n            delete config.params; // fields are moved, not just copied in both places; Custom code will need to reflect new reality!\n        }\n        super(config);\n\n        // Prefix the namespace for this source to all fieldnames: id -> assoc.id\n        // This is useful for almost all layers because the layout object says where to find every field, exactly.\n        // For some very complex data structure- mainly the Genes API payload- the datalayer might want to operate on\n        //   that complex set of fields directly. Disable _prefix_namespace to get field names as they appear\n        //   in the response. (gene_name instead of genes.gene_name)\n        const { prefix_namespace = true, limit_fields } = config;\n        this._prefix_namespace = prefix_namespace;\n        this._limit_fields = limit_fields ? new Set(limit_fields) : false;  // Optional and typically only used for very standard datasets like LD or catalog, where API returns >> what is displayed. People want to show their own custom annos for assoc plots pretty often, so the most-often-customized adapters don't specify limit_fields\n    }\n\n    /**\n     * Determine how a particular request will be identified in cache. Most LZ requests are region based,\n     *   so the default is a string concatenation of `chr_start_end`. This adapter is \"region aware\"- if the user\n     *   zooms in, it won't trigger a network request because we alread have the data needed.\n     * @param options Receives plot.state plus any other request options defined by this source\n     * @returns {string}\n     * @public\n     */\n    _getCacheKey(options) {\n        // Most LZ adapters are fetching REGION data, and it makes sense to treat zooming as a cache hit by default\n        let {chr, start, end} = options;  // Current view: plot.state\n\n        // Does a prior cache hit qualify as a superset of the ROI?\n        const superset = this._cache.find(({metadata: md}) => chr === md.chr && start >= md.start && end <= md.end);\n        if (superset) {\n            ({ chr, start, end } = superset.metadata);\n        }\n\n        // The default cache key is region-based, and this method only returns the region-based part of the cache hit\n        //  That way, methods that override the key can extend the base value and still get the benefits of region-overlap-check\n        options._cache_meta = { chr, start, end };\n        return `${chr}_${start}_${end}`;\n    }\n\n    /**\n     * Add the \"local namespace\" as a prefix for every field returned for this request. Eg if the association api\n     *   returns a field called variant, and the source is referred to as \"assoc\" within a particular data layer, then\n     *   the returned records will have a field called \"assoc:variant\"\n     *\n     * @param records\n     * @param options\n     * @returns {*}\n     * @public\n     */\n    _postProcessResponse(records, options) {\n        if (!this._prefix_namespace || !Array.isArray(records)) {\n            return records;\n        }\n\n        // Transform fieldnames to include the namespace name as a prefix. For example, a data layer that asks for\n        //   assoc data might see \"variant\" as \"assoc.variant\"\n        const { _limit_fields } = this;\n        const { _provider_name } = options;\n\n        return records.map((row) => {\n            return Object.entries(row).reduce(\n                (acc, [label, value]) => {\n                    // Rename API fields to format `namespace:fieldname`. If an adapter specifies limit_fields, then remove any unused API fields from the final payload.\n                    if (!_limit_fields || _limit_fields.has(label)) {\n                        acc[`${_provider_name}:${label}`] = value;\n                    }\n                    return acc;\n                },\n                {},\n            );\n        });\n    }\n\n    /**\n     * Convenience method, manually called in LZ sources that deal with dependent data.\n     *\n     * In the last step of fetching data, LZ adds a prefix to each field name.\n     * This means that operations like \"build query based on prior data\" can't just ask for \"log_pvalue\" because\n     *  they are receiving \"assoc:log_pvalue\" or some such unknown prefix.\n     *\n     * This helper lets us use dependent data more easily. Not every adapter needs to use this method.\n     *\n     * @param {Object} a_record One record (often the first one in a set of records)\n     * @param {String} fieldname The desired fieldname, eg \"log_pvalue\"\n     */\n    _findPrefixedKey(a_record, fieldname) {\n        const suffixer = new RegExp(`:${fieldname}$`);\n        const match = Object.keys(a_record).find((key) => suffixer.test(key));\n        if (!match) {\n            throw new Error(`Could not locate the required key name: ${fieldname} in dependent data`);\n        }\n        return match;\n    }\n}\n\n\n/**\n * The base adapter for the UMich Portaldev API server. This adds a few custom behaviors that handle idiosyncrasies\n *   of one particular web server.\n * @extends module:LocusZoom_Adapters~BaseLZAdapter\n * @inheritDoc\n */\nclass BaseUMAdapter extends BaseLZAdapter {\n    /**\n     * @param {Object} config\n     * @param {String} [config.build] The genome build to be used by all requests for this adapter. (UMich APIs are all genome build aware). \"GRCh37\" or \"GRCh38\"\n     */\n    constructor(config = {}) {\n        super(config);\n        // The UM portaldev API accepts an (optional) parameter \"genome_build\"\n        this._genome_build = config.genome_build || config.build;\n    }\n\n    _validateBuildSource(build, source) {\n        // Build OR Source, not both\n        if ((build && source) || !(build || source)) {\n            throw new Error(`${this.constructor.name} must provide a parameter specifying either \"build\" or \"source\". It should not specify both.`);\n        }\n        // If the build isn't recognized, our APIs can't transparently select a source to match\n        if (build && !['GRCh37', 'GRCh38'].includes(build)) {\n            throw new Error(`${this.constructor.name} must specify a valid 'genome_build'`);\n        }\n    }\n\n    // Special behavior for the UM portaldev API: col -> row format normalization\n    /**\n     * Some endpoints in the UM portaldev API returns columns of data, rather than rows. Convert the response to record objects, each row of a table being represented as an object of {field:value} pairs.\n     * @param response_text\n     * @param options\n     * @returns {Object[]}\n     * @public\n     */\n    _normalizeResponse(response_text, options) {\n        let data = super._normalizeResponse(...arguments);\n        // Most portaldev endpoints (though not all) store the desired response in just one specific part of the payload\n        data = data.data || data;\n\n        if (Array.isArray(data)) {\n            // Already in the desired form\n            return data;\n        }\n        // Otherwise, assume the server response is an object representing columns of data.\n        // Each array should have the same length (verify), and a given array index corresponds to a single row.\n        const keys = Object.keys(data);\n        const N = data[keys[0]].length;\n        const sameLength = keys.every(function (key) {\n            const item = data[key];\n            return item.length === N;\n        });\n        if (!sameLength) {\n            throw new Error(`${this.constructor.name} expects a response in which all arrays of data are the same length`);\n        }\n\n        // Go down the columns, and create an object for each row record\n        const records = [];\n        const fields = Object.keys(data);\n        for (let i = 0; i < N; i++) {\n            const record = {};\n            for (let j = 0; j < fields.length; j++) {\n                record[fields[j]] = data[fields[j]][i];\n            }\n            records.push(record);\n        }\n        return records;\n    }\n}\n\n\n/**\n * Retrieve Association Data from the LocusZoom/ Portaldev API (or compatible). Defines how to make a request\n *  to a specific REST API.\n * @public\n * @see module:LocusZoom_Adapters~BaseUMAdapter\n * @inheritDoc\n *\n * @param {Number} config.source The source ID for the dataset of interest, used to construct the request URL\n */\nclass AssociationLZ extends BaseUMAdapter {\n    constructor(config = {}) {\n        super(config);\n\n        // We don't validate the source option because a depressing number of people use AssociationLZ to serve non-dynamic JSON files\n        const { source } = config;\n        this._source_id = source;\n    }\n\n    _getURL (request_options) {\n        const {chr, start, end} = request_options;\n        const base = super._getURL(request_options);\n        return `${base}results/?filter=analysis in ${this._source_id} and chromosome in  '${chr}' and position ge ${start} and position le ${end}`;\n    }\n}\n\n\n/**\n * Fetch GWAS catalog data for a list of known variants, and align the data with previously fetched association data.\n * There can be more than one claim per variant; this adapter is written to support a visualization in which each\n * association variant is labeled with the single most significant hit in the GWAS catalog. (and enough information to link to the external catalog for more information)\n *\n * Sometimes the GWAS catalog uses rsIDs that could refer to more than one variant (eg multiple alt alleles are\n *  possible for the same rsID). To avoid missing possible hits due to ambiguous meaning, we connect the assoc\n *  and catalog data via the position field, not the full variant specifier. This source will auto-detect the matching\n *  field in association data by looking for the field name `position` or `pos`.\n *\n * @public\n * @see module:LocusZoom_Adapters~BaseUMAdapter\n */\nclass GwasCatalogLZ extends BaseUMAdapter {\n    /**\n     * @param {string} config.url The base URL for the remote data.\n     * @param [config.build] The genome build to use when requesting the specific genomic region.\n     *  May be overridden by a global parameter `plot.state.genome_build` so that all datasets can be fetched for the appropriate build in a consistent way.\n     * @param {Number} [config.source] The ID of the chosen catalog. Most usages should omit this parameter and\n     *  let LocusZoom choose the newest available dataset to use based on the genome build: defaults to recent EBI GWAS catalog, GRCh37.\n     */\n    constructor(config) {\n        if (!config.limit_fields) {\n            config.limit_fields = ['log_pvalue', 'pos', 'rsid', 'trait', 'variant'];\n        }\n        super(config);\n    }\n\n    /**\n     * Add query parameters to the URL to construct a query for the specified region\n     */\n    _getURL(request_options) {\n        const build = request_options.genome_build || this._config.build;\n        const source = this._config.source;\n        this._validateBuildSource(build, source);\n\n        // If a build name is provided, it takes precedence (the API will attempt to auto-select newest dataset based on the requested genome build).\n        //  Build and source are mutually exclusive, because hard-coded source IDs tend to be out of date\n        const source_query = build ? `&build=${build}` : ` and id eq ${source}`;\n\n        const base = super._getURL(request_options);\n        return `${base}?format=objects&sort=pos&filter=chrom eq '${request_options.chr}' and pos ge ${request_options.start} and pos le ${request_options.end}${source_query}`;\n    }\n}\n\n\n/**\n * Retrieve Gene Data, as fetched from the LocusZoom/Portaldev API server (or compatible format)\n * @public\n * @see module:LocusZoom_Adapters~BaseUMAdapter\n * @param {string} config.url The base URL for the remote data\n * @param [config.build] The genome build to use\n *  May be overridden by a global parameter `plot.state.genome_build` so that all datasets can be fetched for the appropriate build in a consistent way.\n * @param {Number} [config.source] The ID of the chosen gene dataset. Most usages should omit this parameter and\n *  let LocusZoom choose the newest available dataset to use based on the genome build: defaults to recent GENCODE data, GRCh37.\n */\nclass GeneLZ extends BaseUMAdapter {\n    constructor(config = {}) {\n        super(config);\n\n        // The UM Genes API has a very complex internal format and the genes layer is written to work with it exactly as given.\n        //  We will avoid transforming or modifying the payload.\n        this._prefix_namespace = false;\n    }\n\n    /**\n     * Add query parameters to the URL to construct a query for the specified region\n     */\n    _getURL(request_options) {\n        const build = request_options.genome_build || this._config.build;\n        let source = this._config.source;\n        this._validateBuildSource(build, source);\n\n        // If a build name is provided, it takes precedence (the API will attempt to auto-select newest dataset based on the requested genome build).\n        //  Build and source are mutually exclusive, because hard-coded source IDs tend to be out of date\n        const source_query = build ? `&build=${build}` : ` and source in ${source}`;\n\n        const base = super._getURL(request_options);\n        return `${base}?filter=chrom eq '${request_options.chr}' and start le ${request_options.end} and end ge ${request_options.start}${source_query}`;\n    }\n}\n\n\n/**\n * Retrieve Gene Constraint Data, as fetched from the gnomAD server (or compatible graphQL api endpoint)\n *\n * This is intended to be the second request in a chain, with special logic that connects it to Genes data\n *  already fetched. It assumes that the genes data is returned from the UM API, and thus the logic involves\n *  matching on specific assumptions about `gene_name` format.\n *\n * @public\n * @see module:LocusZoom_Adapters~BaseUMAdapter\n */\nclass GeneConstraintLZ extends BaseLZAdapter {\n    /**\n     * @param {string} config.url The base URL for the remote data\n     * @param [config.build] The genome build to use\n     *   May be overridden by a global parameter `plot.state.genome_build` so that all datasets can be fetched for the appropriate build in a consistent way.\n     */\n    constructor(config = {}) {\n        super(config);\n        this._prefix_namespace = false;\n    }\n\n    _buildRequestOptions(state, genes_data) {\n        const build = state.genome_build || this._config.build;\n        if (!build) {\n            throw new Error(`Adapter ${this.constructor.name} must specify a 'genome_build' option`);\n        }\n\n        const unique_gene_names = new Set();\n        for (let gene of genes_data) {\n            // In rare cases, the same gene symbol may appear at multiple positions. (issue #179) We de-duplicate the\n            //  gene names to avoid issuing a malformed GraphQL query.\n            unique_gene_names.add(gene.gene_name);\n        }\n\n        state.query = [...unique_gene_names.values()].map(function (gene_name) {\n            // GraphQL alias names must match a specific set of allowed characters: https://stackoverflow.com/a/45757065/1422268\n            const alias = `_${gene_name.replace(/[^A-Za-z0-9_]/g, '_')}`;\n            // Each gene symbol is a separate graphQL query, grouped into one request using aliases\n            return `${alias}: gene(gene_symbol: \"${gene_name}\", reference_genome: ${build}) { gnomad_constraint { exp_syn obs_syn syn_z oe_syn oe_syn_lower oe_syn_upper exp_mis obs_mis mis_z oe_mis oe_mis_lower oe_mis_upper exp_lof obs_lof pLI oe_lof oe_lof_lower oe_lof_upper } } `;\n        });\n        state.build = build;\n        return Object.assign({}, state);\n    }\n\n    _performRequest(options) {\n        let {query, build} = options;\n        if (!query.length || query.length > 25 || build === 'GRCh38') {\n            // Skip the API request when it would make no sense:\n            // - Build 38 (gnomAD supports build GRCh37 only; don't hit server when invalid. This isn't future proof, but we try to be good neighbors.)\n            // - Too many genes (gnomAD appears to set max cost ~25 genes)\n            // - No genes in region (hence no constraint info)\n            return Promise.resolve([]);\n        }\n        query = `{${query.join(' ')} }`; // GraphQL isn't quite JSON; items are separated by spaces but not commas\n\n        const url = this._getURL(options);\n\n        // See: https://graphql.org/learn/serving-over-http/\n        const body = JSON.stringify({ query: query });\n        const headers = { 'Content-Type': 'application/json' };\n\n        // Note: The gnomAD API sometimes fails randomly.\n        // If request blocked, return  a fake \"no data\" signal so the genes track can still render w/o constraint info\n        return fetch(url, { method: 'POST', body, headers }).then((response) => {\n            if (!response.ok) {\n                return [];\n            }\n            return response.text();\n        }).catch((err) => []);\n    }\n\n    /**\n     * The gnomAD API has a very complex internal data format. Bypass any record parsing or transform steps.\n     */\n    _normalizeResponse(response_text) {\n        if (typeof response_text !== 'string') {\n            // If the query short-circuits, we receive an empty list instead of a string\n            return response_text;\n        }\n        const data = JSON.parse(response_text);\n        return data.data;\n    }\n}\n\n\n/**\n * Fetch linkage disequilibrium information from a UMich LDServer-compatible API, relative to a reference variant.\n *  If no `plot.state.ldrefvar` is explicitly provided, this source will attempt to find the most significant GWAS\n *  variant and yse that as the LD reference variant.\n *\n * THIS ADAPTER EXPECTS TO RECEIVE ASSOCIATION DATA WITH FIELDS `variant` and `log_pvalue`. It may not work correctly\n *   if this information is not provided.\n *\n * This source is designed to connect its results to association data, and therefore depends on association data having\n *  been loaded by a previous request. For custom association APIs, some additional options might\n *  need to be be specified in order to locate the most significant SNP. Variant IDs of the form `chrom:pos_ref/alt`\n *  are preferred, but this source will attempt to harmonize other common data formats into something that the LD\n *  server can understand.\n *\n * @public\n * @see module:LocusZoom_Adapters~BaseUMAdapter\n */\nclass LDServer extends BaseUMAdapter {\n    /**\n     * @param {string} config.url The base URL for the remote data.\n     * @param [config.build='GRCh37'] The genome build to use when calculating LD relative to a specified reference variant.\n     *  May be overridden by a global parameter `plot.state.genome_build` so that all datasets can be fetched for the appropriate build in a consistent way.\n     * @param [config.source='1000G'] The name of the reference panel to use, as specified in the LD server instance.\n     *  May be overridden by a global parameter `plot.state.ld_source` to implement widgets that alter LD display.\n     * @param [config.population='ALL'] The sample population used to calculate LD for a specified source;\n     *  population names vary depending on the reference panel and how the server was populated wth data.\n     *  May be overridden by a global parameter `plot.state.ld_pop` to implement widgets that alter LD display.\n     * @param [config.method='rsquare'] The metric used to calculate LD\n     */\n    constructor(config) {\n        if (!config.limit_fields) {\n            config.limit_fields = ['variant2', 'position2', 'correlation'];\n        }\n        super(config);\n    }\n\n    __find_ld_refvar(state, assoc_data) {\n        const assoc_variant_name = this._findPrefixedKey(assoc_data[0], 'variant');\n        const assoc_logp_name = this._findPrefixedKey(assoc_data[0], 'log_pvalue');\n\n        // Determine the reference variant (via user selected OR automatic-per-track)\n        let refvar;\n        let best_hit = {};\n        if (state.ldrefvar) {\n            // State/ldrefvar would store the variant in the format used by assoc data, so no need to clean up to match in data\n            refvar = state.ldrefvar;\n            best_hit = assoc_data.find((item) => item[assoc_variant_name] === refvar) || {};\n        } else {\n            // find highest log-value and associated var spec\n            let best_logp = 0;\n            for (let item of assoc_data) {\n                const { [assoc_variant_name]: variant, [assoc_logp_name]: log_pvalue} = item;\n                if (log_pvalue > best_logp) {\n                    best_logp = log_pvalue;\n                    refvar = variant;\n                    best_hit = item;\n                }\n            }\n        }\n\n        // Add a special field that is not part of the assoc or LD data from the server, but has significance for plotting.\n        //  Since we already know the best hit, it's easier to do this here rather than in annotate or join phase.\n        best_hit.lz_is_ld_refvar = true;\n\n        // Above, we compared the ldrefvar to the assoc data. But for talking to the LD server,\n        //   the variant fields must be normalized to a specific format. All later LD operations will use that format.\n        const match = parseMarker(refvar, true);\n        if (!match) {\n            throw new Error('Could not request LD for a missing or incomplete marker format');\n        }\n\n        const [chrom, pos, ref, alt] = match;\n        // Currently, the LD server only accepts full variant specs; it won't return LD w/o ref+alt. Allowing\n        //  a partial match at most leaves room for potential future features.\n        refvar = `${chrom}:${pos}`; // FIXME: is this a server request that we can skip?\n        if (ref && alt) {\n            refvar += `_${ref}/${alt}`;\n        }\n\n        const coord = +pos;\n        // Last step: sanity check the proposed reference variant. Is it inside the view region? If not, we're probably\n        //  remembering a user choice from before user jumped to a new region. LD should be relative to something nearby.\n        if ((coord && state.ldrefvar && state.chr) && (chrom !== String(state.chr) || coord < state.start || coord > state.end)) {\n            // Rerun this method, after clearing out the proposed reference variant. NOTE: Adapter call receives a\n            //   *copy* of plot.state, so wiping here doesn't remove the original value.\n            state.ldrefvar = null;\n            return this.__find_ld_refvar(state, assoc_data);\n        }\n\n        // Return the reference variant, in a normalized format suitable for LDServer queries\n        return refvar;\n    }\n\n    _buildRequestOptions(state, assoc_data) {\n        if (!assoc_data) {\n            throw new Error('LD request must depend on association data');\n        }\n\n        // If no state refvar is provided, find the most significant variant in any provided assoc data.\n        //   Assumes that assoc satisfies the \"assoc\" fields contract, eg has fields variant and log_pvalue\n        const base = super._buildRequestOptions(...arguments);\n        if (!assoc_data.length) {\n            // No variants, so no need to annotate association data with LD!\n            // NOTE: Revisit. This could have odd cache implications (eg, when joining two assoc datasets to LD, and only the second dataset has data in the region)\n            base._skip_request = true;\n            return base;\n        }\n\n        base.ld_refvar = this.__find_ld_refvar(state, assoc_data);\n\n        // The LD source/pop can be overridden from plot.state, so that user choices can override initial source config\n        const genome_build = state.genome_build || this._config.build || 'GRCh37'; // This isn't expected to change after the data is plotted.\n        let ld_source = state.ld_source || this._config.source || '1000G';\n        const ld_population = state.ld_pop || this._config.population || 'ALL';  // LDServer panels will always have an ALL\n\n        if (ld_source === '1000G' && genome_build === 'GRCh38') {\n            // For build 38 (only), there is a newer/improved 1000G LD panel available that uses WGS data. Auto upgrade by default.\n            ld_source = '1000G-FRZ09';\n        }\n\n        this._validateBuildSource(genome_build, null);  // LD doesn't need to validate `source` option\n        return Object.assign({}, base, { genome_build, ld_source, ld_population });\n    }\n\n    _getURL(request_options) {\n        const method = this._config.method || 'rsquare';\n        const {\n            chr, start, end,\n            ld_refvar,\n            genome_build, ld_source, ld_population,\n        } = request_options;\n\n        const base = super._getURL(request_options);\n\n        return  [\n            base, 'genome_builds/', genome_build, '/references/', ld_source, '/populations/', ld_population, '/variants',\n            '?correlation=', method,\n            '&variant=', encodeURIComponent(ld_refvar),\n            '&chrom=', encodeURIComponent(chr),\n            '&start=', encodeURIComponent(start),\n            '&stop=', encodeURIComponent(end),\n        ].join('');\n    }\n\n    _getCacheKey(options) {\n        // LD is keyed by more than just region; append other parameters to the base cache key\n        const base = super._getCacheKey(options);\n        const { ld_refvar, ld_source, ld_population } = options;\n        return `${base}_${ld_refvar}_${ld_source}_${ld_population}`;\n    }\n\n    _performRequest(options) {\n        // Skip request if this one depends on other data, and we are in a region with no data\n        if (options._skip_request) {\n            // TODO: A skipped request leads to a cache value; possible edge cases where this could get weird.\n            return Promise.resolve([]);\n        }\n\n        const url = this._getURL(options);\n\n        // The UM LDServer uses API pagination; fetch all data by chaining requests when pages are detected\n        let combined = { data: {} };\n        let chainRequests = function (url) {\n            return fetch(url).then().then((response) => {\n                if (!response.ok) {\n                    throw new Error(response.statusText);\n                }\n                return response.text();\n            }).then(function(payload) {\n                payload = JSON.parse(payload);\n                Object.keys(payload.data).forEach(function (key) {\n                    combined.data[key] = (combined.data[key] || []).concat(payload.data[key]);\n                });\n                if (payload.next) {\n                    return chainRequests(payload.next);\n                }\n                return combined;\n            });\n        };\n        return chainRequests(url);\n    }\n}\n\n\n/**\n * Retrieve Recombination Rate Data, as fetched from the LocusZoom API server (or compatible)\n * @public\n * @see module:LocusZoom_Adapters~BaseUMAdapter\n * @param {string} config.url The base URL for the remote data\n * @param [config.build] The genome build to use\n *  May be overridden by a global parameter `plot.state.genome_build` so that all datasets can be fetched for the appropriate build in a consistent way.\n * @param {Number} [config.source] The ID of the chosen dataset. Most usages should omit this parameter and\n *  let LocusZoom choose the newest available dataset to use based on the genome build: defaults to recent HAPMAP recombination rate, GRCh37.\n */\nclass RecombLZ extends BaseUMAdapter {\n    constructor(config) {\n        if (!config.limit_fields) {\n            config.limit_fields = ['position', 'recomb_rate'];\n        }\n        super(config);\n    }\n\n    /**\n     * Add query parameters to the URL to construct a query for the specified region\n     */\n    _getURL(request_options) {\n        const build = request_options.genome_build || this._config.build;\n        let source = this._config.source;\n        this._validateBuildSource(build, source);\n\n        // If a build name is provided, it takes precedence (the API will attempt to auto-select newest dataset based on the requested genome build).\n        //  Build and source are mutually exclusive, because hard-coded source IDs tend to be out of date\n        const source_query = build ? `&build=${build}` : ` and id in ${source}`;\n\n        const base = super._getURL(request_options);\n        return `${base}?filter=chromosome eq '${request_options.chr}' and position le ${request_options.end} and position ge ${request_options.start}${source_query}`;\n    }\n}\n\n\n/**\n * Retrieve static blobs of data as raw JS objects. This does not perform additional parsing, which is required\n *  for some sources (eg it does not know how to join together LD and association data).\n *\n * Therefore it is the responsibility of the user to pass information in a format that can be read and\n * understood by the chosen plot- a StaticJSON source is rarely a drop-in replacement for existing layouts.\n *\n * This source is largely here for legacy reasons. More often, a convenient way to serve static data is as separate\n *  JSON files to an existing source (with the JSON url in place of an API).\n *\n *  Note: The name is a bit misleading. It receives JS objects, not strings serialized as \"json\".\n * @public\n * @see module:LocusZoom_Adapters~BaseLZAdapter\n * @param {object} config.data The data to be returned by this source (subject to namespacing rules)\n */\nclass StaticSource extends BaseLZAdapter {\n    constructor(config = {}) {\n        // Does not receive any config; the only argument is the raw data, embedded when source is created\n        super(...arguments);\n        const { data } = config;\n        if (!data || Array.isArray(config)) { // old usages may provide an array directly instead of as config key\n            throw new Error(\"'StaticSource' must provide data as required option 'config.data'\");\n        }\n        this._data = data;\n    }\n\n    _performRequest(options) {\n        return Promise.resolve(this._data);\n    }\n}\n\n\n/**\n * Retrieve PheWAS data retrieved from a LocusZoom/PortalDev compatible API\n * @public\n * @see module:LocusZoom_Adapters~BaseUMAdapter\n * @param {string} config.url The base URL for the remote data\n * @param {String[]} config.build This datasource expects to be provided the name of the genome build that will\n *   be used to provide PheWAS results for this position. Note positions may not translate between builds.\n */\nclass PheWASLZ extends BaseUMAdapter {\n    _getURL(request_options) {\n        const build = (request_options.genome_build ? [request_options.genome_build] : null) || this._config.build;\n        if (!build || !Array.isArray(build) || !build.length) {\n            throw new Error(['Adapter', this.constructor.name, 'requires that you specify array of one or more desired genome build names'].join(' '));\n        }\n        const base = super._getURL(request_options);\n        const url = [\n            base,\n            \"?filter=variant eq '\", encodeURIComponent(request_options.variant), \"'&format=objects&\",\n            build.map(function (item) {\n                return `build=${encodeURIComponent(item)}`;\n            }).join('&'),\n        ];\n        return url.join('');\n    }\n\n    _getCacheKey(options) {\n        // Not a region based source; don't do anything smart for cache check\n        return this._getURL(options);\n    }\n}\n\n// Deprecated symbols\nexport { BaseAdapter, BaseApiAdapter };\n\n// Usually used as a parent class for custom code\nexport { BaseLZAdapter, BaseUMAdapter };\n\n// Usually used as a standalone class\nexport {\n    AssociationLZ,\n    GeneConstraintLZ,\n    GeneLZ,\n    GwasCatalogLZ,\n    LDServer,\n    PheWASLZ,\n    RecombLZ,\n    StaticSource,\n};\n","import {LRUCache} from './lru_cache';\nimport {clone} from './util';\n\n/**\n * @param {boolean} [config.cache_enabled=true] Whether to enable the LRU cache, and store a copy of the normalized and parsed response data.\n *  Turned on by default for most remote requests; turn off if you are using another datastore (like Vuex) or if the response body uses too much memory.\n * @param {number} [config.cache_size=3] How many requests to cache. Track-dependent annotations like LD might benefit\n *   from caching more items, while very large payloads (like, um, TOPMED LD) might benefit from a smaller cache size.\n *   For most LocusZoom usages, the cache is \"region aware\": zooming in will use cached data, not a separate request\n * @inheritDoc\n * @memberOf module:undercomplicate\n */\nclass BaseAdapter {\n    constructor(config = {}) {\n        this._config = config;\n        const {\n            // Cache control\n            cache_enabled = true,\n            cache_size = 3,\n        } = config;\n        this._enable_cache = cache_enabled;\n        this._cache = new LRUCache(cache_size);\n    }\n\n    /**\n     * Build an object with options that control the request. This can take into account both explicit options, and prior data.\n     * @param {Object} options Any global options passed in via `getData`. Eg, in locuszoom, every request is passed a copy of `plot.state` as the options object, in which case every adapter would expect certain basic information like `chr, start, end` to be available.\n     * @param {Object[]} dependent_data If the source is called with dependencies, this function will receive one argument with the fully parsed response data from each other source it depends on. Eg, `ld(assoc)` means that the LD adapter would be called with the data from an association request as a function argument. Each dependency is its own argument: there can be 0, 1, 2, ...N arguments.\n     * @returns {*} An options object containing initial options, plus any calculated values relevant to the request.\n     * @public\n     */\n    _buildRequestOptions(options, dependent_data) {\n        // Perform any pre-processing required that may influence the request. Receives an array with the payloads\n        //  for each request that preceded this one in the dependency chain\n        // This method may optionally take dependent data into account. For many simple adapters, there won't be any dependent data!\n        return Object.assign({}, options);\n    }\n\n    /**\n     * Determine how this request is uniquely identified in cache. Usually this is an exact match for the same key, but it doesn't have to be.\n     * The LRU cache implements a `find` method, which means that a cache item can optionally be identified by its node\n     * `metadata` (instead of exact key match).\n     *  This is useful for situations where the user zooms in to a smaller region and wants the original request to\n     *  count as a cache hit. See subclasses for example.\n     * @param {object} options Request options from `_buildRequestOptions`\n     * @returns {*} This is often a string concatenating unique values for a compound cache key, like `chr_start_end`. If null, it is treated as a cache miss.\n     * @public\n     */\n    _getCacheKey(options) {\n        /* istanbul ignore next */\n        if (this._enable_cache) {\n            throw new Error('Method not implemented');\n        }\n        return null;\n    }\n\n    /**\n     * Perform the act of data retrieval (eg from a URL, blob, or JSON entity)\n     * @param {object} options Request options from `_buildRequestOptions`\n     * @returns {Promise}\n     * @public\n     */\n    _performRequest(options) {\n        /* istanbul ignore next */\n        throw new Error('Not implemented');\n    }\n\n    /**\n     * Convert the response format into a list of objects, one per datapoint. Eg split lines of a text file, or parse a blob of json.\n     * @param {*} response_text The raw response from performRequest, be it text, binary, etc. For most web based APIs, it is assumed to be text, and often JSON.\n     * @param {Object} options Request options. These are not typically used when normalizing a response, but the object is available.\n     * @returns {*} A list of objects, each object representing one row of data `{column_name: value_for_row}`\n     * @public\n     */\n    _normalizeResponse(response_text, options) {\n        return response_text;\n    }\n\n    /**\n     * Perform custom client-side operations on the retrieved data. For example, add calculated fields or\n     *  perform rapid client-side filtering on cached data. Annotations are applied after cache, which means\n     *  that the same network request can be dynamically annotated/filtered in different ways in response to user interactions.\n     *\n     * This result is currently not cached, but it may become so in the future as responsibility for dynamic UI\n     *   behavior moves to other layers of the application.\n     * @param {Object[]} records\n     * @param {Object} options\n     * @returns {*}\n     * @public\n     */\n    _annotateRecords(records, options) {\n        return records;\n    }\n\n    /**\n     * A hook to transform the response after all operations are done. For example, this can be used to prefix fields\n     *  with a namespace unique to the request, like `log_pvalue` -> `assoc:log_pvalue`. (by applying namespace prefixes to field names last,\n     *  annotations and validation can happen on the actual API payload, without having to guess what the fields were renamed to).\n     * @param records\n     * @param options\n     * @public\n     */\n    _postProcessResponse(records, options) {\n        return records;\n    }\n\n    /**\n     * All adapters must implement this method to asynchronously return data. All other methods are simply internal hooks to customize the actual request for data.\n     * @param {object} options Shared options for this request. In LocusZoom, this is typically a copy of `plot.state`.\n     * @param {Array[]} dependent_data Zero or more recordsets corresponding to each individual adapter that this one depends on.\n     *  Can be used to build a request that takes into account prior data.\n     * @returns {Promise<*>}\n     */\n    getData(options = {}, ...dependent_data) {\n        // Public facing method to define, perform, and process the request\n        options = this._buildRequestOptions(options, ...dependent_data);\n\n        const cache_key = this._getCacheKey(options);\n\n        // Then retrieval and parse steps: parse + normalize response, annotate\n        let result;\n        if (this._enable_cache && this._cache.has(cache_key)) {\n            result = this._cache.get(cache_key);\n        } else {\n            // Cache the promise (to avoid race conditions in conditional fetch). If anything (like `_getCacheKey`)\n            //  sets a special option value called `_cache_meta`, this will be used to annotate the cache entry\n            // For example, this can be used to decide whether zooming into a view could be satisfied by a cache entry,\n            //  even if the actual cache key wasn't an exact match. (see subclasses for an example; this class is generic)\n            result = Promise.resolve(this._performRequest(options))\n                // Note: we cache the normalized (parsed) response\n                .then((text) => this._normalizeResponse(text, options));\n            this._cache.add(cache_key, result, options._cache_meta);\n            // We are caching a promise, which means we want to *un*cache a promise that rejects, eg a failed or interrupted request\n            //  Otherwise, temporary failures couldn't be resolved by trying again in a moment\n            // TODO: In the future, consider providing a way to skip requests (eg, a sentinel value to flag something\n            //  as not cacheable, like \"no dependent data means no request... but maybe in another place this is used, there will be different dependent data and a request would make sense\")\n            result.catch((e) => this._cache.remove(cache_key));\n        }\n\n        return result\n            // Return a deep clone of the data, so that there are no shared mutable references to a parsed object in cache\n            .then((data) => clone(data))\n            .then((records) => this._annotateRecords(records, options))\n            .then((records) => this._postProcessResponse(records, options));\n    }\n}\n\n\n/**\n * Fetch data over the web, usually from a REST API that returns JSON\n * @param {string} config.url The URL to request\n * @extends module:undercomplicate.BaseAdapter\n * @inheritDoc\n * @memberOf module:undercomplicate\n */\nclass BaseUrlAdapter extends BaseAdapter {\n    constructor(config = {}) {\n        super(config);\n        this._url = config.url;\n    }\n\n\n    /**\n     * Default cache key is the URL for this request\n     * @public\n     */\n    _getCacheKey(options) {\n        return this._getURL(options);\n    }\n\n    /**\n     * In many cases, the base url should be modified with query parameters based on request options.\n     * @param options\n     * @returns {*}\n     * @private\n     */\n    _getURL(options) {\n        return this._url;\n    }\n\n    _performRequest(options) {\n        const url = this._getURL(options);\n        // Many resources will modify the URL to add query or segment parameters. Base method provides option validation.\n        //  (not validating in constructor allows URL adapter to be used as more generic parent class)\n        if (!this._url) {\n            throw new Error('Web based resources must specify a resource URL as option \"url\"');\n        }\n        return fetch(url).then((response) => {\n            if (!response.ok) {\n                throw new Error(response.statusText);\n            }\n            return response.text();\n        });\n    }\n\n    _normalizeResponse(response_text, options) {\n        if (typeof response_text === 'string') {\n            return JSON.parse(response_text);\n        }\n        // Some custom usages will return other datatypes. These would need to be handled by custom normalization logic in a subclass.\n        return response_text;\n    }\n}\n\nexport { BaseAdapter, BaseUrlAdapter };\n","/**\n * A registry of known data adapters. Can be used to find adapters by name. It will search predefined classes\n *  as well as those registered by plugins.\n *  @module\n *  @private\n */\nimport {ClassRegistry} from './base';\n\nimport * as adapters from '../data/adapters';\n\n\n// LocusZoom.Adapters is a basic registry with no special behavior.\n/**\n * A plugin registry that allows plots to use both pre-defined and user-provided data adapters (responsible for\n *  controlling the retrieval and harmonization of data).\n * @alias module:LocusZoom~Adapters\n * @type {module:registry/base~ClassRegistry}\n */\nconst registry = new ClassRegistry();\n\nfor (let [name, type] of Object.entries(adapters)) {\n    registry.add(name, type);\n}\n\n// Add some hard-coded aliases for backwards compatibility\n\n/**\n * Backwards-compatible alias for StaticSource\n * @public\n * @name module:LocusZoom_Adapters~StaticJSON\n * @see module:LocusZoom_Adapters~StaticSource\n */\nregistry.add('StaticJSON', adapters.StaticSource);\n\n/**\n * Backwards-compatible alias for LDServer\n * @public\n * @name module:LocusZoom_Adapters~LDLZ2\n * @see module:LocusZoom_Adapters~LDServer\n */\nregistry.add('LDLZ2', adapters.LDServer);\n\n\nexport default registry;\n","const __WEBPACK_NAMESPACE_OBJECT__ = d3;","/**\n * Available statuses that individual elements can have. Each status is described by\n *   a verb and an adjective. Verbs are used to generate data layer\n *   methods for updating the status on one or more elements. Adjectives are used in class\n *   names and applied or removed from elements to have a visual representation of the status,\n *   as well as used as keys in the state for tracking which elements are in which status(es)\n * @static\n * @type {{verbs: String[], adjectives: String[]}}\n * @private\n */\nexport const STATUSES = {\n    verbs: ['highlight', 'select', 'fade', 'hide'],\n    adjectives: ['highlighted', 'selected', 'faded', 'hidden'],\n};\n","/**\n * Transformation functions: used to transform a raw data value. For example, a template or axis label\n *  can convert from pvalue to -log10pvalue by specifying the following field name (the `|funcname` syntax\n *  indicates applying a function):\n *\n * `{{assoc:pvalue|neglog10}}`\n *\n * Transforms can also be chained so that several are used in order from left to right:\n * `{{log_pvalue|logtoscinotation|htmlescape}}`\n *\n * Most parts of LocusZoom that rely on being given a field name (or value) can be used this way: axis labels, position,\n *  match/filter logic, tooltip HTML template, etc. If your use case is not working with filters, please file a\n *  bug report!\n *\n * NOTE: for best results, don't specify filters in the `fields` array of a data layer- only specify them where the\n *  transformed value will be used.\n * @module LocusZoom_TransformationFunctions\n */\n\n/**\n * Return the log10 of a value. Can be applied several times in a row for, eg, loglog plots.\n * @param {number} value\n * @return {null|number}\n */\nexport function log10 (value) {\n    if (isNaN(value) || value <= 0) {\n        return null;\n    }\n    return Math.log(value) / Math.LN10;\n}\n\n/**\n * Return the -log (base 10), a common means of representing pvalues in locuszoom plots\n * @param {number} value\n * @return {number}\n */\nexport function neglog10 (value) {\n    if (isNaN(value) || value <= 0) {\n        return null;\n    }\n    return -Math.log(value) / Math.LN10;\n}\n\n/**\n * Convert a number from logarithm to scientific notation. Useful for, eg, a datasource that returns -log(p) by default\n * @param {number} value\n * @return {string}\n */\nexport function logtoscinotation (value) {\n    if (isNaN(value)) {\n        return 'NaN';\n    }\n    if (value === 0) {\n        return '1';\n    }\n    const exp = Math.ceil(value);\n    const diff = exp - value;\n    const base = Math.pow(10, diff);\n    if (exp === 1) {\n        return (base / 10).toFixed(4);\n    } else if (exp === 2) {\n        return (base / 100).toFixed(3);\n    } else {\n        return `${base.toFixed(2)}  10^-${exp}`;\n    }\n}\n\n/**\n * Represent a number in scientific notation\n * @param {Number} value\n * @returns {String}\n */\nexport function scinotation (value) {\n    if (isNaN(value)) {\n        return 'NaN';\n    }\n    if (value === 0) {\n        return '0';\n    }\n\n    const abs = Math.abs(value);\n    let log;\n    if (abs > 1) {\n        log = Math.ceil(Math.log(abs) / Math.LN10);\n    } else {  // 0...1\n        log = Math.floor(Math.log(abs) / Math.LN10);\n    }\n    if (Math.abs(log) <= 3) {\n        return value.toFixed(3);\n    } else {\n        return value.toExponential(2).replace('+', '').replace('e', '  10^');\n    }\n}\n\n/**\n * HTML-escape user entered values for use in constructed HTML fragments\n *\n * For example, this filter can be used on tooltips with custom HTML display. This protects against some forms of\n *  XSS injection when plotting user-provided data, as well as display artifacts from field values with HTML symbols\n *  such as `<` or `>`.\n * @param {String} value HTML-escape the provided value\n * @return {string}\n */\nexport function htmlescape (value) {\n    if (!value) {\n        return '';\n    }\n    value = `${value}`;\n\n    return value.replace(/['\"<>&`]/g, function (s) {\n        switch (s) {\n        case \"'\":\n            return '&#039;';\n        case '\"':\n            return '&quot;';\n        case '<':\n            return '&lt;';\n        case '>':\n            return '&gt;';\n        case '&':\n            return '&amp;';\n        case '`':\n            return '&#x60;';\n        }\n    });\n}\n\n/**\n * Return true if the value is numeric (including 0)\n *\n * This is useful in template code, where we might wish to hide a field that is absent, but show numeric values even if they are 0\n *   Eg, `{{#if value|is_numeric}}...{{/if}}\n *\n * @param {Number} value\n * @return {boolean}\n */\nexport function is_numeric(value) {\n    return typeof value === 'number';\n}\n\n/**\n * URL-encode the provided text, eg for constructing hyperlinks\n * @param {String} value\n * @return {string}\n */\nexport function urlencode (value) {\n    return encodeURIComponent(value);\n}\n","import {RegistryBase} from './base';\nimport * as transforms from '../helpers/transforms';\n\n/**\n * Registry of transformation functions that may be applied to template values to control how values are rendered.\n * Provides syntactic sugar atop a standard registry.\n * @public\n * @extends module:registry/base:RegistryBase\n * @inheritDoc\n */\nclass TransformationFunctionsRegistry extends RegistryBase {\n    /**\n     * Helper function that turns a sequence of function names into a single callable\n     * @param template_string\n     * @return {function(*=): *}\n     * @private\n     */\n    _collectTransforms(template_string) {\n        const funcs = template_string\n            .match(/\\|([^|]+)/g)\n            .map((item) => super.get(item.substring(1)));\n\n        return (value) => {\n            return funcs.reduce(\n                (acc, func) => func(acc),\n                value,\n            );\n        };\n    }\n\n    /**\n     * In templates, we often use a single concatenated string to ask for several transformation functions at once:\n     *  `value|func1|func2`\n     * This class offers syntactical sugar to retrieve the entire sequence of transformations as a single callable\n     * @param name\n     */\n    get(name) {\n        if (!name) {\n            // This function is sometimes called with no value, and the expected behavior is to return null instead of\n            //  a callable\n            return null;\n        }\n        if (name.substring(0, 1) === '|') {\n            // Legacy artifact of how this function is called- if a pipe is present, this is the template string\n            //  (`|func1|func2...`), rather than any one single transformation function.\n            // A sequence of transformation functions is expected\n            return this._collectTransforms(name);\n        } else {\n            // If not a template string, then user is asking for an item by name directly\n            return super.get(name);\n        }\n    }\n}\n\n\n/**\n * A plugin registry that allows plots to use both pre-defined and user-provided transformation functions, which\n *  can be used to modify a value in the input data in a predefined way. For example, these can be used to let APIs\n *  that return p_values work with plots that display -log10(p)\n * @alias module:LocusZoom~TransformationFunctions\n * @type {TransformationFunctionsRegistry}\n */\nconst registry = new TransformationFunctionsRegistry();\nfor (let [name, type] of Object.entries(transforms)) {\n    registry.add(name, type);\n}\n\n\nexport default registry;\n// Export helper class for unit testing\nexport { TransformationFunctionsRegistry as _TransformationFunctions };\n","import TRANSFORMS from '../registry/transforms';\n\n/**\n * Represents an addressable unit of data from a namespaced datasource, subject to specified value transformations.\n *\n * When used by a data layer, fields will automatically be re-fetched from the appropriate data source whenever the\n *   state of a plot fetches, eg pan or zoom operations that would affect what data is displayed.\n *\n * @private\n * @class\n * @param {String} field A string representing the namespace of the datasource, the name of the desired field to fetch\n *   from that datasource, and arbitrarily many transformations to apply to the value. The namespace and\n *   transformation(s) are optional and information is delimited according to the general syntax\n *   `[namespace:]name[|transformation][|transformation]`. For example, `association:pvalue|neglog10`\n */\nclass Field {\n    constructor(field) {\n        // Two scenarios: we are requesting a field by full name, OR there are transforms to apply\n        // `fieldname` or `namespace:fieldname` followed by `|filter1|filterN`\n        const field_pattern = /^(?:\\w+:\\w+|^\\w+)(?:\\|\\w+)*$/;\n        if (!field_pattern.test(field)) {\n            throw new Error(`Invalid field specifier: '${field}'`);\n        }\n\n        const [name, ...transforms] = field.split('|');\n\n        this.full_name = field; // fieldname + transforms\n        this.field_name = name; // just fieldname\n        this.transformations = transforms.map((name) => TRANSFORMS.get(name));\n    }\n\n    _applyTransformations(val) {\n        this.transformations.forEach(function(transform) {\n            val = transform(val);\n        });\n        return val;\n    }\n\n    /**\n     * Resolve the field for a given data element.\n     *   First look for a full match with transformations already applied by the data requester.\n     *   Otherwise prefer a namespace match and fall back to just a name match, applying transformations on the fly.\n     * @param {Object} data Returned data/fields into for this element\n     * @param {Object} [extra] User-applied annotations for this point (info not provided by the server that we want\n     *  to preserve across re-renders). Example usage: \"should_show_label\"\n     * @returns {*}\n     */\n    resolve(data, extra) {\n        // Four resolutions: a) This is cached, b) this can be calculated from a known field, c) this is a known annotation rather than from an API, d) This field doesn't exist and returns as null\n        if (typeof data[this.full_name] == 'undefined') { // Check for cached result\n            let val = null;\n            if (data[this.field_name] !== undefined) { // Fallback: value sans transforms\n                val = data[this.field_name];\n            } else if (extra && extra[this.field_name] !== undefined) { // Fallback: check annotations\n                val = extra[this.field_name];\n            } // Don't warn if no value found, because sometimes only certain rows will have a specific field (esp happens with annotations)\n            data[this.full_name] = this._applyTransformations(val);\n        }\n        return data[this.full_name];\n    }\n}\n\nexport {Field as default};\n","/**\n * Simplified JSONPath implementation\n *\n * This is designed to make it easier to modify part of a LocusZoom layout, using a syntax based on intent\n *   (\"modify association panels\") rather than hard-coded assumptions (\"modify the first button, and gosh I hope the order doesn't change\")\n *\n * This DOES NOT support the full JSONPath specification. Notable limitations:\n * - Arrays can only be indexed by filter expression, not by number (can't ask for \"array item 1\")\n * - Filter expressions support only exact match, `field === value`. There is no support for \"and\" statements or\n *  arbitrary JS expressions beyond a single exact comparison. (the parser may be improved in the future if use cases emerge)\n *\n * @module\n * @private\n */\n\nconst ATTR_REGEX = /^(\\*|[\\w]+)/; // attribute names can be wildcard or valid variable names\nconst EXPR_REGEX = /^\\[\\?\\(@((?:\\.[\\w]+)+) *===? *([0-9.eE-]+|\"[^\"]*\"|'[^']*')\\)\\]/;  // Arrays can be indexed using filter expressions like `[?(@.id === value)]` where value is a number or a single-or-double quoted string\n\nfunction get_next_token(q) {\n    // This just grabs everything that looks good.\n    // The caller should check that the remaining query is valid.\n    if (q.substr(0, 2) === '..') {\n        if (q[2] === '[') {\n            return {\n                text: '..',\n                attr: '*',\n                depth: '..',\n            };\n        }\n        const m = ATTR_REGEX.exec(q.substr(2));\n        if (!m) {\n            throw `Cannot parse ${JSON.stringify(q)} as dotdot_attr.`;\n        }\n        return {\n            text: `..${m[0]}`,\n            attr: m[1],\n            depth: '..',\n        };\n    } else if (q[0] === '.') {\n        const m = ATTR_REGEX.exec(q.substr(1));\n        if (!m) {\n            throw `Cannot parse ${JSON.stringify(q)} as dot_attr.`;\n        }\n        return {\n            text: `.${m[0]}`,\n            attr: m[1],\n            depth: '.',\n        };\n    } else if (q[0] === '[') {\n        const m = EXPR_REGEX.exec(q);\n        if (!m) {\n            throw `Cannot parse ${JSON.stringify(q)} as expr.`;\n        }\n        let value;\n        try {\n            // Parse strings and numbers\n            value = JSON.parse(m[2]);\n        } catch (e) {\n            // Handle single-quoted strings\n            value = JSON.parse(m[2].replace(/^'|'$/g, '\"'));\n        }\n\n        return {\n            text: m[0],\n            attrs: m[1].substr(1).split('.'),\n            value,\n        };\n    } else {\n        throw `The query ${JSON.stringify(q)} doesn't look valid.`;\n    }\n}\n\nfunction normalize_query(q) {\n    // Normalize the start of the query so that it's just a bunch of selectors one-after-another.\n    // Otherwise the first selector is a little different than the others.\n    if (!q) {\n        return '';\n    }\n    if (!['$', '['].includes(q[0])) {\n        q = `$.${  q}`;\n    } // It starts with a dotless attr, so prepend the implied `$.`.\n    if (q[0] === '$') {\n        q = q.substr(1);\n    }  // strip the leading $\n    return q;\n}\n\nfunction tokenize (q) {\n    q = normalize_query(q);\n    let selectors = [];\n    while (q.length) {\n        const selector = get_next_token(q);\n        q = q.substr(selector.text.length);\n        selectors.push(selector);\n    }\n    return selectors;\n}\n\n/**\n * Fetch the attribute from a dotted path inside a nested object, eg `extract_path({k:['a','b']}, ['k', 1])` would retrieve `'b'`\n *\n * This function returns a three item array `[parent, key, object]`. This is done to support mutating the value, which requires access to the parent.\n *\n * @param obj\n * @param path\n * @returns {Array}\n */\nfunction get_item_at_deep_path(obj, path) {\n    let parent;\n    for (let key of path) {\n        parent = obj;\n        obj = obj[key];\n    }\n    return [parent, path[path.length - 1], obj];\n}\n\nfunction tokens_to_keys(data, selectors) {\n    // Resolve the jsonpath query into full path specifier keys in the object, eg\n    //  `$..data_layers[?(@.tag === 'association)].color\n    //  would become\n    // [\"panels\", 0, \"data_layers\", 1, \"color\"]\n    if (!selectors.length) {\n        return [[]];\n    }\n    const sel = selectors[0];\n    const remaining_selectors = selectors.slice(1);\n    let paths = [];\n\n    if (sel.attr && sel.depth === '.' && sel.attr !== '*') { // .attr\n        const d = data[sel.attr];\n        if (selectors.length === 1) {\n            if (d !== undefined) {\n                paths.push([sel.attr]);\n            }\n        } else {\n            paths.push(...tokens_to_keys(d, remaining_selectors).map((p) => [sel.attr].concat(p)));\n        }\n    } else if (sel.attr && sel.depth === '.' && sel.attr === '*') { // .*\n        for (let [k, d] of Object.entries(data)) {\n            paths.push(...tokens_to_keys(d, remaining_selectors).map((p) => [k].concat(p)));\n        }\n    } else if (sel.attr && sel.depth === '..') { // ..\n        // If `sel.attr` matches, recurse with that match.\n        // And also recurse on every value using unchanged selectors.\n        // I bet `..*..*` duplicates results, so don't do it please.\n        if (typeof data === 'object' && data !== null) {\n            if (sel.attr !== '*' && sel.attr in data) { // Exact match!\n                paths.push(...tokens_to_keys(data[sel.attr], remaining_selectors).map((p) => [sel.attr].concat(p)));\n            }\n            for (let [k, d] of Object.entries(data)) {\n                paths.push(...tokens_to_keys(d, selectors).map((p) => [k].concat(p))); // No match, just recurse\n                if (sel.attr === '*') { // Wildcard match\n                    paths.push(...tokens_to_keys(d, remaining_selectors).map((p) => [k].concat(p)));\n                }\n            }\n        }\n    } else if (sel.attrs) { // [?(@.attr===value)]\n        for (let [k, d] of Object.entries(data)) {\n            const [_, __, subject] = get_item_at_deep_path(d, sel.attrs);\n            if (subject === sel.value) {\n                paths.push(...tokens_to_keys(d, remaining_selectors).map((p) => [k].concat(p)));\n            }\n        }\n    }\n\n    const uniqPaths = uniqBy(paths, JSON.stringify); // dedup\n    uniqPaths.sort((a, b) => b.length - a.length || JSON.stringify(a).localeCompare(JSON.stringify(b))); // sort longest-to-shortest, breaking ties lexicographically\n    return uniqPaths;\n}\n\nfunction uniqBy(arr, key) {\n    // Sometimes, the process of resolving paths to selectors returns duplicate results. This returns only the unique paths.\n    return [...new Map(arr.map((elem) => [key(elem), elem])).values()];\n}\n\nfunction get_items_from_tokens(data, selectors) {\n    let items = [];\n    for (let path of tokens_to_keys(data, selectors)) {\n        items.push(get_item_at_deep_path(data, path));\n    }\n    return items;\n}\n\n/**\n * Perform a query, and return the item + its parent context\n * @param data\n * @param query\n * @returns {Array}\n * @private\n */\nfunction _query(data, query) {\n    const tokens = tokenize(query);\n\n    const matches = get_items_from_tokens(data, tokens);\n    if (!matches.length) {\n        console.warn(`No items matched the specified query: '${query}'`);\n    }\n    return matches;\n}\n\n/**\n * Fetch the value(s) for each possible match for a given query. Returns only the item values.\n * @param {object} data The data object to query\n * @param {string} query A JSONPath-compliant query string\n * @returns {Array}\n */\nfunction query(data, query) {\n    return _query(data, query).map((item) => item[2]);\n}\n\n/**\n * Modify the value(s) for each possible match for a given jsonpath query. Returns the new item values.\n * @param {object} data The data object to query\n * @param {string} query A JSONPath-compliant query string\n * @param {function|*} value_or_callback The new value for the specified field. Mutations will only be applied\n *  after the keys are resolved; this prevents infinite recursion, but could invalidate some matches\n *  (if the mutation removed the expected key).\n */\nfunction mutate(data, query, value_or_callback) {\n    const matches_in_context = _query(data, query);\n    return matches_in_context.map(([parent, key, old_value]) => {\n        const new_value = (typeof value_or_callback === 'function') ? value_or_callback(old_value) : value_or_callback;\n        parent[key] = new_value;\n        return new_value;\n    });\n}\n\nexport {mutate, query};\n","/**\n * Utilities for modifying or working with layout objects\n * @module\n * @private\n */\nimport * as d3 from 'd3';\n\nimport {mutate, query} from './jsonpath';\n\nconst sqrt3 = Math.sqrt(3);\n// D3 v5 does not provide a triangle down symbol shape, but it is very useful for showing direction of effect.\n//  Modified from https://github.com/d3/d3-shape/blob/master/src/symbol/triangle.js\nconst triangledown = {\n    draw(context, size) {\n        const y = -Math.sqrt(size / (sqrt3 * 3));\n        context.moveTo(0, -y * 2);\n        context.lineTo(-sqrt3 * y, y);\n        context.lineTo(sqrt3 * y, y);\n        context.closePath();\n    },\n};\n\n/**\n * Apply shared namespaces to a layout, recursively.\n *\n * Overriding namespaces can be used to identify where to retrieve data from, but not to add new data sources to a layout.\n *   For that, a key would have to be added to `layout.namespace` directly.\n *\n * Detail: This function is a bit magical. Whereas most layouts overrides are copied over verbatim (merging objects and nested keys), applyNamespaces will *only* copy\n *  over keys that are relevant to that data layer. Eg, if overrides specifies a key called \"red_herring\",\n *  an association data layer will ignore that data source entirely, and not copy it into `assoc_layer.namespace`.\n *\n * Only items under a key called `namespace` are given this special treatment. This allows a single call to `Layouts.get('plot'...)` to specify\n *   namespace overrides for many layers in one convenient place, without accidentally telling every layer to request all possible data for itself.\n * @private\n  */\nfunction applyNamespaces(layout, shared_namespaces) {\n    shared_namespaces = shared_namespaces || {};\n    if (!layout || typeof layout !== 'object' || typeof shared_namespaces !== 'object') {\n        throw new Error('Layout and shared namespaces must be provided as objects');\n    }\n\n    for (let [field_name, item] of Object.entries(layout)) {\n        if (field_name === 'namespace') {\n            Object.keys(item).forEach((requested_ns) => {\n                const override = shared_namespaces[requested_ns];\n                if (override) {\n                    item[requested_ns] = override;\n                }\n            });\n        } else if (item !== null && (typeof item === 'object')) {\n            layout[field_name] = applyNamespaces(item, shared_namespaces);\n        }\n    }\n    return layout;\n}\n\n/**\n * A helper method used for merging two objects. If a key is present in both, takes the value from the first object.\n *   Values from `default_layout` will be cleanly copied over, ensuring no references or shared state.\n *\n * Frequently used for preparing custom layouts. Both objects should be JSON-serializable.\n *\n * @alias LayoutRegistry.merge\n * @param {object} custom_layout An object containing configuration parameters that override or add to defaults\n * @param {object} default_layout An object containing default settings.\n * @returns {object} The custom layout is modified in place and also returned from this method.\n */\nfunction merge(custom_layout, default_layout) {\n    if (typeof custom_layout !== 'object' || typeof default_layout !== 'object') {\n        throw new Error(`LocusZoom.Layouts.merge only accepts two layout objects; ${typeof custom_layout}, ${typeof default_layout} given`);\n    }\n    for (let property in default_layout) {\n        if (!Object.prototype.hasOwnProperty.call(default_layout, property)) {\n            continue;\n        }\n        // Get types for comparison. Treat nulls in the custom layout as undefined for simplicity.\n        // (javascript treats nulls as \"object\" when we just want to overwrite them as if they're undefined)\n        // Also separate arrays from objects as a discrete type.\n        let custom_type = custom_layout[property] === null ? 'undefined' : typeof custom_layout[property];\n        let default_type = typeof default_layout[property];\n        if (custom_type === 'object' && Array.isArray(custom_layout[property])) {\n            custom_type = 'array';\n        }\n        if (default_type === 'object' && Array.isArray(default_layout[property])) {\n            default_type = 'array';\n        }\n        // Unsupported property types: throw an exception\n        if (custom_type === 'function' || default_type === 'function') {\n            throw new Error('LocusZoom.Layouts.merge encountered an unsupported property type');\n        }\n        // Undefined custom value: pull the default value\n        if (custom_type === 'undefined') {\n            custom_layout[property] = deepCopy(default_layout[property]);\n            continue;\n        }\n        // Both values are objects: merge recursively\n        if (custom_type === 'object' && default_type === 'object') {\n            custom_layout[property] = merge(custom_layout[property], default_layout[property]);\n            continue;\n        }\n    }\n    return custom_layout;\n}\n\nfunction deepCopy(item) {\n    // FIXME: initial attempt to replace this with a more efficient deep clone method caused merge() to break; revisit in future.\n    //   Replacing this with a proper clone would be the key blocker to allowing functions and non-JSON values (like infinity) in layout objects\n    return JSON.parse(JSON.stringify(item));\n}\n\n/**\n * Convert name to symbol\n * Layout objects accept symbol names as strings (circle, triangle, etc). Convert to symbol objects.\n * @return {object|null} An object that implements a draw method (eg d3-shape symbols or extra LZ items)\n */\nfunction nameToSymbol(shape) {\n    if (!shape) {\n        return null;\n    }\n    if (shape === 'triangledown') {\n        // D3 does not provide this symbol natively\n        return triangledown;\n    }\n    // Legend shape names are strings; need to connect this to factory. Eg circle --> d3.symbolCircle\n    const factory_name = `symbol${shape.charAt(0).toUpperCase() + shape.slice(1)}`;\n    return d3[factory_name] || null;\n}\n\n\n/**\n * Find all references to namespaced fields within a layout object. This is used to validate that a set of provided\n *  data adapters will actually give all the information required to draw the plot.\n * @param {Object} layout\n * @param {Array|null} prefixes A list of allowed namespace prefixes. (used to differentiate between real fields,\n *   and random sentences that match an arbitrary pattern.\n * @param {RegExp|null} field_finder On recursive calls, pass the regexp we constructed the first time\n * @return {Set}\n */\nfunction findFields(layout, prefixes, field_finder = null) {\n    const fields = new Set();\n    if (!field_finder) {\n        if (!prefixes.length) {\n            // A layer that doesn't ask for external data does not need to check if the provider returns expected fields\n            return fields;\n        }\n        const all_ns = prefixes.join('|');\n\n        // Locates any reference within a template string to to `ns:field`, `{{ns:field}}`, or `{{#if ns:field}}`.\n        //  By knowing the list of allowed NS prefixes, we can be much more confident in avoiding spurious matches\n        field_finder = new RegExp(`(?:{{)?(?:#if *)?((?:${all_ns}):\\\\w+)`, 'g');\n    }\n\n    for (const value of Object.values(layout)) {\n        const value_type = typeof value;\n        let matches = [];\n        if (value_type === 'string') {\n            let a_match;\n            while ((a_match = field_finder.exec(value)) !== null) {\n                matches.push(a_match[1]);\n            }\n        } else if (value !== null && value_type === 'object') {\n            matches = findFields(value, prefixes, field_finder);\n        } else {\n            // Only look for field names in strings or compound values\n            continue;\n        }\n        for (let m of matches) {\n            fields.add(m);\n        }\n    }\n    return fields;\n}\n\n\n/**\n * A utility helper for customizing one part of a pre-made layout. Whenever a primitive value is found (eg string),\n *  replaces *exact match*\n *\n * This method works by comparing whether strings are a match. As a result, the \"old\" and \"new\" names must match\n *  whatever namespacing is used in the input layout.\n * Note: this utility *can* replace values with filters, but will not do so by default.\n *\n * @alias LayoutRegistry.renameField\n *\n * @param {object} layout The layout object to be transformed.\n * @param {string} old_name The old field name that will be replaced\n * @param {string} new_name The new field name that will be substituted in\n * @param {boolean} [warn_transforms=true] Sometimes, a field name is used with transforms appended, eg `label|htmlescape`.\n *   In some cases a rename could change the meaning of the field, and by default this method will print a warning to\n *   the console, encouraging the developer to check the relevant usages. This warning can be silenced via an optional function argument.\n */\nfunction renameField(layout, old_name, new_name, warn_transforms = true) {\n    const this_type = typeof layout;\n    // Handle nested types by recursion (in which case, `layout` may be something other than an object)\n    if (Array.isArray(layout)) {\n        return layout.map((item) => renameField(item, old_name, new_name, warn_transforms));\n    } else if (this_type === 'object' && layout !== null) {\n        return Object.keys(layout).reduce(\n            (acc, key) => {\n                acc[key] = renameField(layout[key], old_name, new_name, warn_transforms);\n                return acc;\n            }, {},\n        );\n    } else if (this_type !== 'string') {\n        // Field names are always strings. If the value isn't a string, don't even try to change it.\n        return layout;\n    } else {\n        // If we encounter a field we are trying to rename, then do so!\n        // Rules:\n        //  1. Try to avoid renaming part of a field, by checking token boundaries (field1 should not rename field1_displayvalue)\n        //  2. Warn the user if filter functions are being used with the specified field, so they can audit for changes in meaning\n        const escaped = old_name.replace(/[|\\\\{}()[\\]^$+*?.]/g, '\\\\$&');\n\n        if (warn_transforms) {\n            // Warn the user that they might be renaming, eg, `pvalue|neg_log` to `log_pvalue|neg_log`. Let them decide\n            //   whether the new field name has a meaning that is compatible with the specified transforms.\n            const filter_regex = new RegExp(`${escaped}\\\\|\\\\w+`, 'g');\n            const filter_matches = (layout.match(filter_regex) || []);\n            filter_matches.forEach((match_val) => console.warn(`renameFields is renaming a field that uses transform functions: was '${match_val}' . Verify that these transforms are still appropriate.`));\n        }\n\n        // Find and replace any substring, so long as it is at the end of a valid token\n        const regex = new RegExp(`${escaped}(?!\\\\w+)`, 'g');\n        return layout.replace(regex, new_name);\n    }\n}\n\n/**\n * Modify any and all attributes at the specified path in the object\n * @param {object} layout The layout object to be mutated\n * @param {string} selector The JSONPath-compliant selector string specifying which field(s) to change.\n *   The callback will be applied to ALL matching selectors\n *  (see Interactivity guide for syntax and limitations)\n * @param {*|function} value_or_callable The new value, or a function that receives the old value and returns a new one\n * @returns {Array}\n * @alias LayoutRegistry.mutate_attrs\n */\nfunction mutate_attrs(layout, selector, value_or_callable) {\n    return mutate(\n        layout,\n        selector,\n        value_or_callable,\n    );\n}\n\n/**\n * Query any and all attributes at the specified path in the object.\n *      This is mostly only useful for debugging, to verify that a particular selector matches the intended field.\n * @param {object} layout The layout object to be mutated\n * @param {string} selector The JSONPath-compliant selector string specifying which values to return. (see Interactivity guide for limits)\n * @returns {Array}\n * @alias LayoutRegistry.query_attrs\n */\nfunction query_attrs(layout, selector) {\n    return query(layout, selector);\n}\n\nexport { applyNamespaces, deepCopy, merge, mutate_attrs, query_attrs, nameToSymbol, findFields, renameField };\n","/**\n * @module\n * @private\n */\nimport {getLinkedData} from './undercomplicate';\n\nimport { DATA_OPS } from '../registry';\n\n\nclass DataOperation {\n    /**\n     * Perform a data operation (such as a join)\n     * @param {String} join_type\n     * @param initiator The entity that initiated the request for data. Usually, this is the data layer. This argument exists so that a data_operation could do things like auto-define axis labels/ color scheme in response to dynamic data. It has potential for side effects if misused, so use sparingly!\n     * @param params Optional user/layout parameters to be passed to the data function\n     */\n    constructor(join_type, initiator, params) {\n        this._callable = DATA_OPS.get(join_type);\n        this._initiator = initiator;\n        this._params = params || [];\n    }\n\n    getData(plot_state, ...dependent_recordsets) {\n        // Most operations are joins: they receive two pieces of data (eg left + right)\n        //   Other ops are possible, like consolidating just one set of records to best value per key\n        // Hence all dependencies are passed as first arg: [dep1, dep2, dep3...]\n\n        // Every data operation receives plot_state, reference to the data layer that called it, the input data, & any additional options\n        const context = {plot_state, data_layer: this._initiator};\n        return Promise.resolve(this._callable(context, dependent_recordsets, ...this._params));\n    }\n}\n\n\n/**\n * The Requester manages fetching of data across multiple data sources. It is used internally by LocusZoom data layers.\n *   It passes plot.state information to each adapter, and ensures that a series of requests can be performed in a\n *   designated order.\n *\n * Each data layer calls the requester object directly, and as such, each data layer has a private view of data: it can\n *   perform its own calculations, filter results, and apply transforms without influencing other layers.\n *  (while still respecting a shared cache where appropriate)\n *\n * This object is not part of the public interface. It should almost **never** be replaced or modified directly.\n *\n * @param {DataSources} sources A set of data sources used specifically by this plot instance\n * @private\n */\nclass Requester {\n    constructor(sources) {\n        this._sources = sources;\n    }\n\n    /**\n     * Parse the data layer configuration when a layer is first created.\n     *  Validate config, and return entities and dependencies in a format usable for data retrieval.\n     *  This is used by data layers, and also other data-retrieval functions (like subscribeToDate).\n     *\n     *  Inherent assumptions:\n     *  1. A data layer will always know its data up front, and layout mutations will only affect what is displayed.\n     *  2. People will be able to add new data adapters (tracks), but if they are removed, the accompanying layers will be\n     *      removed at the same time. Otherwise, the pre-parsed data fetching logic could could preserve a reference to the\n     *      removed adapter.\n     * @param {Object} namespace_options\n     * @param {Array} data_operations\n     * @param {Object|null} initiator The entity that initiated the request (the data layer). Passed to data operations,\n     *   but not adapters. By baking this reference into each data operation, functions can do things like autogenerate\n     *   axis tick marks or color schemes based on dyanmic data. This is an advanced usage and should be handled with care!\n     * @returns {Array} Map of entities and list of dependencies\n     */\n    config_to_sources(namespace_options = {}, data_operations = [], initiator) {\n        const entities = new Map();\n        const namespace_local_names = Object.keys(namespace_options);\n\n        // 1. Specify how to coordinate data. Precedence:\n        //   a) EXPLICIT fetch logic,\n        //   b) IMPLICIT auto-generate fetch order if there is only one NS,\n        //   c) Throw \"spec required\" error if > 1, because 2 adapters may need to be fetched in a sequence\n        let dependency_order = data_operations.find((item) => item.type === 'fetch');  // explicit spec: {fetch, from}\n        if (!dependency_order) {\n            dependency_order = { type: 'fetch', from: namespace_local_names };\n            data_operations.unshift(dependency_order);\n        }\n\n        // Validate that all NS items are available to the root requester in DataSources. All layers recognize a\n        //  default value, eg people copying the examples tend to have defined a datasource called \"assoc\"\n        const ns_pattern = /^\\w+$/;\n        for (let [local_name, global_name] of Object.entries(namespace_options)) {\n            if (!ns_pattern.test(local_name)) {\n                throw new Error(`Invalid namespace name: '${local_name}'. Must contain only alphanumeric characters`);\n            }\n\n            const source = this._sources.get(global_name);\n            if (!source) {\n                throw new Error(`A data layer has requested an item not found in DataSources: data type '${local_name}' from ${global_name}`);\n            }\n            entities.set(local_name, source);\n\n            // Note: Dependency spec checker will consider \"ld(assoc)\" to match a namespace called \"ld\"\n            if (!dependency_order.from.find((dep_spec) => dep_spec.split('(')[0] === local_name)) {\n                // Sometimes, a new piece of data (namespace) will be added to a layer. Often this doesn't have any dependencies, other than adding a new join.\n                //  To make it easier to EXTEND existing layers, by default, we'll push any unknown namespaces to data_ops.fetch\n                // Thus the default behavior is \"fetch all namespaces as though they don't depend on anything.\n                //  If they depend on something, only then does \"data_ops[@type=fetch].from\" need to be mutated\n                dependency_order.from.push(local_name);\n            }\n        }\n\n        let dependencies = Array.from(dependency_order.from);\n\n        // Now check all joins. Are namespaces valid? Are they requesting known data?\n        for (let config of data_operations) {\n            let {type, name, requires, params} = config;\n            if (type !== 'fetch') {\n                let namecount = 0;\n                if (!name) {\n                    name = config.name = `join${namecount}`;\n                    namecount += 1;\n                }\n\n                if (entities.has(name)) {\n                    throw new Error(`Configuration error: within a layer, join name '${name}' must be unique`);\n                }\n                requires.forEach((require_name) => {\n                    if (!entities.has(require_name)) {\n                        throw new Error(`Data operation cannot operate on unknown provider '${require_name}'`);\n                    }\n                });\n\n                const task = new DataOperation(type, initiator, params);\n                entities.set(name, task);\n                dependencies.push(`${name}(${requires.join(', ')})`); // Dependency resolver uses the form item(depA, depB)\n            }\n        }\n        return [entities, dependencies];\n    }\n\n    /**\n     * @param {Object} plot_state Plot state, which will be passed to every adapter. Includes view extent (chr, start, end)\n     * @param {Map} entities A list of adapter and join tasks. This is created internally from data layer layouts.\n     *  Keys are layer-local namespaces for data types (like assoc), and values are adapter or join task instances\n     *  (things that implement a method getData).\n     * @param {String[]} dependencies Instructions on what adapters to fetch from, in what order\n     * @returns {Promise}\n     */\n    getData(plot_state, entities, dependencies) {\n        if (!dependencies.length) {\n            return Promise.resolve([]);\n        }\n        // The last dependency (usually the last join operation) determines the last thing returned.\n        return getLinkedData(plot_state, entities, dependencies, true);\n    }\n}\n\n\nexport default Requester;\n\nexport {DataOperation as _JoinTask};\n","/**\n * @module\n * @private\n */\n// FIXME: A place for code that used to live under the `LocusZoom` namespace\n// Eventually this should be moved into classes or some other mechanism for code sharing. No external uses should\n//  depend on any items in this module.\n\nimport * as d3 from 'd3';\n\n/**\n * Generate a curtain object for a plot, panel, or any other subdivision of a layout\n * The panel curtain, like the plot curtain is an HTML overlay that obscures the entire panel. It can be styled\n *   arbitrarily and display arbitrary messages. It is useful for reporting error messages visually to an end user\n *   when the error renders the panel unusable.\n *   TODO: Improve type doc here\n * @returns {object}\n */\nfunction generateCurtain() {\n    return {\n        showing: false,\n        selector: null,\n        content_selector: null,\n        hide_delay: null,\n\n        /**\n         * Generate the curtain. Any content (string) argument passed will be displayed in the curtain as raw HTML.\n         *   CSS (object) can be passed which will apply styles to the curtain and its content.\n         * @param {string} content Content to be displayed on the curtain (as raw HTML)\n         * @param {object} css Apply the specified styles to the curtain and its contents\n         */\n        show: (content, css) => {\n            if (!this.curtain.showing) {\n                this.curtain.selector = d3.select(this.parent_plot.svg.node().parentNode).insert('div')\n                    .attr('class', 'lz-curtain')\n                    .attr('id', `${this.id}.curtain`);\n                this.curtain.content_selector = this.curtain.selector.append('div')\n                    .attr('class', 'lz-curtain-content');\n                this.curtain.selector.append('div')\n                    .attr('class', 'lz-curtain-dismiss').html('Dismiss')\n                    .on('click', () => this.curtain.hide());\n                this.curtain.showing = true;\n            }\n            return this.curtain.update(content, css);\n        },\n\n        /**\n         * Update the content and css of the curtain that's currently being shown. This method also adjusts the size\n         *   and positioning of the curtain to ensure it still covers the entire panel with no overlap.\n         * @param {string} content Content to be displayed on the curtain (as raw HTML)\n         * @param {object} css Apply the specified styles to the curtain and its contents\n         */\n        update: (content, css) => {\n            if (!this.curtain.showing) {\n                return this.curtain;\n            }\n            clearTimeout(this.curtain.hide_delay);\n            // Apply CSS if provided\n            if (typeof css == 'object') {\n                applyStyles(this.curtain.selector, css);\n            }\n            // Update size and position\n            const page_origin = this._getPageOrigin();\n\n            // Panel layouts have a height; plot layouts don't\n            const height = this.layout.height || this._total_height;\n            this.curtain.selector\n                .style('top', `${page_origin.y}px`)\n                .style('left', `${page_origin.x}px`)\n                .style('width', `${this.parent_plot.layout.width}px`)\n                .style('height', `${height}px`);\n            this.curtain.content_selector\n                .style('max-width', `${this.parent_plot.layout.width - 40}px`)\n                .style('max-height', `${height - 40}px`);\n            // Apply content if provided\n            if (typeof content == 'string') {\n                this.curtain.content_selector.html(content);\n            }\n            return this.curtain;\n        },\n\n        /**\n         * Remove the curtain\n         * @param {number} delay Time to wait (in ms)\n         */\n        hide: (delay) => {\n            if (!this.curtain.showing) {\n                return this.curtain;\n            }\n            // If a delay was passed then defer to a timeout\n            if (typeof delay == 'number') {\n                clearTimeout(this.curtain.hide_delay);\n                this.curtain.hide_delay = setTimeout(this.curtain.hide, delay);\n                return this.curtain;\n            }\n            // Remove curtain\n            this.curtain.selector.remove();\n            this.curtain.selector = null;\n            this.curtain.content_selector = null;\n            this.curtain.showing = false;\n            return this.curtain;\n        },\n    };\n}\n\n/**\n * Generate a loader object for a plot, panel, or any other subdivision of a layout\n *\n * The panel loader is a small HTML overlay that appears in the lower left corner of the panel. It cannot be styled\n *   arbitrarily, but can show a custom message and show a minimalist loading bar that can be updated to specific\n *   completion percentages or be animated.\n * TODO Improve type documentation\n * @returns {object}\n */\nfunction generateLoader() {\n    return {\n        showing: false,\n        selector: null,\n        content_selector: null,\n        progress_selector: null,\n        cancel_selector: null,\n\n        /**\n         * Show a loading indicator\n         * @param {string} [content='Loading...'] Loading message (displayed as raw HTML)\n         */\n        show: (content) => {\n            // Generate loader\n            if (!this.loader.showing) {\n                this.loader.selector = d3.select(this.parent_plot.svg.node().parentNode).insert('div')\n                    .attr('class', 'lz-loader')\n                    .attr('id', `${this.id}.loader`);\n                this.loader.content_selector = this.loader.selector.append('div')\n                    .attr('class', 'lz-loader-content');\n                this.loader.progress_selector = this.loader.selector\n                    .append('div')\n                    .attr('class', 'lz-loader-progress-container')\n                    .append('div')\n                    .attr('class', 'lz-loader-progress');\n\n                this.loader.showing = true;\n                if (typeof content == 'undefined') {\n                    content = 'Loading...';\n                }\n            }\n            return this.loader.update(content);\n        },\n\n        /**\n         * Update the currently displayed loader and ensure the new content is positioned correctly.\n         * @param {string} content The text to display (as raw HTML). If not a string, will be ignored.\n         * @param {number} [percent] A number from 1-100. If a value is specified, it will stop all animations\n         *   in progress.\n         */\n        update: (content, percent) => {\n            if (!this.loader.showing) {\n                return this.loader;\n            }\n            clearTimeout(this.loader.hide_delay);\n            // Apply content if provided\n            if (typeof content == 'string') {\n                this.loader.content_selector.html(content);\n            }\n            // Update size and position\n            const padding = 6; // is there a better place to store/define this?\n            const page_origin = this._getPageOrigin();\n            const loader_boundrect = this.loader.selector.node().getBoundingClientRect();\n            this.loader.selector\n                .style('top', `${page_origin.y + this.layout.height - loader_boundrect.height - padding}px`)\n                .style('left', `${page_origin.x + padding  }px`);\n\n            // Apply percent if provided\n            if (typeof percent == 'number') {\n                this.loader.progress_selector\n                    .style('width', `${Math.min(Math.max(percent, 1), 100)}%`);\n            }\n            return this.loader;\n        },\n\n        /**\n         * Adds a class to the loading bar that makes it loop infinitely in a loading animation. Useful when exact\n         *   percent progress is not available.\n         */\n        animate: () => {\n            this.loader.progress_selector.classed('lz-loader-progress-animated', true);\n            return this.loader;\n        },\n\n        /**\n         *  Sets the loading bar in the loader to percentage width equal to the percent (number) value passed. Percents\n         *    will automatically be limited to a range of 1 to 100. Will stop all animations in progress.\n         */\n        setPercentCompleted: (percent) => {\n            this.loader.progress_selector.classed('lz-loader-progress-animated', false);\n            return this.loader.update(null, percent);\n        },\n\n        /**\n         * Remove the loader\n         * @param {number} delay Time to wait (in ms)\n         */\n        hide: (delay) => {\n            if (!this.loader.showing) {\n                return this.loader;\n            }\n            // If a delay was passed then defer to a timeout\n            if (typeof delay == 'number') {\n                clearTimeout(this.loader.hide_delay);\n                this.loader.hide_delay = setTimeout(this.loader.hide, delay);\n                return this.loader;\n            }\n            // Remove loader\n            this.loader.selector.remove();\n            this.loader.selector = null;\n            this.loader.content_selector = null;\n            this.loader.progress_selector = null;\n            this.loader.cancel_selector = null;\n            this.loader.showing = false;\n            return this.loader;\n        },\n    };\n}\n\n/**\n * Modern d3 removed the ability to set many styles at once (object syntax). This is a helper so that layouts with\n *  config-objects can set styles all at once\n * @private\n * @param {d3.selection} selection\n * @param {Object} styles\n */\nfunction applyStyles(selection, styles) {\n    styles = styles || {};\n    for (let [prop, value] of Object.entries(styles)) {\n        selection.style(prop, value);\n    }\n}\n\n/**\n * Prevent a UI function from being called more than once in a given interval. This allows, eg, search boxes to delay\n *   expensive operations until the user is done typing\n * @param {function} func The function to debounce. Returns a wrapper.\n * @param {number} delay Time to wait after last call (in ms)\n */\nfunction debounce(func, delay = 500) {\n    let timer;\n    return () => {\n        clearTimeout(timer);\n        timer = setTimeout(\n            () => func.apply(this, arguments),\n            delay,\n        );\n    };\n}\n\nexport { applyStyles, debounce, generateCurtain, generateLoader };\n","/**\n * Interactive toolbar widgets that allow users to control the plot. These can be used to modify element display:\n *  adding contextual information, rearranging/removing panels, or toggling between sets of rendering options like\n *  different LD populations.\n * @module LocusZoom_Widgets\n */\nimport * as d3 from 'd3';\n\nimport {positionIntToString} from '../../helpers/display';\nimport {applyStyles, debounce} from '../../helpers/common';\nimport {deepCopy} from '../../helpers/layouts';\n\n\n/**\n *\n * A widget is an empty div rendered on a toolbar that can display custom\n * html of user interface elements.\n */\nclass BaseWidget {\n    /**\n     * @param {('left'|'right')} [layout.position='left']  Whether to float the widget left or right.\n     * @param {('start'|'middle'|'end')} [layout.group_position] Buttons can optionally be gathered into a visually\n     *  distinctive group whose elements are closer together. If a button is identified as the start or end of a group,\n     *  it will be drawn with rounded corners and an extra margin of spacing from any button not part of the group.\n     *  For example, the region_nav_plot toolbar is a defined as a group.\n     * @param {('gray'|'red'|'orange'|'yellow'|'green'|'blue'|'purple')} [layout.color='gray']  Color scheme for the\n     *   widget. Applies to buttons and menus.\n     * @param [layout.style] CSS styles that will be applied to the widget\n     * @param {Toolbar} parent The toolbar that contains this widget\n     */\n    constructor(layout, parent) {\n        /** @member {Object} */\n        this.layout = layout || {};\n        if (!this.layout.color) {\n            this.layout.color = 'gray';\n        }\n\n        /** @member {Toolbar|*} */\n        this.parent = parent || null;\n        /**\n         * Some widgets are attached to a panel, rather than directly to a plot\n         * @member {Panel|null}\n         */\n        this.parent_panel = null;\n        /** @member {Plot} */\n        this.parent_plot = null;\n        /**\n         * This is a reference to either the panel or the plot, depending on what the toolbar is\n         *   tied to. Useful when absolutely positioning toolbar widgets relative to their SVG anchor.\n         * @member {Plot|Panel}\n         */\n        this.parent_svg = null;\n        if (this.parent) {\n            if (this.parent.type === 'panel') {\n                this.parent_panel = this.parent.parent;\n                this.parent_plot = this.parent.parent.parent;\n                this.parent_svg = this.parent_panel;\n            } else {\n                this.parent_plot = this.parent.parent;\n                this.parent_svg = this.parent_plot;\n            }\n        }\n        /** @member {d3.selection} */\n        this.selector = null;\n        /**\n         * If this is an interactive widget, it will contain a button or menu instance that handles the interactivity.\n         *   There is a 1-to-1 relationship of toolbar widget to button\n         * @member {null|Button}\n         */\n        this.button = null;\n        /**\n         * If any single widget is marked persistent, it will bubble up to prevent automatic hide behavior on a\n         *   widget's parent toolbar. Check via `shouldPersist`\n         * @protected\n         * @member {Boolean}\n         */\n        this.persist = false;\n        if (!this.layout.position) {\n            this.layout.position = 'left';\n        }\n    }\n\n    /**\n     * Perform all rendering of widget, including toggling visibility to true. Will initialize and create SVG element\n     *   if necessary, as well as updating with new data and performing layout actions.\n     */\n    show() {\n        if (!this.parent || !this.parent.selector) {\n            return;\n        }\n        if (!this.selector) {\n            const group_position = (['start', 'middle', 'end'].includes(this.layout.group_position) ? ` lz-toolbar-group-${this.layout.group_position}` : '');\n            this.selector = this.parent.selector.append('div')\n                .attr('class', `lz-toolbar-${this.layout.position}${group_position}`);\n            if (this.layout.style) {\n                applyStyles(this.selector, this.layout.style);\n            }\n            if (typeof this.initialize == 'function') {\n                this.initialize();\n            }\n        }\n        if (this.button && this.button.status === 'highlighted') {\n            this.button.menu.show();\n        }\n        this.selector.style('visibility', 'visible');\n        this.update();\n        return this.position();\n    }\n\n    /**\n     * Update the toolbar widget with any new data or plot state as appropriate. This method performs all\n     *  necessary rendering steps.\n     */\n    update() { /* stub */\n    }\n\n    /**\n     * Place the widget correctly in the plot\n     * @returns {BaseWidget}\n     */\n    position() {\n        if (this.button) {\n            this.button.menu.position();\n        }\n        return this;\n    }\n\n    /**\n     * Determine whether the widget should persist (will bubble up to parent toolbar)\n     * @returns {boolean}\n     */\n    shouldPersist() {\n        if (this.persist) {\n            return true;\n        }\n        return !!(this.button && this.button.persist);\n    }\n\n    /**\n     * Toggle visibility to hidden, unless marked as persistent\n     * @returns {BaseWidget}\n     */\n    hide() {\n        if (!this.selector || this.shouldPersist()) {\n            return this;\n        }\n        if (this.button) {\n            this.button.menu.hide();\n        }\n        this.selector.style('visibility', 'hidden');\n        return this;\n    }\n\n    /**\n     * Completely remove widget and button. (may be overridden by persistence settings)\n     * @param {Boolean} [force=false] If true, will ignore persistence settings and always destroy the toolbar\n     * @returns {Toolbar}\n     */\n    destroy(force) {\n        if (typeof force == 'undefined') {\n            force = false;\n        }\n        if (!this.selector) {\n            return this;\n        }\n        if (this.shouldPersist() && !force) {\n            return this;\n        }\n        if (this.button && this.button.menu) {\n            this.button.menu.destroy();\n        }\n        this.selector.remove();\n        this.selector = null;\n        this.button = null;\n        return this;\n    }\n}\n\n/**\n * Plots and panels may have a \"toolbar\" element suited for showing HTML widgets that may be interactive.\n *   When widgets need to incorporate a generic button, or additionally a button that generates a menu, this\n *   class provides much of the necessary framework. This widget is rarely used directly; it is usually used as\n *   part of the code for other widgets.\n * @alias module:LocusZoom_Widgets~_Button\n * @param {BaseWidget} parent\n */\nclass Button {\n    constructor(parent) {\n        if (!(parent instanceof BaseWidget)) {\n            throw new Error('Unable to create toolbar widget button, invalid parent');\n        }\n        /** @member {BaseWidget} */\n        this.parent = parent;\n        /** @member {Panel} */\n        this.parent_panel = this.parent.parent_panel;\n        /** @member {Plot} */\n        this.parent_plot = this.parent.parent_plot;\n        /** @member {Plot|Panel} */\n        this.parent_svg = this.parent.parent_svg;\n\n        /** @member {Toolbar|null|*} */\n        this.parent_toolbar = this.parent.parent;\n        /** @member {d3.selection} */\n        this.selector = null;\n\n        /**\n         * Tag to use for the button (default: a)\n         * @member {String}\n         */\n        this.tag = 'a';\n\n        /**\n         * HTML for the button to show.\n         * @protected\n         * @member {String}\n         */\n        this.html = '';\n\n        /**\n         * Mouseover title text for the button to show\n         * @protected\n         * @member {String}\n         */\n        this.title = '';\n\n        /**\n         * Color of the button\n         * @member {String}\n         */\n        this.color = 'gray';\n\n        /**\n         * Hash of arbitrary button styles to apply as {name: value} entries\n         * @protected\n         * @member {Object}\n         */\n        this.style = {};\n\n        // Permanence\n        /**\n         * Track internal state on whether to keep showing the button/ menu contents at the moment\n         * @protected\n         * @member {Boolean}\n         */\n        this.persist = false;\n        /**\n         * Configuration when defining a button: track whether this widget should be allowed to keep open\n         *   menu/button contents in response to certain events\n         * @protected\n         * @member {Boolean}\n         */\n        this.permanent = false;\n\n        /**\n         * Button status (highlighted / disabled/ etc)\n         * @protected\n         * @member {String}\n         */\n        this.status = '';\n\n        /**\n         * Button Menu Object\n         * The menu is an HTML overlay that can appear below a button. It can contain arbitrary HTML and\n         *   has logic to be automatically positioned and sized to behave more or less like a dropdown menu.\n         * @member {Object}\n         */\n        this.menu = {\n            outer_selector: null,\n            inner_selector: null,\n            scroll_position: 0,\n            hidden: true,\n            /**\n             * Show the button menu, including setting up any DOM elements needed for first rendering\n             */\n            show: () => {\n                if (!this.menu.outer_selector) {\n                    this.menu.outer_selector = d3.select(this.parent_plot.svg.node().parentNode).append('div')\n                        .attr('class', `lz-toolbar-menu lz-toolbar-menu-${this.color}`)\n                        .attr('id', `${this.parent_svg.getBaseId()}.toolbar.menu`);\n                    this.menu.inner_selector = this.menu.outer_selector.append('div')\n                        .attr('class', 'lz-toolbar-menu-content');\n                    this.menu.inner_selector.on('scroll', () => {\n                        this.menu.scroll_position = this.menu.inner_selector.node().scrollTop;\n                    });\n                }\n                this.menu.outer_selector.style('visibility', 'visible');\n                this.menu.hidden = false;\n                return this.menu.update();\n            },\n            /**\n             * Update the rendering of the menu\n             */\n            update: () => {\n                if (!this.menu.outer_selector) {\n                    return this.menu;\n                }\n                this.menu.populate(); // This function is stubbed for all buttons by default and custom implemented in widget definition\n                if (this.menu.inner_selector) {\n                    this.menu.inner_selector.node().scrollTop = this.menu.scroll_position;\n                }\n                return this.menu.position();\n            },\n            position: () => {\n                if (!this.menu.outer_selector) {\n                    return this.menu;\n                }\n                // Unset any explicitly defined outer selector height so that menus dynamically shrink if content is removed\n                this.menu.outer_selector.style('height', null);\n                const padding = 3;\n                const scrollbar_padding = 20;\n                const menu_height_padding = 14; // 14: 2x 6px padding, 2x 1px border\n                const page_origin = this.parent_svg._getPageOrigin();\n                const page_scroll_top = document.documentElement.scrollTop || document.body.scrollTop;\n                const container_offset = this.parent_plot.getContainerOffset();\n                const toolbar_client_rect = this.parent_toolbar.selector.node().getBoundingClientRect();\n                const button_client_rect = this.selector.node().getBoundingClientRect();\n                const menu_client_rect = this.menu.outer_selector.node().getBoundingClientRect();\n                const total_content_height = this.menu.inner_selector.node().scrollHeight;\n                let top;\n                let left;\n                if (this.parent_toolbar.type === 'panel') {\n                    top = (page_origin.y + toolbar_client_rect.height + (2 * padding));\n                    left = Math.max(page_origin.x + this.parent_plot.layout.width - menu_client_rect.width - padding, page_origin.x + padding);\n                } else {\n                    top = button_client_rect.bottom + page_scroll_top + padding - container_offset.top;\n                    left = Math.max(button_client_rect.left + button_client_rect.width - menu_client_rect.width - container_offset.left, page_origin.x + padding);\n                }\n                const base_max_width = Math.max(this.parent_plot.layout.width - (2 * padding) - scrollbar_padding, scrollbar_padding);\n                const container_max_width = base_max_width;\n                const content_max_width = (base_max_width - (4 * padding));\n                const base_max_height = Math.max(this.parent_svg.layout.height - (10 * padding) - menu_height_padding, menu_height_padding);\n                const height = Math.min(total_content_height + menu_height_padding, base_max_height);\n                this.menu.outer_selector\n                    .style('top', `${top}px`)\n                    .style('left', `${left}px`)\n                    .style('max-width', `${container_max_width}px`)\n                    .style('max-height', `${base_max_height}px`)\n                    .style('height', `${height}px`);\n                this.menu.inner_selector\n                    .style('max-width', `${content_max_width}px`);\n                this.menu.inner_selector.node().scrollTop = this.menu.scroll_position;\n                return this.menu;\n            },\n            hide: () => {\n                if (!this.menu.outer_selector) {\n                    return this.menu;\n                }\n                this.menu.outer_selector.style('visibility', 'hidden');\n                this.menu.hidden = true;\n                return this.menu;\n            },\n            destroy: () => {\n                if (!this.menu.outer_selector) {\n                    return this.menu;\n                }\n                this.menu.inner_selector.remove();\n                this.menu.outer_selector.remove();\n                this.menu.inner_selector = null;\n                this.menu.outer_selector = null;\n                return this.menu;\n            },\n            /**\n             * Internal method definition\n             * By convention populate() does nothing and should be reimplemented with each toolbar button definition\n             *   Reimplement by way of Toolbar.BaseWidget.Button.menu.setPopulate to define the populate method and hook\n             *   up standard menu click-toggle behavior prototype.\n             * @protected\n             */\n            populate: () => {\n                throw new Error('Method must be implemented');\n            },\n            /**\n             * Define how the menu is populated with items, and set up click and display properties as appropriate\n             * @public\n             */\n            setPopulate: (menu_populate_function) => {\n                if (typeof menu_populate_function == 'function') {\n                    this.menu.populate = menu_populate_function;\n                    this.setOnclick(() => {\n                        if (this.menu.hidden) {\n                            this.menu.show();\n                            this.highlight().update();\n                            this.persist = true;\n                        } else {\n                            this.menu.hide();\n                            this.highlight(false).update();\n                            if (!this.permanent) {\n                                this.persist = false;\n                            }\n                        }\n                    });\n                } else {\n                    this.setOnclick();\n                }\n                return this;\n            },\n        };\n    }\n\n    /**\n     * Set the color associated with this button\n     * @param {('gray'|'red'|'orange'|'yellow'|'green'|'blue'|'purple')} color Any selection not in the preset list\n     *   will be replaced with gray.\n     * @returns {Button}\n     */\n    setColor (color) {\n        if (typeof color != 'undefined') {\n            if (['gray', 'red', 'orange', 'yellow', 'green', 'blue', 'purple'].includes(color)) {\n                this.color = color;\n            } else {\n                this.color = 'gray';\n            }\n        }\n        return this;\n    }\n\n    /**\n     * Allow code to change whether the button is allowed to be `permanent`\n     * @param {boolean} bool\n     * @returns {Button}\n     */\n    setPermanent (bool) {\n        if (typeof bool == 'undefined') {\n            bool = true;\n        } else {\n            bool = Boolean(bool);\n        }\n        this.permanent = bool;\n        if (this.permanent) {\n            this.persist = true;\n        }\n        return this;\n    }\n\n    /**\n     * Determine whether the button/menu contents should persist in response to a specific event\n     * @returns {Boolean}\n     */\n    shouldPersist () {\n        return this.permanent || this.persist;\n    }\n\n    /**\n * Set a collection of custom styles to be used by the button\n * @param {Object} style Hash of {name:value} entries\n * @returns {Button}\n */\n    setStyle (style) {\n        if (typeof style != 'undefined') {\n            this.style = style;\n        }\n        return this;\n    }\n\n    /**\n     * Method to generate a CSS class string\n     * @returns {string}\n     */\n    getClass () {\n        const group_position = (['start', 'middle', 'end'].includes(this.parent.layout.group_position) ? ` lz-toolbar-button-group-${this.parent.layout.group_position}` : '');\n        return `lz-toolbar-button lz-toolbar-button-${this.color}${this.status ? `-${this.status}` : ''}${group_position}`;\n    }\n\n    /**\n     * Change button state\n     * @param {('highlighted'|'disabled'|'')} status\n     */\n    setStatus  (status) {\n        if (typeof status != 'undefined' && ['', 'highlighted', 'disabled'].includes(status)) {\n            this.status = status;\n        }\n        return this.update();\n    }\n\n    /**\n     * Toggle whether the button is highlighted\n     * @param {boolean} bool If provided, explicitly set highlighted state\n     * @returns {Button}\n     */\n    highlight (bool) {\n        if (typeof bool == 'undefined') {\n            bool = true;\n        } else {\n            bool = Boolean(bool);\n        }\n        if (bool) {\n            return this.setStatus('highlighted');\n        } else if (this.status === 'highlighted') {\n            return this.setStatus('');\n        }\n        return this;\n    }\n\n    /**\n     * Toggle whether the button is disabled\n     * @param {boolean} bool If provided, explicitly set disabled state\n     * @returns {Button}\n     */\n    disable (bool) {\n        if (typeof bool == 'undefined') {\n            bool = true;\n        } else {\n            bool = Boolean(bool);\n        }\n        if (bool) {\n            return this.setStatus('disabled');\n        } else if (this.status === 'disabled') {\n            return this.setStatus('');\n        }\n        return this;\n    }\n\n    // Mouse events\n    /** @member {function} */\n    onmouseover () {\n    }\n    setOnMouseover (onmouseover) {\n        if (typeof onmouseover == 'function') {\n            this.onmouseover = onmouseover;\n        } else {\n            this.onmouseover = function () {};\n        }\n        return this;\n    }\n\n    /** @member {function} */\n    onmouseout () {\n    }\n    setOnMouseout (onmouseout) {\n        if (typeof onmouseout == 'function') {\n            this.onmouseout = onmouseout;\n        } else {\n            this.onmouseout = function () {};\n        }\n        return this;\n    }\n\n    /** @member {function} */\n    onclick () {\n    }\n    setOnclick (onclick) {\n        if (typeof onclick == 'function') {\n            this.onclick = onclick;\n        } else {\n            this.onclick = function () {};\n        }\n        return this;\n    }\n\n    /**\n     * Set the mouseover title text for the button (if any)\n     * @param {String} title Simple text to display\n     * @returns {Button}\n     */\n    setTitle(title) {\n        if (typeof title != 'undefined') {\n            this.title = title.toString();\n        }\n        return this;\n    }\n\n    /**\n     * Specify the HTML content of this button.\n     * WARNING: The string provided will be inserted into the document as raw markup; XSS mitigation is the\n     *   responsibility of each button implementation.\n     * @param {String} html\n     * @returns {Button}\n     */\n    setHtml(html) {\n        if (typeof html != 'undefined') {\n            this.html = html.toString();\n        }\n        return this;\n    }\n\n    // Primary behavior functions\n    /**\n     * Show the button, including creating DOM elements if necessary for first render\n     */\n    show () {\n        if (!this.parent) {\n            return;\n        }\n        if (!this.selector) {\n            this.selector = this.parent.selector.append(this.tag)\n                .attr('class', this.getClass());\n        }\n        return this.update();\n    }\n\n    /**\n     * Hook for any actions or state cleanup to be performed before rerendering\n     * @returns {Button}\n     */\n    preUpdate () {\n        return this;\n    }\n\n    /**\n     * Update button state and contents, and fully rerender\n     * @returns {Button}\n     */\n    update () {\n        if (!this.selector) {\n            return this;\n        }\n        this.preUpdate();\n        this.selector\n            .attr('class', this.getClass())\n            .attr('title', this.title)\n            .on('mouseover', (this.status === 'disabled') ? null : this.onmouseover)\n            .on('mouseout', (this.status === 'disabled') ? null : this.onmouseout)\n            .on('click', (this.status === 'disabled') ? null : this.onclick)\n            .html(this.html)\n            .call(applyStyles, this.style);\n\n        this.menu.update();\n        this.postUpdate();\n        return this;\n    }\n\n    /**\n     * Hook for any behavior to be added/changed after the button has been re-rendered\n     * @returns {Button}\n     */\n    postUpdate () {\n        return this;\n    }\n\n    /**\n     * Hide the button by removing it from the DOM (may be overridden by current persistence setting)\n     * @returns {Button}\n     */\n    hide() {\n        if (this.selector && !this.shouldPersist()) {\n            this.selector.remove();\n            this.selector = null;\n        }\n        return this;\n    }\n\n}\n\n/**\n * Renders arbitrary text with large title formatting\n * @alias module:LocusZoom_Widgets~title\n * @param {string} layout.title Text or HTML to render\n * @param {string} [layout.subtitle] Small text to render next to the title\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass Title extends BaseWidget {\n    show() {\n        if (!this.div_selector) {\n            this.div_selector = this.parent.selector.append('div')\n                .attr('class', `lz-toolbar-title lz-toolbar-${this.layout.position}`);\n            this.title_selector = this.div_selector.append('h3');\n        }\n        return this.update();\n    }\n\n    update() {\n        let title = this.layout.title.toString();\n        if (this.layout.subtitle) {\n            title += ` <small>${this.layout.subtitle}</small>`;\n        }\n        this.title_selector.html(title);\n        return this;\n    }\n}\n\n/**\n * Display the current scale of the genome region displayed in the plot, as defined by the difference between\n *  `state.end` and `state.start`. Few users are interested in seeing coordinates with this level of precision, but\n *  it can be useful for debugging.\n *  TODO: It would be nice to move this to an extension, but helper functions drag in large dependencies as a side effect.\n *    (we'd need to reorganize internals a bit before moving this widget)\n * @alias module:LocusZoom_Widgets~region_scale\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass RegionScale extends BaseWidget {\n    update() {\n        if (!isNaN(this.parent_plot.state.start) && !isNaN(this.parent_plot.state.end)\n            && this.parent_plot.state.start !== null && this.parent_plot.state.end !== null) {\n            this.selector.style('display', null);\n            this.selector.html(positionIntToString(this.parent_plot.state.end - this.parent_plot.state.start, null, true));\n        } else {\n            this.selector.style('display', 'none');\n        }\n        if (this.layout.class) {\n            this.selector.attr('class', this.layout.class);\n        }\n        if (this.layout.style) {\n            applyStyles(this.selector, this.layout.style);\n        }\n        return this;\n    }\n}\n\n/**\n * The filter field widget has triggered an update to the plot filtering rules\n *   Note: The widget can optionally be configured to broadcast this event under an alias (layout.custom_event_name)\n *\n * @event widget_filter_field_action\n * @property {Object} data { field, operator, value, filter_id }\n * @see event:any_lz_event\n */\n\n/**\n * @alias module:LocusZoom_Widgets~filter_field\n */\nclass FilterField extends BaseWidget {\n    /**\n     * @param {string} layout.layer_name The data layer to control with filtering\n     * @param {string} [layout.filter_id = null] Sometimes we want to define more than one filter with the same operator\n     *  (eg != null, != bacon). The `filter_id` option allows us to identify which filter is controlled by this widget.\n     * @param {string} layout.field The field to be filtered (eg `assoc:log_pvalue`)\n     * @param {string} layout.field_display_html Human-readable label for the field to be filtered (`-log<sub>10</sub>p`)\n     * @param {string} layout.operator The operator to use when filtering. This must be one of the options allowed by data_layer.filter.\n     * @param {number} [layout.input_size=4] How wide to make the input textbox (number characters shown at a time)\n     * @param {('number'|'string')} [layout.data_type='number'] Convert the text box input to the specified type, and warn the\n     *  user if the value would be invalid (eg, not numeric)\n     * @param {string} [layout.custom_event_name='widget_filter_field_action'] The name of the event that will be emitted when this filter is updated\n     */\n    constructor(layout, parent) {\n        super(layout, parent);\n\n        if (!this.parent_panel) {\n            throw new Error('Filter widget can only be used in panel toolbars');\n        }\n\n        this._data_layer = this.parent_panel.data_layers[layout.layer_name];\n        if (!this._data_layer) {\n            throw new Error(`Filter widget could not locate the specified layer_name: '${layout.layer_name}'`);\n        }\n\n        this._event_name = layout.custom_event_name || 'widget_filter_field_action';\n        this._field = layout.field;\n        this._field_display_html = layout.field_display_html;\n        this._operator = layout.operator;\n        this._filter_id = null;\n        this._data_type = layout.data_type || 'number';\n        if (!['number', 'string'].includes(this._data_type)) {\n            throw new Error('Filter must be either string or number');\n        }\n\n        this._value_selector = null;\n    }\n\n    _getTarget() {\n        // Find the specific filter in layer.layout.filters, and if not present, add one\n        if (!this._data_layer.layout.filters) {\n            this._data_layer.layout.filters = [];\n        }\n        let result = this._data_layer.layout.filters\n            .find((item) => item.field === this._field && item.operator === this._operator && (!this._filter_id || item.id === this._filter_id));\n\n        if (!result) {\n            result = { field: this._field, operator: this._operator, value: null };\n            if (this._filter_id) {\n                result['id'] = this._filter_id;\n            }\n            this._data_layer.layout.filters.push(result);\n        }\n        return result;\n    }\n\n    /** Clear the filter by removing it from the list */\n    _clearFilter() {\n        if (this._data_layer.layout.filters) {\n            const index = this._data_layer.layout.filters.indexOf(this._getTarget());\n            this._data_layer.layout.filters.splice(index, 1);\n        }\n    }\n\n    /**\n     * Set the filter based on a provided value\n     * @fires event:widget_filter_field_action\n     */\n    _setFilter(value) {\n        if (value === null) {\n            // On blank or invalid value, remove the filter & warn\n            this._value_selector\n                .style('border', '1px solid red')\n                .style('color', 'red');\n            this._clearFilter();\n        } else {\n            const filter = this._getTarget();\n            filter.value = value;\n        }\n        this.parent_svg.emit(this._event_name, { field: this._field, operator: this._operator, value, filter_id: this._filter_id }, true);\n    }\n\n    /** Get the user-entered value, coercing type if necessary. Returns null for invalid or missing values.\n     * @return {null|number|string}\n     * @private\n     */\n    _getValue() {\n        let value = this._value_selector.property('value');\n        if (value === null || value === '') {\n            return null;\n        }\n        if (this._data_type === 'number') {\n            value = +value;\n            if (Number.isNaN(value)) {\n                return null;\n            }\n        }\n        return value;\n    }\n\n    update() {\n        if (this._value_selector) {\n            return;\n        }\n        this.selector.style('padding', '0 6px');\n\n        // Label\n        this.selector\n            .append('span')\n            .html(this._field_display_html)\n            .style('background', '#fff')\n            .style('padding-left', '3px');\n        // Operator label\n        this.selector.append('span')\n            .text(this._operator)\n            .style('padding', '0 3px')\n            .style('background', '#fff');\n\n        this._value_selector = this.selector\n            .append('input')\n            .attr('size', this.layout.input_size || 4)\n            .on('input', debounce(() => {\n                // Clear validation state\n                this._value_selector\n                    .style('border', null)\n                    .style('color', null);\n                const value = this._getValue();\n                this._setFilter(value);\n                this.parent_panel.render();\n            }, 750));\n    }\n}\n\n/**\n * The user has asked to download the plot as an SVG image\n *   Note: The widget can optionally be configured to broadcast this event under an alias (layout.custom_event_name)\n *\n * @event widget_save_svg\n * @property {Object} data { filename }\n * @see event:any_lz_event\n */\n\n/**\n * The user has asked to download the plot as a PNG image\n *   Note: The widget can optionally be configured to broadcast this event under an alias (layout.custom_event_name)\n *\n * @event widget_save_png\n * @property {Object} data { filename }\n * @see event:any_lz_event\n */\n\n/**\n * Button to export current plot to an SVG image\n * @alias module:LocusZoom_Widgets~download_svg\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass DownloadSVG extends BaseWidget {\n    /**\n     * @param {string} [layout.button_html=\"Download SVG\"]\n     * @param {string} [layout.button_title=\"Download hi-res image\"]\n     * @param {string} [layout.filename=\"locuszoom.svg\"] The default filename to use when saving the image\n     * @param {string} [layout.custom_event_name='widget_save_svg'] The name of the event that will be emitted when the button is clicked\n     */\n    constructor(layout, parent) {\n        super(layout, parent);\n        this._filename = this.layout.filename || 'locuszoom.svg';\n        this._button_html = this.layout.button_html || 'Save SVG';\n        this._button_title = this.layout.button_title || 'Download hi-res image';\n        this._event_name = layout.custom_event_name || 'widget_save_svg';\n    }\n\n    update() {\n        if (this.button) {\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml(this._button_html)\n            .setTitle(this._button_title)\n            .setOnMouseover(() => {\n                this.button.selector\n                    .classed('lz-toolbar-button-gray-disabled', true)\n                    .html('Preparing Image');\n                this._getBlobUrl().then((url) => {\n                    const old = this.button.selector.attr('href');\n                    if (old) {\n                        // Clean up old url instance to prevent memory leaks\n                        URL.revokeObjectURL(old);\n                    }\n                    this.button.selector\n                        .attr('href', url)\n                        .classed('lz-toolbar-button-gray-disabled', false)\n                        .classed('lz-toolbar-button-gray-highlighted', true)\n                        .html(this._button_html);\n                });\n            })\n            .setOnMouseout(() => {\n                this.button.selector.classed('lz-toolbar-button-gray-highlighted', false);\n            });\n        this.button.show();\n        this.button.selector\n            .attr('href-lang', 'image/svg+xml')\n            .attr('download', this._filename)\n            .on('click', () => this.parent_svg.emit(this._event_name, { filename: this._filename }, true));\n        return this;\n    }\n\n    /**\n     * Extract all CSS rules whose selectors directly reference elements under the root node\n     * @param {Element} root\n     * @return {string}\n     * @private\n     */\n    _getCSS(root) {\n        // Hack: this method is based on text matching the rules on a given node; it doesn't handle, eg ancestors.\n        // Since all LZ cssRules are written as \"svg .classname\", we need to strip the parent selector prefix in order\n        // to extract CSS.\n        const ancestor_pattern = /^svg\\.lz-locuszoom\\s*/;\n\n        // Extract all relevant CSS Rules by iterating through all available stylesheets\n        let extractedCSSText = '';\n        for (let i = 0; i < document.styleSheets.length; i++) {\n            const s = document.styleSheets[i];\n            try {\n                if (!s.cssRules) {\n                    continue;\n                }\n            } catch ( e ) {\n                if (e.name !== 'SecurityError') {\n                    throw e;\n                } // for Firefox\n                continue;\n            }\n            let cssRules = s.cssRules;\n            for (let i = 0; i < cssRules.length; i++) {\n                // FIXME: We could write smaller SVGs by extracting only the exact CSS rules for this plot. However,\n                //   extracting rules (including parent selectors) is a finicky process\n                // Instead just fetch all LZ plot rules, under a known hardcoded parent selector.\n                const rule = cssRules[i];\n                const is_match = (rule.selectorText && rule.selectorText.match(ancestor_pattern));\n                if (is_match) {\n                    extractedCSSText += rule.cssText;\n                }\n            }\n        }\n        return extractedCSSText;\n    }\n\n    _appendCSS( cssText, element ) {\n        // Append styles to the constructed SVG DOM node\n        var styleElement = document.createElement('style');\n        styleElement.setAttribute('type', 'text/css');\n        styleElement.innerHTML = cssText;\n        var refNode = element.hasChildNodes() ? element.children[0] : null;\n        element.insertBefore( styleElement, refNode );\n    }\n\n    /**\n     * Get the target dimensions for the rendered image.\n     *\n     * For non-vector displays, these dimensions will yield ~300 DPI image for an 8\" wide print figure.\n     * @return {number[]}\n     * @private\n     */\n    _getDimensions() {\n        let { width, height } = this.parent_plot.svg.node().getBoundingClientRect();\n        const target_width = 2400;\n        const rescale = target_width / width;\n        return [rescale * width, rescale * height];\n    }\n\n    _generateSVG () {\n        return new Promise((resolve) => {\n            // Copy the DOM node so that we can modify the image for publication\n            let copy = this.parent_plot.svg.node().cloneNode(true);\n            copy.setAttribute('xlink', 'http://www.w3.org/1999/xlink');\n            copy = d3.select(copy);\n\n            // Remove unnecessary elements\n            copy.selectAll('g.lz-curtain').remove();\n            copy.selectAll('g.lz-mouse_guide').remove();\n            // Convert units on axis tick dy attributes from ems to pixels\n            copy.selectAll('g.tick text').each(function() {\n                const dy = +(d3.select(this).attr('dy').substring(-2).slice(0, -2)) * 10;\n                d3.select(this).attr('dy', dy);\n            });\n            // Pull the svg into a string and add the contents of the locuszoom stylesheet\n            // Don't add this with d3 because it will escape the CDATA declaration incorrectly\n            const serializer = new XMLSerializer();\n\n            copy = copy.node();\n\n            // Firefox has issues saving the SVG in certain contexts (esp rendering to canvas) unless a width is given.\n            //  See: https://bugzilla.mozilla.org/show_bug.cgi?id=700533\n            const [width, height] = this._getDimensions();\n            copy.setAttribute('width', width);\n            copy.setAttribute('height', height);\n\n            // Add CSS to the node\n            this._appendCSS(this._getCSS(copy), copy);\n            let svg_markup = serializer.serializeToString(copy);\n            resolve(svg_markup);\n        });\n    }\n\n    /**\n     * Converts the SVG string into a downloadable binary object\n     * @return {Promise}\n     */\n    _getBlobUrl() {\n        return this._generateSVG().then((markup) => {\n            const blob = new Blob([markup], { type: 'image/svg+xml' });\n            return URL.createObjectURL(blob);\n        });\n    }\n}\n\n/**\n * Button to export current plot to a PNG image\n * @alias module:LocusZoom_Widgets~download_png\n * @extends module:LocusZoom_Widgets~download_svg\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass DownloadPNG extends DownloadSVG {\n    /**\n     * @param {string} [layout.button_html=\"Download PNG\"]\n     * @param {string} [layout.button_title=\"Download image\"]\n     * @param {string} [layout.filename=\"locuszoom.svg\"] The default filename to use when saving the image\n     * @param {string} [layout.custom_event_name='widget_save_png'] The name of the event that will be emitted when the button is clicked\n     * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n     */\n    constructor(layout, parent) {\n        super(...arguments);\n        this._filename = this.layout.filename || 'locuszoom.png';\n        this._button_html = this.layout.button_html || 'Save PNG';\n        this._button_title = this.layout.button_title || 'Download image';\n        this._event_name = layout.custom_event_name || 'widget_save_png';\n    }\n\n    /**\n     * @private\n     */\n    _getBlobUrl() {\n        return super._getBlobUrl().then((svg_url) => {\n            const canvas = document.createElement('canvas');\n            const context = canvas.getContext('2d');\n\n            const [width, height] = this._getDimensions();\n\n            canvas.width = width;\n            canvas.height = height;\n\n            return new Promise((resolve, reject) => {\n                const image = new Image();\n                image.onload = () => {\n                    context.drawImage(image, 0, 0, width, height);\n                    // Once canvas rendered, revoke svg blob to avoid memory leaks, and create new url for the canvas\n                    URL.revokeObjectURL(svg_url);\n                    canvas.toBlob((png) => {\n                        resolve(URL.createObjectURL(png));\n                    });\n                };\n                image.src = svg_url;\n            });\n        });\n    }\n}\n\n/**\n * Button to remove panel from plot.\n *   NOTE: Will only work on panel widgets.\n * @alias module:LocusZoom_Widgets~remove_panel\n * @param {Boolean} [layout.suppress_confirm=false] If true, removes the panel without prompting user for confirmation\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass RemovePanel extends BaseWidget {\n    update() {\n        if (this.button) {\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml('')\n            .setTitle('Remove panel')\n            .setOnclick(() => {\n                if (!this.layout.suppress_confirm && !confirm('Are you sure you want to remove this panel? This cannot be undone.')) {\n                    return false;\n                }\n                const panel = this.parent_panel;\n                panel.toolbar.hide(true);\n                d3.select(panel.parent.svg.node().parentNode).on(`mouseover.${panel.getBaseId()}.toolbar`, null);\n                d3.select(panel.parent.svg.node().parentNode).on(`mouseout.${panel.getBaseId()}.toolbar`, null);\n                return panel.parent.removePanel(panel.id);\n            });\n        this.button.show();\n        return this;\n    }\n}\n\n/**\n * Button to move panel up relative to other panels (in terms of y-index on the page)\n *   NOTE: Will only work on panel widgets.\n * @alias module:LocusZoom_Widgets~move_panel_up\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass MovePanelUp extends BaseWidget {\n    update () {\n        if (this.button) {\n            const is_at_top = (this.parent_panel.layout.y_index === 0);\n            this.button.disable(is_at_top);\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml('')\n            .setTitle('Move panel up')\n            .setOnclick(() => {\n                this.parent_panel.moveUp();\n                this.update();\n            });\n        this.button.show();\n        return this.update();\n    }\n}\n\n/**\n * Button to move panel down relative to other panels (in terms of y-index on the page)\n *   NOTE: Will only work on panel widgets.\n * @alias module:LocusZoom_Widgets~move_panel_down\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass MovePanelDown extends BaseWidget {\n    update () {\n        if (this.button) {\n            const is_at_bottom = (this.parent_panel.layout.y_index === this.parent_plot._panel_ids_by_y_index.length - 1);\n            this.button.disable(is_at_bottom);\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml('')\n            .setTitle('Move panel down')\n            .setOnclick(() => {\n                this.parent_panel.moveDown();\n                this.update();\n            });\n        this.button.show();\n        return this.update();\n    }\n}\n\n/**\n * Button to shift plot region forwards or back by a `step` increment provided in the layout\n * @alias module:LocusZoom_Widgets~shift_region\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass ShiftRegion extends BaseWidget {\n    /**\n     * @param {number} [layout.step=50000] The stepsize to change the region by\n     * @param {string} [layout.button_html] Label\n     * @param {string} [layout.button_title] Mouseover text\n     */\n    constructor(layout, parent) {\n        if (isNaN(layout.step) || layout.step === 0) {\n            layout.step = 50000;\n        }\n        if (typeof layout.button_html !== 'string') {\n            layout.button_html = layout.step > 0 ? '>' : '<';\n        }\n\n        if (typeof layout.button_title !== 'string') {\n            layout.button_title = `Shift region by ${layout.step > 0 ? '+' : '-'}${positionIntToString(Math.abs(layout.step), null, true)}`;\n        }\n        super(layout, parent);\n        if (isNaN(this.parent_plot.state.start) || isNaN(this.parent_plot.state.end)) {\n            throw new Error('Unable to add shift_region toolbar widget: plot state does not have region bounds');\n        }\n\n\n    }\n\n    update () {\n        if (this.button) {\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml(this.layout.button_html)\n            .setTitle(this.layout.button_title)\n            .setOnclick(() => {\n                this.parent_plot.applyState({\n                    start: Math.max(this.parent_plot.state.start + this.layout.step, 1),\n                    end: this.parent_plot.state.end + this.layout.step,\n                });\n            });\n        this.button.show();\n        return this;\n    }\n}\n\n/**\n * Zoom in or out on the plot, centered on the middle of the plot region, by the specified amount\n * @alias module:LocusZoom_Widgets~zoom_region\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass ZoomRegion extends BaseWidget {\n    /**\n     * @param {number} [layout.step=0.2] The fraction to zoom in by (where 1 indicates 100%)\n     * @param {string} [layout.button_html] Label\n     * @param {string} [layout.button_title] Mouseover text\n     */\n    constructor(layout, parent) {\n        if (isNaN(layout.step) || layout.step === 0) {\n            layout.step = 0.2;\n        }\n        if (typeof layout.button_html != 'string') {\n            layout.button_html = layout.step > 0 ? 'z' : 'z+';\n        }\n        if (typeof layout.button_title != 'string') {\n            layout.button_title = `Zoom region ${layout.step > 0 ? 'out' : 'in'} by ${(Math.abs(layout.step) * 100).toFixed(1)}%`;\n        }\n\n        super(layout, parent);\n        if (isNaN(this.parent_plot.state.start) || isNaN(this.parent_plot.state.end)) {\n            throw new Error('Unable to add zoom_region toolbar widget: plot state does not have region bounds');\n        }\n    }\n\n    update () {\n        if (this.button) {\n            let can_zoom = true;\n            const current_region_scale = this.parent_plot.state.end - this.parent_plot.state.start;\n            if (this.layout.step > 0 && !isNaN(this.parent_plot.layout.max_region_scale) && current_region_scale >= this.parent_plot.layout.max_region_scale) {\n                can_zoom = false;\n            }\n            if (this.layout.step < 0 && !isNaN(this.parent_plot.layout.min_region_scale) && current_region_scale <= this.parent_plot.layout.min_region_scale) {\n                can_zoom = false;\n            }\n            this.button.disable(!can_zoom);\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml(this.layout.button_html)\n            .setTitle(this.layout.button_title)\n            .setOnclick(() => {\n                const current_region_scale = this.parent_plot.state.end - this.parent_plot.state.start;\n                const zoom_factor = 1 + this.layout.step;\n                let new_region_scale = current_region_scale * zoom_factor;\n                if (!isNaN(this.parent_plot.layout.max_region_scale)) {\n                    new_region_scale = Math.min(new_region_scale, this.parent_plot.layout.max_region_scale);\n                }\n                if (!isNaN(this.parent_plot.layout.min_region_scale)) {\n                    new_region_scale = Math.max(new_region_scale, this.parent_plot.layout.min_region_scale);\n                }\n                const delta = Math.floor((new_region_scale - current_region_scale) / 2);\n                this.parent_plot.applyState({\n                    start: Math.max(this.parent_plot.state.start - delta, 1),\n                    end: this.parent_plot.state.end + delta,\n                });\n            });\n        this.button.show();\n        return this;\n    }\n}\n\n/**\n * Renders button with arbitrary text that, when clicked, shows a dropdown containing arbitrary HTML. This is usually\n *   used as part of coding a custom button, rather than as a standalone widget.\n * NOTE: Trusts content exactly as given. XSS prevention is the responsibility of the implementer.\n * @alias module:LocusZoom_Widgets~menu\n * @param {string} layout.button_html The HTML to render inside the button\n * @param {string} layout.button_title Text to display as a tooltip when hovering over the button\n * @param {string} layout.menu_html The HTML content of the dropdown menu\n */\nclass Menu extends BaseWidget {\n    update() {\n        if (this.button) {\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml(this.layout.button_html)\n            .setTitle(this.layout.button_title);\n        this.button.menu.setPopulate(() => {\n            this.button.menu.inner_selector.html(this.layout.menu_html);\n        });\n        this.button.show();\n        return this;\n    }\n}\n\n/**\n * Button to resize panel height to fit available data (eg when showing a list of tracks)\n * @alias module:LocusZoom_Widgets~resize_to_data\n */\nclass ResizeToData extends BaseWidget {\n    /**\n     * @param {string} [layout.button_html=\"Resize to Data\"]\n     * @param {string} [layout.button_title]\n     */\n    constructor(layout) {\n        super(...arguments);\n    }\n    update() {\n        if (this.button) {\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setHtml(this.layout.button_html || 'Resize to Data')\n            .setTitle(this.layout.button_title || 'Automatically resize this panel to show all data available')\n            .setOnclick(() => {\n                this.parent_panel.scaleHeightToData();\n                this.update();\n            });\n        this.button.show();\n        return this;\n    }\n}\n\n/**\n * Button to toggle legend\n * @alias module:LocusZoom_Widgets~toggle_legend\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass ToggleLegend extends BaseWidget {\n    update() {\n        const html = this.parent_panel.legend.layout.hidden ? 'Show Legend' : 'Hide Legend';\n        if (this.button) {\n            this.button.setHtml(html).show();\n            this.parent.position();\n            return this;\n        }\n        this.button = new Button(this)\n            .setColor(this.layout.color)\n            .setTitle('Show or hide the legend for this panel')\n            .setOnclick(() => {\n                this.parent_panel.legend.layout.hidden = !this.parent_panel.legend.layout.hidden;\n                this.parent_panel.legend.render();\n                this.update();\n            });\n        return this.update();\n    }\n}\n\n\n/**\n * @typedef {object} DisplayOptionsButtonConfigField\n * @property {string} display_name The human-readable label for this set of options\n * @property {object} display An object with layout directives that will be merged into the target layer.\n *   The directives should be among those listed in `fields_whitelist` for this widget.\n */\n\n/**\n * The user has chosen a specific display option to show information on the plot\n *   Note: The widget can optionally be configured to broadcast this event under an alias (layout.custom_event_name)\n *\n * @event widget_display_options_choice\n * @property {Object} data {choice} The display_name of the item chosen from the list\n * @see event:any_lz_event\n */\n\n/**\n * Dropdown menu allowing the user to choose between different display options for a single specific data layer\n *  within a panel.\n *\n * This allows controlling how points on a datalayer can be displayed- any display options supported via the layout for the target datalayer. This includes point\n *  size/shape, coloring, etc.\n *\n * This button intentionally limits display options it can control to those available on common plot types.\n *   Although the list of options it sets can be overridden (to control very special custom plot types), this\n *   capability should be used sparingly if at all.\n * @alias module:LocusZoom_Widgets~display_options\n * @see {@link module:LocusZoom_Widgets~BaseWidget} for additional options\n */\nclass DisplayOptions extends BaseWidget {\n    /**\n     * @param {string} layout.layer_name Specify the datalayer that this button should affect\n     * @param {String} [layout.button_html=\"Display options...\"] Text to display on the toolbar button\n     * @param {String} [layout.button_title=\"Control how plot items are displayed\"] Hover text for the toolbar button\n     * @param {string} [layout.default_config_display_name] Store the default configuration for this datalayer\n     *  configuration, and show a button to revert to the \"default\" (listing the human-readable display name provided)\n     * @param {Array} [layout.fields_whitelist='see code'] The list of presentation fields that this button can control.\n     *   This can be overridden if this button needs to be used on a custom layer type with special options.\n     *   The whitelist is chosen to be things that are known to be easily modified with few side effects.\n     *   When the button is first created, all fields in the whitelist will have their default values saved, so the user can revert to the default view easily.\n     * @param {module:LocusZoom_Widgets~DisplayOptionsButtonConfigField[]} layout.options Specify a label and set of layout directives associated\n     *  with this `display` option. Display field should include all changes that will be merged to datalayer layout options.\n     * @param {string} [layout.custom_event_name='widget_display_options_choice'] The name of the event that will be emitted when an option is selected\n     */\n    constructor(layout, parent) {\n        if (typeof layout.button_html != 'string') {\n            layout.button_html = 'Display options...';\n        }\n        if (typeof layout.button_title != 'string') {\n            layout.button_title = 'Control how plot items are displayed';\n        }\n        super(...arguments);\n        this._event_name = layout.custom_event_name || 'widget_display_options_choice';\n\n        // List of layout fields that this button is allowed to control. This ensures that we don't override any other\n        //  information (like plot height etc) while changing point rendering\n        const allowed_fields = layout.fields_whitelist || ['color', 'fill_opacity', 'filters', 'label', 'legend',\n            'point_shape', 'point_size', 'tooltip', 'tooltip_positioning'];\n\n        const dataLayer = this.parent_panel.data_layers[layout.layer_name];\n        if (!dataLayer) {\n            throw new Error(`Display options could not locate the specified layer_name: '${layout.layer_name}'`);\n        }\n        const dataLayerLayout = dataLayer.layout;\n\n        // Store default configuration for the layer as a clean deep copy, so we may revert later\n        const defaultConfig = {};\n        allowed_fields.forEach((name) => {\n            const configSlot = dataLayerLayout[name];\n            if (configSlot !== undefined) {\n                defaultConfig[name] =  deepCopy(configSlot);\n            }\n        });\n\n        /**\n         * Which item in the menu is currently selected. (track for rerendering menu)\n         * @member {String}\n         * @private\n         */\n        this._selected_item = 'default';\n\n        // Define the button + menu that provides the real functionality for this toolbar widget\n\n        this.button = new Button(this)\n            .setColor(layout.color)\n            .setHtml(layout.button_html)\n            .setTitle(layout.button_title)\n            .setOnclick(() => {\n                this.button.menu.populate();\n            });\n        this.button.menu.setPopulate(() => {\n            // Multiple copies of this button might be used on a single LZ page; append unique IDs where needed\n            const uniqueID = Math.floor(Math.random() * 1e4).toString();\n\n            this.button.menu.inner_selector.html('');\n            const table = this.button.menu.inner_selector.append('table');\n\n            const menuLayout = this.layout;\n\n            const renderRow = (display_name, display_options, row_id) => { // Helper method\n                const row = table.append('tr');\n                const radioId = `${uniqueID}${row_id}`;\n                row.append('td')\n                    .append('input')\n                    .attr('id', radioId)\n                    .attr('type', 'radio')\n                    .attr('name', `display-option-${uniqueID}`)\n                    .attr('value', row_id)\n                    .style('margin', 0) // Override css libraries (eg skeleton) that style form inputs\n                    .property('checked', (row_id === this._selected_item))\n                    .on('click', () => {\n                        // If an option is not specified in these display options, use the original defaults\n                        allowed_fields.forEach((field_name) => {\n                            const has_option = typeof display_options[field_name] !== 'undefined';\n                            dataLayer.layout[field_name] = has_option ? display_options[field_name] : defaultConfig[field_name];\n                        });\n\n                        this.parent_svg.emit(this._event_name, { choice: display_name }, true);\n                        this._selected_item = row_id;\n                        this.parent_panel.render();\n                        const legend = this.parent_panel.legend;\n                        if (legend) {\n                            legend.render();\n                        }\n                    });\n                row.append('td').append('label')\n                    .style('font-weight', 'normal')\n                    .attr('for', radioId)\n                    .text(display_name);\n            };\n            // Render the \"display options\" menu: default and special custom options\n            const defaultName = menuLayout.default_config_display_name || 'Default style';\n            renderRow(defaultName, defaultConfig, 'default');\n            menuLayout.options.forEach((item, index) => renderRow(item.display_name, item.display, index));\n            return this;\n        });\n    }\n\n    update() {\n        this.button.show();\n        return this;\n    }\n}\n\n/**\n * @typedef {object} SetStateOptionsConfigField\n * @property {string} display_name Human readable name for option label (eg \"European\")\n * @property value Value to set in plot.state (eg \"EUR\")\n */\n\n/**\n * An option has been chosen from the set_state dropdown menu\n *   Note: The widget can optionally be configured to broadcast this event under an alias (layout.custom_event_name)\n *\n * @event widget_set_state_choice\n * @property {Object} data { choice_name, choice_value, state_field }\n * @see event:any_lz_event\n */\n\n/**\n * Dropdown menu allowing the user to set the value of a specific `state_field` in plot.state\n * This is useful for things (like datasources) that allow dynamic configuration based on global information in state\n *\n * For example, the LDServer data adapter can use it to change LD reference population (for all panels) after render\n *\n * @alias module:LocusZoom_Widgets~set_state\n * @param {String} [layout.button_html=\"Set option...\"] Text to display on the toolbar button\n * @param {String} [layout.button_title=\"Choose an option to customize the plot\"] Hover text for the toolbar button\n * @param {bool} [layout.show_selected=false] Whether to append the selected value to the button label (\"LD Population: ALL\")\n * @param {string} [layout.state_field] The name of the field in plot.state that will be set by this button\n * @param {module:LocusZoom_Widgets~SetStateOptionsConfigField[]} layout.options Specify human labels and associated values for the dropdown menu\n * @param {string} [layout.custom_event_name='widget_set_state_choice'] The name of the event that will be emitted when an option is selected\n */\nclass SetState extends BaseWidget {\n    constructor(layout, parent) {\n        if (typeof layout.button_html != 'string') {\n            layout.button_html = 'Set option...';\n        }\n        if (typeof layout.button_title != 'string') {\n            layout.button_title = 'Choose an option to customize the plot';\n        }\n\n        super(layout, parent);\n\n        if (this.parent_panel) {\n            throw new Error('This widget is designed to set global options, so it can only be used at the top (plot) level');\n        }\n        if (!layout.state_field) {\n            throw new Error('Must specify the `state_field` that this widget controls');\n        }\n\n        this._event_name = layout.custom_event_name || 'widget_set_state_choice';\n\n        /**\n         * Which item in the menu is currently selected. (track for rerendering menu)\n         * @member {String}\n         * @private\n         */\n        // The first option listed is automatically assumed to be the default, unless a value exists in plot.state\n        this._selected_item = this.parent_plot.state[layout.state_field] || layout.options[0].value;\n        if (!layout.options.find((item) => {\n            return item.value === this._selected_item;\n        })) {\n            // Check only gets run at widget creation, but generally this widget is assumed to be an exclusive list of options\n            throw new Error('There is an existing state value that does not match the known values in this widget');\n        }\n\n        // Define the button + menu that provides the real functionality for this toolbar widget\n        this.button = new Button(this)\n            .setColor(layout.color)\n            .setHtml(layout.button_html + (layout.show_selected ? this._selected_item : ''))\n            .setTitle(layout.button_title)\n            .setOnclick(() => {\n                this.button.menu.populate();\n            });\n        this.button.menu.setPopulate(() => {\n            // Multiple copies of this button might be used on a single LZ page; append unique IDs where needed\n            const uniqueID = Math.floor(Math.random() * 1e4).toString();\n\n            this.button.menu.inner_selector.html('');\n            const table = this.button.menu.inner_selector.append('table');\n\n            const renderRow = (display_name, value, row_id) => { // Helper method\n                const row = table.append('tr');\n                const radioId = `${uniqueID}${row_id}`;\n                row.append('td')\n                    .append('input')\n                    .attr('id', radioId)\n                    .attr('type', 'radio')\n                    .attr('name', `set-state-${uniqueID}`)\n                    .attr('value', row_id)\n                    .style('margin', 0) // Override css libraries (eg skeleton) that style form inputs\n                    .property('checked', (value === this._selected_item))\n                    .on('click', () => {\n                        const new_state = {};\n                        new_state[layout.state_field] = value;\n                        this._selected_item = value;\n                        this.parent_plot.applyState(new_state);\n                        this.button.setHtml(layout.button_html + (layout.show_selected ? this._selected_item : ''));\n\n                        this.parent_svg.emit(this._event_name, { choice_name: display_name, choice_value: value, state_field: layout.state_field }, true);\n                    });\n                row.append('td').append('label')\n                    .style('font-weight', 'normal')\n                    .attr('for', radioId)\n                    .text(display_name);\n            };\n            layout.options.forEach((item, index) => renderRow(item.display_name, item.value, index));\n            return this;\n        });\n    }\n\n    update() {\n        this.button.show();\n        return this;\n    }\n}\n\n\nexport {\n    BaseWidget,  // This is used to create subclasses\n    Button as _Button, // This is used to create Widgets that contain a button. It actually shouldn't be in the registry because it's not usable directly..\n    DisplayOptions as display_options,\n    DownloadSVG as download,\n    DownloadPNG as download_png,\n    FilterField as filter_field,\n    Menu as menu,\n    MovePanelDown as move_panel_down,\n    MovePanelUp as move_panel_up,\n    RegionScale as region_scale,\n    ResizeToData as resize_to_data,\n    SetState as set_state,\n    ShiftRegion as shift_region,\n    RemovePanel as remove_panel,\n    Title as title,\n    ToggleLegend as toggle_legend,\n    ZoomRegion as zoom_region,\n};\n","import {ClassRegistry} from './base';\nimport * as widgets from '../components/toolbar/widgets';\n\n/**\n * A plugin registry that allows plots to use both pre-defined and user-provided toolbar widgets: interactive buttons\n *  and menus that control plot display, modify data, or show additional information as context.\n * @alias module:LocusZoom~Widgets\n * @type {module:registry/base~ClassRegistry}\n */\nconst registry = new ClassRegistry();\n\nfor (let [name, type] of Object.entries(widgets)) {\n    registry.add(name, type);\n}\n\n\nexport default registry;\n","import WIDGETS from '../../registry/widgets';\nimport * as d3 from 'd3';\n\n/**\n * A Toolbar is an HTML element used for presenting arbitrary user interface widgets. Toolbars are anchored\n *   to either the entire Plot or to individual Panels.\n *\n * Each toolbar is an HTML-based (read: not SVG) collection of widgets used to display information or provide\n *   user interface. Toolbars can exist on entire plots, where their visibility is permanent and vertically adjacent\n *   to the plot, or on individual panels, where their visibility is tied to a behavior (e.g. a mouseover) and is as\n *   an overlay.\n *\n * This class is used internally for rendering, and is not part of the public interface\n * @private\n */\nclass Toolbar {\n    constructor(parent) {\n        // parent must be a locuszoom plot or panel\n        // if (!(parent instanceof LocusZoom.Plot) && !(parent instanceof LocusZoom.Panel)) {\n        //     throw new Error('Unable to create toolbar, parent must be a locuszoom plot or panel');\n        // }\n        /** @member {Plot|Panel} */\n        this.parent = parent;\n\n        /** @member {String} */\n        this.id = `${this.parent.getBaseId()}.toolbar`;\n\n        /** @member {('plot'|'panel')} */\n        this.type = (this.parent.parent) ? 'panel' : 'plot';\n\n        /** @member {Plot} */\n        this.parent_plot = this.parent.parent_plot;\n\n        /** @member {d3.selection} */\n        this.selector = null;\n\n        /** @member {BaseWidget[]} */\n        this.widgets = [];\n\n        /**\n         * The timer identifier as returned by setTimeout\n         * @member {Number}\n         */\n        this.hide_timeout = null;\n\n        /**\n         * Whether to hide the toolbar. Can be overridden by a child widget. Check via `shouldPersist`\n         * @protected\n         * @member {Boolean}\n         */\n        this.persist = false;\n\n        this.initialize();\n    }\n\n    /**\n     * Prepare the toolbar for first use: generate all widget instances for this toolbar, based on the provided\n     *   layout of the parent. Connects event listeners and shows/hides as appropriate.\n     * @returns {Toolbar}\n     */\n    initialize() {\n        // Parse layout to generate widget instances\n        const options = this.parent.layout.toolbar.widgets;\n        if (Array.isArray(options)) {\n            options.forEach((layout) => {\n                this.addWidget(layout);\n            });\n        }\n\n        // Add mouseover event handlers to show/hide panel toolbar (plot toolbar will always be shown)\n        if (this.type === 'panel') {\n            d3.select(this.parent.parent.svg.node().parentNode)\n                .on(`mouseover.${this.id}`, () => {\n                    clearTimeout(this.hide_timeout);\n                    if (!this.selector || this.selector.style('visibility') === 'hidden') {\n                        this.show();\n                    }\n                }).on(`mouseout.${this.id}`, () => {\n                    clearTimeout(this.hide_timeout);\n                    this.hide_timeout = setTimeout(() => {\n                        this.hide();\n                    }, 300);\n                });\n        }\n\n        return this;\n    }\n\n    /**\n     * Add a new widget to the toolbar.\n     * FIXME: Kludgy to use. In the very rare cases where a widget is added dynamically, the caller will need to:\n     *  - add the widget to plot.layout.toolbar.widgets, AND calling it with the same object reference here.\n     *  - call widget.show() to ensure that the widget is initialized and rendered correctly\n     *  When creating an existing plot defined in advance, neither of these actions is needed and so we don't do this by default.\n     * @param {Object} layout The layout object describing the desired widget\n     * @returns {layout.type}\n     */\n    addWidget(layout) {\n        try {\n            const widget = WIDGETS.create(layout.type, layout, this);\n            this.widgets.push(widget);\n            return widget;\n        } catch (e) {\n            console.warn('Failed to create widget');\n            console.error(e);\n        }\n    }\n\n    /**\n     * Whether to persist the toolbar. Returns true if at least one widget should persist, or if the panel is engaged\n     *   in an active drag event.\n     * @returns {boolean}\n     */\n    shouldPersist() {\n        if (this.persist) {\n            return true;\n        }\n        let persist = false;\n        // Persist if at least one widget should also persist\n        this.widgets.forEach((widget) => {\n            persist = persist || widget.shouldPersist();\n        });\n        // Persist if in a parent drag event\n        persist = persist || (this.parent_plot._panel_boundaries.dragging || this.parent_plot._interaction.dragging);\n        return !!persist;\n    }\n\n    /**\n     * Make the toolbar appear. If it doesn't exist yet create it, including creating/positioning all widgets within,\n     *   and make sure it is set to be visible.\n     */\n    show() {\n        if (!this.selector) {\n            switch (this.type) {\n            case 'plot':\n                this.selector = d3.select(this.parent.svg.node().parentNode)\n                    .insert('div', ':first-child');\n                break;\n            case 'panel':\n                this.selector = d3.select(this.parent.parent.svg.node().parentNode)\n                    .insert('div', '.lz-data_layer-tooltip, .lz-toolbar-menu, .lz-curtain').classed('lz-panel-toolbar', true);\n                break;\n            default:\n                throw new Error(`Toolbar cannot be a child of ${this.type}`);\n            }\n\n            this.selector\n                .classed('lz-toolbar', true)\n                .classed(`lz-${this.type}-toolbar`, true)\n                .attr('id', this.id);\n        }\n        this.widgets.forEach((widget) => widget.show());\n        this.selector.style('visibility', 'visible');\n        return this.update();\n    }\n\n\n    /**\n     * Update the toolbar and rerender all child widgets. This can be called whenever plot state changes.\n     * @returns {Toolbar}\n     */\n    update() {\n        if (!this.selector) {\n            return this;\n        }\n        this.widgets.forEach((widget) => widget.update());\n        return this.position();\n    }\n\n\n    /**\n     * Position the toolbar (and child widgets) within the panel\n     * @returns {Toolbar}\n     */\n    position() {\n        if (!this.selector) {\n            return this;\n        }\n        // Position the toolbar itself (panel only)\n        if (this.type === 'panel') {\n            const page_origin = this.parent._getPageOrigin();\n            const top = `${(page_origin.y + 3.5).toString()}px`;\n            const left = `${page_origin.x.toString()}px`;\n            const width = `${(this.parent_plot.layout.width - 4).toString()}px`;\n            this.selector\n                .style('position', 'absolute')\n                .style('top', top)\n                .style('left', left)\n                .style('width', width);\n        }\n        // Recursively position widgets\n        this.widgets.forEach((widget) => widget.position());\n        return this;\n    }\n\n    /**\n     * Hide the toolbar (make invisible but do not destroy). Will do nothing if `shouldPersist` returns true.\n     *\n     * @returns {Toolbar}\n     */\n    hide() {\n        if (!this.selector || this.shouldPersist()) {\n            return this;\n        }\n        this.widgets.forEach((widget) => widget.hide());\n        this.selector\n            .style('visibility', 'hidden');\n        return this;\n    }\n\n    /**\n     * Completely remove toolbar and all child widgets. (may be overridden by persistence settings)\n     * @param {Boolean} [force=false] If true, will ignore persistence settings and always destroy the toolbar\n     * @returns {Toolbar}\n     */\n    destroy(force) {\n        if (typeof force == 'undefined') {\n            force = false;\n        }\n        if (!this.selector) {\n            return this;\n        }\n        if (this.shouldPersist() && !force) {\n            return this;\n        }\n        this.widgets.forEach((widget) => widget.destroy(true));\n        this.widgets = [];\n        this.selector.remove();\n        this.selector = null;\n        return this;\n    }\n}\n\n\nexport {Toolbar as default};\n","/**\n * @module\n * @private\n */\nimport * as d3 from 'd3';\nimport {applyStyles} from '../helpers/common';\nimport {merge, nameToSymbol} from '../helpers/layouts';\n\n// FIXME: Document legend options\n/**\n * The default layout used by legends (used internally)\n * @protected\n * @member {Object}\n */\nconst default_layout = {\n    orientation: 'vertical',\n    origin: { x: 0, y: 0 },\n    width: 10,\n    height: 10,\n    padding: 5,\n    label_size: 14,\n    hidden: false,\n};\n\n/**\n * An SVG object used to display contextual information about a panel.\n * Panel layouts determine basic features of a legend - its position in the panel, orientation, title, etc.\n * Layouts of child data layers of the panel determine the actual content of the legend.\n *\n * @param {Panel} parent\n*/\nclass Legend {\n    constructor(parent) {\n        // if (!(parent instanceof LocusZoom.Panel)) {\n        //     throw new Error('Unable to create legend, parent must be a locuszoom panel');\n        // }\n        /** @member {Panel} */\n        this.parent = parent;\n        /** @member {String} */\n        this.id = `${this.parent.getBaseId()}.legend`;\n\n        this.parent.layout.legend = merge(this.parent.layout.legend || {}, default_layout);\n        /** @member {Object} */\n        this.layout = this.parent.layout.legend;\n\n        /** @member {d3.selection} */\n        this.selector = null;\n        /** @member {d3.selection} */\n        this.background_rect = null;\n        /** @member {d3.selection[]} */\n        this.elements = [];\n        /**\n         * SVG selector for the group containing all elements in the legend\n         * @protected\n         * @member {d3.selection|null}\n         */\n        this.elements_group = null;\n\n        /**\n         * TODO: Not sure if this property is used; the external-facing methods are setting `layout.hidden` instead. Tentatively mark deprecated.\n         * @deprecated\n         * @protected\n         * @member {Boolean}\n         */\n        this.hidden = false;\n\n        return this.render();\n    }\n\n    /**\n     * Render the legend in the parent panel\n     */\n    render() {\n        // Get a legend group selector if not yet defined\n        if (!this.selector) {\n            this.selector = this.parent.svg.group.append('g')\n                .attr('id', `${this.parent.getBaseId()}.legend`).attr('class', 'lz-legend');\n        }\n\n        // Get a legend background rect selector if not yet defined\n        if (!this.background_rect) {\n            this.background_rect = this.selector.append('rect')\n                .attr('width', 100)\n                .attr('height', 100)\n                .attr('class', 'lz-legend-background');\n        }\n\n        // Get a legend elements group selector if not yet defined\n        if (!this.elements_group) {\n            this.elements_group = this.selector.append('g');\n        }\n\n        // Remove all elements from the document and re-render from scratch\n        this.elements.forEach((element) => element.remove());\n        this.elements = [];\n\n        // Gather all elements from data layers in order (top to bottom) and render them\n        const padding = +this.layout.padding || 1;\n        let x = padding;\n        let y = padding;\n        let line_height = 0;\n        this.parent._data_layer_ids_by_z_index.slice().reverse().forEach((id) => {\n            const layer_legend = this.parent.data_layers[id].layout.legend;\n            if (Array.isArray(layer_legend)) {\n                layer_legend.forEach((element) => {\n                    const selector = this.elements_group.append('g')\n                        .attr('transform', `translate(${x}, ${y})`);\n                    const label_size = +element.label_size || +this.layout.label_size;\n                    let label_x = 0;\n                    let label_y = (label_size / 2) + (padding / 2);\n                    line_height = Math.max(line_height, label_size + padding);\n                    // Draw the legend element symbol (line, rect, shape, etc)\n                    const shape = element.shape || '';\n                    const shape_factory = nameToSymbol(shape);\n                    if (shape === 'line') {\n                        // Line symbol\n                        const length = +element.length || 16;\n                        const path_y = (label_size / 4) + (padding / 2);\n                        selector\n                            .append('path')\n                            .attr('class', element.class || '')\n                            .attr('d', `M0,${path_y}L${length},${path_y}`)\n                            .call(applyStyles, element.style || {});\n                        label_x = length + padding;\n                    } else if (shape === 'rect') {\n                        // Rect symbol\n                        const width = +element.width || 16;\n                        const height = +element.height || width;\n                        selector\n                            .append('rect')\n                            .attr('class', element.class || '')\n                            .attr('width', width)\n                            .attr('height', height)\n                            .attr('fill', element.color || {})\n                            .call(applyStyles, element.style || {});\n\n                        label_x = width + padding;\n                        line_height = Math.max(line_height, height + padding);\n                    } else if (shape === 'ribbon') {\n                        // Color ribbons describe a series of color stops: small boxes of color across a continuous\n                        //  scale. Drawn horizontally, or vertically, like:\n                        //      [red | orange | yellow | green ] label\n                        // For example, this can be used with the numerical-bin color scale to describe LD color stops in a compact way.\n                        const width = +element.width || 25;\n                        const height = +element.height || width;\n                        const is_horizontal = (element.orientation || 'vertical') === 'horizontal';\n                        let color_stops = element.color_stops;\n\n                        const all_elements = selector.append('g');\n                        const ribbon_group = all_elements.append('g');\n                        const axis_group = all_elements.append('g');\n                        let axis_offset = 0;\n                        if (element.tick_labels) {\n                            let range;\n                            if (is_horizontal) {\n                                range = [0, width * color_stops.length - 1];  // 1 px offset to align tick with inner borders\n                            } else {\n                                range = [height * color_stops.length - 1, 0];\n                            }\n                            const scale = d3.scaleLinear()\n                                .domain(d3.extent(element.tick_labels)) // Assumes tick labels are always numeric in this mode\n                                .range(range);\n                            const axis = (is_horizontal ? d3.axisTop : d3.axisRight)(scale)\n                                .tickSize(3)\n                                .tickValues(element.tick_labels)\n                                .tickFormat((v) => v);\n                            axis_group\n                                .call(axis)\n                                .attr('class', 'lz-axis');\n                            let bcr = axis_group.node().getBoundingClientRect();\n                            axis_offset = bcr.height;\n                        }\n                        if (is_horizontal) {\n                            // Shift axis down (so that tick marks aren't above the origin)\n                            axis_group\n                                .attr('transform', `translate(0, ${axis_offset})`);\n                            // Ribbon appears below axis\n                            ribbon_group\n                                .attr('transform', `translate(0, ${axis_offset})`);\n                        } else {\n                            // Vertical mode: Shift axis ticks to the right of the ribbon\n                            all_elements.attr('transform', 'translate(5, 0)');\n                            axis_group\n                                .attr('transform', `translate(${width}, 0)`);\n                        }\n\n                        if (!is_horizontal) {\n                            //  Vertical mode: renders top -> bottom but scale is usually specified low..high\n                            color_stops = color_stops.slice();\n                            color_stops.reverse();\n                        }\n                        for (let i = 0; i < color_stops.length; i++) {\n                            const color = color_stops[i];\n                            const to_next_marking = is_horizontal ? `translate(${width * i}, 0)` : `translate(0, ${height * i})`;\n                            ribbon_group\n                                .append('rect')\n                                .attr('class', element.class || '')\n                                .attr('stroke', 'black')\n                                .attr('transform', to_next_marking)\n                                .attr('stroke-width', 0.5)\n                                .attr('width', width)\n                                .attr('height', height)\n                                .attr('fill', color)\n                                .call(applyStyles, element.style || {});\n                        }\n\n                        // Note: In vertical mode, it's usually easier to put the label above the legend as a separate marker\n                        //  This is because the legend element label is drawn last (can't use it's size to position the ribbon, which is drawn first)\n                        if (!is_horizontal && element.label) {\n                            throw new Error('Legend labels not supported for vertical ribbons (use a separate legend item as text instead)');\n                        }\n                        // This only makes sense for horizontal labels.\n                        label_x = (width * color_stops.length + padding);\n                        label_y += axis_offset;\n                    } else if (shape_factory) {\n                        // Shape symbol is a recognized d3 type, so we can draw it in the legend (circle, diamond, etc.)\n                        const size = +element.size || 40;\n                        const radius = Math.ceil(Math.sqrt(size / Math.PI));\n                        selector\n                            .append('path')\n                            .attr('class', element.class || '')\n                            .attr('d', d3.symbol().size(size).type(shape_factory))\n                            .attr('transform', `translate(${radius}, ${radius + (padding / 2)})`)\n                            .attr('fill', element.color || {})\n                            .call(applyStyles, element.style || {});\n\n                        label_x = (2 * radius) + padding;\n                        label_y = Math.max((2 * radius) + (padding / 2), label_y);\n                        line_height = Math.max(line_height, (2 * radius) + padding);\n                    }\n                    // Draw the legend element label\n                    selector\n                        .append('text')\n                        .attr('text-anchor', 'left')\n                        .attr('class', 'lz-label')\n                        .attr('x', label_x)\n                        .attr('y', label_y)\n                        .style('font-size', label_size)\n                        .text(element.label);\n\n                    // Position the legend element group based on legend layout orientation\n                    const bcr = selector.node().getBoundingClientRect();\n                    if (this.layout.orientation === 'vertical') {\n                        y += bcr.height + padding;\n                        line_height = 0;\n                    } else {\n                        // Ensure this element does not exceed the panel width\n                        // (E.g. drop to the next line if it does, but only if it's not the only element on this line)\n                        const right_x = this.layout.origin.x + x + bcr.width;\n                        if (x > padding && right_x > this.parent.parent.layout.width) {\n                            y += line_height;\n                            x = padding;\n                            selector.attr('transform', `translate(${x}, ${y})`);\n                        }\n                        x += bcr.width + (3 * padding);\n                    }\n                    // Store the element\n                    this.elements.push(selector);\n                });\n            }\n        });\n\n        // Scale the background rect to the elements in the legend\n        const bcr = this.elements_group.node().getBoundingClientRect();\n        this.layout.width = bcr.width + (2 * this.layout.padding);\n        this.layout.height = bcr.height + (2 * this.layout.padding);\n        this.background_rect\n            .attr('width', this.layout.width)\n            .attr('height', this.layout.height);\n\n        // Set the visibility on the legend from the \"hidden\" flag\n        // TODO: `show()` and `hide()` call a full rerender; might be able to make this more lightweight?\n        this.selector\n            .style('visibility', this.layout.hidden ? 'hidden' : 'visible');\n\n        return this.position();\n    }\n\n    /**\n     * Place the legend in position relative to the panel, as specified in the layout configuration\n     * @returns {Legend | null}\n     * TODO: should this always be chainable?\n     */\n    position() {\n        if (!this.selector) {\n            return this;\n        }\n        const bcr = this.selector.node().getBoundingClientRect();\n        if (!isNaN(+this.layout.pad_from_bottom)) {\n            this.layout.origin.y = this.parent.layout.height - bcr.height - +this.layout.pad_from_bottom;\n        }\n        if (!isNaN(+this.layout.pad_from_right)) {\n            this.layout.origin.x = this.parent.parent.layout.width - bcr.width - +this.layout.pad_from_right;\n        }\n        this.selector.attr('transform', `translate(${this.layout.origin.x}, ${this.layout.origin.y})`);\n    }\n\n    /**\n     * Hide the legend (triggers a re-render)\n     * @public\n     */\n    hide() {\n        this.layout.hidden = true;\n        this.render();\n    }\n\n    /**\n     * Show the legend (triggers a re-render)\n     * @public\n     */\n    show() {\n        this.layout.hidden = false;\n        this.render();\n    }\n}\n\nexport {Legend as default};\n","import * as d3 from 'd3';\n\nimport {STATUSES} from './constants';\nimport Toolbar from './toolbar';\nimport {applyStyles, generateCurtain, generateLoader} from '../helpers/common';\nimport {parseFields, positionIntToString, prettyTicks} from '../helpers/display';\nimport {merge} from '../helpers/layouts';\nimport Legend from './legend';\nimport data_layers from '../registry/data_layers';\n\n\n/**\n * Default panel layout\n * @memberof Panel\n * @static\n * @type {Object}\n */\nconst default_layout = {\n    id: '',\n    tag: 'custom_data_type',\n    title: { text: '', style: {}, x: 10, y: 22 },\n    y_index: null,\n    min_height: 1,\n    height: 1,\n    origin: { x: 0, y: null },\n    margin: { top: 0, right: 0, bottom: 0, left: 0 },\n    background_click: 'clear_selections',\n    toolbar: {\n        widgets: [],\n    },\n    cliparea: {\n        height: 0,\n        width: 0,\n        origin: { x: 0, y: 0 },\n    },\n    axes: {  // These are the only axes supported!!\n        x:  {},\n        y1: {},\n        y2: {},\n    },\n    legend: null,\n    interaction: {\n        drag_background_to_pan: false,\n        drag_x_ticks_to_scale: false,\n        drag_y1_ticks_to_scale: false,\n        drag_y2_ticks_to_scale: false,\n        scroll_to_zoom: false,\n        x_linked: false,\n        y1_linked: false,\n        y2_linked: false,\n    },\n    show_loading_indicator: true,\n    data_layers: [],\n};\n\n/**\n * A panel is an abstract class representing a subdivision of the LocusZoom stage\n *   to display a distinct data representation as a collection of data layers.\n */\nclass Panel {\n    /**\n     * @param {string} layout.id An identifier string that must be unique across all panels in the plot. Required.\n     * @param {string} [layout.tag='custom_data_type'] Tags have no functional purpose, but they can be used\n     *   as a semantic label for what is being displayed in this element. This makes it easy to write custom code like \"find every panel\n     *   that shows association scatter plots, anywhere\": even if the IDs are different, the tag can be the same.\n     *   Most built-in panels will contain a tag that describes, in human-readable terms, what kind of data is being shown.\n     *   (see: {@link LayoutRegistry.mutate_attrs})\n     * @param {boolean} [layout.show_loading_indicator=true] Whether to show a \"loading indicator\" while data is being fetched\n     * @param {module:LocusZoom_DataLayers[]} [layout.data_layers] Data layer layout objects\n     * @param {module:LocusZoom_Widgets[]} [layout.toolbar.widgets] Configuration options for each toolbar widget; {@link module:LocusZoom_Widgets}\n     * @param {number} [layout.title.text] Text to show in panel title\n     * @param {number} [layout.title.style] CSS options to apply to the title\n     * @param {number} [layout.title.x=10] x-offset for title position\n     * @param {number} [layout.title.y=22] y-offset for title position\n     * @param {'vertical'|'horizontal'} [layout.legend.orientation='vertical']  Orientation with which elements in the legend should be arranged.\n     *   Presently only \"vertical\" and \"horizontal\" are supported values. When using the horizontal orientation\n     *   elements will automatically drop to a new line if the width of the legend would exceed the right edge of the\n     *   containing panel. Defaults to \"vertical\".\n     * @param {number} [layout.legend.origin.x=0]  X-offset, in pixels, for the top-left corner of the legend (relative to the top left corner of the panel).\n     * @param {number} [layout.legend.origin.y=0] Y-offset, in pixels, for the top-left corner of the legend (relative to the top left corner of the panel).\n     *   NOTE: SVG y values go from the top down, so the SVG origin of (0,0) is in the top left corner.\n     * @param {number} [layout.legend.padding=5]  Value in pixels to pad between the legend's outer border and the\n     *   elements within the legend. This value is also used for spacing between elements in the legend on different\n     *   lines (e.g. in a vertical orientation) and spacing between element shapes and labels, as well as between\n     *   elements in a horizontal orientation, are defined as a function of this value. Defaults to 5.\n     * @param {number} [layout.legend.label_size=12]  Font size for element labels in the legend (loosely analogous to the height of full-height letters, in pixels). Defaults to 12.\n     * @param {boolean} [layout.legend.hidden=false] Whether to hide the legend by default\n     * @param {number} [layout.y_index] The position of the panel (above or below other panels). This is usually set\n     *  automatically when the panel is added, and rarely controlled directly.\n     * @param {number} [layout.min_height=1] When resizing, do not allow height to go below this value\n     * @param {number} [layout.height=1] The actual height allocated to the panel (>= min_height)\n     * @param {number} [layout.margin.top=0] The margin (space between top of panel and edge of viewing area)\n     * @param {number} [layout.margin.right=0] The margin (space between right side of panel and edge of viewing area)\n     * @param {number} [layout.margin.bottom=0] The margin (space between bottom of panel and edge of viewing area)\n     * @param {number} [layout.margin.left=0] The margin (space between left side of panel and edge of viewing area)\n     * @param {'clear_selections'|null} [layout.background_click='clear_selections'] What happens when the background of the panel is clicked\n     * @param {'state'|null} [layout.axes.x.extent] If 'state', the x extent will be determined from plot.state (a\n     *   shared region). Otherwise it will be determined based on data later ranges.\n     * @param {string} [layout.axes.x.label] Label text for the provided axis\n     * @param {number} [layout.axes.x.label_offset]\n     * @param {boolean} [layout.axes.x.render] Whether to render this axis\n     * @param {'region'|null} [layout.axes.x.tick_format] If 'region', format ticks in a concise way suitable for\n     *   genomic coordinates, eg 23423456 => 23.42 (Mb)\n     * @param {Array} [layout.axes.x.ticks] An array of custom ticks that will override any automatically generated)\n     * @param {string} [layout.axes.y1.label] Label text for the provided axis\n     * @param {number} [layout.axes.y1.label_offset] The distance between the axis title and the axis. Use this to prevent\n     *  the title from overlapping with tick mark labels. If there is not enough space for the label, be sure to increase the panel margins (left or right) accordingly.\n     * @param {boolean} [layout.axes.y1.render=false] Whether to render this axis\n     * @param {Array} [layout.axes.y1.ticks] An array of custom ticks that will override any automatically generated)\n     * @param {string} [layout.axes.y2.label] Label text for the provided axis\n     * @param {number} [layout.axes.y2.label_offset]\n     * @param {boolean} [layout.axes.y2.render=false] Whether to render this axis\n     * @param {Array} [layout.axes.y2.ticks] An array of custom ticks that will override any automatically generated)\n     * @param {boolean} [layout.interaction.drag_background_to_pan=false] Allow the user to drag the panel background to pan\n     *   the plot to another genomic region.\n     * @param {boolean} [layout.interaction.drag_x_ticks_to_scale=false] Allow the user to rescale the x axis by dragging x ticks\n     * @param {boolean}  [layout.interaction.drag_y1_ticks_to_scale=false] Allow the user to rescale the y1 axis by dragging y1 ticks\n     * @param {boolean} [layout.interaction.drag_y2_ticks_to_scale=false] Allow the user to rescale the y2 axis by dragging y2 ticks\n     * @param {boolean} [layout.interaction.scroll_to_zoom=false] Allow the user to rescale the plot by mousewheel-scrolling\n     * @param {boolean} [layout.interaction.x_linked=false] Whether this panel should change regions to match all other linked panels\n     * @param {boolean} [layout.interaction.y1_linked=false] Whether this panel should rescale to match all other linked panels\n     * @param {boolean} [layout.interaction.y2_linked=false] Whether this panel should rescale to match all other linked panels\n     * @param {Plot|null} parent\n     */\n    constructor(layout, parent) {\n        if (typeof layout !== 'object') {\n            throw new Error('Unable to create panel, invalid layout');\n        }\n\n        /**\n         * @protected\n         * @member {Plot|null}\n         */\n        this.parent = parent || null;\n        /**\n         *  @protected\n         *  @member {Plot|null}\n         */\n        this.parent_plot = parent;\n\n        if (typeof layout.id !== 'string' || !layout.id) {\n            throw new Error('Panel layouts must specify \"id\"');\n        } else if (this.parent) {\n            if (typeof this.parent.panels[layout.id] !== 'undefined') {\n                throw new Error(`Cannot create panel with id [${layout.id}]; panel with that id already exists`);\n            }\n        }\n        /**\n         * @public\n         * @member {String}\n         */\n        this.id = layout.id;\n\n        /**\n         * @private\n         * @member {Boolean}\n         */\n        this._initialized = false;\n        /**\n         * The index of this panel in the parent plot's `layout.panels`\n         * @private\n         * @member {number}\n         * */\n        this._layout_idx = null;\n        /**\n         * @private\n         * @member {Object}\n         */\n        this.svg = {};\n\n        /**\n         * A JSON-serializable object used to describe the composition of the Panel\n         * @public\n         * @member {Object}\n         */\n        this.layout = merge(layout || {}, default_layout);\n\n        // Define state parameters specific to this panel\n        if (this.parent) {\n            /**\n             * @private\n             * @member {Object}\n             */\n            this.state = this.parent.state;\n\n            /**\n             *  @private\n             *  @member {String}\n             */\n            this._state_id = this.id;\n            this.state[this._state_id] = this.state[this._state_id] || {};\n        } else {\n            this.state = null;\n            this._state_id = null;\n        }\n\n        /**\n         * Direct access to data layer instances, keyed by data layer ID. Used primarily for introspection/ development.\n         * @public\n         * @member {Object.<String, BaseDataLayer>}\n         */\n        this.data_layers = {};\n        /**\n         * @private\n         * @member {String[]}\n         */\n        this._data_layer_ids_by_z_index = [];\n\n        /**\n         * Track data requests in progress\n         * @member {Promise[]}\n         * @private\n         */\n        this._data_promises = [];\n\n        /**\n         * @private\n         * @member {d3.scale}\n         */\n        this.x_scale  = null;\n        /**\n         * @private\n         * @member {d3.scale}\n         */\n        this.y1_scale = null;\n        /**\n         *  @private\n         *  @member {d3.scale}\n         */\n        this.y2_scale = null;\n\n        /**\n         * @private\n         * @member {d3.extent}\n         */\n        this.x_extent  = null;\n        /**\n         *  @private\n         *  @member {d3.extent}\n         */\n        this.y1_extent = null;\n        /**\n         *  @private\n         *  @member {d3.extent}\n         */\n        this.y2_extent = null;\n\n        /**\n         * @private\n         * @member {Number[]}\n         */\n        this.x_ticks  = [];\n        /**\n         *  @private\n         *  @member {Number[]}\n         */\n        this.y1_ticks = [];\n        /**\n         * @private\n         * @member {Number[]}\n         */\n        this.y2_ticks = [];\n\n        /**\n         * A timeout ID as returned by setTimeout\n         * @private\n         * @member {number}\n         */\n        this._zoom_timeout = null;\n\n        /**\n         * Known event hooks that the panel can respond to\n         * @see {@link event:any_lz_event} for a list of pre-defined events commonly used by LocusZoom\n         * @protected\n         * @member {Object}\n         */\n        this._event_hooks = {};\n\n        // Initialize the layout\n        this.initializeLayout();\n    }\n\n    /******* Public methods: intended for direct external manipulation of panel internals */\n\n    /**\n     * There are several events that a LocusZoom panel can \"emit\" when appropriate, and LocusZoom supports registering\n     *   \"hooks\" for these events which are essentially custom functions intended to fire at certain times.\n     *\n     * To register a hook for any of these events use `panel.on('event_name', function() {})`.\n     *\n     * There can be arbitrarily many functions registered to the same event. They will be executed in the order they\n     *   were registered.\n     *\n     * @public\n     * @see {@link event:any_lz_event} for a list of pre-defined events commonly used by LocusZoom\n     * @param {String} event The name of the event. Consult documentation for the names of built-in events.\n     * @param {function} hook\n     * @returns {function} The registered event listener\n     */\n    on(event, hook) {\n        // TODO: Dry plot and panel event code into a shared mixin\n        if (typeof event !== 'string') {\n            throw new Error(`Unable to register event hook. Event name must be a string: ${event.toString()}`);\n        }\n        if (typeof hook != 'function') {\n            throw new Error('Unable to register event hook, invalid hook function passed');\n        }\n        if (!this._event_hooks[event]) {\n            // We do not validate on known event names, because LZ is allowed to track and emit custom events like \"widget button clicked\".\n            this._event_hooks[event] = [];\n        }\n        this._event_hooks[event].push(hook);\n        return hook;\n    }\n\n    /**\n     * Remove one or more previously defined event listeners\n     * @public\n     * @param {String} event The name of an event (as defined in `event_hooks`)\n     * @param {eventCallback} [hook] The callback to deregister\n     * @returns {Panel}\n     */\n    off(event, hook) {\n        const theseHooks = this._event_hooks[event];\n        if (typeof event != 'string' || !Array.isArray(theseHooks)) {\n            throw new Error(`Unable to remove event hook, invalid event: ${event.toString()}`);\n        }\n        if (hook === undefined) {\n            // Deregistering all hooks for this event may break basic functionality, and should only be used during\n            //  cleanup operations (eg to prevent memory leaks)\n            this._event_hooks[event] = [];\n        } else {\n            const hookMatch = theseHooks.indexOf(hook);\n            if (hookMatch !== -1) {\n                theseHooks.splice(hookMatch, 1);\n            } else {\n                throw new Error('The specified event listener is not registered and therefore cannot be removed');\n            }\n        }\n        return this;\n    }\n\n    /**\n     * Handle running of event hooks when an event is emitted\n     *\n     * There is a shorter overloaded form of this method: if the event does not have any data, the second\n     *   argument can be a boolean to control bubbling\n     *\n     * @public\n     * @see {@link event:any_lz_event} for a list of pre-defined events commonly used by LocusZoom\n     * @param {string} event A known event name\n     * @param {*} [eventData] Data or event description that will be passed to the event listener\n     * @param {boolean} [bubble=false] Whether to bubble the event to the parent\n     * @returns {Panel}\n     */\n    emit(event, eventData, bubble)  {\n        bubble = bubble || false;\n\n        // TODO: DRY this with the parent plot implementation. Ensure interfaces remain compatible.\n        // TODO: Improve documentation for overloaded method signature (JSDoc may have trouble here)\n        if (typeof event != 'string') {\n            throw new Error(`LocusZoom attempted to throw an invalid event: ${event.toString()}`);\n        }\n        if (typeof eventData === 'boolean' && arguments.length === 2) {\n            // Overloaded method signature: emit(event, bubble)\n            bubble = eventData;\n            eventData = null;\n        }\n        const sourceID = this.getBaseId();\n        const eventContext = { sourceID: sourceID, target: this, data: eventData || null };\n\n        if (this._event_hooks[event]) {\n            // If the tree_fall event is emitted in a forest and no one is around to hear it, does it really make a sound?\n            this._event_hooks[event].forEach((hookToRun) => {\n                // By default, any handlers fired here will see the panel as the value of `this`. If a bound function is\n                // registered as a handler, the previously bound `this` will override anything provided to `call` below.\n                hookToRun.call(this, eventContext);\n            });\n        }\n\n        if (bubble && this.parent) {\n            // Even if this event has no listeners locally, it might still have listeners on the parent\n            this.parent.emit(event, eventContext);\n        }\n        return this;\n    }\n\n    /**\n     * Set the title for the panel. If passed an object, will merge the object with the existing layout configuration, so\n     *   that all or only some of the title layout object's parameters can be customized. If passed null, false, or an empty\n     *   string, the title DOM element will be set to display: none.\n     *\n     * @public\n     * @param {string|object|null} title The title text, or an object with additional configuration\n     * @param {string} title.text Text to display. Since titles are rendered as SVG text, HTML and newlines will not be rendered.\n     * @param {number} title.x X-offset, in pixels, for the title's text anchor (default left) relative to the top-left corner of the panel.\n     * @param {number} title.y Y-offset, in pixels, for the title's text anchor (default left) relative to the top-left corner of the panel.\n        NOTE: SVG y values go from the top down, so the SVG origin of (0,0) is in the top left corner.\n     * @param {object} title.style CSS styles object to be applied to the title's DOM element.\n     * @returns {Panel}\n     */\n    setTitle(title) {\n        if (typeof this.layout.title == 'string') {\n            const text = this.layout.title;\n            this.layout.title = { text: text, x: 0, y: 0, style: {} };\n        }\n        if (typeof title == 'string') {\n            this.layout.title.text = title;\n        } else if (typeof title == 'object' && title !== null) {\n            this.layout.title = merge(title, this.layout.title);\n        }\n        if (this.layout.title.text.length) {\n            this.title\n                .attr('display', null)\n                .attr('x', parseFloat(this.layout.title.x))\n                .attr('y', parseFloat(this.layout.title.y))\n                .text(this.layout.title.text)\n                .call(applyStyles, this.layout.title.style);\n\n        } else {\n            this.title.attr('display', 'none');\n        }\n        return this;\n    }\n\n    /**\n     * Create a new data layer from a provided layout object. Should have the keys specified in `DefaultLayout`\n     * Will automatically add at the top (depth/z-index) of the panel unless explicitly directed differently\n     *   in the layout provided.\n     *\n     * **NOTE**: It is very rare that new data layers are added after a panel is rendered.\n     * @public\n     * @param {object} layout\n     * @returns {BaseDataLayer}\n     */\n    addDataLayer(layout) {\n        // Sanity checks\n        if (typeof layout !== 'object' || typeof layout.id !== 'string' || !layout.id.length) {\n            throw new Error('Invalid data layer layout');\n        }\n        if (typeof this.data_layers[layout.id] !== 'undefined') {\n            throw new Error(`Cannot create data_layer with id '${layout.id}'; data layer with that id already exists in the panel`);\n        }\n        if (typeof layout.type !== 'string') {\n            throw new Error('Invalid data layer type');\n        }\n\n        // If the layout defines a y axis make sure the axis number is set and is 1 or 2 (default to 1)\n        if (typeof layout.y_axis == 'object' && (typeof layout.y_axis.axis == 'undefined' || ![1, 2].includes(layout.y_axis.axis))) {\n            layout.y_axis.axis = 1;\n        }\n\n        // Create the Data Layer\n        const data_layer = data_layers.create(layout.type, layout, this);\n\n        // Store the Data Layer on the Panel\n        this.data_layers[data_layer.id] = data_layer;\n\n        // If a discrete z_index was set in the layout then adjust other data layer z_index values to accommodate this one\n        if (data_layer.layout.z_index !== null && !isNaN(data_layer.layout.z_index)\n            && this._data_layer_ids_by_z_index.length > 0) {\n            // Negative z_index values should count backwards from the end, so convert negatives to appropriate values here\n            if (data_layer.layout.z_index < 0) {\n                data_layer.layout.z_index = Math.max(this._data_layer_ids_by_z_index.length + data_layer.layout.z_index, 0);\n            }\n            this._data_layer_ids_by_z_index.splice(data_layer.layout.z_index, 0, data_layer.id);\n            this._data_layer_ids_by_z_index.forEach((dlid, idx) => {\n                this.data_layers[dlid].layout.z_index = idx;\n            });\n        } else {\n            const length = this._data_layer_ids_by_z_index.push(data_layer.id);\n            this.data_layers[data_layer.id].layout.z_index = length - 1;\n        }\n\n        // Determine if this data layer was already in the layout.data_layers array.\n        // If it wasn't, add it. Either way store the layout.data_layers array index on the data_layer.\n        let layout_idx = null;\n        this.layout.data_layers.forEach((data_layer_layout, idx) => {\n            if (data_layer_layout.id === data_layer.id) {\n                layout_idx = idx;\n            }\n        });\n        if (layout_idx === null) {\n            layout_idx = this.layout.data_layers.push(this.data_layers[data_layer.id].layout) - 1;\n        }\n        this.data_layers[data_layer.id]._layout_idx = layout_idx;\n\n        return this.data_layers[data_layer.id];\n    }\n\n    /**\n     * Remove a data layer by id\n     * @public\n     * @param {string} id\n     * @returns {Panel}\n     */\n    removeDataLayer(id) {\n        const target_layer = this.data_layers[id];\n        if (!target_layer) {\n            throw new Error(`Unable to remove data layer, ID not found: ${id}`);\n        }\n\n        // Destroy all tooltips for the data layer\n        target_layer.destroyAllTooltips();\n\n        // Remove the svg container for the data layer if it exists\n        if (target_layer.svg.container) {\n            target_layer.svg.container.remove();\n        }\n\n        // Delete the data layer and its presence in the panel layout and state\n        this.layout.data_layers.splice(target_layer._layout_idx, 1);\n        delete this.state[target_layer._state_id];\n        delete this.data_layers[id];\n\n        // Remove the data_layer id from the z_index array\n        this._data_layer_ids_by_z_index.splice(this._data_layer_ids_by_z_index.indexOf(id), 1);\n\n        // Update layout_idx and layout.z_index values for all remaining data_layers\n        this.applyDataLayerZIndexesToDataLayerLayouts();\n        this.layout.data_layers.forEach((data_layer_layout, idx) => {\n            this.data_layers[data_layer_layout.id]._layout_idx = idx;\n        });\n\n        return this;\n    }\n\n    /**\n     * Clear all selections on all data layers\n     * @public\n     * @returns {Panel}\n     */\n    clearSelections() {\n        this._data_layer_ids_by_z_index.forEach((id) => {\n            this.data_layers[id].setAllElementStatus('selected', false);\n        });\n        return this;\n    }\n\n    /**\n     * Update rendering of this panel whenever an event triggers a redraw. Assumes that the panel has already been\n     *   prepared the first time via `initialize`\n     * @public\n     * @returns {Panel}\n     */\n    render() {\n        // Position the panel container\n        this.svg.container.attr('transform', `translate(${this.layout.origin.x}, ${this.layout.origin.y})`);\n\n        // Set size on the clip rect\n        this.svg.clipRect\n            .attr('width', this.parent_plot.layout.width)\n            .attr('height', this.layout.height);\n\n        const { cliparea } = this.layout;\n\n        // Set and position the inner border, style if necessary\n        const { margin } = this.layout;\n        this.inner_border\n            .attr('x', margin.left)\n            .attr('y', margin.top)\n            .attr('width', this.parent_plot.layout.width - (margin.left + margin.right))\n            .attr('height', this.layout.height - (margin.top + margin.bottom));\n        if (this.layout.inner_border) {\n            this.inner_border\n                .style('stroke-width', 1)\n                .style('stroke', this.layout.inner_border);\n        }\n\n        // Set/update panel title if necessary\n        this.setTitle();\n\n        // Regenerate all extents\n        this.generateExtents();\n\n        // Helper function to constrain any procedurally generated vectors (e.g. ranges, extents)\n        // Constraints applied here keep vectors from going to infinity or beyond a definable power of ten\n        const constrain = function (value, limit_exponent) {\n            const neg_min = Math.pow(-10, limit_exponent);\n            const neg_max = Math.pow(-10, -limit_exponent);\n            const pos_min = Math.pow(10, -limit_exponent);\n            const pos_max = Math.pow(10, limit_exponent);\n            if (value === Infinity) {\n                value = pos_max;\n            }\n            if (value === -Infinity) {\n                value = neg_min;\n            }\n            if (value === 0) {\n                value = pos_min;\n            }\n            if (value > 0) {\n                value = Math.max(Math.min(value, pos_max), pos_min);\n            }\n            if (value < 0) {\n                value = Math.max(Math.min(value, neg_max), neg_min);\n            }\n            return value;\n        };\n\n        // Define default and shifted ranges for all axes\n        const ranges = {};\n        const axes_config = this.layout.axes;\n        if (this.x_extent) {\n            const base_x_range = { start: 0, end: this.layout.cliparea.width };\n            if (axes_config.x.range) {\n                base_x_range.start = axes_config.x.range.start || base_x_range.start;\n                base_x_range.end = axes_config.x.range.end || base_x_range.end;\n            }\n            ranges.x = [base_x_range.start, base_x_range.end];\n            ranges.x_shifted = [base_x_range.start, base_x_range.end];\n        }\n        if (this.y1_extent) {\n            const base_y1_range = { start: cliparea.height, end: 0 };\n            if (axes_config.y1.range) {\n                base_y1_range.start = axes_config.y1.range.start || base_y1_range.start;\n                base_y1_range.end = axes_config.y1.range.end || base_y1_range.end;\n            }\n            ranges.y1 = [base_y1_range.start, base_y1_range.end];\n            ranges.y1_shifted = [base_y1_range.start, base_y1_range.end];\n        }\n        if (this.y2_extent) {\n            const base_y2_range = { start: cliparea.height, end: 0 };\n            if (axes_config.y2.range) {\n                base_y2_range.start = axes_config.y2.range.start || base_y2_range.start;\n                base_y2_range.end = axes_config.y2.range.end || base_y2_range.end;\n            }\n            ranges.y2 = [base_y2_range.start, base_y2_range.end];\n            ranges.y2_shifted = [base_y2_range.start, base_y2_range.end];\n        }\n\n        // Shift ranges based on any drag or zoom interactions currently underway\n        let { _interaction } = this.parent;\n        const current_drag = _interaction.dragging;\n        if (_interaction.panel_id && (_interaction.panel_id === this.id || _interaction.linked_panel_ids.includes(this.id))) {\n            let anchor, scalar = null;\n            if (_interaction.zooming && typeof this.x_scale == 'function') {\n                const current_extent_size = Math.abs(this.x_extent[1] - this.x_extent[0]);\n                const current_scaled_extent_size = Math.round(this.x_scale.invert(ranges.x_shifted[1])) - Math.round(this.x_scale.invert(ranges.x_shifted[0]));\n                let zoom_factor = _interaction.zooming.scale;\n                const potential_extent_size = Math.floor(current_scaled_extent_size * (1 / zoom_factor));\n                if (zoom_factor < 1 && !isNaN(this.parent.layout.max_region_scale)) {\n                    zoom_factor = 1 / (Math.min(potential_extent_size, this.parent.layout.max_region_scale) / current_scaled_extent_size);\n                } else if (zoom_factor > 1 && !isNaN(this.parent.layout.min_region_scale)) {\n                    zoom_factor = 1 / (Math.max(potential_extent_size, this.parent.layout.min_region_scale) / current_scaled_extent_size);\n                }\n                const new_extent_size = Math.floor(current_extent_size * zoom_factor);\n                anchor = _interaction.zooming.center - margin.left - this.layout.origin.x;\n                const offset_ratio = anchor / cliparea.width;\n                const new_x_extent_start = Math.max(Math.floor(this.x_scale.invert(ranges.x_shifted[0]) - ((new_extent_size - current_scaled_extent_size) * offset_ratio)), 1);\n                ranges.x_shifted = [ this.x_scale(new_x_extent_start), this.x_scale(new_x_extent_start + new_extent_size) ];\n            } else if (current_drag) {\n                switch (current_drag.method) {\n                case 'background':\n                    ranges.x_shifted[0] = +current_drag.dragged_x;\n                    ranges.x_shifted[1] = cliparea.width + current_drag.dragged_x;\n                    break;\n                case 'x_tick':\n                    if (d3.event && d3.event.shiftKey) {\n                        ranges.x_shifted[0] = +current_drag.dragged_x;\n                        ranges.x_shifted[1] = cliparea.width + current_drag.dragged_x;\n                    } else {\n                        anchor = current_drag.start_x - margin.left - this.layout.origin.x;\n                        scalar = constrain(anchor / (anchor + current_drag.dragged_x), 3);\n                        ranges.x_shifted[0] = 0;\n                        ranges.x_shifted[1] = Math.max(cliparea.width * (1 / scalar), 1);\n                    }\n                    break;\n                case 'y1_tick':\n                case 'y2_tick': {\n                    const y_shifted = `y${current_drag.method[1]}_shifted`;\n                    if (d3.event && d3.event.shiftKey) {\n                        ranges[y_shifted][0] = cliparea.height + current_drag.dragged_y;\n                        ranges[y_shifted][1] = +current_drag.dragged_y;\n                    } else {\n                        anchor = cliparea.height - (current_drag.start_y - margin.top - this.layout.origin.y);\n                        scalar = constrain(anchor / (anchor - current_drag.dragged_y), 3);\n                        ranges[y_shifted][0] = cliparea.height;\n                        ranges[y_shifted][1] = cliparea.height - (cliparea.height * (1 / scalar));\n                    }\n                }\n                }\n            }\n        }\n\n        // Generate scales and ticks for all axes, then render them\n        ['x', 'y1', 'y2'].forEach((axis) => {\n            if (!this[`${axis}_extent`]) {\n                return;\n            }\n\n            // Base Scale\n            this[`${axis}_scale`] = d3.scaleLinear()\n                .domain(this[`${axis}_extent`])\n                .range(ranges[`${axis}_shifted`]);\n\n            // Shift the extent\n            this[`${axis}_extent`] = [\n                this[`${axis}_scale`].invert(ranges[axis][0]),\n                this[`${axis}_scale`].invert(ranges[axis][1]),\n            ];\n\n            // Finalize Scale\n            this[`${axis}_scale`] = d3.scaleLinear()\n                .domain(this[`${axis}_extent`]).range(ranges[axis]);\n\n            // Render axis (and generate ticks as needed)\n            this.renderAxis(axis);\n        });\n\n        // Establish mousewheel zoom event handers on the panel (namespacing not passed through by d3, so not used here)\n        if (this.layout.interaction.scroll_to_zoom) {\n            const zoom_handler = () => {\n                // Look for a shift key press while scrolling to execute.\n                // If not present, gracefully raise a notification and allow conventional scrolling\n                if (!(d3.event.shiftKey || d3.event.altKey)) {\n                    if (this.parent._canInteract(this.id)) {\n                        this.loader.show('Press <tt>[SHIFT]</tt> or <tt>[ALT]</tt> while scrolling to zoom').hide(1000);\n                    }\n                    return;\n                }\n                d3.event.preventDefault();\n                if (!this.parent._canInteract(this.id)) {\n                    return;\n                }\n                const coords = d3.mouse(this.svg.container.node());\n                const delta = Math.max(-1, Math.min(1, (d3.event.wheelDelta || -d3.event.detail || -d3.event.deltaY)));\n                if (delta === 0) {\n                    return;\n                }\n                this.parent._interaction = {\n                    panel_id: this.id,\n                    linked_panel_ids: this.getLinkedPanelIds('x'),\n                    zooming: {\n                        scale: (delta < 1) ? 0.9 : 1.1,\n                        center: coords[0],\n                    },\n                };\n                this.render();\n                // Redefine b/c might have been changed during call to parent re-render\n                _interaction = this.parent._interaction;\n                _interaction.linked_panel_ids.forEach((panel_id) => {\n                    this.parent.panels[panel_id].render();\n                });\n                if (this._zoom_timeout !== null) {\n                    clearTimeout(this._zoom_timeout);\n                }\n                this._zoom_timeout = setTimeout(() => {\n                    this.parent._interaction = {};\n                    this.parent.applyState({ start: this.x_extent[0], end: this.x_extent[1] });\n                }, 500);\n            };\n            // FIXME: Consider moving back to d3.zoom and rewriting drag + zoom to use behaviors.\n            this.svg.container\n                .on('wheel.zoom', zoom_handler)\n                .on('mousewheel.zoom', zoom_handler)\n                .on('DOMMouseScroll.zoom', zoom_handler);\n        }\n\n        // Render data layers in order by z-index\n        this._data_layer_ids_by_z_index.forEach((data_layer_id) => {\n            this.data_layers[data_layer_id].draw().render();\n        });\n\n        // Rerender legend last (on top of data). A legend must have been defined at the start in order for this to work.\n        if (this.legend) {\n            this.legend.render();\n        }\n        return this;\n    }\n\n    /**\n     * Add a \"basic\" loader to a panel. This is rarely used directly: the `show_loading_indicator` panel layout\n     *   directive is the preferred way to trigger this function. The imperative form is useful if for some reason a\n     *   loading indicator needs to be added only after first render.\n     * This method is just a shortcut for adding the most commonly used type of loading indicator, which appears when\n     *   data is requested, animates (e.g. shows an infinitely cycling progress bar as opposed to one that loads from\n     *   0-100% based on actual load progress), and disappears when new data is loaded and rendered.\n     *\n     * @protected\n     * @listens event:data_requested\n     * @listens event:data_rendered\n     * @param {Boolean} show_immediately\n     * @returns {Panel}\n     */\n    addBasicLoader(show_immediately = true) {\n        if (this.layout.show_loading_indicator && this._initialized) {\n            // Prior to LZ 0.13, this function was called only after the plot was first rendered. Now, it is run by default.\n            //   Some older pages could thus end up adding a loader twice: to avoid duplicate render events,\n            //   short-circuit if a loader is already present after the first render has finished.\n            return this;\n        }\n        if (show_immediately) {\n            this.loader.show('Loading...').animate();\n        }\n        this.on('data_requested', () => {\n            this.loader.show('Loading...').animate();\n        });\n        this.on('data_rendered', () => {\n            this.loader.hide();\n        });\n\n        // Update layout to reflect new option\n        this.layout.show_loading_indicator = true;\n        return this;\n    }\n\n    /************* Private interface: only used internally */\n    /** @private */\n    applyDataLayerZIndexesToDataLayerLayouts () {\n        this._data_layer_ids_by_z_index.forEach((dlid, idx) => {\n            this.data_layers[dlid].layout.z_index = idx;\n        });\n    }\n\n    /**\n     * @private\n     * @returns {string}\n     */\n    getBaseId () {\n        return `${this.parent.id}.${this.id}`;\n    }\n\n    /**\n     * Get an object with the x and y coordinates of the panel's origin in terms of the entire page\n     * Necessary for positioning any HTML elements over the panel\n     * @private\n     * @returns {{x: Number, y: Number}}\n     */\n    _getPageOrigin() {\n        const plot_origin = this.parent._getPageOrigin();\n        return {\n            x: plot_origin.x + this.layout.origin.x,\n            y: plot_origin.y + this.layout.origin.y,\n        };\n    }\n\n    /**\n     * Prepare the panel for first use by performing parameter validation, creating axes, setting default dimensions,\n     *   and preparing / positioning data layers as appropriate.\n     * @private\n     * @returns {Panel}\n     */\n    initializeLayout() {\n        // Set panel dimensions, origin, and margin\n        this.setDimensions();\n        this.setOrigin();\n        this.setMargin();\n\n        // Set ranges\n        // TODO: Define stub values in constructor\n        this.x_range = [0, this.layout.cliparea.width];\n        this.y1_range = [this.layout.cliparea.height, 0];\n        this.y2_range = [this.layout.cliparea.height, 0];\n\n        // Initialize panel axes\n        ['x', 'y1', 'y2'].forEach((id) => {\n            const axis = this.layout.axes[id];\n            if (!Object.keys(axis).length || axis.render === false) {\n                // The default layout sets the axis to an empty object, so set its render boolean here\n                axis.render = false;\n            } else {\n                axis.render = true;\n                axis.label = axis.label || null;\n            }\n        });\n\n        // Add data layers (which define x and y extents)\n        this.layout.data_layers.forEach((data_layer_layout) => {\n            this.addDataLayer(data_layer_layout);\n        });\n\n        return this;\n    }\n\n    /**\n     * Set the dimensions for the panel. If passed with no arguments will calculate optimal size based on layout\n     *   directives and the available area within the plot. If passed discrete width (number) and height (number) will\n     *   attempt to resize the panel to them, but may be limited by minimum dimensions defined on the plot or panel.\n     *\n     * @private\n     * @param {number} [width]\n     * @param {number} [height]\n     * @returns {Panel}\n     */\n    setDimensions(width, height) {\n        const layout = this.layout;\n        if (typeof width != 'undefined' && typeof height != 'undefined') {\n            if (!isNaN(width) && width >= 0 && !isNaN(height) && height >= 0) {\n                this.parent.layout.width = Math.round(+width);\n                // Ensure that the requested height satisfies all minimum values\n                layout.height = Math.max(Math.round(+height), layout.min_height);\n            }\n        }\n        layout.cliparea.width = Math.max(this.parent_plot.layout.width - (layout.margin.left + layout.margin.right), 0);\n        layout.cliparea.height = Math.max(layout.height - (layout.margin.top + layout.margin.bottom), 0);\n        if (this.svg.clipRect) {\n            this.svg.clipRect\n                .attr('width', this.parent.layout.width)\n                .attr('height', layout.height);\n        }\n        if (this._initialized) {\n            this.render();\n            this.curtain.update();\n            this.loader.update();\n            this.toolbar.update();\n            if (this.legend) {\n                this.legend.position();\n            }\n        }\n        return this;\n    }\n\n    /**\n     * Set panel origin on the plot, and re-render as appropriate\n     *\n     * @private\n     * @param {number} x\n     * @param {number} y\n     * @returns {Panel}\n     */\n    setOrigin(x, y) {\n        if (!isNaN(x) && x >= 0) {\n            this.layout.origin.x = Math.max(Math.round(+x), 0);\n        }\n        if (!isNaN(y) && y >= 0) {\n            this.layout.origin.y = Math.max(Math.round(+y), 0);\n        }\n        if (this._initialized) {\n            this.render();\n        }\n        return this;\n    }\n\n    /**\n     * Set margins around this panel\n     * @private\n     * @param {number} top\n     * @param {number} right\n     * @param {number} bottom\n     * @param {number} left\n     * @returns {Panel}\n     */\n    setMargin(top, right, bottom, left) {\n        let extra;\n        const { cliparea, margin } = this.layout;\n        if (!isNaN(top) && top >= 0) {\n            margin.top = Math.max(Math.round(+top), 0);\n        }\n        if (!isNaN(right)  && right  >= 0) {\n            margin.right = Math.max(Math.round(+right), 0);\n        }\n        if (!isNaN(bottom) && bottom >= 0) {\n            margin.bottom = Math.max(Math.round(+bottom), 0);\n        }\n        if (!isNaN(left)   && left   >= 0) {\n            margin.left = Math.max(Math.round(+left), 0);\n        }\n        // If the specified margins are greater than the available width, then shrink the margins.\n        if (margin.top + margin.bottom > this.layout.height) {\n            extra = Math.floor(((margin.top + margin.bottom) - this.layout.height) / 2);\n            margin.top -= extra;\n            margin.bottom -= extra;\n        }\n        if (margin.left + margin.right > this.parent_plot.layout.width) {\n            extra = Math.floor(((margin.left + margin.right) - this.parent_plot.layout.width) / 2);\n            margin.left -= extra;\n            margin.right -= extra;\n        }\n        ['top', 'right', 'bottom', 'left'].forEach((m) => {\n            margin[m] = Math.max(margin[m], 0);\n        });\n        cliparea.width = Math.max(this.parent_plot.layout.width - (margin.left + margin.right), 0);\n        cliparea.height = Math.max(this.layout.height - (margin.top + margin.bottom), 0);\n        cliparea.origin.x = margin.left;\n        cliparea.origin.y = margin.top;\n\n        if (this._initialized) {\n            this.render();\n        }\n        return this;\n    }\n\n    /**\n     * Prepare the first rendering of the panel. This includes drawing the individual data layers, but also creates shared\n     *   elements such as axes,  title, and loader/curtain.\n     * @private\n     * @returns {Panel}\n     */\n    initialize() {\n        // Append a container group element to house the main panel group element and the clip path\n        // Position with initial layout parameters\n        const base_id = this.getBaseId();\n        this.svg.container = this.parent.svg.append('g')\n            .attr('id', `${base_id}.panel_container`)\n            .attr('transform', `translate(${this.layout.origin.x || 0}, ${this.layout.origin.y || 0})`);\n\n        // Append clip path to the parent svg element, size with initial layout parameters\n        const clipPath = this.svg.container.append('clipPath')\n            .attr('id', `${base_id}.clip`);\n        this.svg.clipRect = clipPath.append('rect')\n            .attr('width', this.parent_plot.layout.width)\n            .attr('height', this.layout.height);\n\n        // Append svg group for rendering all panel child elements, clipped by the clip path\n        this.svg.group = this.svg.container.append('g')\n            .attr('id', `${base_id}.panel`)\n            .attr('clip-path', `url(#${base_id}.clip)`);\n\n        // Add curtain and loader to the panel\n        /**\n         * @protected\n         * @member {Object}\n         */\n        this.curtain = generateCurtain.call(this);\n        /**\n         * @protected\n         * @member {Object}\n         */\n        this.loader = generateLoader.call(this);\n\n        if (this.layout.show_loading_indicator) {\n            // Activate the loading indicator prior to first render, and only show when data is loading\n            this.addBasicLoader(false);\n        }\n\n        /**\n         * Create the toolbar object and hang widgets on it as defined by panel layout\n         * @protected\n         * @member {Toolbar}\n         */\n        this.toolbar = new Toolbar(this);\n\n        // Inner border\n        this.inner_border = this.svg.group.append('rect')\n            .attr('class', 'lz-panel-background')\n            .on('click', () => {\n                if (this.layout.background_click === 'clear_selections') {\n                    this.clearSelections();\n                }\n            });\n\n        // Add the title\n        /**\n         * @private\n         * @member {Element}\n         */\n        this.title = this.svg.group.append('text').attr('class', 'lz-panel-title');\n        if (typeof this.layout.title != 'undefined') {\n            this.setTitle();\n        }\n\n        // Initialize Axes\n        this.svg.x_axis = this.svg.group.append('g')\n            .attr('id', `${base_id}.x_axis`)\n            .attr('class', 'lz-x lz-axis');\n        if (this.layout.axes.x.render) {\n            this.svg.x_axis_label = this.svg.x_axis.append('text')\n                .attr('class', 'lz-x lz-axis lz-label')\n                .attr('text-anchor', 'middle');\n        }\n        this.svg.y1_axis = this.svg.group.append('g')\n            .attr('id', `${base_id}.y1_axis`).attr('class', 'lz-y lz-y1 lz-axis');\n        if (this.layout.axes.y1.render) {\n            this.svg.y1_axis_label = this.svg.y1_axis.append('text')\n                .attr('class', 'lz-y1 lz-axis lz-label')\n                .attr('text-anchor', 'middle');\n        }\n        this.svg.y2_axis = this.svg.group.append('g')\n            .attr('id', `${base_id}.y2_axis`)\n            .attr('class', 'lz-y lz-y2 lz-axis');\n        if (this.layout.axes.y2.render) {\n            this.svg.y2_axis_label = this.svg.y2_axis.append('text')\n                .attr('class', 'lz-y2 lz-axis lz-label')\n                .attr('text-anchor', 'middle');\n        }\n\n        // Initialize child Data Layers\n        this._data_layer_ids_by_z_index.forEach((id) => {\n            this.data_layers[id].initialize();\n        });\n\n        /**\n         * Legend object, as defined by panel layout and child data layer layouts\n         * @protected\n         * @member {Legend}\n         * */\n        this.legend = null;\n        if (this.layout.legend) {\n            this.legend = new Legend(this);\n        }\n\n        // Establish panel background drag interaction mousedown event handler (on the panel background)\n        if (this.layout.interaction.drag_background_to_pan) {\n            const namespace = `.${this.parent.id}.${this.id}.interaction.drag`;\n            const mousedown = () => this.parent.startDrag(this, 'background');\n            this.svg.container.select('.lz-panel-background')\n                .on(`mousedown${namespace}.background`, mousedown)\n                .on(`touchstart${namespace}.background`, mousedown);\n        }\n\n        return this;\n    }\n\n    /**\n     * Refresh the sort order of all data layers (called by data layer moveForward and moveBack methods)\n     * @private\n     */\n    resortDataLayers() {\n        const sort = [];\n        this._data_layer_ids_by_z_index.forEach((id) => {\n            sort.push(this.data_layers[id].layout.z_index);\n        });\n        this.svg.group\n            .selectAll('g.lz-data_layer-container')\n            .data(sort)\n            .sort(d3.ascending);\n        this.applyDataLayerZIndexesToDataLayerLayouts();\n    }\n\n    /**\n     * Get an array of panel IDs that are axis-linked to this panel\n     * @private\n     * @param {('x'|'y1'|'y2')} axis\n     * @returns {Array}\n     */\n    getLinkedPanelIds(axis) {\n        axis = axis || null;\n        const linked_panel_ids = [];\n        if (!['x', 'y1', 'y2'].includes(axis)) {\n            return linked_panel_ids;\n        }\n        if (!this.layout.interaction[`${axis}_linked`]) {\n            return linked_panel_ids;\n        }\n        this.parent._panel_ids_by_y_index.forEach((panel_id) => {\n            if (panel_id !== this.id && this.parent.panels[panel_id].layout.interaction[`${axis}_linked`]) {\n                linked_panel_ids.push(panel_id);\n            }\n        });\n        return linked_panel_ids;\n    }\n\n    /**\n     * Move a panel up relative to others by y-index\n     * @private\n     * @returns {Panel}\n     */\n    moveUp() {\n        const { parent } = this;\n        const y_index = this.layout.y_index;\n        if (parent._panel_ids_by_y_index[y_index - 1]) {\n            parent._panel_ids_by_y_index[y_index] = parent._panel_ids_by_y_index[y_index - 1];\n            parent._panel_ids_by_y_index[y_index - 1] = this.id;\n            parent.applyPanelYIndexesToPanelLayouts();\n            parent.positionPanels();\n        }\n        return this;\n    }\n\n    /**\n     * Move a panel down (y-axis) relative to others in the plot\n     * @private\n     * @returns {Panel}\n     */\n    moveDown() {\n        const { _panel_ids_by_y_index } = this.parent;\n        if (_panel_ids_by_y_index[this.layout.y_index + 1]) {\n            _panel_ids_by_y_index[this.layout.y_index] = _panel_ids_by_y_index[this.layout.y_index + 1];\n            _panel_ids_by_y_index[this.layout.y_index + 1] = this.id;\n            this.parent.applyPanelYIndexesToPanelLayouts();\n            this.parent.positionPanels();\n        }\n        return this;\n    }\n\n    /**\n     * When the parent plot changes state, adjust the panel accordingly. For example, this may include fetching new data\n     *   from the API as the viewing region changes\n     * @private\n     * @fires event:data_requested\n     * @fires event:layout_changed\n     * @fires event:data_rendered\n     * @returns {Promise}\n     */\n    reMap() {\n        this.emit('data_requested');\n        this._data_promises = [];\n\n        // Remove any previous error messages before attempting to load new data\n        this.curtain.hide();\n        // Trigger reMap on each Data Layer\n        for (let id in this.data_layers) {\n            try {\n                this._data_promises.push(this.data_layers[id].reMap());\n            } catch (error) {\n                console.error(error);\n                this.curtain.show(error.message || error);\n            }\n        }\n        // When all finished trigger a render\n        return Promise.all(this._data_promises)\n            .then(() => {\n                this._initialized = true;\n                this.render();\n                this.emit('layout_changed', true);\n                this.emit('data_rendered');\n            })\n            .catch((error) => {\n                console.error(error);\n                this.curtain.show(error.message || error);\n            });\n    }\n\n    /**\n     * Iterate over data layers to generate panel axis extents\n     * @private\n     * @returns {Panel}\n     */\n    generateExtents() {\n        // Reset extents\n        ['x', 'y1', 'y2'].forEach((axis) => {\n            this[`${axis}_extent`] = null;\n        });\n\n        // Loop through the data layers\n        for (let id in this.data_layers) {\n            const data_layer = this.data_layers[id];\n\n            // If defined and not decoupled, merge the x extent of the data layer with the panel's x extent\n            if (data_layer.layout.x_axis && !data_layer.layout.x_axis.decoupled) {\n                this.x_extent = d3.extent((this.x_extent || []).concat(data_layer.getAxisExtent('x')));\n            }\n\n            // If defined and not decoupled, merge the y extent of the data layer with the panel's appropriate y extent\n            if (data_layer.layout.y_axis && !data_layer.layout.y_axis.decoupled) {\n                const y_axis = `y${data_layer.layout.y_axis.axis}`;\n                this[`${y_axis}_extent`] = d3.extent((this[`${y_axis}_extent`] || []).concat(data_layer.getAxisExtent('y')));\n            }\n\n        }\n\n        // Override x_extent from state if explicitly defined to do so\n        if (this.layout.axes.x && this.layout.axes.x.extent === 'state') {\n            this.x_extent = [ this.state.start, this.state.end ];\n        }\n        return this;\n    }\n\n    /**\n     * Generate an array of ticks for an axis. These ticks are generated in one of three ways (highest wins):\n     *   1. An array of specific tick marks\n     *   2. Query each data layer for what ticks are appropriate, and allow a panel-level tick configuration parameter\n     *     object to override the layer's default presentation settings\n     *   3. Generate generic tick marks based on the extent of the data\n     *\n     * @private\n     * @param {('x'|'y1'|'y2')} axis The string identifier of the axis\n     * @returns {Number[]|Object[]}  TODO: number format?\n     *   An array of numbers: interpreted as an array of axis value offsets for positioning.\n     *   An array of objects: each object must have an 'x' attribute to position the tick.\n     *   Other supported object keys:\n     *     * text: string to render for a given tick\n     *     * style: d3-compatible CSS style object\n     *     * transform: SVG transform attribute string\n     *     * color: string or LocusZoom scalable parameter object\n     */\n    generateTicks(axis) {\n        // Parse an explicit 'ticks' attribute in the axis layout\n        if (this.layout.axes[axis].ticks) {\n            const layout = this.layout.axes[axis];\n\n            const baseTickConfig = layout.ticks;\n            if (Array.isArray(baseTickConfig)) {\n                // Array of specific ticks hard-coded into a panel will override any ticks that an individual layer might specify\n                return baseTickConfig;\n            }\n\n            if (typeof baseTickConfig === 'object') {\n                // If the layout specifies base configuration for ticks- but without specific positions- then ask each\n                //   data layer to report the tick marks that it thinks it needs\n                // TODO: Few layers currently need to specify custom ticks (which is ok!). But if it becomes common, consider adding mechanisms to deduplicate ticks across layers\n                const self = this;\n\n                // Pass any layer-specific customizations for how ticks are calculated. (styles are overridden separately)\n                const config = { position: baseTickConfig.position };\n\n                const combinedTicks = this._data_layer_ids_by_z_index.reduce((acc, data_layer_id) => {\n                    const nextLayer = self.data_layers[data_layer_id];\n                    return acc.concat(nextLayer.getTicks(axis, config));\n                }, []);\n\n                return combinedTicks.map((item) => {\n                    // The layer makes suggestions, but tick configuration params specified on the panel take precedence\n                    let itemConfig = {};\n                    itemConfig = merge(itemConfig, baseTickConfig);\n                    return merge(itemConfig, item);\n                });\n            }\n        }\n\n        // If no other configuration is provided, attempt to generate ticks from the extent\n        if (this[`${axis}_extent`]) {\n            return prettyTicks(this[`${axis}_extent`], 'both');\n        }\n        return [];\n    }\n\n    /**\n     * Render ticks for a particular axis\n     * @private\n     * @param {('x'|'y1'|'y2')} axis The identifier of the axes\n     * @returns {Panel}\n     */\n    renderAxis(axis) {\n        if (!['x', 'y1', 'y2'].includes(axis)) {\n            throw new Error(`Unable to render axis; invalid axis identifier: ${axis}`);\n        }\n\n        const canRender = this.layout.axes[axis].render\n            && typeof this[`${axis}_scale`] == 'function'\n            && !isNaN(this[`${axis}_scale`](0));\n\n        // If the axis has already been rendered then check if we can/can't render it\n        // Make sure the axis element is shown/hidden to suit\n        if (this[`${axis}_axis`]) {\n            this.svg.container.select(`g.lz-axis.lz-${axis}`)\n                .style('display', canRender ? null : 'none');\n        }\n\n        if (!canRender) {\n            return this;\n        }\n\n        // Axis-specific values to plug in where needed\n        const axis_params = {\n            x: {\n                position: `translate(${this.layout.margin.left}, ${this.layout.height - this.layout.margin.bottom})`,\n                orientation: 'bottom',\n                label_x: this.layout.cliparea.width / 2,\n                label_y: (this.layout.axes[axis].label_offset || 0),\n                label_rotate: null,\n            },\n            y1: {\n                position: `translate(${this.layout.margin.left}, ${this.layout.margin.top})`,\n                orientation: 'left',\n                label_x: -1 * (this.layout.axes[axis].label_offset || 0),\n                label_y: this.layout.cliparea.height / 2,\n                label_rotate: -90,\n            },\n            y2: {\n                position: `translate(${this.parent_plot.layout.width - this.layout.margin.right}, ${this.layout.margin.top})`,\n                orientation: 'right',\n                label_x: (this.layout.axes[axis].label_offset || 0),\n                label_y: this.layout.cliparea.height / 2,\n                label_rotate: -90,\n            },\n        };\n\n        // Generate Ticks\n        this[`${axis}_ticks`] = this.generateTicks(axis);\n\n        // Determine if the ticks are all numbers (d3-automated tick rendering) or not (manual tick rendering)\n        const ticksAreAllNumbers = ((ticks) => {\n            for (let i = 0; i < ticks.length; i++) {\n                if (isNaN(ticks[i])) {\n                    return false;\n                }\n            }\n            return true;\n        })(this[`${axis}_ticks`]);\n\n        // Initialize the axis; set scale and orientation\n        let axis_factory;\n        switch (axis_params[axis].orientation) {\n        case 'right':\n            axis_factory = d3.axisRight;\n            break;\n        case 'left':\n            axis_factory = d3.axisLeft;\n            break;\n        case 'bottom':\n            axis_factory = d3.axisBottom;\n            break;\n        default:\n            throw new Error('Unrecognized axis orientation');\n        }\n\n        this[`${axis}_axis`] = axis_factory(this[`${axis}_scale`])\n            .tickPadding(3);\n\n        // Set tick values and format\n        if (ticksAreAllNumbers) {\n            this[`${axis}_axis`].tickValues(this[`${axis}_ticks`]);\n            if (this.layout.axes[axis].tick_format === 'region') {\n                this[`${axis}_axis`].tickFormat((d) => positionIntToString(d, 6));\n            }\n        } else {\n            let ticks = this[`${axis}_ticks`].map((t) => {\n                return (t[axis.substr(0, 1)]);\n            });\n            this[`${axis}_axis`].tickValues(ticks)\n                .tickFormat((t, i) => {\n                    return this[`${axis}_ticks`][i].text;\n                });\n        }\n\n        // Position the axis in the SVG and apply the axis construct\n        this.svg[`${axis}_axis`]\n            .attr('transform', axis_params[axis].position)\n            .call(this[`${axis}_axis`]);\n\n        // If necessary manually apply styles and transforms to ticks as specified by the layout\n        if (!ticksAreAllNumbers) {\n            const tick_selector = d3.selectAll(`g#${this.getBaseId().replace('.', '\\\\.')}\\\\.${axis}_axis g.tick`);\n            const panel = this;\n            tick_selector.each(function (d, i) {\n                const selector = d3.select(this).select('text');\n                if (panel[`${axis}_ticks`][i].style) {\n                    applyStyles(selector, panel[`${axis}_ticks`][i].style);\n                }\n                if (panel[`${axis}_ticks`][i].transform) {\n                    selector.attr('transform', panel[`${axis}_ticks`][i].transform);\n                }\n            });\n        }\n\n        // Render the axis label if necessary\n        const label = this.layout.axes[axis].label || null;\n        if (label !== null) {\n            this.svg[`${axis}_axis_label`]\n                .attr('x', axis_params[axis].label_x)\n                .attr('y', axis_params[axis].label_y)\n                .text(parseFields(label, this.state))\n                .attr('fill', 'currentColor');\n            if (axis_params[axis].label_rotate !== null) {\n                this.svg[`${axis}_axis_label`]\n                    .attr('transform', `rotate(${axis_params[axis].label_rotate} ${axis_params[axis].label_x}, ${axis_params[axis].label_y})`);\n            }\n        }\n\n        // Attach interactive handlers to ticks as needed\n        ['x', 'y1', 'y2'].forEach((axis) => {\n            if (this.layout.interaction[`drag_${axis}_ticks_to_scale`]) {\n                const namespace = `.${this.parent.id}.${this.id}.interaction.drag`;\n                const tick_mouseover = function() {\n                    if (typeof d3.select(this).node().focus == 'function') {\n                        d3.select(this).node().focus();\n                    }\n                    let cursor = (axis === 'x') ? 'ew-resize' : 'ns-resize';\n                    if (d3.event && d3.event.shiftKey) {\n                        cursor = 'move';\n                    }\n                    d3.select(this)\n                        .style('font-weight', 'bold')\n                        .style('cursor', cursor )\n                        .on(`keydown${namespace}`, tick_mouseover)\n                        .on(`keyup${namespace}`, tick_mouseover);\n                };\n                this.svg.container.selectAll(`.lz-axis.lz-${axis} .tick text`)\n                    .attr('tabindex', 0) // necessary to make the tick focusable so keypress events can be captured\n                    .on(`mouseover${namespace}`, tick_mouseover)\n                    .on(`mouseout${namespace}`, function() {\n                        d3.select(this)\n                            .style('font-weight', 'normal')\n                            .on(`keydown${namespace}`, null)\n                            .on(`keyup${namespace}`, null);\n                    })\n                    .on(`mousedown${namespace}`, () => {\n                        this.parent.startDrag(this, `${axis}_tick`);\n                    });\n            }\n        });\n\n        return this;\n    }\n\n    /**\n     * Force the height of this panel to the largest absolute height of the data in\n     *   all child data layers (if not null for any child data layers)\n     * @private\n     * @param {number|null} [target_height] A target height, which will be used in situations when the expected height can be\n     *   pre-calculated (eg when the layers are transitioning)\n     */\n    scaleHeightToData(target_height) {\n        target_height = +target_height || null;\n        if (target_height === null) {\n            this._data_layer_ids_by_z_index.forEach((id) => {\n                const dh = this.data_layers[id].getAbsoluteDataHeight();\n                if (+dh) {\n                    if (target_height === null) {\n                        target_height = +dh;\n                    } else {\n                        target_height = Math.max(target_height, +dh);\n                    }\n                }\n            });\n        }\n        if (+target_height) {\n            target_height += +this.layout.margin.top + +this.layout.margin.bottom;\n            // FIXME: plot.setDimensions calls panel.setDimensions (though without arguments)\n            this.setDimensions(this.parent_plot.layout.width, target_height);\n            this.parent.setDimensions();\n            this.parent.positionPanels();\n        }\n    }\n\n    /**\n     * Set/unset element statuses across all data layers\n     * @private\n     * @param {String} status\n     * @param {Boolean} toggle\n     */\n    setAllElementStatus(status, toggle) {\n        this._data_layer_ids_by_z_index.forEach((id) => {\n            this.data_layers[id].setAllElementStatus(status, toggle);\n        });\n    }\n}\n\nSTATUSES.verbs.forEach((verb, idx) => {\n    const adjective = STATUSES.adjectives[idx];\n    const antiverb = `un${verb}`;\n\n    // Set/unset status for all elements\n    /**\n     * @private\n     * @function highlightAllElements\n     */\n    /**\n     *  @private\n     *  @function selectAllElements\n     */\n    /**\n     *  @private\n     *  @function fadeAllElements\n     */\n    /**\n     *  @private\n     *  @function hideAllElements\n     */\n    Panel.prototype[`${verb}AllElements`] = function() {\n        this.setAllElementStatus(adjective, true);\n        return this;\n    };\n\n    /**\n     * @private\n     * @function unhighlightAllElements\n     */\n    /**\n     *  @private\n     *  @function unselectAllElements\n     */\n    /**\n     * @private\n     * @function unfadeAllElements\n     */\n    /**\n     *  @private\n     *  @function unhideAllElements\n     */\n    Panel.prototype[`${antiverb}AllElements`] = function() {\n        this.setAllElementStatus(adjective, false);\n        return this;\n    };\n});\n\nexport {Panel as default};\n","/**\n * Helpers that control the display of individual points and field values\n * @module\n * @private\n */\nimport * as d3 from 'd3';\n\nimport Field from '../data/field';\nimport Plot from '../components/plot';\nimport {applyStyles} from './common';\n\n\n/**\n * Convert an integer chromosome position to an SI string representation (e.g. 23423456 => \"23.42\" (Mb))\n * @param {Number} pos Position\n * @param {Number} [exp] Exponent to use for the returned string, eg 6=> MB. If not specified, will attempt to guess\n *   the most appropriate SI prefix based on the number provided.\n * @param {Boolean} [suffix=false] Whether or not to append a suffix (e.g. \"Mb\") to the end of the returned string\n * @returns {string}\n */\nfunction positionIntToString(pos, exp, suffix) {\n    const exp_symbols = { 0: '', 3: 'K', 6: 'M', 9: 'G' };\n    suffix = suffix || false;\n    if (isNaN(exp) || exp === null) {\n        const log = Math.log(pos) / Math.LN10;\n        exp = Math.min(Math.max(log - (log % 3), 0), 9);\n    }\n    const places_exp = exp - Math.floor((Math.log(pos) / Math.LN10).toFixed(exp + 3));\n    const min_exp = Math.min(Math.max(exp, 0), 2);\n    const places = Math.min(Math.max(places_exp, min_exp), 12);\n    let ret = `${(pos / Math.pow(10, exp)).toFixed(places)}`;\n    if (suffix && typeof exp_symbols[exp] !== 'undefined') {\n        ret += ` ${exp_symbols[exp]}b`;\n    }\n    return ret;\n}\n\n/**\n * Convert an SI string chromosome position to an integer representation (e.g. \"5.8 Mb\" => 58000000)\n * @param {String} p The chromosome position\n * @returns {Number}\n */\nfunction positionStringToInt(p) {\n    let val = p.toUpperCase();\n    val = val.replace(/,/g, '');\n    const suffixre = /([KMG])[B]*$/;\n    const suffix = suffixre.exec(val);\n    let mult = 1;\n    if (suffix) {\n        if (suffix[1] === 'M') {\n            mult = 1e6;\n        } else if (suffix[1] === 'G') {\n            mult = 1e9;\n        } else {\n            mult = 1e3; //K\n        }\n        val = val.replace(suffixre, '');\n    }\n    val = Number(val) * mult;\n    return val;\n}\n\n/**\n * Generate a \"pretty\" set of ticks (multiples of 1, 2, or 5 on the same order of magnitude for the range)\n *   Based on R's \"pretty\" function: https://github.com/wch/r-source/blob/b156e3a711967f58131e23c1b1dc1ea90e2f0c43/src/appl/pretty.c\n * @param {Number[]} range A two-item array specifying [low, high] values for the axis range\n * @param {('low'|'high'|'both'|'neither')} [clip_range='neither'] What to do if first and last generated ticks extend\n *   beyond the range. Set this to \"low\", \"high\", \"both\", or \"neither\" to clip the first (low) or last (high) tick to\n *   be inside the range or allow them to extend beyond.\n *   e.g. \"low\" will clip the first (low) tick if it extends beyond the low end of the range but allow the\n *  last (high) tick to extend beyond the range. \"both\" clips both ends, \"neither\" allows both to extend beyond.\n * @param {Number} [target_tick_count=5] The approximate number of ticks you would like to be returned; may not be exact\n * @returns {Number[]}\n */\nfunction prettyTicks(range, clip_range, target_tick_count) {\n    if (typeof target_tick_count == 'undefined' || isNaN(parseInt(target_tick_count))) {\n        target_tick_count = 5;\n    }\n    target_tick_count = +target_tick_count;\n\n    const min_n = target_tick_count / 3;\n    const shrink_sml = 0.75;\n    const high_u_bias = 1.5;\n    const u5_bias = 0.5 + 1.5 * high_u_bias;\n\n    const d = Math.abs(range[0] - range[1]);\n    let c = d / target_tick_count;\n    if ((Math.log(d) / Math.LN10) < -2) {\n        c = (Math.max(Math.abs(d)) * shrink_sml) / min_n;\n    }\n\n    const base = Math.pow(10, Math.floor(Math.log(c) / Math.LN10));\n    let base_toFixed = 0;\n    if (base < 1 && base !== 0) {\n        base_toFixed = Math.abs(Math.round(Math.log(base) / Math.LN10));\n    }\n\n    let unit = base;\n    if ( ((2 * base) - c) < (high_u_bias * (c - unit)) ) {\n        unit = 2 * base;\n        if ( ((5 * base) - c) < (u5_bias * (c - unit)) ) {\n            unit = 5 * base;\n            if ( ((10 * base) - c) < (high_u_bias * (c - unit)) ) {\n                unit = 10 * base;\n            }\n        }\n    }\n\n    let ticks = [];\n    let i = parseFloat((Math.floor(range[0] / unit) * unit).toFixed(base_toFixed));\n    while (i < range[1]) {\n        ticks.push(i);\n        i += unit;\n        if (base_toFixed > 0) {\n            i = parseFloat(i.toFixed(base_toFixed));\n        }\n    }\n    ticks.push(i);\n\n    if (typeof clip_range == 'undefined' || ['low', 'high', 'both', 'neither'].indexOf(clip_range) === -1) {\n        clip_range = 'neither';\n    }\n    if (clip_range === 'low' || clip_range === 'both') {\n        if (ticks[0] < range[0]) {\n            ticks = ticks.slice(1);\n        }\n    }\n    if (clip_range === 'high' || clip_range === 'both') {\n        if (ticks[ticks.length - 1] > range[1]) {\n            ticks.pop();\n        }\n    }\n\n    return ticks;\n}\n\n/**\n * Replace placeholders in an html string with field values defined in a data object\n *  Only works on scalar values in data! Will ignore non-scalars. This is useful in, eg, tooltip templates.\n *\n *  NOTE: Trusts content exactly as given. XSS prevention is the responsibility of the implementer.\n * @param {String} html A placeholder string in which to substitute fields. Supports several template options:\n *   `{{field_name}}` is a variable placeholder for the value of `field_name` from the provided data\n *   `{{#if field_name}} Conditional text {{/if}}` will insert the contents of the tag only if the value exists.\n *     This can be used with namespaced values, `{{#if assoc:field}}`; any dynamic namespacing will be applied when the\n *     layout is first retrieved. For numbers, transforms like `{{#if field|is_numeric}}` can help to ensure that 0\n *     values are displayed when expected.\n *     Can optionally take an else block, useful for things like toggle buttons: {{#if field}} ... {{#else}} ... {{/if}}\n * @param {Object} data The data associated with a particular element. Eg, tooltips often appear over a specific point.\n * @param {Object|null} extra Any additional fields (eg element annotations) associated with the specified datum\n * @returns {string}\n */\nfunction parseFields(html, data, extra) {\n    if (typeof data != 'object') {\n        throw new Error('invalid arguments: data is not an object');\n    }\n    if (typeof html != 'string') {\n        throw new Error('invalid arguments: html is not a string');\n    }\n    // `tokens` is like [token,...]\n    // `token` is like {text: '...'} or {variable: 'foo|bar'} or {condition: 'foo|bar'} or {close: 'if'}\n    const tokens = [];\n    const regex = /{{(?:(#if )?([\\w+_:|]+)|(#else)|(\\/if))}}/;\n    while (html.length > 0) {\n        const m = regex.exec(html);\n        if (!m) {\n            tokens.push({text: html});\n            html = '';\n        } else if (m.index !== 0) {\n            tokens.push({text: html.slice(0, m.index)});\n            html = html.slice(m.index);\n        } else if (m[1] === '#if ') {\n            tokens.push({condition: m[2]});\n            html = html.slice(m[0].length);\n        } else if (m[2]) {\n            tokens.push({variable: m[2]});\n            html = html.slice(m[0].length);\n        } else if (m[3] === '#else') {\n            tokens.push({branch: 'else'});\n            html = html.slice(m[0].length);\n        } else if (m[4] === '/if') {\n            tokens.push({close: 'if'});\n            html = html.slice(m[0].length);\n        } else {\n            console.error(`Error tokenizing tooltip when remaining template is ${JSON.stringify(html)} and previous tokens are ${JSON.stringify(tokens)} and current regex match is ${JSON.stringify([m[1], m[2], m[3]])}`);\n            html = html.slice(m[0].length);\n        }\n    }\n    const astify = function () {\n        const token = tokens.shift();\n        if (typeof token.text !== 'undefined' || token.variable) {\n            return token;\n        } else if (token.condition) {\n            let dest = token.then = [];\n            token.else = [];\n            // Inside an if block, consume all tokens related to text and/or else block\n            while (tokens.length > 0) {\n                if (tokens[0].close === 'if') {\n                    tokens.shift();\n                    break;\n                }\n                if (tokens[0].branch === 'else') {\n                    tokens.shift();\n                    dest = token.else;\n                }\n                dest.push(astify());\n            }\n            return token;\n        } else {\n            console.error(`Error making tooltip AST due to unknown token ${JSON.stringify(token)}`);\n            return { text: '' };\n        }\n    };\n    // `ast` is like [thing,...]\n    // `thing` is like {text: \"...\"} or {variable:\"foo|bar\"} or {condition: \"foo|bar\", then:[thing,...]}\n    const ast = [];\n    while (tokens.length > 0) {\n        ast.push(astify());\n    }\n\n    const resolve = function (variable) {\n        if (!Object.prototype.hasOwnProperty.call(resolve.cache, variable)) {\n            resolve.cache[variable] = (new Field(variable)).resolve(data, extra);\n        }\n        return resolve.cache[variable];\n    };\n    resolve.cache = {};\n    const render_node = function (node) {\n        if (typeof node.text !== 'undefined') {\n            return node.text;\n        } else if (node.variable) {\n            try {\n                const value = resolve(node.variable);\n                if (['string', 'number', 'boolean'].indexOf(typeof value) !== -1) {\n                    return value;\n                }\n                if (value === null) {\n                    return '';\n                }\n            } catch (error) {\n                console.error(`Error while processing variable ${JSON.stringify(node.variable)}`);\n            }\n            return `{{${node.variable}}}`;\n        } else if (node.condition) {\n            try {\n                const condition = resolve(node.condition);\n                if (condition) {\n                    return node.then.map(render_node).join('');\n                } else if (node.else) {\n                    return node.else.map(render_node).join('');\n                }\n            } catch (error) {\n                console.error(`Error while processing condition ${JSON.stringify(node.variable)}`);\n            }\n            return '';\n        } else {\n            console.error(`Error rendering tooltip due to unknown AST node ${JSON.stringify(node)}`);\n        }\n    };\n    return ast.map(render_node).join('');\n}\n\n/**\n * Populate a single element with a LocusZoom plot. This is the primary means of generating a new plot, and is part\n *  of the public interface for LocusZoom.\n * @alias module:LocusZoom~populate\n * @public\n * @param {String|d3.selection} selector CSS selector for the container element where the plot will be mounted. Any pre-existing\n *   content in the container will be completely replaced.\n * @param {module:LocusZoom~DataSources} datasource Ensemble of data providers used by the plot\n * @param {Object} layout A JSON-serializable object of layout configuration parameters\n * @returns {Plot} The newly created plot instance\n */\nfunction populate(selector, datasource, layout) {\n    if (typeof selector == 'undefined') {\n        throw new Error('LocusZoom.populate selector not defined');\n    }\n    // Empty the selector of any existing content\n    d3.select(selector).html('');\n    let plot;\n    d3.select(selector).call(function(target) {\n        // Require each containing element have an ID. If one isn't present, create one.\n        if (typeof target.node().id == 'undefined') {\n            let iterator = 0;\n            while (!d3.select(`#lz-${iterator}`).empty()) {\n                iterator++;\n            }\n            target.attr('id', `#lz-${iterator}`);\n        }\n        // Create the plot\n        plot = new Plot(target.node().id, datasource, layout);\n        plot.container = target.node();\n        // Detect HTML `data-region` attribute, and use it to fill in state values if present\n        if (typeof target.node().dataset !== 'undefined' && typeof target.node().dataset.region !== 'undefined') {\n            const parsed_state = parsePositionQuery(target.node().dataset.region);\n            Object.keys(parsed_state).forEach(function(key) {\n                plot.state[key] = parsed_state[key];\n            });\n        }\n        // Add an SVG to the div and set its dimensions\n        plot.svg = d3.select(`div#${plot.id}`)\n            .append('svg')\n            .attr('version', '1.1')\n            .attr('xmlns', 'http://www.w3.org/2000/svg')\n            .attr('id', `${plot.id}_svg`)\n            .attr('class', 'lz-locuszoom')\n            .call(applyStyles, plot.layout.style);\n\n        plot.setDimensions();\n        plot.positionPanels();\n        // Initialize the plot\n        plot.initialize();\n        // If the plot has defined data sources then trigger its first mapping based on state values\n        if (datasource) {\n            plot.refresh();\n        }\n    });\n    return plot;\n}\n\n/**\n * Parse region queries into their constituent parts\n * @param {String} x A chromosome position query. May be any of the forms `chr:start-end`, `chr:center+offset`,\n *   or `chr:pos`\n * @returns {{chr:*, start: *, end:*} | {chr:*, position:*}}\n */\nfunction parsePositionQuery(x) {\n    const chrposoff = /^(\\w+):([\\d,.]+[kmgbKMGB]*)([-+])([\\d,.]+[kmgbKMGB]*)$/;\n    const chrpos = /^(\\w+):([\\d,.]+[kmgbKMGB]*)$/;\n    let match = chrposoff.exec(x);\n    if (match) {\n        if (match[3] === '+') {\n            const center = positionStringToInt(match[2]);\n            const offset = positionStringToInt(match[4]);\n            return {\n                chr:match[1],\n                start: center - offset,\n                end: center + offset,\n            };\n        } else {\n            return {\n                chr: match[1],\n                start: positionStringToInt(match[2]),\n                end: positionStringToInt(match[4]),\n            };\n        }\n    }\n    match = chrpos.exec(x);\n    if (match) {\n        return {\n            chr:match[1],\n            position: positionStringToInt(match[2]),\n        };\n    }\n    return null;\n}\n\nexport { parseFields, parsePositionQuery, populate, positionIntToString, positionStringToInt, prettyTicks };\n","import * as d3 from 'd3';\n\nimport {deepCopy, merge} from '../helpers/layouts';\nimport Requester from '../data/requester';\nimport Toolbar from './toolbar';\nimport Panel from './panel';\nimport {generateCurtain, generateLoader} from '../helpers/common';\n\n/**\n * Default/ expected configuration parameters for basic plotting; most plots will override\n *\n * @memberof Plot\n * @protected\n * @static\n * @type {Object}\n */\nconst default_layout = {\n    state: {},\n    width: 800,\n    min_width: 400,\n    min_region_scale: null,\n    max_region_scale: null,\n    responsive_resize: false,\n    panels: [],\n    toolbar: {\n        widgets: [],\n    },\n    panel_boundaries: true,\n    mouse_guide: true,\n};\n\n\n/**\n * Fields common to every event emitted by LocusZoom. This is not an actual event that should ever be used directly;\n *  see list below.\n *\n * Note: plot-level listeners *can* be defined for this event, but you should almost never do this.\n *  Use the most specific event name to describe the thing you are interested in.\n *\n * Listening to 'any_lz_event' is only for advanced usages, such as proxying (repeating) LZ behavior to a piece of\n *  wrapper code. One example is converting all LocusZoom events to vue.js events.\n *\n * @event any_lz_event\n * @type {object}\n * @property {string} sourceID The fully qualified ID of the entity that originated the event, eg `lz-plot.association`\n * @property {Plot|Panel} target A reference to the plot or panel instance that originated the event.\n * @property {object|null} data Additional data provided. (see event-specific documentation)\n */\n\n/**\n * A panel was removed from the plot. Commonly initiated by the \"remove panel\" toolbar widget.\n * @event panel_removed\n * @property {string} data The id of the panel that was removed (eg 'genes')\n * @see event:any_lz_event\n */\n\n/**\n * A request for new or cached data was initiated. This can be used for, eg, showing data loading indicators.\n * @event data_requested\n * @see event:any_lz_event\n */\n\n/**\n * A request for new data has completed, and all data has been rendered in the plot.\n * @event data_rendered\n * @see event:any_lz_event\n */\n\n/**\n * One particular data layer has completed a request for data. This event is primarily used internally by the `subscribeToData` function, and the syntax may change in the future.\n * @event data_from_layer\n * @property {object} data\n * @property {String} data.layer The fully qualified ID of the layer emitting this event\n * @property {Object[]} data.content The data used to draw this layer: an array where each element represents one row/ datum\n *  element. It reflects all namespaces and data operations used by that layer.\n * @see event:any_lz_event\n */\n\n\n/**\n * An action occurred that changed, or could change, the layout.\n *   Many rerendering operations can fire this event and it is somewhat generic: it includes resize, highlight,\n *   and rerender on new data.\n * Caution: Direct layout mutations might not be captured by this event. It is deprecated due to its limited utility.\n * @event layout_changed\n * @deprecated\n * @see event:any_lz_event\n */\n\n/**\n * The user has requested any state changes, eg via `plot.applyState`. This reports the original requested values even\n *  if they are overridden by plot logic. Only triggered when a state change causes a re-render.\n * @event state_changed\n * @property {object} data The set of all state changes requested\n * @see event:any_lz_event\n * @see {@link event:region_changed} for a related event that provides more accurate information in some cases\n */\n\n/**\n * The plot region has changed. Reports the actual coordinates of the plot after the zoom event. If plot.applyState is\n *  called with an invalid region (eg zooming in or out too far), this reports the actual final coordinates, not what was requested.\n *  The actual coordinates are subject to region min/max, etc.\n * @event region_changed\n * @property {object} data The {chr, start, end} coordinates of the requested region.\n * @see event:any_lz_event\n */\n\n/**\n * Indicate whether the element was selected (or unselected)\n * @event element_selection\n * @property {object} data An object with keys { element, active }, representing the datum bound to the element and the\n *   selection status (boolean)\n * @see {@link event:element_clicked} if you are interested in tracking clicks that result in other behaviors, like links\n * @see event:any_lz_event\n */\n\n/**\n * Indicates whether an element was clicked. (regardless of the behavior associated with clicking)\n * @event element_clicked\n * @see {@link event:element_selection} for a more specific and more frequently useful event\n * @see event:any_lz_event\n */\n\n/**\n * Indicate whether a match was requested from within a data layer.\n * @event match_requested\n * @property {object} data An object of `{value, active}` representing the scalar value to be matched and whether a match is\n *   being initiated or canceled\n * @see event:any_lz_event\n */\n\n/**\n * Check that position fields (chr, start, end) are provided where appropriate, and ensure that the plot fits within\n *  any constraints specified by the layout\n *\n * This function has side effects; it mutates the proposed state in order to meet certain bounds checks etc.\n * @private\n * @param {Object} new_state\n * @param {Number} new_state.chr\n * @param {Number} new_state.start\n * @param {Number} new_state.end\n * @param {Object} layout\n * @returns {*|{}}\n */\nfunction _updateStatePosition(new_state, layout) {\n\n    new_state = new_state || {};\n    layout = layout || {};\n\n    // If a \"chr\", \"start\", and \"end\" are present then resolve start and end\n    // to numeric values that are not decimal, negative, or flipped\n    let validated_region = false;\n    let attempted_midpoint = null;\n    let attempted_scale;\n    if (typeof new_state.chr != 'undefined' && typeof new_state.start != 'undefined' && typeof new_state.end != 'undefined') {\n        // Determine a numeric scale and midpoint for the attempted region,\n        new_state.start = Math.max(parseInt(new_state.start), 1);\n        new_state.end = Math.max(parseInt(new_state.end), 1);\n        if (isNaN(new_state.start) && isNaN(new_state.end)) {\n            new_state.start = 1;\n            new_state.end = 1;\n            attempted_midpoint = 0.5;\n            attempted_scale = 0;\n        } else if (isNaN(new_state.start) || isNaN(new_state.end)) {\n            attempted_midpoint = new_state.start || new_state.end;\n            attempted_scale = 0;\n            new_state.start = (isNaN(new_state.start) ? new_state.end : new_state.start);\n            new_state.end = (isNaN(new_state.end) ? new_state.start : new_state.end);\n        } else {\n            attempted_midpoint = Math.round((new_state.start + new_state.end) / 2);\n            attempted_scale = new_state.end - new_state.start;\n            if (attempted_scale < 0) {\n                const temp = new_state.start;\n                new_state.end = new_state.start;\n                new_state.start = temp;\n                attempted_scale = new_state.end - new_state.start;\n            }\n            if (attempted_midpoint < 0) {\n                new_state.start = 1;\n                new_state.end = 1;\n                attempted_scale = 0;\n            }\n        }\n        validated_region = true;\n    }\n\n    // Constrain w/r/t layout-defined minimum region scale\n    if (layout.min_region_scale && validated_region && attempted_scale < layout.min_region_scale) {\n        new_state.start = Math.max(attempted_midpoint - Math.floor(layout.min_region_scale / 2), 1);\n        new_state.end = new_state.start + layout.min_region_scale;\n    }\n\n    // Constrain w/r/t layout-defined maximum region scale\n    if (layout.max_region_scale && validated_region && attempted_scale > layout.max_region_scale) {\n        new_state.start = Math.max(attempted_midpoint - Math.floor(layout.max_region_scale / 2), 1);\n        new_state.end = new_state.start + layout.max_region_scale;\n    }\n\n    return new_state;\n}\n\n\nclass Plot {\n    /**\n     * An independent LocusZoom object that renders a unique set of data and subpanels.\n     * Many such LocusZoom objects can exist simultaneously on a single page, each having its own layout.\n     *\n     * This creates a new plot instance, but does not immediately render it. For practical use, it may be more convenient\n     * to use the `LocusZoom.populate` helper method.\n     *\n     * @param {String} id The ID of the plot. Often corresponds to the ID of the container element on the page\n     *   where the plot is rendered..\n     * @param {DataSources} datasource Ensemble of data providers used by the plot\n     * @param {object} [layout.state] Initial state parameters; the most common options are 'chr', 'start', and 'end'\n     *   to specify initial region view\n     * @param {number} [layout.width=800] The width of the plot and all child panels\n     * @param {number} [layout.min_width=400] Do not allow the panel to be resized below this width\n     * @param {number} [layout.min_region_scale] The minimum region width (do not allow the user to zoom smaller than this region size)\n     * @param {number} [layout.max_region_scale] The maximum region width (do not allow the user to zoom wider than this region size)\n     * @param {boolean} [layout.responsive_resize=false] Whether to resize plot width as the screen is resized\n     * @param {Object[]} [layout.panels] Configuration options for each panel to be added\n     * @param {module:LocusZoom_Widgets[]} [layout.toolbar.widgets] Configuration options for each widget to place on the\n     *   plot-level toolbar\n     * @param {boolean} [layout.panel_boundaries=true] Whether to show interactive resize handles to change panel dimensions\n     * @param {boolean} [layout.mouse_guide=true] Whether to always show horizontal and vertical dotted lines that intersect at the current location of the mouse pointer.\n     *   This line spans the entire plot area and is especially useful for plots with multiple panels.\n     */\n    constructor(id, datasource, layout) {\n        /**\n         * @private\n         * @member Boolean}\n         */\n        this._initialized = false;\n\n        /**\n         *  @private\n         *  @member {Plot}\n         */\n        this.parent_plot = this;\n\n        /**\n         *  @public\n         *  @member {String}\n         */\n        this.id = id;\n\n        /**\n         * @private\n         * @member {Element}\n         */\n        this.container = null;\n        /**\n         * Selector for a node that will contain the plot. (set externally by populate methods)\n         * @private\n         * @member {d3.selection}\n         */\n        this.svg = null;\n\n        /**\n         * Direct access to panel instances, keyed by panel ID. Used primarily for introspection/ development.\n         *  @public\n         *  @member {Object.<String, Panel>}\n         */\n        this.panels = {};\n        /**\n         * TODO: This is currently used by external classes that manipulate the parent and may indicate room for a helper method in the api to coordinate boilerplate\n         * @private\n         * @member {String[]}\n         */\n        this._panel_ids_by_y_index = [];\n\n        /**\n         * Track update operations (reMap) performed on all child panels, and notify the parent plot when complete\n         * TODO: Reconsider whether we need to be tracking this as global state outside of context of specific operations\n         * @ignore\n         * @protected\n         * @member {Promise[]}\n         */\n        this._remap_promises = [];\n\n\n        /**\n         * The current layout options for the plot, including the effect of any resizing events or dynamically\n         *  generated config produced during rendering options.\n         * @public\n         * @type {Object}\n         */\n        this.layout = layout;\n        merge(this.layout, default_layout); // TODO: evaluate how the default layout is applied\n\n        /**\n         * Values in the layout object may change during rendering etc. Retain a copy of the original plot options.\n         * This is useful for, eg, dynamically generated color schemes that need to start from scratch when new data is\n         * loaded: it contains the \"defaults\", not just the result of a calculated value.\n         * @ignore\n         * @protected\n         * @member {Object}\n         */\n        this._base_layout = deepCopy(this.layout);\n\n        /**\n         * Create a shortcut to the state in the layout on the Plot. Tracking in the layout allows the plot to be created\n         *   with initial state/setup.\n         *\n         * Tracks state of the plot, eg start and end position\n         * @public\n         * @member {Object}\n         */\n        this.state = this.layout.state;\n\n        /**\n         * @private\n         * @member {Requester}\n         */\n        this.lzd = new Requester(datasource);\n\n        /**\n         * Track global event listeners that are used by LZ. This allows cleanup of listeners when plot is destroyed.\n         * @private\n         * @member {Map} A nested hash of entries: { parent: {event_name: [listeners] } }\n         */\n        this._external_listeners = new Map();\n\n        /**\n         * Known event hooks that the panel can respond to\n         * @see {@link event:any_lz_event} for a list of pre-defined events commonly used by LocusZoom\n         * @protected\n         * @member {Object}\n         */\n        this._event_hooks = {};\n\n        /**\n         * @callback eventCallback\n         * @param {object} eventData A description of the event\n         * @param {String|null} eventData.sourceID The unique identifier (eg plot or parent name) of the element that\n         *  triggered the event. Will be automatically filled in if not explicitly provided.\n         * @param {Object|null} eventData.context Any additional information to be passed to the callback, eg the data\n         *   associated with a clicked plot element\n         */\n\n        /**\n         * Event information describing interaction (e.g. panning and zooming) is stored on the plot\n         * TODO: Add/ document details of interaction structure as we expand\n         * @private\n         * @member {{panel_id: String, linked_panel_ids: Array, x_linked: *, dragging: *, zooming: *}}\n         * @returns {Plot}\n         */\n        this._interaction = {};\n\n        // Initialize the layout\n        this.initializeLayout();\n    }\n\n    /******* User-facing methods that allow manipulation of the plot instance: the public interface */\n\n    /**\n     * There are several events that a LocusZoom plot can \"emit\" when appropriate, and LocusZoom supports registering\n     *   \"hooks\" for these events which are essentially custom functions intended to fire at certain times.\n     *\n     * To register a hook for any of these events use `plot.on('event_name', function() {})`.\n     *\n     * There can be arbitrarily many functions registered to the same event. They will be executed in the order they\n     *   were registered.\n     *\n     * @public\n     * @see {@link event:any_lz_event} for a list of pre-defined events commonly used by LocusZoom\n     * @param {String} event The name of an event. Consult documentation for the names of built-in events.\n     * @param {eventCallback} hook\n     * @returns {function} The registered event listener\n     */\n    on(event, hook) {\n        if (typeof event !== 'string') {\n            throw new Error(`Unable to register event hook. Event name must be a string: ${event.toString()}`);\n        }\n        if (typeof hook != 'function') {\n            throw new Error('Unable to register event hook, invalid hook function passed');\n        }\n        if (!this._event_hooks[event]) {\n            // We do not validate on known event names, because LZ is allowed to track and emit custom events like \"widget button clicked\".\n            this._event_hooks[event] = [];\n        }\n        this._event_hooks[event].push(hook);\n        return hook;\n    }\n\n    /**\n     * Remove one or more previously defined event listeners\n     * @public\n     * @see {@link event:any_lz_event} for a list of pre-defined events commonly used by LocusZoom\n     * @param {String} event The name of an event (as defined in `event_hooks`)\n     * @param {eventCallback} [hook] The callback to deregister\n     * @returns {Plot}\n     */\n    off(event, hook) {\n        const theseHooks = this._event_hooks[event];\n        if (typeof event != 'string' || !Array.isArray(theseHooks)) {\n            throw new Error(`Unable to remove event hook, invalid event: ${event.toString()}`);\n        }\n        if (hook === undefined) {\n            // Deregistering all hooks for this event may break basic functionality, and should only be used during\n            //  cleanup operations (eg to prevent memory leaks)\n            this._event_hooks[event] = [];\n        } else {\n            const hookMatch = theseHooks.indexOf(hook);\n            if (hookMatch !== -1) {\n                theseHooks.splice(hookMatch, 1);\n            } else {\n                throw new Error('The specified event listener is not registered and therefore cannot be removed');\n            }\n        }\n        return this;\n    }\n\n    /**\n     * Handle running of event hooks when an event is emitted\n     * @public\n     * @see {@link event:any_lz_event} for a list of pre-defined events commonly used by LocusZoom\n     * @param {string} event A known event name\n     * @param {*} eventData Data or event description that will be passed to the event listener\n     * @returns {Plot}\n     */\n    emit(event, eventData) {\n        // TODO: there are small differences between the emit implementation between plots and panels. In the future,\n        //  DRY this code via mixins, and make sure to keep the interfaces compatible when refactoring.\n        const these_hooks = this._event_hooks[event];\n        if (typeof event != 'string') {\n            throw new Error(`LocusZoom attempted to throw an invalid event: ${event.toString()}`);\n        } else if (!these_hooks && !this._event_hooks['any_lz_event']) {\n            // If the tree_fall event is emitted in a forest and no one is around to hear it, does it really make a sound?\n            return this;\n        }\n        const sourceID = this.getBaseId();\n        let eventContext;\n        if (eventData && eventData.sourceID) {\n            // If we detect that an event originated elsewhere (via bubbling or externally), preserve the context\n            //  when re-emitting the event to plot-level listeners\n            eventContext = eventData;\n        } else {\n            eventContext = {sourceID: sourceID, target: this, data: eventData || null};\n        }\n        if (these_hooks) {\n            // This event may have no hooks, but we could be passing by on our way to any_lz_event (below)\n            these_hooks.forEach((hookToRun) => {\n                // By default, any handlers fired here (either directly, or bubbled) will see the plot as the\n                //  value of `this`. If a bound function is registered as a handler, the previously bound `this` will\n                //  override anything provided to `call` below.\n                hookToRun.call(this, eventContext);\n            });\n        }\n\n        // At the plot level (only), all events will be re-emitted under the special name \"any_lz_event\"- a single place to\n        //  globally listen to every possible event.\n        // This is not intended for direct use. It is for UI frameworks like Vue.js, which may need to wrap LZ\n        //   instances and proxy all events to their own declarative event system\n        if (event !== 'any_lz_event') {\n            const anyEventData = Object.assign({ event_name: event }, eventContext);\n            this.emit('any_lz_event', anyEventData);\n        }\n        return this;\n    }\n\n    /**\n     * Create a new panel from a layout, and handle the work of initializing and placing the panel on the plot\n     * @public\n     * @param {Object} layout\n     * @returns {Panel}\n     */\n    addPanel(layout) {\n        // Sanity checks\n        if (typeof layout !== 'object') {\n            throw new Error('Invalid panel layout');\n        }\n\n        // Create the Panel and set its parent\n        const panel = new Panel(layout, this);\n\n        // Store the Panel on the Plot\n        this.panels[panel.id] = panel;\n\n        // If a discrete y_index was set in the layout then adjust other panel y_index values to accommodate this one\n        if (panel.layout.y_index !== null && !isNaN(panel.layout.y_index)\n            && this._panel_ids_by_y_index.length > 0) {\n            // Negative y_index values should count backwards from the end, so convert negatives to appropriate values here\n            if (panel.layout.y_index < 0) {\n                panel.layout.y_index = Math.max(this._panel_ids_by_y_index.length + panel.layout.y_index, 0);\n            }\n            this._panel_ids_by_y_index.splice(panel.layout.y_index, 0, panel.id);\n            this.applyPanelYIndexesToPanelLayouts();\n        } else {\n            const length = this._panel_ids_by_y_index.push(panel.id);\n            this.panels[panel.id].layout.y_index = length - 1;\n        }\n\n        // Determine if this panel was already in the layout.panels array.\n        // If it wasn't, add it. Either way store the layout.panels array index on the panel.\n        let layout_idx = null;\n        this.layout.panels.forEach((panel_layout, idx) => {\n            if (panel_layout.id === panel.id) {\n                layout_idx = idx;\n            }\n        });\n        if (layout_idx === null) {\n            layout_idx = this.layout.panels.push(this.panels[panel.id].layout) - 1;\n        }\n        this.panels[panel.id]._layout_idx = layout_idx;\n\n        // Call positionPanels() to keep panels from overlapping and ensure filling all available vertical space\n        if (this._initialized) {\n            this.positionPanels();\n            // Initialize and load data into the new panel\n            this.panels[panel.id].initialize();\n            this.panels[panel.id].reMap();\n            // An extra call to setDimensions with existing discrete dimensions fixes some rounding errors with tooltip\n            // positioning. TODO: make this additional call unnecessary.\n            this.setDimensions(this.layout.width, this._total_height);\n        }\n        return this.panels[panel.id];\n    }\n\n    /**\n     * Clear all state, tooltips, and other persisted data associated with one (or all) panel(s) in the plot\n     *\n     * This is useful when reloading an existing plot with new data, eg \"click for genome region\" links.\n     *   This is a utility method for custom usage. It is not fired automatically during normal rerender of existing panels\n     * TODO: Is this method still necessary in modern usage? Hide from docs for now.\n     * @public\n     * @ignore\n     * @param {String} [panelId] If provided, clear state for only this panel. Otherwise, clear state for all panels.\n     * @param {('wipe'|'reset')} [mode='wipe'] Optionally specify how state should be cleared. `wipe` deletes all data\n     *   and is useful for when the panel is being removed; `reset` is best when the panel will be reused in place.\n     * @returns {Plot}\n     */\n    clearPanelData(panelId, mode) {\n        mode = mode || 'wipe';\n\n        // TODO: Add unit tests for this method\n        let panelsList;\n        if (panelId) {\n            panelsList = [panelId];\n        } else {\n            panelsList = Object.keys(this.panels);\n        }\n\n        panelsList.forEach((pid) => {\n            this.panels[pid]._data_layer_ids_by_z_index.forEach((dlid) => {\n                const layer = this.panels[pid].data_layers[dlid];\n                layer.destroyAllTooltips();\n\n                delete layer._layer_state;\n                delete this.layout.state[layer._state_id];\n                if (mode === 'reset') {\n                    layer._setDefaultState();\n                }\n            });\n        });\n        return this;\n    }\n\n    /**\n     * Remove the panel from the plot, and clear any state, tooltips, or other visual elements belonging to nested content\n     * @public\n     * @fires event:panel_removed\n     * @param {String} id\n     * @returns {Plot}\n     */\n    removePanel(id) {\n        const target_panel = this.panels[id];\n        if (!target_panel) {\n            throw new Error(`Unable to remove panel, ID not found: ${id}`);\n        }\n\n        // Hide all panel boundaries\n        this._panel_boundaries.hide();\n\n        // Destroy all tooltips and state vars for all data layers on the panel\n        this.clearPanelData(id);\n\n        // Remove all panel-level HTML overlay elements\n        target_panel.loader.hide();\n        target_panel.toolbar.destroy(true);\n        target_panel.curtain.hide();\n\n        // Remove the svg container for the panel if it exists\n        if (target_panel.svg.container) {\n            target_panel.svg.container.remove();\n        }\n\n        // Delete the panel and its presence in the plot layout and state\n        this.layout.panels.splice(target_panel._layout_idx, 1);\n        delete this.panels[id];\n        delete this.layout.state[id];\n\n        // Update layout_idx values for all remaining panels\n        this.layout.panels.forEach((panel_layout, idx) => {\n            this.panels[panel_layout.id]._layout_idx = idx;\n        });\n\n        // Remove the panel id from the y_index array\n        this._panel_ids_by_y_index.splice(this._panel_ids_by_y_index.indexOf(id), 1);\n        this.applyPanelYIndexesToPanelLayouts();\n\n        // Call positionPanels() to keep panels from overlapping and ensure filling all available vertical space\n        if (this._initialized) {\n            this.positionPanels();\n            // An extra call to setDimensions with existing discrete dimensions fixes some rounding errors with tooltip\n            // positioning. TODO: make this additional call unnecessary.\n            this.setDimensions(this.layout.width, this._total_height);\n        }\n\n        this.emit('panel_removed', id);\n\n        return this;\n    }\n\n    /**\n     * Refresh (or fetch) a plot's data from sources, regardless of whether position or state has changed\n     * @public\n     * @returns {Promise}\n     */\n    refresh() {\n        return this.applyState();\n    }\n\n    /**\n     * A user-defined callback function that can receive (and potentially act on) new plot data.\n     * @callback externalDataCallback\n     * @param {Object} new_data The body resulting from a data request. This represents the same information that would be passed to\n     *  a data layer making an equivalent request.\n     * @param {Object} plot A reference to the plot object. This can be useful for listeners that react to the\n     *   structure of the data, instead of just displaying something.\n     */\n\n    /**\n     * A user-defined callback function that can respond to errors received during a previous operation\n     * @callback externalErrorCallback\n     * @param err A representation of the error that occurred\n     */\n\n    /**\n     * Allow newly fetched data to be made available outside the LocusZoom plot. For example, a callback could be\n     *  registered to draw an HTML table of top GWAS hits, and update that table whenever the plot region changes.\n     *\n     * This is a convenience method for external hooks. It registers an event listener and returns parsed data,\n     *  using the same fields syntax and underlying methods as data layers.\n     *\n     * @public\n     * @listens event:data_rendered\n     * @listens event:data_from_layer\n     * @param {Object} [opts] Options\n     * @param {String} [opts.from_layer=null] The ID string (`panel_id.layer_id`) of a specific data layer to be watched.\n     * @param {Object} [opts.namespace] An object specifying where to find external data. See data layer documentation for details.\n     * @param {Object} [opts.data_operations] An array of data operations. If more than one source of data is requested,\n     *  this is usually required in order to specify dependency order and join operations. See data layer documentation for details.\n     * @param {externalErrorCallback} [opts.onerror] User defined function that is automatically called if a problem\n     *  occurs during the data request or subsequent callback operations\n     * @param {externalDataCallback} success_callback Used defined function that is automatically called any time that\n     *  new data is received by the plot. Receives two arguments: (data, plot).\n     *  @return {function} The newly created event listener, to allow for later cleanup/removal\n     */\n    subscribeToData(opts, success_callback) {\n        const { from_layer, namespace, data_operations, onerror } = opts;\n\n        // Register an event listener that is notified whenever new data has been rendered\n        const error_callback = onerror || function (err) {\n            console.error('An error occurred while acting on an external callback', err);\n        };\n\n        if (from_layer) {\n            // Option 1: Subscribe to a data layer. Receive a copy of the exact data it receives; no need to duplicate NS or data operations code in two places.\n            const base_prefix = `${this.getBaseId()}.`;\n            // Allow users to provide either `plot.panel.layer`, or `panel.layer`. The latter usually leads to more reusable code.\n            const layer_target = from_layer.startsWith(base_prefix) ? from_layer : `${base_prefix}${from_layer}`;\n\n            // Ensure that a valid layer exists to watch\n            let is_valid_layer = false;\n            for (let p of Object.values(this.panels)) {\n                is_valid_layer = Object.values(p.data_layers).some((d) => d.getBaseId() === layer_target);\n                if (is_valid_layer) {\n                    break;\n                }\n            }\n            if (!is_valid_layer) {\n                throw new Error(`Could not subscribe to unknown data layer ${layer_target}`);\n            }\n\n            const listener = (eventData) => {\n                if (eventData.data.layer !== layer_target) {\n                    // Same event name fires for many layers; only fire success cb for the one layer we want\n                    return;\n                }\n                try {\n                    success_callback(eventData.data.content, this);\n                } catch (error) {\n                    error_callback(error);\n                }\n            };\n\n            this.on('data_from_layer', listener);\n            return listener;\n        }\n\n        // Second option: subscribe to an explicit list of fields and namespaces. This is useful if the same piece of\n        //   data has to be displayed in multiple ways, eg if we just want an annotation (which is normally visualized\n        //   in connection to some other visualization)\n        if (!namespace) {\n            throw new Error(\"subscribeToData must specify the desired data: either 'from_layer' or 'namespace' option\");\n        }\n\n        const [entities, dependencies] = this.lzd.config_to_sources(namespace, data_operations); // Does not pass reference to initiator- we don't want external subscribers with the power to mutate the whole plot.\n        const listener = () => {\n            try {\n                // NOTE TO FUTURE SELF: since this event does something async and not tied to a returned promise, unit tests will behave strangely,\n                //  even though this method totally works. Don't spend another hour scratching your head; this is the line to blame.\n                this.lzd.getData(this.state, entities, dependencies)\n                    .then((new_data) => success_callback(new_data, this))\n                    .catch(error_callback);\n            } catch (error) {\n                // In certain cases, errors are thrown before a promise can be generated, and LZ error display seems to rely on these errors bubbling up\n                error_callback(error);\n            }\n        };\n        this.on('data_rendered', listener);\n        return listener;\n    }\n\n    /**\n     * Update state values and trigger a pull for fresh data on all data sources for all data layers\n     * @public\n     * @param {Object} state_changes\n     * @returns {Promise} A promise that resolves when all data fetch and update operations are complete\n     * @listens event:match_requested\n     * @fires event:data_requested\n     * @fires event:layout_changed\n     * @fires event:data_rendered\n     * @fires event:state_changed\n     * @fires event:region_changed\n     */\n    applyState(state_changes) {\n        state_changes = state_changes || {};\n        if (typeof state_changes != 'object') {\n            throw new Error(`applyState only accepts an object; ${typeof state_changes} given`);\n        }\n\n        // Track what parameters will be modified. For bounds checking, we must take some preset values into account.\n        let mods = { chr: this.state.chr, start: this.state.start, end: this.state.end };\n        for (let property in state_changes) {\n            mods[property] = state_changes[property];\n        }\n        mods = _updateStatePosition(mods, this.layout);\n\n        // Apply new state to the actual state\n        for (let property in mods) {\n            this.state[property] = mods[property];\n        }\n\n        // Generate requests for all panels given new state\n        this.emit('data_requested');\n        this._remap_promises = [];\n        this.loading_data = true;\n        for (let id in this.panels) {\n            this._remap_promises.push(this.panels[id].reMap());\n        }\n\n        return Promise.all(this._remap_promises)\n            .catch((error) => {\n                console.error(error);\n                this.curtain.show(error.message || error);\n                this.loading_data = false;\n            })\n            .then(() => {\n                // Update toolbar / widgets\n                this.toolbar.update();\n\n                // Apply panel-level state values\n                this._panel_ids_by_y_index.forEach((panel_id) => {\n                    const panel = this.panels[panel_id];\n                    panel.toolbar.update();\n                    // Apply data-layer-level state values\n                    panel._data_layer_ids_by_z_index.forEach((data_layer_id) => {\n                        panel.data_layers[data_layer_id].applyAllElementStatus();\n                    });\n                });\n\n                // Emit events\n                this.emit('layout_changed');\n                this.emit('data_rendered');\n                this.emit('state_changed', state_changes);\n\n                // An interesting quirk of region changing in LZ: the final region is not always the same as the requested region\n                //   (example: zoom out beyond max, or request non-integer position)\n                // Echo the actual plot region as the final source of truth\n                const { chr, start, end } = this.state;\n                const position_changed = Object.keys(state_changes)\n                    .some((key) => ['chr', 'start', 'end'].includes(key));\n\n                if (position_changed) {\n                    this.emit('region_changed', { chr, start, end });\n                }\n\n                this.loading_data = false;\n            });\n    }\n\n    /**\n     * Keep a record of event listeners that are defined outside of the LocusZoom boundary (and therefore would not\n     *  get cleaned up when the plot was removed from the DOM). For example, window resize or mouse events.\n     * This allows safe cleanup of the plot on removal from the page. This method is useful for authors of LocusZoom plugins.\n     * @param {Node} target The node on which the listener has been defined\n     * @param {String} event_name\n     * @param {function} listener The handle for the event listener to be cleaned up\n     */\n    trackExternalListener(target, event_name, listener) {\n        if (!this._external_listeners.has(target)) {\n            this._external_listeners.set(target, new Map());\n        }\n        const container = this._external_listeners.get(target);\n\n        const tracker = container.get(event_name) || [];\n        if (!tracker.includes(listener)) {\n            tracker.push(listener);\n        }\n        container.set(event_name, tracker);\n    }\n\n    /**\n     * Remove the plot from the page, and clean up any globally registered event listeners\n     *\n     * Internally, the plot retains references to some nodes via selectors; it may be useful to delete the plot\n     *  instance after calling this method\n     */\n    destroy() {\n        for (let [target, registered_events] of this._external_listeners.entries()) {\n            for (let [event_name, listeners] of registered_events) {\n                for (let listener of listeners) {\n                    target.removeEventListener(event_name, listener);\n                }\n            }\n        }\n\n        // Clear the SVG, plus other HTML nodes (like toolbar) that live under the same parent\n        const parent = this.svg.node().parentNode;\n        if (!parent) {\n            throw new Error('Plot has already been removed');\n        }\n        while (parent.lastElementChild) {\n            parent.removeChild(parent.lastElementChild);\n        }\n        // Clear toolbar event listeners defined on the parent lz-container. As of 2020 this appears to be the\n        //  state of the art cross-browser DOM API for this task.\n        // eslint-disable-next-line no-self-assign\n        parent.outerHTML = parent.outerHTML;\n\n        this._initialized = false;\n\n        this.svg = null;\n        this.panels = null;\n    }\n\n    /**\n     * Plots can change how data is displayed by layout mutations. In rare cases, such as swapping from one source of LD to another,\n     *   these layout mutations won't be picked up instantly. This method notifies the plot to recalculate any cached properties,\n     *   like data fetching logic, that might depend on initial layout. It does not trigger a re-render by itself.\n     * @public\n     */\n    mutateLayout() {\n        Object.values(this.panels).forEach((panel) => {\n            Object.values(panel.data_layers).forEach((layer) => layer.mutateLayout());\n        });\n    }\n\n    /******* The private interface: methods only used by LocusZoom internals */\n    /**\n     * Track whether the target panel can respond to mouse interaction events\n     * @private\n     * @param {String} panel_id\n     * @returns {boolean}\n     */\n    _canInteract(panel_id) {\n        panel_id = panel_id || null;\n        const { _interaction } = this;\n        if (panel_id) {\n            return ((typeof _interaction.panel_id == 'undefined' || _interaction.panel_id === panel_id) && !this.loading_data);\n        } else {\n            return !(_interaction.dragging || _interaction.zooming || this.loading_data);\n        }\n    }\n\n    /**\n     * Get an object with the x and y coordinates of the plot's origin in terms of the entire page\n     *  This returns a result with absolute position relative to the page, regardless of current scrolling\n     * Necessary for positioning any HTML elements over the plot\n     * @private\n     * @returns {{x: Number, y: Number, width: Number, height: Number}}\n     */\n    _getPageOrigin() {\n        const bounding_client_rect = this.svg.node().getBoundingClientRect();\n        let x_offset = document.documentElement.scrollLeft || document.body.scrollLeft;\n        let y_offset = document.documentElement.scrollTop || document.body.scrollTop;\n        let container = this.svg.node();\n        while (container.parentNode !== null) {\n            // TODO: Recursively seeks offsets for highest non-static parent node. This can lead to incorrect\n            //   calculations of, for example, x coordinate relative to the page. Revisit this logic.\n            container = container.parentNode;\n            if (container !== document && d3.select(container).style('position') !== 'static') {\n                x_offset = -1 * container.getBoundingClientRect().left;\n                y_offset = -1 * container.getBoundingClientRect().top;\n                break;\n            }\n        }\n        return {\n            x: x_offset + bounding_client_rect.left,\n            y: y_offset + bounding_client_rect.top,\n            width: bounding_client_rect.width,\n            height: bounding_client_rect.height,\n        };\n    }\n\n    /**\n     * Get the top and left offset values for the plot's container element (the div that was populated)\n     * @private\n     * @returns {{top: number, left: number}}\n     */\n    getContainerOffset() {\n        const offset = { top: 0, left: 0 };\n        let container = this.container.offsetParent || null;\n        while (container !== null) {\n            offset.top += container.offsetTop;\n            offset.left += container.offsetLeft;\n            container = container.offsetParent || null;\n        }\n        return offset;\n    }\n\n    /**\n     * Notify each child panel of the plot of changes in panel ordering/ arrangement\n     * @private\n     */\n    applyPanelYIndexesToPanelLayouts () {\n        this._panel_ids_by_y_index.forEach((pid, idx) => {\n            this.panels[pid].layout.y_index = idx;\n        });\n    }\n\n    /**\n     * Get the qualified ID pathname for the plot\n     * @private\n     * @returns {String}\n     */\n    getBaseId () {\n        return this.id;\n    }\n\n    /**\n     * Resize the plot to fit the bounding container\n     * @private\n     * @returns {Plot}\n     */\n    rescaleSVG() {\n        const clientRect = this.svg.node().getBoundingClientRect();\n        this.setDimensions(clientRect.width, clientRect.height);\n        return this;\n    }\n\n    /**\n     * Prepare the plot for first use by performing parameter validation, setting up panels, and calculating dimensions\n     * @private\n     * @returns {Plot}\n     */\n    initializeLayout() {\n        // Sanity check layout values\n        if (isNaN(this.layout.width) || this.layout.width <= 0) {\n            throw new Error('Plot layout parameter `width` must be a positive number');\n        }\n\n        // Backwards compatible check: there was previously a third option. Anything truthy should thus act as \"responsive_resize: true\"\n        this.layout.responsive_resize = !!this.layout.responsive_resize;\n\n        // Add panels\n        this.layout.panels.forEach((panel_layout) => {\n            this.addPanel(panel_layout);\n        });\n        return this;\n    }\n\n    /**\n     * Set the dimensions for a plot, and ensure that panels are sized and positioned correctly.\n     *\n     * If dimensions are provided, resizes each panel proportionally to match the new plot dimensions. Otherwise,\n     *   calculates the appropriate plot dimensions based on all panels, and ensures that panels are placed and\n     *   rendered in the correct relative positions.\n     * @private\n     * @param {Number} [width] If provided and larger than minimum allowed size, set plot to this width\n     * @param {Number} [height] If provided and larger than minimum allowed size, set plot to this height\n     * @returns {Plot}\n     * @fires event:layout_changed\n     */\n    setDimensions(width, height) {\n        // If width and height arguments were passed, then adjust plot dimensions to fit all panels\n        // Then resize the plot and proportionally resize panels to fit inside the new plot dimensions.\n        if (!isNaN(width) && width >= 0 && !isNaN(height) && height >= 0) {\n            // Resize operations may ask for a different amount of space than that used by panels.\n            const height_scaling_factor = height / this._total_height;\n\n            this.layout.width = Math.max(Math.round(+width), this.layout.min_width);\n            // Override discrete values if resizing responsively\n            if (this.layout.responsive_resize) {\n                // All resize modes will affect width\n                if (this.svg) {\n                    this.layout.width = Math.max(this.svg.node().parentNode.getBoundingClientRect().width, this.layout.min_width);\n                }\n            }\n            // Resize/reposition panels to fit, update proportional origins if necessary\n            let y_offset = 0;\n            this._panel_ids_by_y_index.forEach((panel_id) => {\n                const panel = this.panels[panel_id];\n                const panel_width = this.layout.width;\n                // In this block, we are passing explicit dimensions that might require rescaling all panels at once\n                const panel_height = panel.layout.height * height_scaling_factor;\n                panel.setDimensions(panel_width, panel_height);\n                panel.setOrigin(0, y_offset);\n                y_offset += panel_height;\n                panel.toolbar.update();\n            });\n        }\n\n        // Set the plot height to the sum of all panels (using the \"real\" height values accounting for panel.min_height)\n        const final_height = this._total_height;\n\n        // Apply layout width and height as discrete values or viewbox values\n        if (this.svg !== null) {\n            // The viewBox must always be specified in order for \"save as image\" button to work\n            this.svg.attr('viewBox', `0 0 ${this.layout.width} ${final_height}`);\n\n            this.svg\n                .attr('width', this.layout.width)\n                .attr('height', final_height);\n        }\n\n        // If the plot has been initialized then trigger some necessary render functions\n        if (this._initialized) {\n            this._panel_boundaries.position();\n            this.toolbar.update();\n            this.curtain.update();\n            this.loader.update();\n        }\n\n        return this.emit('layout_changed');\n    }\n\n    /**\n     * Automatically position panels based on panel positioning rules and values.\n     * Keep panels from overlapping vertically by adjusting origins, and keep the sum of proportional heights at 1.\n     *\n     * LocusZoom panels can only be stacked vertically (not horizontally)\n     * @private\n     */\n    positionPanels() {\n        // We want to enforce that all x-linked panels have consistent horizontal margins\n        // (to ensure that aligned items stay aligned despite inconsistent initial layout parameters)\n        // NOTE: This assumes panels have consistent widths already. That should probably be enforced too!\n        const x_linked_margins = { left: 0, right: 0 };\n\n        // Proportional heights for newly added panels default to null unless explicitly set, so determine appropriate\n        // proportional heights for all panels with a null value from discretely set dimensions.\n        // Likewise handle default nulls for proportional widths, but instead just force a value of 1 (full width)\n        for (let panel of Object.values(this.panels)) {\n            if (panel.layout.interaction.x_linked) {\n                x_linked_margins.left = Math.max(x_linked_margins.left, panel.layout.margin.left);\n                x_linked_margins.right = Math.max(x_linked_margins.right, panel.layout.margin.right);\n            }\n        }\n\n        // Update origins on all panels without changing plot-level dimensions yet\n        // Also apply x-linked margins to x-linked panels, updating widths as needed\n        let y_offset = 0;\n        this._panel_ids_by_y_index.forEach((panel_id) => {\n            const panel = this.panels[panel_id];\n            const panel_layout = panel.layout;\n            panel.setOrigin(0, y_offset);\n            y_offset += this.panels[panel_id].layout.height;\n            if (panel_layout.interaction.x_linked) {\n                const delta = Math.max(x_linked_margins.left - panel_layout.margin.left, 0)\n                    + Math.max(x_linked_margins.right - panel_layout.margin.right, 0);\n                panel_layout.width += delta;\n                panel_layout.margin.left = x_linked_margins.left;\n                panel_layout.margin.right = x_linked_margins.right;\n                panel_layout.cliparea.origin.x = x_linked_margins.left;\n            }\n        });\n\n        // Update dimensions on the plot to accommodate repositioned panels (eg when resizing one panel,\n        //  also must update the plot dimensions)\n        this.setDimensions();\n\n        // Set dimensions on all panels using newly set plot-level dimensions and panel-level proportional dimensions\n        this._panel_ids_by_y_index.forEach((panel_id) => {\n            const panel = this.panels[panel_id];\n            panel.setDimensions(\n                this.layout.width,\n                panel.layout.height,\n            );\n        });\n\n        return this;\n    }\n\n    /**\n     * Prepare the first rendering of the plot. This includes initializing the individual panels, but also creates shared\n     *   elements such as mouse events, panel guides/boundaries, and loader/curtain.\n     * @private\n     * @returns {Plot}\n     */\n    initialize() {\n        // Ensure proper responsive class is present on the containing node if called for\n        if (this.layout.responsive_resize) {\n            d3.select(this.container).classed('lz-container-responsive', true);\n\n            // If this is a responsive layout then set a namespaced/unique onresize event listener on the window\n            const resize_listener = () => window.requestAnimationFrame(() => this.rescaleSVG());\n\n            window.addEventListener('resize', resize_listener);\n            this.trackExternalListener(window, 'resize', resize_listener);\n\n            // Many libraries collapse/hide tab widgets using display:none, which doesn't trigger the resize listener\n            //   High threshold: Don't fire listeners on every 1px change, but allow this to work if the plot position is a bit cockeyed\n            if (typeof IntersectionObserver !== 'undefined') { // don't do this in old browsers\n                const options = { root: document.documentElement, threshold: 0.9 };\n                const observer = new IntersectionObserver((entries, observer) => {\n                    if (entries.some((entry) => entry.intersectionRatio > 0)) {\n                        this.rescaleSVG();\n                    }\n                }, options);\n                // IntersectionObservers will be cleaned up when DOM node removed; no need to track them for manual cleanup\n                observer.observe(this.container);\n            }\n\n            // Forcing one additional setDimensions() call after the page is loaded clears up\n            // any disagreements between the initial layout and the loaded responsive container's size\n            const load_listener = () => this.setDimensions();\n            window.addEventListener('load', load_listener);\n            this.trackExternalListener(window, 'load', load_listener);\n        }\n\n        // Create an element/layer for containing mouse guides\n        if (this.layout.mouse_guide) {\n            const mouse_guide_svg = this.svg.append('g')\n                .attr('class', 'lz-mouse_guide')\n                .attr('id', `${this.id}.mouse_guide`);\n            const mouse_guide_vertical_svg = mouse_guide_svg.append('rect')\n                .attr('class', 'lz-mouse_guide-vertical')\n                .attr('x', -1);\n            const mouse_guide_horizontal_svg = mouse_guide_svg.append('rect')\n                .attr('class', 'lz-mouse_guide-horizontal')\n                .attr('y', -1);\n            this._mouse_guide = {\n                svg: mouse_guide_svg,\n                vertical: mouse_guide_vertical_svg,\n                horizontal: mouse_guide_horizontal_svg,\n            };\n        }\n\n        // Add curtain and loader prototpyes to the plot\n        this.curtain = generateCurtain.call(this);\n        this.loader = generateLoader.call(this);\n\n        // Create the panel_boundaries object with show/position/hide methods\n        this._panel_boundaries = {\n            parent: this,\n            hide_timeout: null,\n            showing: false,\n            dragging: false,\n            selectors: [],\n            corner_selector: null,\n            show: function() {\n                // Generate panel boundaries\n                if (!this.showing && !this.parent.curtain.showing) {\n                    this.showing = true;\n                    // Loop through all panels to create a horizontal boundary for each\n                    this.parent._panel_ids_by_y_index.forEach((panel_id, panel_idx) => {\n                        const selector = d3.select(this.parent.svg.node().parentNode).insert('div', '.lz-data_layer-tooltip')\n                            .attr('class', 'lz-panel-boundary')\n                            .attr('title', 'Resize panel');\n                        selector.append('span');\n                        const panel_resize_drag = d3.drag();\n                        panel_resize_drag.on('start', () => {\n                            this.dragging = true;\n                        });\n                        panel_resize_drag.on('end', () => {\n                            this.dragging = false;\n                        });\n                        panel_resize_drag.on('drag', () => {\n                            // First set the dimensions on the panel we're resizing\n                            const this_panel = this.parent.panels[this.parent._panel_ids_by_y_index[panel_idx]];\n                            const original_panel_height = this_panel.layout.height;\n                            this_panel.setDimensions(this.parent.layout.width, this_panel.layout.height + d3.event.dy);\n                            const panel_height_change = this_panel.layout.height - original_panel_height;\n                            // Next loop through all panels.\n                            // Update proportional dimensions for all panels including the one we've resized using discrete heights.\n                            // Reposition panels with a greater y-index than this panel to their appropriate new origin.\n                            this.parent._panel_ids_by_y_index.forEach((loop_panel_id, loop_panel_idx) => {\n                                const loop_panel = this.parent.panels[this.parent._panel_ids_by_y_index[loop_panel_idx]];\n                                if (loop_panel_idx > panel_idx) {\n                                    loop_panel.setOrigin(loop_panel.layout.origin.x, loop_panel.layout.origin.y + panel_height_change);\n                                    loop_panel.toolbar.position();\n                                }\n                            });\n                            // Reset dimensions on the entire plot and reposition panel boundaries\n                            this.parent.positionPanels();\n                            this.position();\n                        });\n                        selector.call(panel_resize_drag);\n                        this.parent._panel_boundaries.selectors.push(selector);\n                    });\n                    // Create a corner boundary / resize element on the bottom-most panel that resizes the entire plot\n                    const corner_selector = d3.select(this.parent.svg.node().parentNode)\n                        .insert('div', '.lz-data_layer-tooltip')\n                        .attr('class', 'lz-panel-corner-boundary')\n                        .attr('title', 'Resize plot');\n\n                    corner_selector\n                        .append('span')\n                        .attr('class', 'lz-panel-corner-boundary-outer');\n                    corner_selector\n                        .append('span')\n                        .attr('class', 'lz-panel-corner-boundary-inner');\n\n                    const corner_drag = d3.drag();\n                    corner_drag.on('start', () => {\n                        this.dragging = true;\n                    });\n                    corner_drag.on('end', () => {\n                        this.dragging = false;\n                    });\n                    corner_drag.on('drag', () => {\n                        this.parent.setDimensions(this.parent.layout.width + d3.event.dx, this.parent._total_height + d3.event.dy);\n                    });\n                    corner_selector.call(corner_drag);\n                    this.parent._panel_boundaries.corner_selector = corner_selector;\n                }\n                return this.position();\n            },\n            position: function() {\n                if (!this.showing) {\n                    return this;\n                }\n                // Position panel boundaries\n                const plot_page_origin = this.parent._getPageOrigin();\n                this.selectors.forEach((selector, panel_idx) => {\n                    const panel = this.parent.panels[this.parent._panel_ids_by_y_index[panel_idx]];\n                    const panel_page_origin = panel._getPageOrigin();\n                    const left = plot_page_origin.x;\n                    const top = panel_page_origin.y + panel.layout.height - 12;\n                    const width = this.parent.layout.width - 1;\n                    selector\n                        .style('top', `${top}px`)\n                        .style('left', `${left}px`)\n                        .style('width', `${width}px`);\n                    selector.select('span')\n                        .style('width', `${width}px`);\n                });\n                // Position corner selector\n                const corner_padding = 10;\n                const corner_size = 16;\n                this.corner_selector\n                    .style('top', `${plot_page_origin.y + this.parent._total_height - corner_padding - corner_size}px`)\n                    .style('left', `${plot_page_origin.x + this.parent.layout.width - corner_padding - corner_size}px`);\n                return this;\n            },\n            hide: function() {\n                if (!this.showing) {\n                    return this;\n                }\n                this.showing = false;\n                // Remove panel boundaries\n                this.selectors.forEach((selector) => {\n                    selector.remove();\n                });\n                this.selectors = [];\n                // Remove corner boundary\n                this.corner_selector.remove();\n                this.corner_selector = null;\n                return this;\n            },\n        };\n\n        // Show panel boundaries stipulated by the layout (basic toggle, only show on mouse over plot)\n        if (this.layout.panel_boundaries) {\n            d3.select(this.svg.node().parentNode)\n                .on(`mouseover.${this.id}.panel_boundaries`, () => {\n                    clearTimeout(this._panel_boundaries.hide_timeout);\n                    this._panel_boundaries.show();\n                })\n                .on(`mouseout.${this.id}.panel_boundaries`, () => {\n                    this._panel_boundaries.hide_timeout = setTimeout(() => {\n                        this._panel_boundaries.hide();\n                    }, 300);\n                });\n        }\n\n        // Create the toolbar object and immediately show it\n        this.toolbar = new Toolbar(this).show();\n\n        // Initialize all panels\n        for (let id in this.panels) {\n            this.panels[id].initialize();\n        }\n\n        // Define plot-level mouse events\n        const namespace = `.${this.id}`;\n        if (this.layout.mouse_guide) {\n            const mouseout_mouse_guide = () => {\n                this._mouse_guide.vertical.attr('x', -1);\n                this._mouse_guide.horizontal.attr('y', -1);\n            };\n            const mousemove_mouse_guide = () => {\n                const coords = d3.mouse(this.svg.node());\n                this._mouse_guide.vertical.attr('x', coords[0]);\n                this._mouse_guide.horizontal.attr('y', coords[1]);\n            };\n            this.svg\n                .on(`mouseout${namespace}-mouse_guide`, mouseout_mouse_guide)\n                .on(`touchleave${namespace}-mouse_guide`, mouseout_mouse_guide)\n                .on(`mousemove${namespace}-mouse_guide`, mousemove_mouse_guide);\n        }\n        const mouseup = () => {\n            this.stopDrag();\n        };\n        const mousemove = () => {\n            const { _interaction } = this;\n            if (_interaction.dragging) {\n                const coords = d3.mouse(this.svg.node());\n                if (d3.event) {\n                    d3.event.preventDefault();\n                }\n                _interaction.dragging.dragged_x = coords[0] - _interaction.dragging.start_x;\n                _interaction.dragging.dragged_y = coords[1] - _interaction.dragging.start_y;\n                this.panels[_interaction.panel_id].render();\n                _interaction.linked_panel_ids.forEach((panel_id) => {\n                    this.panels[panel_id].render();\n                });\n            }\n        };\n        this.svg\n            .on(`mouseup${namespace}`, mouseup)\n            .on(`touchend${namespace}`, mouseup)\n            .on(`mousemove${namespace}`, mousemove)\n            .on(`touchmove${namespace}`, mousemove);\n\n        // Add an extra namespaced mouseup handler to the containing body, if there is one\n        // This helps to stop interaction events gracefully when dragging outside of the plot element\n        const body_selector = d3.select('body');\n        const body_node = body_selector.node();\n        if (body_node) {\n            body_node.addEventListener('mouseup', mouseup);\n            body_node.addEventListener('touchend', mouseup);\n\n            this.trackExternalListener(body_node, 'mouseup', mouseup);\n            this.trackExternalListener(body_node, 'touchend', mouseup);\n        }\n\n        this.on('match_requested', (eventData) => {\n            // Layers can broadcast that a specific point has been selected, and the plot will tell every other layer\n            //  to look for that value. Whenever a point is de-selected, it clears the match.\n            const data = eventData.data;\n            const to_send = (data.active ? data.value : null);\n            const emitted_by = eventData.target.id;\n            // When a match is initiated, hide all tooltips from other panels (prevents zombie tooltips from reopening)\n            // TODO: This is a bit hacky. Right now, selection and matching are tightly coupled, and hence tooltips\n            //   reappear somewhat aggressively. A better solution depends on designing alternative behavior, and\n            //   applying tooltips post (instead of pre) render.\n            Object.values(this.panels).forEach((panel) => {\n                if (panel.id !== emitted_by) {\n                    Object.values(panel.data_layers).forEach((layer) => layer.destroyAllTooltips(false));\n                }\n            });\n\n            this.applyState({ lz_match_value: to_send });\n        });\n\n        this._initialized = true;\n\n        // An extra call to setDimensions with existing discrete dimensions fixes some rounding errors with tooltip\n        // positioning. TODO: make this additional call unnecessary.\n        const client_rect = this.svg.node().getBoundingClientRect();\n        const width = client_rect.width ? client_rect.width : this.layout.width;\n        const height = client_rect.height ? client_rect.height : this._total_height;\n        this.setDimensions(width, height);\n\n        return this;\n    }\n\n    /**\n     * Register interactions along the specified axis, provided that the target panel allows interaction.\n     * @private\n     * @param {Panel} panel\n     * @param {('background'|'x_tick'|'y1_tick'|'y2_tick')} method The direction (axis) along which dragging is being performed.\n     * @returns {Plot}\n     */\n    startDrag(panel, method) {\n        panel = panel || null;\n        method = method || null;\n\n        let axis = null;\n        switch (method) {\n        case 'background':\n        case 'x_tick':\n            axis = 'x';\n            break;\n        case 'y1_tick':\n            axis = 'y1';\n            break;\n        case 'y2_tick':\n            axis = 'y2';\n            break;\n        }\n\n        if (!(panel instanceof Panel) || !axis || !this._canInteract()) {\n            return this.stopDrag();\n        }\n\n        const coords = d3.mouse(this.svg.node());\n        this._interaction = {\n            panel_id: panel.id,\n            linked_panel_ids: panel.getLinkedPanelIds(axis),\n            dragging: {\n                method: method,\n                start_x: coords[0],\n                start_y: coords[1],\n                dragged_x: 0,\n                dragged_y: 0,\n                axis: axis,\n            },\n        };\n\n        this.svg.style('cursor', 'all-scroll');\n\n        return this;\n    }\n\n    /**\n     * Process drag interactions across the target panel and synchronize plot state across other panels in sync;\n     *   clear the event when complete\n     * @private\n     * @returns {Plot}\n     */\n    stopDrag() {\n        const { _interaction } = this;\n        if (!_interaction.dragging) {\n            return this;\n        }\n\n        if (typeof this.panels[_interaction.panel_id] != 'object') {\n            this._interaction = {};\n            return this;\n        }\n        const panel = this.panels[_interaction.panel_id];\n\n        // Helper function to find the appropriate axis layouts on child data layers\n        // Once found, apply the extent as floor/ceiling and remove all other directives\n        // This forces all associated axes to conform to the extent generated by a drag action\n        const overrideAxisLayout = (axis, axis_number, extent) => {\n            panel._data_layer_ids_by_z_index.forEach((id) => {\n                const axis_layout = panel.data_layers[id].layout[`${axis}_axis`];\n                if (axis_layout.axis === axis_number) {\n                    axis_layout.floor = extent[0];\n                    axis_layout.ceiling = extent[1];\n                    delete axis_layout.lower_buffer;\n                    delete axis_layout.upper_buffer;\n                    delete axis_layout.min_extent;\n                    delete axis_layout.ticks;\n                }\n            });\n        };\n\n        switch (_interaction.dragging.method) {\n        case 'background':\n        case 'x_tick':\n            if (_interaction.dragging.dragged_x !== 0) {\n                overrideAxisLayout('x', 1, panel.x_extent);\n                this.applyState({ start: panel.x_extent[0], end: panel.x_extent[1] });\n            }\n            break;\n        case 'y1_tick':\n        case 'y2_tick':\n            if (_interaction.dragging.dragged_y !== 0) {\n                const y_axis_number = parseInt(_interaction.dragging.method[1]);\n                overrideAxisLayout('y', y_axis_number, panel[`y${y_axis_number}_extent`]);\n            }\n            break;\n        }\n\n        this._interaction = {};\n        this.svg.style('cursor', null);\n\n        return this;\n\n    }\n\n    get _total_height() {\n        // The plot height is a calculated property, derived from the sum of its panel layout objects\n        return this.layout.panels.reduce((acc, item) => item.height + acc, 0);\n    }\n}\n\nexport {Plot as default};\n\n// Only for testing\nexport { _updateStatePosition };\n","/**\n * \"Match\" test functions used to compare two values for filtering (what to render) and matching\n *  (comparison and finding related points across data layers)\n *\n * ### How do matching and filtering work?\n * See the Interactivity Tutorial for details.\n *\n * ## Adding a new function\n * LocusZoom allows users to write their own plugins, so that \"does this point match\" logic can incorporate\n *  user-defined code. (via `LocusZoom.MatchFunctions.add('my_function', my_function);`)\n *\n * All \"matcher\" functions have the call signature (item_value, target_value) => {boolean}\n *\n * Both filtering and matching depend on asking \"is this field interesting to me\", which is inherently a problem of\n *  making comparisons. The registry allows any arbitrary function (with a field value as the first argument), but that\n *  function doesn't have to use either argument.\n *\n * @module LocusZoom_MatchFunctions\n */\nimport {RegistryBase} from './base';\n\n/**\n * A plugin registry that allows plots to use both pre-defined and user-provided \"match\" functions, used by filtering and matching behavior.\n * @alias module:LocusZoom~MatchFunctions\n * @type {module:registry/base~RegistryBase}\n */\nconst registry = new RegistryBase();\n\n// Most of the filter syntax uses things that are JS reserved operators. Instead of exporting symbols from another\n//  module, just define and register them here.\n\n/**\n * Check if two values are (strictly) equal\n * @function\n * @name '='\n * @param item_value\n * @param target_value\n */\nregistry.add('=', (item_value, target_value) => item_value === target_value);\n\n/**\n * Check if two values are not equal. This allows weak comparisons (eg undefined/null), so it can also be used to test for the absence of a value\n * @function\n * @name '!='\n * @param item_value\n * @param target_value\n */\n// eslint-disable-next-line eqeqeq\nregistry.add('!=', (a, b) => a != b); // For absence of a value, deliberately allow weak comparisons (eg undefined/null)\n\n/**\n * Less-than comparison\n * @function\n * @name '<'\n * @param item_value\n * @param target_value\n */\nregistry.add('<', (a, b) => a < b);\n\n/**\n * Less than or equals to comparison\n * @function\n * @name '<='\n * @param item_value\n * @param target_value\n */\nregistry.add('<=', (a, b) => a <= b);\n\n/**\n * Greater-than comparison\n * @function\n * @name '>'\n * @param item_value\n * @param target_value\n */\nregistry.add('>', (a, b) => a > b);\n\n/**\n * Greater than or equals to comparison\n * @function\n * @name '>='\n * @param item_value\n * @param target_value\n */\nregistry.add('>=', (a, b) => a >= b);\n\n/**\n * Modulo: tests for whether the remainder a % b is nonzero\n * @function\n * @name '%'\n * @param item_value\n * @param target_value\n */\nregistry.add('%', (a, b) => a % b);\n\n/**\n * Check whether the provided value (a) is in the string or array of values (b)\n *\n * This can be used to check if a field value is one of a set of predefined choices\n *  Eg, `gene_type` is one of the allowed types of interest\n * @function\n * @name 'in'\n * @param item_value A scalar value\n * @param {String|Array} target_value A container that implements the `includes` method\n */\nregistry.add('in', (a, b) => b && b.includes(a));\n\n/**\n * Partial-match function. Can be used for free text search (\"find all gene names that contain the user-entered string 'TCF'\")\n * @function\n * @name 'match'\n * @param {String|Array} item_value A container (like a string) that implements the `includes` method\n * @param target_value A scalar value, like a string\n */\nregistry.add('match', (a, b) => a && a.includes(b)); // useful for text search: \"find all gene names that contain the user-entered value HLA\"\n\n\nexport default registry;\n","/**\n * Plugin registry of available functions that can be used in scalable layout directives.\n *\n * These \"scale functions\" are used during rendering to return output (eg color) based on input value\n *\n * @module LocusZoom_ScaleFunctions\n * @see {@link module:LocusZoom_DataLayers~ScalableParameter} for details on how scale functions are used by datalayers\n */\n\nimport * as d3 from 'd3';\n\n/**\n * Basic conditional function to evaluate the value of the input field and return based on equality.\n * @alias module:LocusZoom_ScaleFunctions~if\n * @param {Object} parameters\n * @param {*} parameters.field_value The value against which to test the input value.\n * @param {*} parameters.then The value to return if the input value matches the field value\n * @param {*} parameters.else  The value to return if the input value does not match the field value. Optional. If not\n *   defined this scale function will return null (or value of null_value parameter, if defined) when input value fails\n *   to match field_value.\n * @param {*} value value\n */\nconst if_value = (parameters, value) => {\n    if (typeof value == 'undefined' || parameters.field_value !== value) {\n        if (typeof parameters.else != 'undefined') {\n            return parameters.else;\n        } else {\n            return null;\n        }\n    } else {\n        return parameters.then;\n    }\n};\n\n/**\n * Function to sort numerical values into bins based on numerical break points. Will only operate on numbers and\n *   return null (or value of null_value parameter, if defined) if provided a non-numeric input value. Parameters:\n * @function numerical_bin\n * @param {Object} parameters\n * @param {Number[]} parameters.breaks  Array of numerical break points against which to evaluate the input value.\n *   Must be of equal length to values parameter. If the input value is greater than or equal to break n and less than\n *   or equal to break n+1 (or break n+1 doesn't exist) then returned value is the nth entry in the values parameter.\n * @param {Array} parameters.values  Array of values to return given evaluations against break points. Must be of\n *   equal length to breaks parameter. Each entry n represents the value to return if the input value is greater than\n *   or equal to break n and less than or equal to break n+1 (or break n+1 doesn't exist).\n * @param {*} parameters.null_value\n * @param {*} value value\n * @returns {*}\n */\nconst numerical_bin = (parameters, value) => {\n    const breaks = parameters.breaks || [];\n    const values = parameters.values || [];\n    if (typeof value == 'undefined' || value === null || isNaN(+value)) {\n        return (parameters.null_value ? parameters.null_value : null);\n    }\n    const threshold = breaks.reduce(function (prev, curr) {\n        if (+value < prev || (+value >= prev && +value < curr)) {\n            return prev;\n        } else {\n            return curr;\n        }\n    });\n    return values[breaks.indexOf(threshold)];\n};\n\n/**\n * Function to sort values of any type into bins based on direct equality testing with a list of categories.\n *   Will return null if provided an input value that does not match to a listed category.\n * @function categorical_bin\n * @param {Object} parameters\n * @param {Array} parameters.categories  Array of values against which to evaluate the input value. Must be of equal\n *   length to values parameter. If the input value is equal to category n then returned value is the nth entry in the\n *   values parameter.\n * @param {Array} parameters.values  Array of values to return given evaluations against categories. Must be of equal\n *   length to categories parameter. Each entry n represents the value to return if the input value is equal to the nth\n *   value in the categories parameter.\n * @param {*} parameters.null_value  Value to return if the input value fails to match to any categories. Optional.\n */\nconst categorical_bin = (parameters, value) => {\n    if (typeof value == 'undefined' || !parameters.categories.includes(value)) {\n        return (parameters.null_value ? parameters.null_value : null);\n    } else {\n        return parameters.values[parameters.categories.indexOf(value)];\n    }\n};\n\n/**\n * Cycle through a set of options, so that the each element in a set of data receives a value different than the\n *  element before it. For example: \"use this palette of 10 colors to visually distinguish 100 adjacent items\"\n * This is useful when ADJACENT items must be guaranteed to yield a different result, but it leads to unstable color\n *  choices if the user pans to a region with a different number/order of items. (the same item is assigned a different color)\n *\n *  See also: stable_choice.\n * @function ordinal_cycle\n *  @param {Object} parameters\n *  @param {Array} parameters.values A list of option values\n * @return {*}\n */\nconst ordinal_cycle = (parameters, value, index) => {\n    const options = parameters.values;\n    return options[index % options.length];\n};\n\n/**\n * A scale function that auto-chooses something (like color) from a preset scheme, and makes the same choice every\n * time given the same value, regardless of ordering or what other data is in the region\n *\n * This is useful when categories must be stable (same color, every time). But sometimes it will assign adjacent values\n *  the same color due to hash collisions.\n *\n * For performance reasons, this is memoized once per instance. Eg, each scalable color parameter has its own cache.\n *  This function is therefore slightly less amenable to layout mutations like \"changing the options after scaling\n *  function is used\", but this is not expected to be a common use case.\n *\n *  CAVEAT: Some datasets do not return true datum ids, but instead append synthetic ID fields (\"item 1, item2\"...)\n *    just to appease D3. This hash function only works if there is a meaningful, stable identifier in the data,\n *    like a category or gene name.\n *\n * @function stable_choice\n *\n * @param parameters\n * @param {Array} [parameters.values] A list of options to choose from\n * @param {Number} [parameters.max_cache_size=500] The maximum number of values to cache. This option is mostly used\n *  for unit testing, because stable choice is intended for datasets with a relatively limited number of\n *  discrete categories.\n * @param value\n * @param index\n */\nlet stable_choice = (parameters, value, index) => {\n    // Each place the function gets used has its own parameters object. This function thus memoizes per usage\n    //  (\"association - point color - directive 1\") rather than globally (\"all properties/panels\")\n    const cache = parameters._cache = parameters._cache || new Map();\n    const max_cache_size = parameters.max_cache_size || 500;\n\n    if (cache.size >= max_cache_size) {\n        // Prevent cache from growing out of control (eg as user moves between regions a lot)\n        cache.clear();\n    }\n    if (cache.has(value)) {\n        return cache.get(value);\n    }\n\n    // Simple JS hashcode implementation, from:\n    //  https://stackoverflow.com/questions/7616461/generate-a-hash-from-string-in-javascript\n    let hash = 0;\n    value = String(value);\n    for (let i = 0; i < value.length; i++) {\n        let chr = value.charCodeAt(i);\n        hash  = ((hash << 5) - hash) + chr;\n        hash |= 0; // Convert to 32bit integer\n    }\n    // Convert signed 32 bit integer to be within the range of options allowed\n    const options = parameters.values;\n    const result = options[Math.abs(hash) % options.length];\n    cache.set(value, result);\n    return result;\n};\n\n/**\n * Function for continuous interpolation of numerical values along a gradient with arbitrarily many break points.\n * @function interpolate\n * @parameters {Object} parameters\n * @parameters {Number[]} parameters.breaks  Array of numerical break points against which to evaluate the input value.\n *   Must be of equal length to values parameter and contain at least two elements. Input value will be evaluated for\n *   relative position between two break points n and n+1 and the returned value will be interpolated at a relative\n *   position between values n and n+1.\n * @parameters {*[]} parameters.values  Array of values to interpolate and return given evaluations against break\n *   points. Must be of equal length to breaks parameter and contain at least two elements. Each entry n represents\n *   the value to return if the input value matches the nth entry in breaks exactly. Note that this scale function\n *   uses d3.interpolate to provide for effective interpolation of many different value types, including numbers,\n *   colors, shapes, etc.\n * @parameters {*} parameters.null_value\n */\nconst interpolate = (parameters, value) => {\n    var breaks = parameters.breaks || [];\n    var values = parameters.values || [];\n    var nullval = (parameters.null_value ? parameters.null_value : null);\n    if (breaks.length < 2 || breaks.length !== values.length) {\n        return nullval;\n    }\n    if (typeof value == 'undefined' || value === null || isNaN(+value)) {\n        return nullval;\n    }\n    if (+value <= parameters.breaks[0]) {\n        return values[0];\n    } else if (+value >= parameters.breaks[parameters.breaks.length - 1]) {\n        return values[breaks.length - 1];\n    } else {\n        var upper_idx = null;\n        breaks.forEach(function (brk, idx) {\n            if (!idx) {\n                return;\n            }\n            if (breaks[idx - 1] <= +value && breaks[idx] >= +value) {\n                upper_idx = idx;\n            }\n        });\n        if (upper_idx === null) {\n            return nullval;\n        }\n        const normalized_input = (+value - breaks[upper_idx - 1]) / (breaks[upper_idx] - breaks[upper_idx - 1]);\n        if (!isFinite(normalized_input)) {\n            return nullval;\n        }\n        return d3.interpolate(values[upper_idx - 1], values[upper_idx])(normalized_input);\n    }\n};\n\n\n/**\n * Calculate the effect direction based on beta, or the combination of beta and standard error.\n *   Typically used with phewas plots, to show point shape based on the beta and stderr_beta fields.\n *\n * @function effect_direction\n * @param parameters\n * @param parameters.'+' The value to return if the effect direction is positive\n * @param parameters.'-' The value to return if the effect direction is positive\n * @param parameters.beta_field The name of the field containing beta\n * @param parameters.stderr_beta_field The name of the field containing stderr_beta\n * @param {Object} input This function should receive the entire datum object, rather than one single field\n * @returns {null}\n */\nfunction effect_direction(parameters, input) {\n    if (input === undefined) {\n        return null;\n    }\n\n    const { beta_field, stderr_beta_field, '+': plus_result = null, '-': neg_result = null } = parameters;\n\n    if (!beta_field || !stderr_beta_field) {\n        throw new Error(`effect_direction must specify how to find required 'beta' and 'stderr_beta' fields`);\n    }\n\n    const beta_val = input[beta_field];\n    const se_val = input[stderr_beta_field];\n\n    if (beta_val !== undefined) {\n        if (se_val !== undefined) {\n            if ((beta_val - 1.96 * se_val) > 0) {\n                return plus_result;\n            } else if ((beta_val + 1.96 * se_val) < 0) {\n                return neg_result || null;\n            }\n        } else {\n            if (beta_val > 0) {\n                return plus_result;\n            } else if (beta_val < 0) {\n                return neg_result;\n            }\n        }\n    }\n    // Note: The original PheWeb implementation allowed odds ratio in place of beta/se. LZ core is a bit more rigid\n    //   about expected data formats for layouts.\n    return null;\n}\n\nexport { categorical_bin, stable_choice, if_value, interpolate, numerical_bin, ordinal_cycle, effect_direction };\n","/**\n * Functions that control \"scalable\" layout directives: given a value (like a number) return another value\n *  (like a color, size, or shape) that governs how something is displayed\n *\n *  All scale functions have the call signature `(layout_parameters, input) => result|null`\n * @module\n * @private\n */\nimport {RegistryBase} from './base';\nimport * as scalable from '../helpers/scalable';\n\n\nconst registry = new RegistryBase();\nfor (let [name, type] of Object.entries(scalable)) {\n    registry.add(name, type);\n}\n\n// Alias for the \"if_value\" function (can't export reserved language keywords directly)\nregistry.add('if', scalable.if_value);\n\n\nexport default registry;\n","/**\n * Data layers represent instructions for how to render common types of information.\n *  (GWAS scatter plot, nearby genes, straight lines and filled curves, etc)\n *\n * Each rendering type also provides helpful functionality such as filtering, matching, and interactive tooltip\n *  display. Predefined layers can be extended or customized, with many configurable options.\n *\n * @module LocusZoom_DataLayers\n */\n\nimport * as d3 from 'd3';\n\nimport {STATUSES} from '../constants';\nimport Field from '../../data/field';\nimport {parseFields} from '../../helpers/display';\nimport {deepCopy, findFields, merge} from '../../helpers/layouts';\nimport MATCHERS from '../../registry/matchers';\nimport SCALABLE from '../../registry/scalable';\n\n\n/**\n * \"Scalable\" parameters indicate that a datum can be rendered in custom ways based on its value. (color, size, shape, etc)\n *\n * This means that if the value of this property is a scalar, it is used directly (`color: '#FF0000'`). But if the\n *  value is an array of options, each will be evaluated in turn until the first non-null result is found. The syntax\n *  below describes how each member of the array should specify the field and scale function to be used.\n * Often, the last item in the list is a string, providing a \"default\" value if all scale functions evaluate to null.\n *\n * @typedef {object[]|string} ScalableParameter\n * @property {string} [field] The name of the field to use in the scale function. If omitted, all fields for the given\n *  datum element will be passed to the scale function.\n * @property {module:LocusZoom_ScaleFunctions} scale_function The name of a scale function that will be run on each individual datum\n * @property {object} parameters A set of parameters that configure the desired scale function (options vary by function)\n */\n\n\n/**\n * @typedef {Object} module:LocusZoom_DataLayers~behavior\n * @property {'set'|'unset'|'toggle'|'link'} action\n * @property {'highlighted'|'selected'|'faded'|'hidden'} status An element display status to set/unset/toggle\n * @property {boolean} exclusive Whether an element status should be exclusive (eg only allow one point to be selected at a time)\n * @property {string} href For links, the URL to visit when clicking\n * @property {string} target For links, the `target` attribute (eg, name of a window or tab in which to open this link)\n */\n\n\n/**\n * @typedef {object} FilterOption\n * @property {string} field The name of a field found within each datapoint datum\n * @property {module:LocusZoom_MatchFunctions} operator The name of a comparison function to use when deciding if the\n *   field satisfies this filter\n * @property value The target value to compare to\n */\n\n/**\n * @typedef {object} DataOperation A synchronous function that modifies data returned from adapters, in order to clean up or reformat prior to plotting.\n * @property {module:LocusZoom_DataFunctions|'fetch'} type\n * @property {String[]} [from] For operations of type \"fetch\", this is required. By default, it will fill in any items provided in \"namespace\" (everything specified in namespace triggers an adapter/network request)\n *   A namespace should be manually specified in this array when there are dependencies (one request depends on the content of what is returned from another namespace).\n *   Eg, for ld to be fetched after association data, specify \"ld(assoc)\". Most LocusZoom examples fill in all items, in order to make the examples more clear.\n * @property {String} [name] The name of this operation. This only needs to be specified if a data layer performs several operations, and needs to refer to the result of a prior operation.\n *   Eg, if the retrieved data is combined via several left joins in series: `name: \"assoc_plus_ld\"` -> feeds into `{name: \"final\", requires: [\"assoc_plus_ld\"]}`\n * @property {String[]} requires The names of each adapter required. This does not need to specify dependencies, just\n *  the names of other namespaces (or data operations) whose results must be available before a join can be performed\n * @property {String[]} params Any user-defined parameters that should be passed to the particular join function\n *   (see: {@link module:LocusZoom_DataFunctions} for details). For example, this could specify the left and right key fields for a join function, based on the expected field names used in this data layer: `params: ['assoc:position', 'ld:position2']`\n *   Separate from this section, data functions will also receive a copy of \"plot.state\" automatically.\n */\n\n\n/**\n * @typedef {object} LegendItem\n * @property [shape] This is optional (e.g. a legend element could just be a textual label).\n *   Supported values are the standard d3 3.x symbol types (i.e. \"circle\", \"cross\", \"diamond\", \"square\",\n *   \"triangle-down\", and \"triangle-up\"), as well as \"rect\" for an arbitrary square/rectangle or \"line\" for a path.\n *   A special \"ribbon\" option can be use to draw a series of explicit, numeric-only color stops (a row of colored squares, such as to indicate LD)\n * @property {string} color The point color (hexadecimal, rgb, etc)\n * @property {string} label The human-readable label of the legend item\n * @property {string} [class] The name of a CSS class used to style the point in the legend\n * @property {number} [size] The point area for each element (if the shape is a d3 symbol). Eg, for a 40 px area,\n *  a circle would be ~7..14 px in diameter.\n * @property {number} [length] Length (in pixels) for the path rendered as the graphical portion of the legend element\n *  if the value of the shape parameter is \"line\".\n * @property {number} [width] Width (in pixels) for the rect rendered as the graphical portion of the legend element if\n *   the value of the shape parameter is \"rect\" or \"ribbon\".\n * @property {number} [height] Height (in pixels) for the rect rendered as the graphical portion of the legend element if\n *   the value of the shape parameter is \"rect\" or \"ribbon\".\n * @property {'vertical'|'horizontal'} [orientation='vertical'] For shape \"ribbon\", specifies whether to draw the ribbon vertically or horizontally.\n * @property {Array} [tick_labels] For shape \"ribbon\", specifies the tick labels that correspond to each colorstop value. Tick labels appear at all box edges: this array should have 1 more item than the number of colorstops.\n * @property {String[]} [color_stops] For shape \"ribbon\", specifies the colors of each box in the row of colored squares. There should be 1 fewer item in color_stops than the number of tick labels.\n * @property {object} style CSS styles object to be applied to the DOM element representing the graphical portion of\n *   the legend element.\n */\n\n\n/**\n * A basic description of keys expected in all data layer layouts. Not intended to be directly used or modified by an end user.\n * @memberof module:LocusZoom_DataLayers~BaseDataLayer\n * @protected\n */\nconst default_layout = {\n    id: '',\n    type: '',\n    tag: 'custom_data_type',\n    namespace: {},\n    data_operations: [],\n    id_field: 'id',\n    filters: null,\n    match: {},\n    x_axis: {},\n    y_axis: {},  // Axis options vary based on data layer type\n    legend: null,\n    tooltip: {},\n    tooltip_positioning: 'horizontal',  // Where to draw tooltips relative to the point. Can be \"vertical\" or \"horizontal\"\n    behaviors: {},\n};\n\n/**\n * A data layer is an abstract class representing a data set and its graphical representation within a panel\n * @public\n*/\nclass BaseDataLayer {\n    /**\n     * @param {string} [layout.id=''] An identifier string that must be unique across all layers within the same panel\n     * @param {string} [layout.type=''] The type of data layer. This parameter is used in layouts to specify which class\n     *   (from the registry) is created; it is also used in CSS class names.\n     * @param {string} [layout.tag='custom_data_type'] Tags have no functional purpose, but they can be used\n     *   as a semantic label for what is being displayed in this element. This makes it easy to write custom code like \"find every data\n     *   layer that shows association scatter plots, anywhere\": even if the IDs are different, the tag can be the same.\n     *   Most built-in data layers will contain a tag that describes, in human-readable terms, what kind of data is being shown.\n     *   (see: {@link LayoutRegistry.mutate_attrs})\n     * @param {string} [layout.id_field] The datum field used for unique element IDs when addressing DOM elements, mouse\n     *   events, etc. This should be unique to the specified datum, and persistent across re-renders (because it is\n     *   used to identify where to draw tooltips, eg, if the plot is dragged or zoomed). If no single field uniquely\n     *   identifies all items, a template expression can be used to create an ID from multiple fields instead. (it is\n     *   your job to assure that all of the expected fields are present in every element)\n     * @param {object} layout.namespace A set of key value pairs representing how to map the local usage of data (\"assoc\")\n     *   to the globally unique name for something defined in LocusZoom.DataSources.\n     *   Namespaces allow a single layout to be reused to plot many tracks of the same type: \"given some form of association data, plot it\".\n     *   These pairs take the form of { local_name: global_name }. (and all data layer layouts provide a default) In order to reuse\n     *   a layout with a new provider of data- like plotting two association studies stacked together-\n     *   only the namespace section of the layout needs to be overridden.\n     *   Eg, `LocusZoom.Layouts.get('data_layers', 'association_pvalues', { namespace: { assoc: 'assoc_study_2' }})`\n     * @param {module:LocusZoom_DataLayers~DataOperation[]} layout.data_operations A set of data operations that will be performed on the data returned from the data adapters specified in `namespace`. (see: {@link module:LocusZoom_DataFunctions})\n     * @param {module:LocusZoom_DataLayers~FilterOption[]} [layout.filters] If present, restricts the list of data elements to be displayed. Typically, filters\n     *  hide elements, but arrange the layer so as to leave the space those elements would have occupied. The exact\n     *  details vary from one layer to the next. See the Interactivity Tutorial for details.\n     * @param {object} [layout.match] An object describing how to connect this data layer to other data layers in the\n     *   same plot. Specifies keys `send` and `receive` containing the names of fields with data to be matched;\n     *   `operator` specifies the name of a MatchFunction to use. If a datum matches the broadcast value, it will be\n     *   marked with the special field `lz_is_match=true`, which can be used in any scalable layout directive to control how the item is rendered.\n     * @param {boolean} [layout.x_axis.decoupled=false] If true, the data in this layer will not influence the x-extent of the panel.\n     * @param {'state'|null} [layout.x_axis.extent] If provided, the region plot x-extent will be determined from\n     *   `plot.state` rather than from the range of the data. This is the most common way of setting x-extent,\n     *   as it is useful for drawing a set of panels to reflect a particular genomic region.\n     * @param {number} [layout.x_axis.floor] The low end of the x-extent, which overrides any actual data range, min_extent, or buffer options.\n     * @param {number} [layout.x_axis.ceiling] The high end of the x-extent, which overrides any actual data range, min_extent, or buffer options.\n     * @param {Number[]} [layout.x_axis.min_extent] The smallest possible range [min, max] of the x-axis. If the actual values lie outside the extent, the actual data takes precedence.\n     * @param {number} [layout.x_axis.field] The datum field to look at when determining data extent along the x-axis.\n     * @param {number} [layout.x_axis.lower_buffer] Amount to expand (pad) the lower end of an axis as a proportion of the extent of the data.\n     * @param {number} [layout.x_axis.upper_buffer] Amount to expand (pad) the higher end of an axis as a proportion of the extent of the data.\n     * @param {boolean} [layout.y_axis.decoupled=false] If true, the data in this layer will not influence the y-extent of the panel.\n     * @param {object} [layout.y_axis.axis=1] Which y axis to use for this data layer (left=1, right=2)\n     * @param {number} [layout.y_axis.floor] The low end of the y-extent, which overrides any actual data range, min_extent, or buffer options.\n     * @param {number} [layout.y_axis.ceiling] The high end of the y-extent, which overrides any actual data range, min_extent, or buffer options.\n     * @param {Number[]} [layout.y_axis.min_extent] The smallest possible range [min, max] of the y-axis. Actual lower or higher data values will take precedence.\n     * @param {number} [layout.y_axis.field] The datum field to look at when determining data extent along the y-axis.\n     * @param {number} [layout.y_axis.lower_buffer] Amount to expand (pad) the lower end of an axis as a proportion of the extent of the data.\n     * @param {number} [layout.y_axis.upper_buffer] Amount to expand (pad) the higher end of an axis as a proportion of the extent of the data.\n     * @param {object} [layout.tooltip.show] Define when to show a tooltip in terms of interaction states, eg, `{ or: ['highlighted', 'selected'] }`\n     * @param {object} [layout.tooltip.hide] Define when to hide a tooltip in terms of interaction states, eg, `{ and: ['unhighlighted', 'unselected'] }`\n     * @param {boolean} [layout.tooltip.closable] Whether a tool tip should render a \"close\" button in the upper right corner.\n     * @param {string} [layout.tooltip.html] HTML template to render inside the tool tip. The template syntax uses curly braces to allow simple expressions:\n     *   eg `{{sourcename:fieldname}} to insert a field value from the datum associated with\n     *   the tooltip/element. Conditional tags are supported using the format:\n     *   `{{#if sourcename:fieldname|transforms_can_be_used_too}}render text here{{#else}}Optional else branch{{/if}}`.\n     * @param {'horizontal'|'vertical'|'top'|'bottom'|'left'|'right'} [layout.tooltip_positioning='horizontal'] Where to draw the tooltip relative to the datum.\n     *  Typically tooltip positions are centered around the midpoint of the data element, subject to overflow off the edge of the plot.\n     * @param {object} [layout.behaviors] LocusZoom data layers support the binding of mouse events to one or more\n     *   layout-definable behaviors. Some examples of behaviors include highlighting an element on mouseover, or\n     *   linking to a dynamic URL on click, etc.\n     * @param {module:LocusZoom_DataLayers~LegendItem[]} [layout.legend] Tick marks found in the panel legend\n     * @param {module:LocusZoom_DataLayers~behavior[]} [layout.behaviors.onclick]\n     * @param {module:LocusZoom_DataLayers~behavior[]} [layout.behaviors.onctrlclick]\n     * @param {module:LocusZoom_DataLayers~behavior[]} [layout.behaviors.onctrlshiftclick]\n     * @param {module:LocusZoom_DataLayers~behavior[]} [layout.behaviors.onshiftclick]\n     * @param {module:LocusZoom_DataLayers~behavior[]} [layout.behaviors.onmouseover]\n     * @param {module:LocusZoom_DataLayers~behavior[]} [layout.behaviors.onmouseout]\n     * @param {Panel|null} parent Where this layout is used\n     */\n    constructor(layout, parent) {\n        /**\n         * @private\n         * @member {Boolean}\n         */\n        this._initialized = false;\n        /**\n         * @private\n         * @member {Number}\n         */\n        this._layout_idx = null;\n\n        /**\n         * The unique identifier for this layer. Should be unique within this panel.\n         * @public\n         * @member {String}\n         */\n        this.id     = null;\n\n        /**\n         * The fully qualified identifier for the data layer, prefixed by any parent or container elements.\n         * @type {string}\n         * @private\n         */\n        this._base_id = null;\n\n        /**\n         * @protected\n         * @member {Panel}\n         */\n        this.parent = parent || null;\n        /**\n         * @private\n         * @member {{group: d3.selection, container: d3.selection, clipRect: d3.selection}}\n         */\n        this.svg    = {};\n\n        /**\n         * @protected\n         * @member {Plot}\n         */\n        this.parent_plot = null;\n        if (parent) {\n            this.parent_plot = parent.parent;\n        }\n\n        /**\n         * The current layout configuration for this data layer. This reflects any resizing or dynamically generated\n         *  config options produced during rendering. Direct layout mutations are a powerful way to dynamically\n         *  modify the plot in response to user interactions, but require a deep knowledge of LZ internals to use\n         *  effectively.\n         * @public\n         * @member {Object}\n         */\n        this.layout = merge(layout || {}, default_layout);\n        if (this.layout.id) {\n            this.id = this.layout.id;\n        }\n\n        /**\n         * A user-provided function used to filter data for display. If provided, this will override any declarative\n         *  options in `layout.filters`\n         * @private\n         * @deprecated\n         */\n        this._filter_func = null;\n\n        // Ensure any axes defined in the layout have an explicit axis number (default: 1)\n        if (this.layout.x_axis !== {} && typeof this.layout.x_axis.axis !== 'number') {\n            // TODO: Example of x2? if none remove\n            this.layout.x_axis.axis = 1;\n        }\n        if (this.layout.y_axis !== {} && typeof this.layout.y_axis.axis !== 'number') {\n            this.layout.y_axis.axis = 1;\n        }\n\n        /**\n         * Values in the layout object may change during rendering etc. Retain a copy of the original data layer state.\n         * This is useful for, eg, dynamically generated color schemes that need to start from scratch when new data is\n         * loaded: it contains the \"defaults\", not just the result of a calculated value.\n         * @ignore\n         * @protected\n         * @member {Object}\n         */\n        this._base_layout = deepCopy(this.layout);\n\n        /**\n         * @private\n         * @member {Object}\n         */\n        this.state = {};\n        /**\n         * @private\n         * @member {String}\n         */\n        this._state_id = null;\n\n        /**\n         * @private\n         * @member {Object}\n         * */\n        this._layer_state = null;\n        // Create a default state (and set any references to the parent as appropriate)\n        this._setDefaultState();\n\n        // Initialize parameters for storing data and tool tips\n        /**\n         * The data retrieved from a region request. This field is useful for debugging, but will be overridden on\n         *  re-render; do not modify it directly. The point annotation cache can be used to preserve markings\n         *  after re-render.\n         * @protected\n         * @member {Array}\n         */\n        this.data = [];\n        if (this.layout.tooltip) {\n            /**\n             * @private\n             * @member {Object}\n             */\n            this._tooltips = {};\n        }\n\n        // Initialize flags for tracking global statuses\n        this._global_statuses = {\n            'highlighted': false,\n            'selected': false,\n            'faded': false,\n            'hidden': false,\n        };\n\n        // On first load, pre-parse the data specification once, so that it can be used for all other data retrieval\n        this._data_contract = new Set(); // List of all fields requested by the layout\n        this._entities = new Map();\n        this._dependencies = [];\n        this.mutateLayout();  // Parse data spec and any other changes that need to reflect the layout\n    }\n\n    /****** Public interface: methods for manipulating the layer from other parts of LZ */\n\n    /**\n     * @public\n     */\n    render() {\n        throw new Error('Method must be implemented');\n    }\n\n    /**\n     * Move a data layer forward relative to others by z-index\n     * @public\n     * @returns {BaseDataLayer}\n     */\n    moveForward() {\n        const layer_order = this.parent._data_layer_ids_by_z_index;\n        const current_index = this.layout.z_index;\n        if (layer_order[current_index + 1]) {\n            layer_order[current_index] = layer_order[current_index + 1];\n            layer_order[current_index + 1] = this.id;\n            this.parent.resortDataLayers();\n        }\n        return this;\n    }\n\n    /**\n     * Move a data layer back relative to others by z-index\n     * @public\n     * @returns {BaseDataLayer}\n     */\n    moveBack() {\n        const layer_order = this.parent._data_layer_ids_by_z_index;\n        const current_index = this.layout.z_index;\n        if (layer_order[current_index - 1]) {\n            layer_order[current_index] = layer_order[current_index - 1];\n            layer_order[current_index - 1] = this.id;\n            this.parent.resortDataLayers();\n        }\n        return this;\n    }\n\n    /**\n     * Set an \"annotation\": a piece of additional information about a point that is preserved across re-render,\n     *  or as the user pans and zooms near this region.\n     *\n     * Annotations can be referenced as a named pseudo-field in any filters and scalable parameters. (template support\n     *  may be added in the future)\n     * Sample use case: user clicks a tooltip to \"label this specific point\". (or change any other display property)\n     *\n     * @public\n     * @param {String|Object} element The data object or ID string for the element\n     * @param {String} key The name of the annotation to track\n     * @param {*} value The value of the marked field\n     */\n    setElementAnnotation (element, key, value) {\n        const id = this.getElementId(element);\n        if (!this._layer_state.extra_fields[id]) {\n            this._layer_state.extra_fields[id] = {};\n        }\n        this._layer_state.extra_fields[id][key] = value;\n        return this;\n    }\n\n    /**\n     * Select a filter function to be applied to the data. DEPRECATED: Please use the LocusZoom.MatchFunctions registry\n     *  and reference via declarative filters.\n     * @param func\n     * @deprecated\n     */\n    setFilter(func) {\n        console.warn('The setFilter method is deprecated and will be removed in the future; please use the layout API with a custom filter function instead');\n        this._filter_func = func;\n    }\n\n    /**\n     * A list of operations that should be run when the layout is mutated\n     * Typically, these are things done once when a layout is first specified, that would not automatically\n     *  update when the layout was changed.\n     * @public\n     */\n    mutateLayout() {\n        // Are we fetching data from external providers? If so, validate that those API calls would meet the expected contract.\n        if (this.parent_plot) { // Don't run this method if instance isn't mounted to a plot, eg unit tests that don't require requester\n            const { namespace, data_operations } = this.layout;\n            this._data_contract = findFields(this.layout, Object.keys(namespace));\n            const [entities, dependencies] = this.parent_plot.lzd.config_to_sources(namespace, data_operations, this);\n            this._entities = entities;\n            this._dependencies = dependencies;\n        }\n    }\n\n    /********** Protected methods: useful in subclasses to manipulate data layer behaviors */\n    /**\n     * Implementation hook for fetching the min and max values of available data. Used to determine axis range, if no other\n     *   explicit axis settings override. Useful for data layers where the data extent depends on more than one field.\n     *   (eg confidence intervals in a forest plot)\n     *\n     * @protected\n     * @param data\n     * @param axis_config The configuration object for the specified axis.\n     * @returns {Array} [min, max] without any padding applied\n     */\n    _getDataExtent (data, axis_config) {\n        data = data || this.data;\n        // By default this depends only on a single field.\n        return d3.extent(data, (d) => {\n            const f = new Field(axis_config.field);\n            return +f.resolve(d);\n        });\n    }\n\n    /**\n     * Fetch the fully qualified ID to be associated with a specific visual element, based on the data to which that\n     *   element is bound. In general this element ID will be unique, allowing it to be addressed directly via selectors.\n     *\n     * The ID should also be stable across re-renders, so that tooltips and highlights may be reapplied to that\n     *   element as we switch regions or drag left/right. If the element is not unique along a single field (eg PheWAS data),\n     *   a unique ID can be generated via a template expression like `{{phewas:pheno}}-{{phewas:trait_label}}`\n     * @protected\n     * @param {Object} element The data associated with a particular element\n     * @returns {String}\n     */\n    getElementId (element) {\n        // Use a cached value if possible\n        const id_key = Symbol.for('lzID');\n        if (element[id_key]) {\n            return element[id_key];\n        }\n\n        // Two ways to get element ID: field can specify an exact field name, or, we can parse a template expression\n        const id_field = this.layout.id_field;\n        let value  = element[id_field];\n        if (typeof value === 'undefined' && /{{[^{}]*}}/.test(id_field)) {\n            // No field value was found directly, but if it looks like a template expression, next, try parsing that\n            // WARNING: In this mode, it doesn't validate that all requested fields from the template are present. Only use this if you trust the data being given to the plot!\n            value = parseFields(id_field, element, {}); // Not allowed to use annotations b/c IDs should be stable, and annos may be transient\n        }\n        if (value === null || value === undefined) {\n            // Neither exact field nor template options produced an ID\n            throw new Error('Unable to generate element ID');\n        }\n        const element_id = value.toString().replace(/\\W/g, '');\n\n        // Cache ID value for future calls\n        const key = (`${this.getBaseId()}-${element_id}`).replace(/([:.[\\],])/g, '_');\n        element[id_key] = key;\n        return key;\n    }\n\n    /**\n     * Abstract method. It should be overridden by data layers that implement separate status\n     *   nodes, such as genes or intervals.\n     * Fetch an ID that may bind a data element to a separate visual node for displaying status\n     * Examples of this might be highlighting a gene with a surrounding box to show select/highlight statuses, or\n     *   a group of unrelated intervals (all markings grouped within a category).\n     * @private\n     * @param {String|Object} element\n     * @returns {String|null}\n     */\n    getElementStatusNodeId (element) {\n        return null;\n    }\n\n    /**\n     * Returns a reference to the underlying data associated with a single visual element in the data layer, as\n     *   referenced by the unique identifier for the element\n     *\n     * @ignore\n     * @protected\n     * @param {String} id The unique identifier for the element, as defined by `getElementId`\n     * @returns {Object|null} The data bound to that element\n     */\n    getElementById(id) {\n        const selector = d3.select(`#${id.replace(/([:.[\\],])/g, '\\\\$1')}`); // escape special characters\n        if (!selector.empty() && selector.data() && selector.data().length) {\n            return selector.data()[0];\n        } else {\n            return null;\n        }\n    }\n\n    /**\n     * Basic method to apply arbitrary methods and properties to data elements.\n     *   This is called on all data immediately after being fetched. (requires reMap, not just re-render)\n     *\n     * Allowing a data element to access its parent enables interactive functionality, such as tooltips that modify\n     *  the parent plot. This is also used for system-derived fields like \"matching\" behavior\".\n     *\n     * @protected\n     * @returns {BaseDataLayer}\n     */\n    applyDataMethods() {\n        const field_to_match = (this.layout.match && this.layout.match.receive);\n        const match_function = MATCHERS.get(this.layout.match && this.layout.match.operator || '=');\n        const broadcast_value = this.parent_plot.state.lz_match_value;\n        // Match functions are allowed to use transform syntax on field values, but not (yet) UI \"annotations\"\n        const field_resolver = field_to_match ? new Field(field_to_match) : null;\n\n        // Does the data from the API satisfy the list of fields expected by this layout?\n        //   Not every record will have every possible field (example: left joins like assoc + ld). The check is \"did\n        //      we see this field at least once in any record at all\".\n        if (this.data.length && this._data_contract.size) {\n            const fields_unseen = new Set(this._data_contract);\n            for (let record of this.data) {\n                Object.keys(record).forEach((field) => fields_unseen.delete(field));\n                if (!fields_unseen.size) {\n                    // Once every requested field has been seen in at least one record, no need to look at more records\n                    break;\n                }\n            }\n            if (fields_unseen.size) {\n                // Current implementation is a soft warning, so that certain \"incremental enhancement\" features\n                //  (like rsIDs in tooltips) can fail gracefully if the API does not provide the requested info.\n                //  Template syntax like `{{#if fieldname}}` means that throwing an Error is not always the right answer for missing data.\n                console.debug(`Data layer '${this.getBaseId()}' did not receive all expected fields from retrieved data. Missing fields are: ${[...fields_unseen]}\n  Common reasons for this error include API payloads with missing fields, or data layer layouts that use two kinds of data and need join logic in \"data_operations\"                \n  If this field is optional, you can safely ignore this message. Examples include {{#if value}} tags or conditional color rules.\n`);\n            }\n        }\n\n        this.data.forEach((item, i) => {\n            // Basic toHTML() method - return the stringified value in the id_field, if defined.\n\n            // When this layer receives data, mark whether points match (via a synthetic boolean field)\n            //   Any field-based layout directives (color, size, shape) can then be used to control display\n            if (field_to_match && broadcast_value !== null && broadcast_value !== undefined) {\n                item.lz_is_match = match_function(field_resolver.resolve(item), broadcast_value);\n            }\n\n            // Helper methods - return a reference to various plot levels. Useful for interactive tooltips.\n            item.getDataLayer = () => this;\n            item.getPanel = () => this.parent || null;\n            item.getPlot = () => {\n                // For unit testing etc, this layer may be created without a parent.\n                const panel = this.parent;\n                return panel ? panel.parent : null;\n            };\n        });\n        this.applyCustomDataMethods();\n        return this;\n    }\n\n    /**\n     * Hook that allows custom datalayers to apply additional methods and properties to data elements as needed.\n     * Most data layers will never need to use this.\n     * @protected\n     * @returns {BaseDataLayer}\n     */\n    applyCustomDataMethods() {\n        return this;\n    }\n\n    /**\n     * Apply scaling functions to an element as needed, based on the layout rules governing display + the element's data\n     * If the layout parameter is already a primitive type, simply return the value as given\n     *\n     * In the future this may be further expanded, so that scaling functions can operate similar to mappers\n     *  (item, index, array). Additional arguments would be added as the need arose.\n     *\n     * @private\n     * @param {Array|Number|String|Object} option_layout Either a scalar (\"color is red\") or a configuration object\n     *  (\"rules for how to choose color based on item value\")\n     * @param {*} element_data The value to be used with the filter. May be a primitive value, or a data object for a single item\n     * @param {Number} data_index The array index for the data element\n     * @returns {*} The transformed value\n     */\n    resolveScalableParameter (option_layout, element_data, data_index) {\n        let ret = null;\n        if (Array.isArray(option_layout)) {\n            let idx = 0;\n            while (ret === null && idx < option_layout.length) {\n                ret = this.resolveScalableParameter(option_layout[idx], element_data, data_index);\n                idx++;\n            }\n        } else {\n            switch (typeof option_layout) {\n            case 'number':\n            case 'string':\n                ret = option_layout;\n                break;\n            case 'object':\n                if (option_layout.scale_function) {\n                    const func = SCALABLE.get(option_layout.scale_function);\n                    if (option_layout.field) {\n                        const f = new Field(option_layout.field);\n                        let extra;\n                        try {\n                            extra = this.getElementAnnotation(element_data);\n                        } catch (e) {\n                            extra = null;\n                        }\n                        ret = func(option_layout.parameters || {}, f.resolve(element_data, extra), data_index);\n                    } else {\n                        ret = func(option_layout.parameters || {}, element_data, data_index);\n                    }\n                }\n                break;\n            }\n        }\n        return ret;\n    }\n\n    /**\n     * Generate dimension extent function based on layout parameters\n     * @ignore\n     * @protected\n     * @param {('x'|'y')} dimension\n     */\n    getAxisExtent (dimension) {\n        if (!['x', 'y'].includes(dimension)) {\n            throw new Error('Invalid dimension identifier');\n        }\n\n        const axis_name = `${dimension}_axis`;\n        const axis_layout = this.layout[axis_name];\n\n        // If a floor AND a ceiling are explicitly defined then just return that extent and be done\n        if (!isNaN(axis_layout.floor) && !isNaN(axis_layout.ceiling)) {\n            return [+axis_layout.floor, +axis_layout.ceiling];\n        }\n\n        // If a field is defined for the axis and the data layer has data then generate the extent from the data set\n        let data_extent = [];\n        if (axis_layout.field && this.data) {\n            if (!this.data.length) {\n                // If data has been fetched (but no points in region), enforce the min_extent (with no buffers,\n                //  because we don't need padding around an empty screen)\n                data_extent = axis_layout.min_extent || [];\n                return data_extent;\n            } else {\n                data_extent = this._getDataExtent(this.data, axis_layout);\n\n                // Apply upper/lower buffers, if applicable\n                const original_extent_span = data_extent[1] - data_extent[0];\n                if (!isNaN(axis_layout.lower_buffer)) {\n                    data_extent[0] -= original_extent_span * axis_layout.lower_buffer;\n                }\n                if (!isNaN(axis_layout.upper_buffer)) {\n                    data_extent[1] += original_extent_span * axis_layout.upper_buffer;\n                }\n\n                if (typeof axis_layout.min_extent == 'object') {\n                    // The data should span at least the range specified by min_extent, an array with [low, high]\n                    const range_min = axis_layout.min_extent[0];\n                    const range_max = axis_layout.min_extent[1];\n                    if (!isNaN(range_min) && !isNaN(range_max)) {\n                        data_extent[0] = Math.min(data_extent[0], range_min);\n                    }\n                    if (!isNaN(range_max)) {\n                        data_extent[1] = Math.max(data_extent[1], range_max);\n                    }\n                }\n                // If specified, floor and ceiling will override the actual data range\n                return [\n                    isNaN(axis_layout.floor) ? data_extent[0] : axis_layout.floor,\n                    isNaN(axis_layout.ceiling) ? data_extent[1] : axis_layout.ceiling,\n                ];\n            }\n        }\n\n        // If this is for the x axis and no extent could be generated yet but state has a defined start and end\n        // then default to using the state-defined region as the extent\n        if (dimension === 'x' && !isNaN(this.state.start) && !isNaN(this.state.end)) {\n            return [this.state.start, this.state.end];\n        }\n\n        // No conditions met for generating a valid extent, return an empty array\n        return [];\n    }\n\n    /**\n     * Allow this data layer to tell the panel what axis ticks it thinks it will require. The panel may choose whether\n     *   to use some, all, or none of these when rendering, either alone or in conjunction with other data layers.\n     *\n     *   This method is a stub and should be overridden in data layers that need to specify custom behavior.\n     *\n     * @protected\n     * @param {('x'|'y1'|'y2')} dimension\n     * @param {Object} [config] Additional parameters for the panel to specify how it wants ticks to be drawn. The names\n     *   and meanings of these parameters may vary between different data layers.\n     * @returns {Object[]}\n     *   An array of objects: each object must have an 'x' attribute to position the tick.\n     *   Other supported object keys:\n     *     * text: string to render for a given tick\n     *     * style: d3-compatible CSS style object\n     *     * transform: SVG transform attribute string\n     *     * color: string or LocusZoom scalable parameter object\n     */\n    getTicks (dimension, config) {\n        if (!['x', 'y1', 'y2'].includes(dimension)) {\n            throw new Error(`Invalid dimension identifier ${dimension}`);\n        }\n        return [];\n    }\n\n    /**\n     * Determine the coordinates for where to point the tooltip at. Typically, this is the center of a datum element (eg,\n     *  the middle of a scatter plot point). Also provide an offset if the tooltip should not be at that center (most\n     *  elements are not single points, eg a scatter plot point has a radius and a gene is a rectangle).\n     *  The default implementation is quite naive: it places the tooltip at the origin for that layer. Individual layers\n     *    should override this method to position relative to the chosen data element or mouse event.\n     * @protected\n     * @param {Object} tooltip A tooltip object (including attribute tooltip.data)\n     * @returns {Object} as {x_min, x_max, y_min, y_max} in px, representing bounding box of a rectangle around the data pt\n     *  Note that these pixels are in the SVG coordinate system\n     */\n    _getTooltipPosition(tooltip) {\n        const panel = this.parent;\n\n        const y_scale = panel[`y${this.layout.y_axis.axis}_scale`];\n        const y_extent = panel[`y${this.layout.y_axis.axis}_extent`];\n\n        const x = panel.x_scale(panel.x_extent[0]);\n        const y = y_scale(y_extent[0]);\n\n        return { x_min: x, x_max: x, y_min: y, y_max: y };\n    }\n\n    /**\n     * Draw a tooltip on the data layer pointed at the specified coordinates, in the specified orientation.\n     *  Tooltip will be drawn on the edge of the major axis, and centered along the minor axis- see diagram.\n     *   v\n     * > o <\n     *   ^\n     *\n     * @protected\n     * @param tooltip {Object} The object representing all data for the tooltip to be drawn\n     * @param {'vertical'|'horizontal'|'top'|'bottom'|'left'|'right'} position Where to draw the tooltip relative to\n     *  the data\n     * @param {Number} x_min The min x-coordinate for the bounding box of the data element\n     * @param {Number} x_max The max x-coordinate for the bounding box of the data element\n     * @param {Number} y_min The min y-coordinate for the bounding box of the data element\n     * @param {Number} y_max The max y-coordinate for the bounding box of the data element\n     */\n    _drawTooltip(tooltip, position, x_min, x_max, y_min, y_max) {\n        const panel_layout = this.parent.layout;\n        const plot_layout = this.parent_plot.layout;\n        const layer_layout = this.layout;\n\n        // Tooltip position params: as defined in the default stylesheet, used in calculations\n        const arrow_size = 7;\n        const stroke_width = 1;\n        const arrow_total = arrow_size + stroke_width;  // Tooltip pos should account for how much space the arrow takes up\n\n        const tooltip_padding = 6;  // bbox size must account for any internal padding applied between data and border\n\n        const page_origin = this._getPageOrigin();\n        const tooltip_box = tooltip.selector.node().getBoundingClientRect();\n        const data_layer_height = panel_layout.height - (panel_layout.margin.top + panel_layout.margin.bottom);\n        const data_layer_width = plot_layout.width - (panel_layout.margin.left + panel_layout.margin.right);\n\n        // Clip the edges of the datum to the available plot area\n        x_min = Math.max(x_min, 0);\n        x_max = Math.min(x_max, data_layer_width);\n        y_min = Math.max(y_min, 0);\n        y_max = Math.min(y_max, data_layer_height);\n\n        const x_center = (x_min + x_max) / 2;\n        const y_center = (y_min + y_max) / 2;\n        // Default offsets are the far edge of the datum bounding box\n        let x_offset = x_max - x_center;\n        let y_offset = y_max - y_center;\n        let placement = layer_layout.tooltip_positioning;\n\n        // Coordinate system note: the tooltip is positioned relative to the plot/page; the arrow is positioned relative to\n        //  the tooltip boundaries\n        let tooltip_top, tooltip_left, arrow_type, arrow_top, arrow_left;\n\n        // The user can specify a generic orientation, and LocusZoom will autoselect whether to place the tooltip above or below\n        if (placement === 'vertical') {\n            // Auto-select whether to position above the item, or below\n            x_offset = 0;\n            if (tooltip_box.height + arrow_total > data_layer_height - (y_center + y_offset)) {\n                placement = 'top';\n            } else {\n                placement = 'bottom';\n            }\n        } else if (placement === 'horizontal') {\n            // Auto select whether to position to the left of the item, or to the right\n            y_offset = 0;\n            if (x_center <= plot_layout.width / 2) {\n                placement = 'left';\n            } else {\n                placement = 'right';\n            }\n        }\n\n        if (placement === 'top' || placement === 'bottom') {\n            // Position horizontally centered above the point\n            const offset_right = Math.max((tooltip_box.width / 2) - x_center, 0);\n            const offset_left = Math.max((tooltip_box.width / 2) + x_center - data_layer_width, 0);\n            tooltip_left = page_origin.x + x_center - (tooltip_box.width / 2) - offset_left + offset_right;\n            arrow_left =  page_origin.x + x_center - tooltip_left - arrow_size;  // Arrow should be centered over the data\n            // Position vertically above the point unless there's insufficient space, then go below\n            if (placement === 'top') {\n                tooltip_top = page_origin.y + y_center - (y_offset + tooltip_box.height + arrow_total);\n                arrow_type = 'down';\n                arrow_top = tooltip_box.height - stroke_width;\n            } else {\n                tooltip_top = page_origin.y + y_center + y_offset + arrow_total;\n                arrow_type = 'up';\n                arrow_top = 0 - arrow_total;\n            }\n        } else if (placement === 'left' || placement === 'right') {\n            // Position tooltip horizontally on the left or the right depending on which side of the plot the point is on\n            if (placement === 'left') {\n                tooltip_left = page_origin.x + x_center + x_offset + arrow_total;\n                arrow_type = 'left';\n                arrow_left = -1 * (arrow_size + stroke_width);\n            } else {\n                tooltip_left = page_origin.x + x_center - tooltip_box.width - x_offset - arrow_total;\n                arrow_type = 'right';\n                arrow_left = tooltip_box.width - stroke_width;\n            }\n            // Position with arrow vertically centered along tooltip edge unless we're at the top or bottom of the plot\n            if (y_center - (tooltip_box.height / 2) <= 0) { // Too close to the top, push it down\n                tooltip_top = page_origin.y + y_center - (1.5 * arrow_size) - tooltip_padding;\n                arrow_top = tooltip_padding;\n            } else if (y_center + (tooltip_box.height / 2) >= data_layer_height) { // Too close to the bottom, pull it up\n                tooltip_top = page_origin.y + y_center + arrow_size + tooltip_padding - tooltip_box.height;\n                arrow_top = tooltip_box.height - (2 * arrow_size) - tooltip_padding;\n            } else { // vertically centered\n                tooltip_top = page_origin.y + y_center - (tooltip_box.height / 2);\n                arrow_top = (tooltip_box.height / 2) - arrow_size;\n            }\n        } else {\n            throw new Error('Unrecognized placement value');\n        }\n\n        // Position the div itself, relative to the layer origin\n        tooltip.selector\n            .style('left', `${tooltip_left}px`)\n            .style('top', `${tooltip_top}px`);\n        // Create / update position on arrow connecting tooltip to data\n        if (!tooltip.arrow) {\n            tooltip.arrow = tooltip.selector.append('div')\n                .style('position', 'absolute');\n        }\n        tooltip.arrow\n            .attr('class', `lz-data_layer-tooltip-arrow_${arrow_type}`)\n            .style('left', `${arrow_left}px`)\n            .style('top', `${arrow_top}px`);\n        return this;\n    }\n\n    /**\n     * Determine whether a given data element matches all predefined filter criteria, usually as specified in a layout directive.\n     *\n     * Typically this is used with array.filter (the first argument is curried, `this.filter.bind(this, options)`\n     * @private\n     * @param {Object[]} filter_rules A list of rule entries: {field, value, operator} describing each filter.\n     *  Operator must be from a list of built-in operators. If the field is omitted, the entire datum object will be\n     *  passed to the filter, rather than a single scalar value. (this is only useful with custom `MatchFunctions` as operator)\n     * @param {Object} item\n     * @param {Number} index\n     * @param {Array} array\n     * @returns {Boolean} Whether the specified item is a match\n     */\n    filter(filter_rules, item, index, array) {\n        let is_match = true;\n        filter_rules.forEach((filter) => { // Try each filter on this item, in sequence\n            const {field, operator, value: target} = filter;\n            const test_func = MATCHERS.get(operator);\n\n            // Return the field value or annotation. If no `field` is specified, the filter function will operate on\n            //  the entire data object. This behavior is only really useful with custom functions, because the\n            //  builtin ones expect to receive a scalar value\n            const extra = this.getElementAnnotation(item);\n            const field_value = field ? (new Field(field)).resolve(item, extra) : item;\n            if (!test_func(field_value, target)) {\n                is_match = false;\n            }\n        });\n        return is_match;\n    }\n\n    /**\n     * Get \"annotation\" metadata associated with a particular point.\n     *\n     * @protected\n     * @param {String|Object} element The data object or ID string for the element\n     * @param {String} [key] The name of the annotation to track. If omitted, returns all annotations for this element as an object.\n     * @return {*}\n     */\n    getElementAnnotation (element, key) {\n        const id = this.getElementId(element);\n        const extra = this._layer_state.extra_fields[id];\n        return key ? (extra && extra[key]) : extra;\n    }\n\n    /****** Private methods: rarely overridden or modified by external usages */\n\n    /**\n     * Apply filtering options to determine the set of data to render\n     *\n     * This must be applied on rendering, not fetch, so that the axis limits reflect the true range of the dataset\n     *   Otherwise, two stacked panels (same dataset filtered in different ways) might not line up on the x-axis when\n     *   filters are applied.\n     * @param data\n     * @return {*}\n     * @private\n     */\n    _applyFilters(data) {\n        data = data || this.data;\n\n        if (this._filter_func) {\n            data = data.filter(this._filter_func);\n        } else if (this.layout.filters) {\n            data = data.filter(this.filter.bind(this, this.layout.filters));\n        }\n        return data;\n    }\n\n    /**\n     * Define default state that should get tracked during the lifetime of this layer.\n     *\n     * In some special custom usages, it may be useful to completely reset a panel (eg \"click for\n     *   genome region\" links), plotting new data that invalidates any previously tracked state.  This hook makes it\n     *   possible to reset without destroying the panel entirely. It is used by `Plot.clearPanelData`.\n     * @private\n     */\n    _setDefaultState() {\n        // Each datalayer tracks two kinds of status: flags for internal state (highlighted, selected, tooltip),\n        //  and \"extra fields\" (annotations like \"show a tooltip\" that are not determined by the server, but need to\n        //  persist across re-render)\n        const _layer_state = { status_flags: {}, extra_fields: {} };\n        const status_flags = _layer_state.status_flags;\n        STATUSES.adjectives.forEach((status) => {\n            status_flags[status] = status_flags[status] || new Set();\n        });\n        // Also initialize \"internal-only\" state fields (things that are tracked, but not set directly by external events)\n        status_flags['has_tooltip'] = status_flags['has_tooltip'] || new Set();\n\n        if (this.parent) {\n            // If layer has a parent, store a reference in the overarching plot.state object\n            this._state_id = `${this.parent.id}.${this.id}`;\n            this.state = this.parent.state;\n            this.state[this._state_id] = _layer_state;\n        }\n        this._layer_state = _layer_state;\n    }\n\n    /**\n     * Get the fully qualified identifier for the data layer, prefixed by any parent or container elements\n     *\n     * @private\n     * @returns {string} A dot-delimited string of the format <plot>.<panel>.<data_layer>\n     */\n    getBaseId () {\n        if (this._base_id) {\n            return this._base_id;\n        }\n\n        if (this.parent) {\n            return `${this.parent_plot.id}.${this.parent.id}.${this.id}`;\n        } else {\n            return (this.id || '').toString();\n        }\n    }\n\n    /**\n     * Determine the pixel height of data-bound objects represented inside this data layer. (excluding elements such as axes)\n     *\n     * May be used by operations that resize the data layer to fit available data\n     *\n     * @private\n     * @returns {number}\n     */\n    getAbsoluteDataHeight() {\n        const dataBCR = this.svg.group.node().getBoundingClientRect();\n        return dataBCR.height;\n    }\n\n    /**\n     * Initialize a data layer\n     * @private\n     * @returns {BaseDataLayer}\n     */\n    initialize() {\n        this._base_id = this.getBaseId();\n\n        // Append a container group element to house the main data layer group element and the clip path\n        const base_id = this.getBaseId();\n        this.svg.container = this.parent.svg.group.append('g')\n            .attr('class', 'lz-data_layer-container')\n            .attr('id', `${base_id}.data_layer_container`);\n\n        // Append clip path to the container element\n        this.svg.clipRect = this.svg.container.append('clipPath')\n            .attr('id', `${base_id}.clip`)\n            .append('rect');\n\n        // Append svg group for rendering all data layer elements, clipped by the clip path\n        this.svg.group = this.svg.container.append('g')\n            .attr('id', `${base_id}.data_layer`)\n            .attr('clip-path', `url(#${base_id}.clip)`);\n\n        return this;\n\n    }\n\n    /**\n     * Generate a tool tip for a given element\n     * @private\n     * @param {String|Object} data Data for the element associated with the tooltip\n     */\n    createTooltip (data) {\n        if (typeof this.layout.tooltip != 'object') {\n            throw new Error(`DataLayer [${this.id}] layout does not define a tooltip`);\n        }\n        const id = this.getElementId(data);\n        if (this._tooltips[id]) {\n            this.positionTooltip(id);\n            return;\n        }\n        this._tooltips[id] = {\n            data: data,\n            arrow: null,\n            selector: d3.select(this.parent_plot.svg.node().parentNode).append('div')\n                .attr('class', 'lz-data_layer-tooltip')\n                .attr('id', `${id}-tooltip`),\n        };\n        this._layer_state.status_flags['has_tooltip'].add(id);\n        this.updateTooltip(data);\n        return this;\n    }\n\n    /**\n     * Update a tool tip (generate its inner HTML)\n     *\n     * @private\n     * @param {String|Object} d The element associated with the tooltip\n     * @param {String} [id] An identifier to the tooltip\n     */\n    updateTooltip(d, id) {\n        if (typeof id == 'undefined') {\n            id = this.getElementId(d);\n        }\n        // Empty the tooltip of all HTML (including its arrow!)\n        this._tooltips[id].selector.html('');\n        this._tooltips[id].arrow = null;\n        // Set the new HTML\n        if (this.layout.tooltip.html) {\n            this._tooltips[id].selector.html(parseFields(this.layout.tooltip.html, d, this.getElementAnnotation(d)));\n        }\n        // If the layout allows tool tips on this data layer to be closable then add the close button\n        // and add padding to the tooltip to accommodate it\n        if (this.layout.tooltip.closable) {\n            this._tooltips[id].selector.insert('button', ':first-child')\n                .attr('class', 'lz-tooltip-close-button')\n                .attr('title', 'Close')\n                .text('')\n                .on('click', () => {\n                    this.destroyTooltip(id);\n                });\n        }\n        // Apply data directly to the tool tip for easier retrieval by custom UI elements inside the tool tip\n        this._tooltips[id].selector.data([d]);\n        // Reposition and draw a new arrow\n        this.positionTooltip(id);\n        return this;\n    }\n\n    /**\n     * Destroy tool tip - remove the tool tip element from the DOM and delete the tool tip's record on the data layer\n     *\n     * @private\n     * @param {String|Object} element_or_id The element (or id) associated with the tooltip\n     * @param {boolean} [temporary=false] Whether this is temporary (not to be tracked in state). Differentiates\n     *  \"recreate tooltips on re-render\" (which is temporary) from \"user has closed this tooltip\" (permanent)\n     * @returns {BaseDataLayer}\n     */\n    destroyTooltip(element_or_id, temporary) {\n        let id;\n        if (typeof element_or_id == 'string') {\n            id = element_or_id;\n        } else {\n            id = this.getElementId(element_or_id);\n        }\n        if (this._tooltips[id]) {\n            if (typeof this._tooltips[id].selector == 'object') {\n                this._tooltips[id].selector.remove();\n            }\n            delete this._tooltips[id];\n        }\n        // When a tooltip is removed, also remove the reference from the state\n        if (!temporary) {\n            const tooltip_state = this._layer_state.status_flags['has_tooltip'];\n            tooltip_state.delete(id);\n        }\n        return this;\n    }\n\n    /**\n     * Loop through and destroy all tool tips on this data layer\n     *\n     * @private\n     * @returns {BaseDataLayer}\n     */\n    destroyAllTooltips(temporary = true) {\n        for (let id in this._tooltips) {\n            this.destroyTooltip(id, temporary);\n        }\n        return this;\n    }\n\n    /**\n     * Position and then redraw tool tip - nave function to place a tool tip in the data layer. By default, positions wrt\n     *   the top-left corner of the data layer.\n     *\n     * Each layer type may have more specific logic. Consider overriding the provided hooks `_getTooltipPosition` or\n     *  `_drawTooltip` as appropriate\n     *\n     * @private\n     * @param {String} id The identifier of the tooltip to position\n     * @returns {BaseDataLayer}\n     */\n    positionTooltip(id) {\n        if (typeof id != 'string') {\n            throw new Error('Unable to position tooltip: id is not a string');\n        }\n        if (!this._tooltips[id]) {\n            throw new Error('Unable to position tooltip: id does not point to a valid tooltip');\n        }\n        const tooltip = this._tooltips[id];\n        const coords = this._getTooltipPosition(tooltip);\n\n        if (!coords) {\n            // Special cutout: normally, tooltips are positioned based on the datum element. Some, like lines/curves,\n            //  work better if based on a mouse event. Since not every redraw contains a mouse event, we can just skip\n            //  calculating position when no position information is available.\n            return null;\n        }\n        this._drawTooltip(tooltip, this.layout.tooltip_positioning, coords.x_min, coords.x_max, coords.y_min, coords.y_max);\n    }\n\n    /**\n     * Loop through and position all tool tips on this data layer\n     *\n     * @private\n     * @returns {BaseDataLayer}\n     */\n    positionAllTooltips() {\n        for (let id in this._tooltips) {\n            this.positionTooltip(id);\n        }\n        return this;\n    }\n\n    /**\n     * Show or hide a tool tip by ID depending on directives in the layout and state values relative to the ID\n     *\n     * @private\n     * @param {String|Object} element The element associated with the tooltip\n     * @param {boolean} first_time Because panels can re-render, the rules for showing a tooltip\n     *  depend on whether this is the first time a status change affecting display has been applied.\n     * @returns {BaseDataLayer}\n     */\n    showOrHideTooltip(element, first_time) {\n        const tooltip_layout = this.layout.tooltip;\n        if (typeof tooltip_layout != 'object') {\n            return this;\n        }\n        const id = this.getElementId(element);\n\n        /**\n         * Apply rules and decide whether to show or hide the tooltip\n         * @param {Object} statuses All statuses that apply to an element\n         * @param {String[]|object} directive A layout directive object\n         * @param operator\n         * @returns {null|bool}\n         */\n        const resolveStatus = (statuses, directive, operator) => {\n            let status = null;\n            if (typeof statuses != 'object' || statuses === null) {\n                return null;\n            }\n            if (Array.isArray(directive)) {\n                // This happens when the function is called on the inner part of the directive\n                operator = operator || 'and';\n                if (directive.length === 1) {\n                    status = statuses[directive[0]];\n                } else {\n                    status = directive.reduce((previousValue, currentValue) => {\n                        if (operator === 'and') {\n                            return statuses[previousValue] && statuses[currentValue];\n                        } else if (operator === 'or') {\n                            return statuses[previousValue] || statuses[currentValue];\n                        }\n                        return null;\n                    });\n                }\n            } else if (typeof directive == 'object') {\n                let sub_status;\n                for (let sub_operator in directive) {\n                    sub_status = resolveStatus(statuses, directive[sub_operator], sub_operator);\n                    if (status === null) {\n                        status = sub_status;\n                    } else if (operator === 'and') {\n                        status = status && sub_status;\n                    } else if (operator === 'or') {\n                        status = status || sub_status;\n                    }\n                }\n            } else {\n                return false;\n            }\n            return status;\n        };\n\n        let show_directive = {};\n        if (typeof tooltip_layout.show == 'string') {\n            show_directive = { and: [ tooltip_layout.show ] };\n        } else if (typeof tooltip_layout.show == 'object') {\n            show_directive = tooltip_layout.show;\n        }\n\n        let hide_directive = {};\n        if (typeof tooltip_layout.hide == 'string') {\n            hide_directive = { and: [ tooltip_layout.hide ] };\n        } else if (typeof tooltip_layout.hide == 'object') {\n            hide_directive = tooltip_layout.hide;\n        }\n\n        // Find all the statuses that apply to just this single element\n        const _layer_state = this._layer_state;\n        var status_flags = {};  // {status_name: bool}\n        STATUSES.adjectives.forEach((status) => {\n            const antistatus = `un${status}`;\n            status_flags[status] = (_layer_state.status_flags[status].has(id));\n            status_flags[antistatus] = !status_flags[status];\n        });\n\n        // Decide whether to show/hide the tooltip based solely on the underlying element\n        const show_resolved = resolveStatus(status_flags, show_directive);\n        const hide_resolved = resolveStatus(status_flags, hide_directive);\n\n        // Most of the tooltip display logic depends on behavior layouts: was point (un)selected, (un)highlighted, etc.\n        // But sometimes, a point is selected, and the user then closes the tooltip. If the panel is re-rendered for\n        //  some outside reason (like state change), we must track this in the create/destroy events as tooltip state.\n        const has_tooltip = (_layer_state.status_flags['has_tooltip'].has(id));\n        const tooltip_was_closed = first_time ? false : !has_tooltip;\n        if (show_resolved && !tooltip_was_closed && !hide_resolved) {\n            this.createTooltip(element);\n        } else {\n            this.destroyTooltip(element);\n        }\n\n        return this;\n    }\n\n    /**\n     * Toggle a status (e.g. highlighted, selected, identified) on an element\n     *\n     * @private\n     * @fires event:layout_changed\n     * @fires event:element_selection\n     * @fires event:match_requested\n     * @param {String} status The name of a recognized status to be added/removed on an appropriate element\n     * @param {String|Object} element The data bound to the element of interest\n     * @param {Boolean} active True to add the status (and associated CSS styles); false to remove it\n     * @param {Boolean} exclusive Whether to only allow a state for a single element at a time\n     * @returns {BaseDataLayer}\n     */\n    setElementStatus(status, element, active, exclusive) {\n        if (status === 'has_tooltip') {\n            // This is a special adjective that exists solely to track tooltip state. It has no CSS and never gets set\n            //  directly. It is invisible to the official enums.\n            return this;\n        }\n        if (typeof active == 'undefined') {\n            active = true;\n        }\n\n        // Get an ID for the element or return having changed nothing\n        let element_id;\n        try {\n            element_id = this.getElementId(element);\n        } catch (get_element_id_error) {\n            return this;\n        }\n\n        // Enforce exclusivity (force all elements to have the opposite of toggle first)\n        if (exclusive) {\n            this.setAllElementStatus(status, !active);\n        }\n\n        // Set/unset the proper status class on the appropriate DOM element(s), *and* potentially an additional element\n        d3.select(`#${element_id}`).classed(`lz-data_layer-${this.layout.type}-${status}`, active);\n        const element_status_node_id = this.getElementStatusNodeId(element);\n        if (element_status_node_id !== null) {\n            d3.select(`#${element_status_node_id}`).classed(`lz-data_layer-${this.layout.type}-statusnode-${status}`, active);\n        }\n\n        // Track element ID in the proper status state array\n        const added_status = !this._layer_state.status_flags[status].has(element_id);  // On a re-render, existing statuses will be reapplied.\n        if (active && added_status) {\n            this._layer_state.status_flags[status].add(element_id);\n        }\n        if (!active && !added_status) {\n            this._layer_state.status_flags[status].delete(element_id);\n        }\n\n        // Trigger tool tip show/hide logic\n        this.showOrHideTooltip(element, added_status);\n\n        // Trigger layout changed event hook\n        if (added_status) {\n            this.parent.emit('layout_changed', true);\n        }\n\n        const is_selected = (status === 'selected');\n        if (is_selected && (added_status || !active)) {\n            // Notify parents that an element has changed selection status (either active, or inactive)\n            this.parent.emit('element_selection', { element: element, active: active }, true);\n        }\n\n        const value_to_broadcast = (this.layout.match && this.layout.match.send);\n        if (is_selected && (typeof value_to_broadcast !== 'undefined') && (added_status || !active)) {\n            this.parent.emit(\n                // The broadcast value can use transforms to \"clean up value before sending broadcasting\"\n                'match_requested',\n                { value: new Field(value_to_broadcast).resolve(element), active: active },\n                true,\n            );\n        }\n        return this;\n    }\n\n    /**\n     * Toggle a status on all elements in the data layer\n     *\n     * @private\n     * @param {String} status\n     * @param {Boolean} toggle\n     * @returns {BaseDataLayer}\n     */\n    setAllElementStatus(status, toggle) {\n\n        // Sanity check\n        if (typeof status == 'undefined' || !STATUSES.adjectives.includes(status)) {\n            throw new Error('Invalid status');\n        }\n        if (typeof this._layer_state.status_flags[status] == 'undefined') {\n            return this;\n        }\n        if (typeof toggle == 'undefined') {\n            toggle = true;\n        }\n\n        // Apply statuses\n        if (toggle) {\n            this.data.forEach((element) => this.setElementStatus(status, element, true));\n        } else {\n            const status_ids = new Set(this._layer_state.status_flags[status]); // copy so that we don't mutate while iterating\n            status_ids.forEach((id) => {\n                const element = this.getElementById(id);\n                if (typeof element == 'object' && element !== null) {\n                    this.setElementStatus(status, element, false);\n                }\n            });\n            this._layer_state.status_flags[status] = new Set();\n        }\n\n        // Update global status flag\n        this._global_statuses[status] = toggle;\n\n        return this;\n    }\n\n    /**\n     * Apply all layout-defined behaviors (DOM event handlers) to a selection of elements\n     *\n     * @private\n     * @param {d3.selection} selection\n     */\n    applyBehaviors(selection) {\n        if (typeof this.layout.behaviors != 'object') {\n            return;\n        }\n        Object.keys(this.layout.behaviors).forEach((directive) => {\n            const event_match = /(click|mouseover|mouseout)/.exec(directive);\n            if (!event_match) {\n                return;\n            }\n            selection.on(`${event_match[0]}.${directive}`, this.executeBehaviors(directive, this.layout.behaviors[directive]));\n        });\n    }\n\n    /**\n     * Generate a function that executes an arbitrary list of behaviors on an element during an event\n     *\n     * @private\n     * @param {String} directive The name of the event, as described in layout.behaviors for this datalayer\n     * @param {Object[]} behaviors An object describing the behavior to attach to this single element\n     * @param {string} behaviors.action The name of the action that would trigger this behavior (eg click, mouseover, etc)\n     * @param {string} behaviors.status What status to apply to the element when this behavior is triggered (highlighted,\n     *  selected, etc)\n     * @param {boolean} [behaviors.exclusive] Whether triggering the event for this element should unset the relevant status\n     *   for all other elements. Useful for, eg, click events that exclusively highlight one thing.\n     * @returns {function(this:BaseDataLayer)} Return a function that handles the event in context with the behavior\n     *   and the element- can be attached as an event listener\n     */\n    executeBehaviors(directive, behaviors) {\n\n        // Determine the required state of control and shift keys during the event\n        const requiredKeyStates = {\n            'ctrl': (directive.includes('ctrl')),\n            'shift': (directive.includes('shift')),\n        };\n        const self = this;\n        return function(element) {\n            // This method may be used on two kinds of events: directly attached, or bubbled.\n            // D3 doesn't natively support bubbling very well; if no data is bound on the currentTarget, check to see\n            //  if there is data available at wherever the event was initiated from\n            element = element || d3.select(d3.event.target).datum();\n\n            // Do nothing if the required control and shift key presses (or lack thereof) doesn't match the event\n            if (requiredKeyStates.ctrl !== !!d3.event.ctrlKey || requiredKeyStates.shift !== !!d3.event.shiftKey) {\n                return;\n            }\n\n            // Loop through behaviors making each one go in succession\n            behaviors.forEach((behavior) => {\n\n                // Route first by the action, if defined\n                if (typeof behavior != 'object' || behavior === null) {\n                    return;\n                }\n\n                switch (behavior.action) {\n\n                // Set a status (set to true regardless of current status, optionally with exclusivity)\n                case 'set':\n                    self.setElementStatus(behavior.status, element, true, behavior.exclusive);\n                    break;\n\n                // Unset a status (set to false regardless of current status, optionally with exclusivity)\n                case 'unset':\n                    self.setElementStatus(behavior.status, element, false, behavior.exclusive);\n                    break;\n\n                // Toggle a status\n                case 'toggle':\n                    var current_status_boolean = (self._layer_state.status_flags[behavior.status].has(self.getElementId(element)));\n                    var exclusive = behavior.exclusive && !current_status_boolean;\n\n                    self.setElementStatus(behavior.status, element, !current_status_boolean, exclusive);\n                    break;\n\n                // Link to a dynamic URL\n                case 'link':\n                    if (typeof behavior.href == 'string') {\n                        const url = parseFields(behavior.href, element, self.getElementAnnotation(element));\n                        if (typeof behavior.target == 'string') {\n                            window.open(url, behavior.target);\n                        } else {\n                            window.location.href = url;\n                        }\n                    }\n                    break;\n\n                // Action not defined, just return\n                default:\n                    break;\n                }\n            });\n        };\n    }\n\n    /**\n     * Get an object with the x and y coordinates of the panel's origin in terms of the entire page\n     *   Necessary for positioning any HTML elements over the panel\n     *\n     * @private\n     * @returns {{x: Number, y: Number}}\n     */\n    _getPageOrigin() {\n        const panel_origin = this.parent._getPageOrigin();\n        return {\n            x: panel_origin.x + this.parent.layout.margin.left,\n            y: panel_origin.y + this.parent.layout.margin.top,\n        };\n    }\n\n    /**\n     * Apply all tracked element statuses. This is primarily intended for re-rendering the plot, in order to preserve\n     *  behaviors when items are updated.\n     *  @private\n     */\n    applyAllElementStatus () {\n        const status_flags = this._layer_state.status_flags;\n        const self = this;\n        for (let property in status_flags) {\n            if (!Object.prototype.hasOwnProperty.call(status_flags, property)) {\n                continue;\n            }\n            status_flags[property].forEach((element_id) => {\n                try {\n                    this.setElementStatus(property, this.getElementById(element_id), true);\n                } catch (e) {\n                    console.warn(`Unable to apply state: ${self._state_id}, ${property}`);\n                    console.error(e);\n                }\n            });\n\n        }\n    }\n\n    /**\n     * Position the datalayer and all tooltips\n     * @private\n     * @returns {BaseDataLayer}\n     */\n    draw() {\n        this.svg.container\n            .attr('transform', `translate(${this.parent.layout.cliparea.origin.x}, ${this.parent.layout.cliparea.origin.y})`);\n        this.svg.clipRect\n            .attr('width', this.parent.layout.cliparea.width)\n            .attr('height', this.parent.layout.cliparea.height);\n        this.positionAllTooltips();\n        return this;\n    }\n\n    /**\n     * Re-Map a data layer to reflect changes in the state of a plot (such as viewing region/ chromosome range)\n     *\n     * Whereas .render draws whatever data is available, this method resets the view and fetches new data if necessary.\n     *\n     * @private\n     * @return {Promise}\n     */\n    reMap() {\n        this.destroyAllTooltips(); // hack - only non-visible tooltips should be destroyed\n        // and then recreated if returning to visibility\n\n        // Fetch new data. Datalayers are only given access to the final consolidated data from the chain (not headers or raw payloads)\n        return this.parent_plot.lzd.getData(this.state, this._entities, this._dependencies)\n            .then((new_data) => {\n                this.data = new_data;\n                this.applyDataMethods();\n                this._initialized = true;\n                // Allow listeners (like subscribeToData) to see the information associated with a layer\n                this.parent.emit(\n                    'data_from_layer',\n                    { layer: this.getBaseId(), content: deepCopy(new_data) }, // TODO: revamp event signature post layer-eventing-mixin\n                    true,\n                );\n            });\n    }\n}\n\nSTATUSES.verbs.forEach((verb, idx) => {\n    const adjective = STATUSES.adjectives[idx];\n    const antiverb = `un${verb}`;\n    // Set/unset a single element's status\n\n    /**\n     * @private\n     * @function highlightElement\n     */\n    /**\n     * @private\n     * @function selectElement\n     */\n    /**\n     *  @private\n     *  @function fadeElement\n     */\n    /**\n     *  @private\n     *  @function hideElement\n     */\n    BaseDataLayer.prototype[`${verb}Element`] = function(element, exclusive = false) {\n        exclusive = !!exclusive;\n        this.setElementStatus(adjective, element, true, exclusive);\n        return this;\n    };\n\n    /**\n     * @private\n     * @function unhighlightElement\n     */\n    /**\n     *  @private\n     *  @function unselectElement\n     */\n    /**\n     *  @private\n     *  @function unfadeElement\n     */\n    /**\n     *  @private\n     *  @function unhideElement\n     */\n    BaseDataLayer.prototype[`${antiverb}Element`] = function(element, exclusive) {\n        if (typeof exclusive == 'undefined') {\n            exclusive = false;\n        } else {\n            exclusive = !!exclusive;\n        }\n        this.setElementStatus(adjective, element, false, exclusive);\n        return this;\n    };\n\n    /**\n     * @private\n     * @function highlightAllElements\n     */\n    /**\n     *  @private\n     *  @function selectAllElements\n     */\n    /**\n     *  @private\n     *  @function fadeAllElements\n     */\n    /**\n     *  @private\n     *  @function hideAllElements\n     */\n    // Set/unset status for all elements\n    BaseDataLayer.prototype[`${verb}AllElements`] = function() {\n        this.setAllElementStatus(adjective, true);\n        return this;\n    };\n\n    /**\n     * @private\n     * @function unhighlightAllElements\n     */\n    /**\n     *  @private\n     *  @function unselectAllElements\n     */\n    /**\n     * @private\n     * @function unfadeAllElements\n     * */\n    /**\n     * @private\n     * @function unhideAllElements\n     */\n    BaseDataLayer.prototype[`${antiverb}AllElements`] = function() {\n        this.setAllElementStatus(adjective, false);\n        return this;\n    };\n});\n\nexport {BaseDataLayer as default};\n","import BaseDataLayer from './base';\nimport {merge} from '../../helpers/layouts';\n\n/**\n * @memberof module:LocusZoom_DataLayers~annotation_track\n */\nconst default_layout = {\n    color: '#000000',\n    filters: null,\n    tooltip_positioning: 'vertical',\n    hitarea_width: 8,\n};\n\n/**\n * Create a single continuous 2D track that provides information about each datapoint\n *\n * For example, this can be used to mark items by membership in a group, alongside information in other panels\n * @alias module:LocusZoom_DataLayers~annotation_track\n * @see {@link module:LocusZoom_DataLayers~BaseDataLayer} for additional layout options\n */\nclass AnnotationTrack extends BaseDataLayer {\n    /**\n     * @param {String|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.color] Specify how to choose the fill color for each tick mark\n     * @param {number} [layout.hitarea_width=8] The width (in pixels) of hitareas. Annotation marks are typically 1 px wide,\n     *   so a hit area of 4px on each side can make it much easier to select an item for a tooltip. Hitareas will not interfere\n     *   with selecting adjacent points.\n     * @param {'horizontal'|'vertical'|'top'|'bottom'|'left'|'right'} [layout.tooltip_positioning='vertical'] Where to draw the tooltip relative to the datum.\n     */\n    constructor(layout) {\n        if (!Array.isArray(layout.filters)) {\n            throw new Error('Annotation track must specify array of filters for selecting points to annotate');\n        }\n        merge(layout, default_layout);\n        super(...arguments);\n    }\n\n    initialize() {\n        super.initialize();\n        this._hitareas_group = this.svg.group.append('g')\n            .attr('class', `lz-data_layer-${this.layout.type}-hit_areas`);\n\n        this._visible_lines_group = this.svg.group.append('g')\n            .attr('class', `lz-data_layer-${this.layout.type}-visible_lines`);\n    }\n\n    render() {\n        // Apply filters to only render a specified set of points\n        const track_data = this._applyFilters();\n\n        const hit_areas_selection = this._hitareas_group.selectAll(`rect.lz-data_layer-${this.layout.type}`)\n            .data(track_data, (d) => d[this.layout.id_field]);\n\n\n        const _getX = (d, i) => {\n            // Helper for hitarea position calcs: ensures that a hitarea never overlaps the space allocated\n            // for a real data element. Helps to avoid mouse jitter when selecting tooltips in crowded areas.\n            const x_center = this.parent['x_scale'](d[this.layout.x_axis.field]);\n            let x_left = x_center - this.layout.hitarea_width / 2;\n            if (i >= 1) {\n                // This assumes that the data are in sorted order.\n                const left_node = track_data[i - 1];\n                const left_node_x_center = this.parent['x_scale'](left_node[this.layout.x_axis.field]);\n                x_left = Math.max(x_left, (x_center + left_node_x_center) / 2);\n            }\n            return [x_left, x_center];\n        };\n\n        // Draw hitareas under real data elements, so that real data elements always take precedence\n        hit_areas_selection.enter()\n            .append('rect')\n            .attr('class', `lz-data_layer-${this.layout.type}`)\n            // Update the set of elements to reflect new data\n            .merge(hit_areas_selection)\n            .attr('id', (d) => this.getElementId(d))\n            .attr('height', this.parent.layout.height)\n            .attr('opacity', 0)\n            .attr('x', (d, i) => {\n                const crds = _getX(d, i);\n                return crds[0];\n            })\n            .attr('width', (d, i) => {\n                const crds = _getX(d, i);\n                return (crds[1] - crds[0]) + this.layout.hitarea_width / 2;\n            });\n\n        const width = 1;\n        const selection = this._visible_lines_group.selectAll(`rect.lz-data_layer-${this.layout.type}`)\n            .data(track_data, (d) => d[this.layout.id_field]);\n        // Draw rectangles (visual and tooltip positioning)\n        selection.enter()\n            .append('rect')\n            .attr('class', `lz-data_layer-${this.layout.type}`)\n            .merge(selection)\n            .attr('id', (d) => this.getElementId(d))\n            .attr('x', (d) => this.parent['x_scale'](d[this.layout.x_axis.field]) - width / 2)\n            .attr('width', width)\n            .attr('height', this.parent.layout.height)\n            .attr('fill', (d, i) => this.resolveScalableParameter(this.layout.color, d, i));\n\n        // Remove unused elements\n        selection.exit()\n            .remove();\n\n        // Set up tooltips and mouse interaction\n        this.svg.group\n            .call(this.applyBehaviors.bind(this));\n\n        // Remove unused elements\n        hit_areas_selection.exit()\n            .remove();\n    }\n\n    /**\n     * Render tooltip at the center of each tick mark\n     * @param tooltip\n     * @return {{y_min: number, x_max: *, y_max: *, x_min: number}}\n     * @private\n     */\n    _getTooltipPosition(tooltip) {\n        const panel = this.parent;\n        const data_layer_height = panel.layout.height - (panel.layout.margin.top + panel.layout.margin.bottom);\n        const stroke_width = 1; // as defined in the default stylesheet\n\n        const x_center = panel.x_scale(tooltip.data[this.layout.x_axis.field]);\n        const y_center = data_layer_height / 2;\n        return {\n            x_min: x_center - stroke_width,\n            x_max: x_center + stroke_width,\n            y_min: y_center - panel.layout.margin.top,\n            y_max: y_center + panel.layout.margin.bottom,\n        };\n    }\n}\n\nexport {AnnotationTrack as default};\n","import * as d3 from 'd3';\n\nimport BaseDataLayer from './base';\nimport {merge} from '../../helpers/layouts';\n\n/**\n * @memberof module:LocusZoom_DataLayers~highlight_regions\n */\nconst default_layout = {\n    color: '#CCCCCC',\n    fill_opacity: 0.5,\n    // By default, it will draw the regions shown.\n    filters: null,\n    // Most use cases will show a preset list of regions defined in the layout\n    //  (if empty, AND layout.fields is not, it could fetch from a data source instead)\n    regions: [],\n    id_field: 'id',\n    start_field: 'start',\n    end_field: 'end',\n    merge_field: null,\n};\n\n/**\n * \"Highlight regions with rectangle\" data layer.\n * Creates one (or more) continuous 2D rectangles that mark an entire interval, to the full height of the panel.\n *\n * Each individual rectangle can be shown in full, or overlapping ones can be merged (eg, based on same category).\n * The rectangles are generally drawn with partial transparency, and do not respond to mouse events: they are a\n *   useful highlight tool to draw attention to intervals that contain interesting variants.\n *\n * This layer has several useful modes:\n * 1. Draw one or more specified rectangles as provided from:\n *      A. Hard-coded layout (layout.regions)\n *      B. Data fetched from a source (like intervals with start and end coordinates)- as specified in layout.fields\n * 2. Fetch data from an external source, and only render the intervals that match criteria\n *\n * @alias module:LocusZoom_DataLayers~highlight_regions\n * @see {@link module:LocusZoom_DataLayers~BaseDataLayer} for additional layout options\n */\nclass HighlightRegions extends BaseDataLayer {\n    /**\n     * @param {String|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.color='#CCCCCC'] The fill color for each rectangle\n     * @param {String|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.fill_opacity=0.5] The opacity (0-1). We recommend partial transparency so that\n     *   rectangles do not hide or interfere with adjacent elements.\n     * @param {Object[]} [layout.filters] An array of filter entries specifying which intervals to draw annotations for.\n     * @param {Object[]} [layout.regions] A hard-coded list of regions. If provided, takes precedence over data fetched from an external source.\n     * @param {String} [layout.start_field='start'] The field to use for rectangle start x coordinate\n     * @param {String} [layout.end_field='end'] The field to use for rectangle end x coordinate\n     * @param {String} [layout.merge_field] If two intervals overlap, they can be \"merged\" based on a field that\n     *  identifies the category (eg, only rectangles of the same category will be merged).\n     *  This field must be present in order to trigger merge behavior. This is applied after filters.\n     */\n    constructor(layout) {\n        merge(layout, default_layout);\n        if (layout.interaction || layout.behaviors) {\n            throw new Error('highlight_regions layer does not support mouse events');\n        }\n\n        if (layout.regions.length && layout.namespace && Object.keys(layout.namespace).length) {\n            throw new Error('highlight_regions layer can specify \"regions\" in layout, OR external data \"fields\", but not both');\n        }\n        super(...arguments);\n    }\n\n    /**\n     * Helper method that combines two rectangles if they are the same type of data (category) and occupy the same\n     *  area of the plot (will automatically sort the data prior to rendering)\n     *\n     * When two fields conflict, it will fill in the fields for the last of the items that overlap in that range.\n     *   Thus, it is not recommended to use tooltips with this feature, because the tooltip won't reflect real data.\n     * @param {Object[]} data\n     * @return {Object[]}\n     * @private\n     */\n    _mergeNodes(data) {\n        const { end_field, merge_field, start_field } = this.layout;\n        if (!merge_field) {\n            return data;\n        }\n\n        // Ensure data is sorted by start field, with category as a tie breaker\n        data.sort((a, b) => {\n            // Ensure that data is sorted by category, then start field (ensures overlapping intervals are adjacent)\n            return d3.ascending(a[merge_field], b[merge_field]) || d3.ascending(a[start_field], b[start_field]);\n        });\n\n        let track_data = [];\n        data.forEach(function (cur_item, index) {\n            const prev_item = track_data[track_data.length - 1] || cur_item;\n            if (cur_item[merge_field] === prev_item[merge_field] && cur_item[start_field] <= prev_item[end_field]) {\n                // If intervals overlap, merge the current item with the previous, and append only the merged interval\n                const new_start = Math.min(prev_item[start_field], cur_item[start_field]);\n                const new_end = Math.max(prev_item[end_field], cur_item[end_field]);\n                cur_item = Object.assign({}, prev_item, cur_item, { [start_field]: new_start, [end_field]: new_end });\n                track_data.pop();\n            }\n            track_data.push(cur_item);\n        });\n        return track_data;\n    }\n\n    render() {\n        const { x_scale } = this.parent;\n        // Apply filters to only render a specified set of points\n        let track_data = this.layout.regions.length ? this.layout.regions : this.data;\n\n        // Pseudo identifier for internal use only (regions have no semantic or transition meaning)\n        track_data.forEach((d, i) => d.id || (d.id = i));\n        track_data = this._applyFilters(track_data);\n        track_data = this._mergeNodes(track_data);\n\n        const selection = this.svg.group.selectAll(`rect.lz-data_layer-${this.layout.type}`)\n            .data(track_data);\n\n        // Draw rectangles\n        selection.enter()\n            .append('rect')\n            .attr('class', `lz-data_layer-${this.layout.type}`)\n            .merge(selection)\n            .attr('id', (d) => this.getElementId(d))\n            .attr('x', (d) => x_scale(d[this.layout.start_field]))\n            .attr('width', (d) => x_scale(d[this.layout.end_field]) - x_scale(d[this.layout.start_field]))\n            .attr('height', this.parent.layout.height)\n            .attr('fill', (d, i) => this.resolveScalableParameter(this.layout.color, d, i))\n            .attr('fill-opacity', (d, i) => this.resolveScalableParameter(this.layout.fill_opacity, d, i));\n\n        // Remove unused elements\n        selection.exit()\n            .remove();\n\n        // Note: This layer intentionally does not allow tooltips or mouse behaviors, and doesn't affect pan/zoom\n        this.svg.group.style('pointer-events', 'none');\n    }\n\n    _getTooltipPosition(tooltip) {\n        // This layer is for visual highlighting only; it does not allow mouse interaction, drag, or tooltips\n        throw new Error('This layer does not support tooltips');\n    }\n}\n\nexport {HighlightRegions as default};\n","import * as d3 from 'd3';\n\nimport BaseDataLayer from './base';\nimport {merge} from '../../helpers/layouts';\nimport {applyStyles} from '../../helpers/common';\n\n/**\n * @memberof module:LocusZoom_DataLayers~arcs\n */\nconst default_layout = {\n    color: 'seagreen',\n    hitarea_width: '10px',\n    style: {\n        fill: 'none',\n        'stroke-width': '1px',\n        'stroke-opacity': '100%',\n    },\n    tooltip_positioning: 'top',\n};\n\n/**\n * Arc Data Layer\n * Implements a data layer that will render chromatin accessibility tracks.\n * This layer draws arcs (one per datapoint) that connect two endpoints (x.field1 and x.field2) by means of an arc,\n *  with a height determined by y.field.\n * @alias module:LocusZoom_DataLayers~arcs\n * @see {@link module:LocusZoom_DataLayers~BaseDataLayer} for additional layout options\n */\nclass Arcs extends BaseDataLayer {\n    /**\n     * @param {String|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.color='seagreen'] Specify how to choose the stroke color for each arc\n     * @param {number} [layout.hitarea_width='10px'] The width (in pixels) of hitareas. Arcs are only as wide as the stroke,\n     *   so a hit area of 5px on each side can make it much easier to select an item for a tooltip.\n     * @param {string} [layout.style.fill='none'] The fill color under the area of the arc\n     * @param {string} [layout.style.stroke-width='1px']\n     * @param {string} [layout.style.stroke_opacity='100%']\n     * @param {'horizontal'|'vertical'|'top'|'bottom'|'left'|'right'} [layout.tooltip_positioning='top'] Where to draw the tooltip relative to the datum.\n     * @param {string} [layout.x_axis.field1] The field to use for one end of the arc; creates a point at (x1, 0)\n     * @param {string} [layout.x_axis.field2] The field to use for the other end of the arc; creates a point at (x2, 0)\n     * @param {string} [layout.y_axis.field] The height at the midpoint of the arc, (xmid, y)\n     */\n    constructor(layout) {\n        layout = merge(layout, default_layout);\n        super(...arguments);\n    }\n\n    // Implement the main render function\n    render() {\n        const self = this;\n        const layout = self.layout;\n        const x_scale = self.parent['x_scale'];\n        const y_scale = self.parent[`y${layout.y_axis.axis}_scale`];\n\n        // Apply filters to only render a specified set of points\n        const track_data = this._applyFilters();\n\n        // Helper: Each individual data point describes a path composed of 3 points, with a spline to smooth the line\n        function _make_line(d) {\n            const x1 = d[layout.x_axis.field1];\n            const x2 = d[layout.x_axis.field2];\n            const xmid = (x1 + x2) / 2;\n            const coords = [\n                [x_scale(x1), y_scale(0)],\n                [x_scale(xmid), y_scale(d[layout.y_axis.field])],\n                [x_scale(x2), y_scale(0)],\n            ];\n            // Smoothing options: https://bl.ocks.org/emmasaunders/f7178ed715a601c5b2c458a2c7093f78\n            const line = d3.line()\n                .x((d) => d[0])\n                .y((d) => d[1])\n                .curve(d3.curveNatural);\n            return line(coords);\n        }\n\n        // Draw real lines, and also invisible hitareas for easier mouse events\n        const hitareas = this.svg.group\n            .selectAll('path.lz-data_layer-arcs-hitarea')\n            .data(track_data, (d) => this.getElementId(d));\n\n        const selection = this.svg.group\n            .selectAll('path.lz-data_layer-arcs')\n            .data(track_data, (d) => this.getElementId(d));\n\n        this.svg.group\n            .call(applyStyles, layout.style);\n\n        hitareas\n            .enter()\n            .append('path')\n            .attr('class', 'lz-data_layer-arcs-hitarea')\n            .merge(hitareas)\n            .attr('id', (d) => this.getElementId(d))\n            .style('fill', 'none')\n            .style('stroke-width', layout.hitarea_width)\n            .style('stroke-opacity', 0)\n            .style('stroke', 'transparent')\n            .attr('d', (d) => _make_line(d));\n\n        // Add new points as necessary\n        selection\n            .enter()\n            .append('path')\n            .attr('class', 'lz-data_layer-arcs')\n            .merge(selection)\n            .attr('id', (d) => this.getElementId(d))\n            .attr('stroke', (d, i) => this.resolveScalableParameter(this.layout.color, d, i))\n            .attr('d', (d, i) => _make_line(d));\n\n        // Remove old elements as needed\n        selection.exit()\n            .remove();\n\n        hitareas.exit()\n            .remove();\n\n        // Apply mouse behaviors to arcs\n        this.svg.group\n            .call(this.applyBehaviors.bind(this));\n\n        return this;\n    }\n\n    _getTooltipPosition(tooltip) {\n        // Center the tooltip arrow at the apex of the arc. Sometimes, only part of an arc shows on the screen, so we\n        //  clean up these values to ensure that the tooltip will appear within the window.\n        const panel = this.parent;\n        const layout = this.layout;\n\n        const x1 = tooltip.data[layout.x_axis.field1];\n        const x2 = tooltip.data[layout.x_axis.field2];\n\n        const y_scale = panel[`y${layout.y_axis.axis}_scale`];\n\n        return {\n            x_min: panel.x_scale(Math.min(x1, x2)),\n            x_max: panel.x_scale(Math.max(x1, x2)),\n            y_min: y_scale(tooltip.data[layout.y_axis.field]),\n            y_max: y_scale(0),\n        };\n    }\n\n}\n\nexport {Arcs as default};\n","import * as d3 from 'd3';\n\nimport BaseDataLayer from './base';\nimport {merge} from '../../helpers/layouts';\n\n/**\n * @memberof module:LocusZoom_DataLayers~genes\n * @type {{track_vertical_spacing: number, bounding_box_padding: number, color: string, tooltip_positioning: string, exon_height: number, label_font_size: number, label_exon_spacing: number, stroke: string}}\n */\nconst default_layout = {\n    // Optionally specify different fill and stroke properties\n    stroke: 'rgb(54, 54, 150)',\n    color: '#363696',\n    label_font_size: 15,\n    label_exon_spacing: 3,\n    exon_height: 10,\n    bounding_box_padding: 3,\n    track_vertical_spacing: 5,\n    tooltip_positioning: 'top',\n};\n\n\n/**\n * Genes Data Layer\n * Implements a data layer that will render gene tracks\n * @alias module:LocusZoom_DataLayers~genes\n * @see {@link module:LocusZoom_DataLayers~BaseDataLayer} for additional layout options\n */\nclass Genes extends BaseDataLayer {\n    /**\n     * @param {string|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.stroke='rgb(54, 54, 150)'] The stroke color for each intron and exon\n     * @param {string|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.color='#363696'] The fill color for each intron and exon\n     * @param {number} [layout.label_font_size]\n     * @param {number} [layout.label_exon_spacing] The number of px padding between exons and the gene label\n     * @param {number} [layout.exon_height=10] The height of each exon (vertical line) when drawing the gene\n     * @param {number} [layout.bounding_box_padding=3] Padding around edges of the bounding box, as shown when highlighting a selected gene\n     * @param {number} [layout.track_vertical_spacing=5] Vertical spacing between each row of genes\n     * @param {'horizontal'|'vertical'|'top'|'bottom'|'left'|'right'} [layout.tooltip_positioning='top'] Where to draw the tooltip relative to the datum.\n     */\n    constructor(layout) {\n        layout = merge(layout, default_layout);\n        super(...arguments);\n        /**\n         * A gene may have arbitrarily many transcripts, but this data layer isn't set up to render them yet.\n         * Stash a transcript_idx to point to the first transcript and use that for all transcript refs.\n         * @member {number}\n         * @type {number}\n         */\n        this.transcript_idx = 0;\n\n        /**\n         * An internal counter for the number of tracks in the data layer. Used as an internal counter for looping\n         *   over positions / assignments\n         * @protected\n         * @member {number}\n         */\n        this.tracks = 1;\n\n        /**\n         * Store information about genes in dataset, in a hash indexed by track number: {track_number: [gene_indices]}\n         * @member {Object.<Number, Array>}\n         */\n        this.gene_track_index = { 1: [] };\n    }\n\n    /**\n     * Generate a statusnode ID for a given element\n     * @override\n     * @returns {String}\n     */\n    getElementStatusNodeId(element) {\n        return `${this.getElementId(element)}-statusnode`;\n    }\n\n    /**\n     * Helper function to sum layout values to derive total height for a single gene track\n     * @returns {number}\n     */\n    getTrackHeight() {\n        return 2 * this.layout.bounding_box_padding\n            + this.layout.label_font_size\n            + this.layout.label_exon_spacing\n            + this.layout.exon_height\n            + this.layout.track_vertical_spacing;\n    }\n\n    /**\n     * Ensure that genes in overlapping chromosome regions are positioned so that parts of different genes do not\n     *   overlap in the view. A track is a row used to vertically separate overlapping genes.\n     * @returns {Genes}\n     */\n    assignTracks(data) {\n        /**\n         * Function to get the width in pixels of a label given the text and layout attributes\n         * @param {String} gene_name\n         * @param {number|string} font_size\n         * @returns {number}\n         */\n        const _getLabelWidth = (gene_name, font_size) => {\n            try {\n                const temp_text = this.svg.group.append('text')\n                    .attr('x', 0)\n                    .attr('y', 0)\n                    .attr('class', 'lz-data_layer-genes lz-label')\n                    .style('font-size', font_size)\n                    .text(`${gene_name}`);\n                const label_width = temp_text.node().getBBox().width;\n                temp_text.remove();\n                return label_width;\n            } catch (e) {\n                return 0;\n            }\n        };\n\n        // Reinitialize some metadata\n        this.tracks = 1;\n        this.gene_track_index = { 1: [] };\n\n        return data\n            // Filter out any genes that are fully outside the region of interest. This allows us to use cached data\n            //  when zooming in, without breaking the layout by allocating space for genes that are not visible.\n            .filter((item) => !(item.end < this.state.start) && !(item.start > this.state.end))\n            .map((item) => {\n                // If necessary, split combined gene id / version fields into discrete fields.\n                // NOTE: this may be an issue with CSG's genes data API that may eventually be solved upstream.\n                if (item.gene_id && item.gene_id.indexOf('.')) {\n                    const split = item.gene_id.split('.');\n                    item.gene_id = split[0];\n                    item.gene_version = split[1];\n                }\n\n                // Stash the transcript ID on the parent gene\n                item.transcript_id = item.transcripts[this.transcript_idx].transcript_id;\n\n                // Determine display range start and end, based on minimum allowable gene display width, bounded by what we can see\n                // (range: values in terms of pixels on the screen)\n                item.display_range = {\n                    start: this.parent.x_scale(Math.max(item.start, this.state.start)),\n                    end:   this.parent.x_scale(Math.min(item.end, this.state.end)),\n                };\n                item.display_range.label_width = _getLabelWidth(item.gene_name, this.layout.label_font_size);\n                item.display_range.width = item.display_range.end - item.display_range.start;\n                // Determine label text anchor (default to middle)\n                item.display_range.text_anchor = 'middle';\n                if (item.display_range.width < item.display_range.label_width) {\n                    if (item.start < this.state.start) {\n                        item.display_range.end = item.display_range.start\n                            + item.display_range.label_width\n                            + this.layout.label_font_size;\n                        item.display_range.text_anchor = 'start';\n                    } else if (item.end > this.state.end) {\n                        item.display_range.start = item.display_range.end\n                            - item.display_range.label_width\n                            - this.layout.label_font_size;\n                        item.display_range.text_anchor = 'end';\n                    } else {\n                        const centered_margin = ((item.display_range.label_width - item.display_range.width) / 2)\n                            + this.layout.label_font_size;\n                        if ((item.display_range.start - centered_margin) < this.parent.x_scale(this.state.start)) {\n                            item.display_range.start = this.parent.x_scale(this.state.start);\n                            item.display_range.end = item.display_range.start + item.display_range.label_width;\n                            item.display_range.text_anchor = 'start';\n                        } else if ((item.display_range.end + centered_margin) > this.parent.x_scale(this.state.end)) {\n                            item.display_range.end = this.parent.x_scale(this.state.end);\n                            item.display_range.start = item.display_range.end - item.display_range.label_width;\n                            item.display_range.text_anchor = 'end';\n                        } else {\n                            item.display_range.start -= centered_margin;\n                            item.display_range.end += centered_margin;\n                        }\n                    }\n                    item.display_range.width = item.display_range.end - item.display_range.start;\n                }\n                // Add bounding box padding to the calculated display range start, end, and width\n                item.display_range.start -= this.layout.bounding_box_padding;\n                item.display_range.end   += this.layout.bounding_box_padding;\n                item.display_range.width += 2 * this.layout.bounding_box_padding;\n                // Convert and stash display range values into domain values\n                // (domain: values in terms of the data set, e.g. megabases)\n                item.display_domain = {\n                    start: this.parent.x_scale.invert(item.display_range.start),\n                    end:   this.parent.x_scale.invert(item.display_range.end),\n                };\n                item.display_domain.width = item.display_domain.end - item.display_domain.start;\n\n                // Using display range/domain data generated above cast each gene to tracks such that none overlap\n                item.track = null;\n                let potential_track = 1;\n                while (item.track === null) {\n                    let collision_on_potential_track = false;\n                    this.gene_track_index[potential_track].map((placed_gene) => {\n                        if (!collision_on_potential_track) {\n                            const min_start = Math.min(placed_gene.display_range.start, item.display_range.start);\n                            const max_end = Math.max(placed_gene.display_range.end, item.display_range.end);\n                            if ((max_end - min_start) < (placed_gene.display_range.width + item.display_range.width)) {\n                                collision_on_potential_track = true;\n                            }\n                        }\n                    });\n                    if (!collision_on_potential_track) {\n                        item.track = potential_track;\n                        this.gene_track_index[potential_track].push(item);\n                    } else {\n                        potential_track++;\n                        if (potential_track > this.tracks) {\n                            this.tracks = potential_track;\n                            this.gene_track_index[potential_track] = [];\n                        }\n                    }\n                }\n\n                // Stash parent references on all genes, transcripts, and exons\n                item.parent = this;\n                item.transcripts.map((d, t) => {\n                    item.transcripts[t].parent = item;\n                    item.transcripts[t].exons.map((d, e) => item.transcripts[t].exons[e].parent = item.transcripts[t]);\n                });\n                return item;\n            });\n    }\n\n    /**\n     * Main render function\n     */\n    render() {\n        const self = this;\n        // Apply filters to only render a specified set of points\n        let track_data = this._applyFilters();\n        track_data = this.assignTracks(track_data);\n        let height;\n\n        // Render gene groups\n        const selection = this.svg.group.selectAll('g.lz-data_layer-genes')\n            .data(track_data, (d) => d.gene_name);\n\n        selection.enter()\n            .append('g')\n            .attr('class', 'lz-data_layer-genes')\n            .merge(selection)\n            .attr('id', (d) => this.getElementId(d))\n            .each(function(gene) {\n                const data_layer = gene.parent;\n\n                // Render gene bounding boxes (status nodes to show selected/highlighted)\n                const bboxes = d3.select(this).selectAll('rect.lz-data_layer-genes.lz-data_layer-genes-statusnode')\n                    .data([gene], (d) => data_layer.getElementStatusNodeId(d));\n\n                height = data_layer.getTrackHeight() - data_layer.layout.track_vertical_spacing;\n\n                bboxes.enter()\n                    .append('rect')\n                    .attr('class', 'lz-data_layer-genes lz-data_layer-genes-statusnode')\n                    .merge(bboxes)\n                    .attr('id', (d) => data_layer.getElementStatusNodeId(d))\n                    .attr('rx', data_layer.layout.bounding_box_padding)\n                    .attr('ry', data_layer.layout.bounding_box_padding)\n                    .attr('width', (d) => d.display_range.width)\n                    .attr('height', height)\n                    .attr('x', (d) => d.display_range.start)\n                    .attr('y', (d) => ((d.track - 1) * data_layer.getTrackHeight()));\n\n                bboxes.exit()\n                    .remove();\n\n                // Render gene boundaries\n                const boundaries = d3.select(this).selectAll('rect.lz-data_layer-genes.lz-boundary')\n                    .data([gene], (d) => `${d.gene_name}_boundary`);\n\n                // FIXME: Make gene text font sizes scalable\n                height = 1;\n                boundaries.enter()\n                    .append('rect')\n                    .attr('class', 'lz-data_layer-genes lz-boundary')\n                    .merge(boundaries)\n                    .attr('width', (d) => data_layer.parent.x_scale(d.end) - data_layer.parent.x_scale(d.start))\n                    .attr('height', height)\n                    .attr('x', (d) => data_layer.parent.x_scale(d.start))\n                    .attr('y', (d) => {\n                        return ((d.track - 1) * data_layer.getTrackHeight())\n                            + data_layer.layout.bounding_box_padding\n                            + data_layer.layout.label_font_size\n                            + data_layer.layout.label_exon_spacing\n                            + (Math.max(data_layer.layout.exon_height, 3) / 2);\n                    })\n                    .style('fill', (d, i) => self.resolveScalableParameter(self.layout.color, d, i))\n                    .style('stroke', (d, i) => self.resolveScalableParameter(self.layout.stroke, d, i));\n\n                boundaries.exit()\n                    .remove();\n\n                // Render gene labels\n                const labels = d3.select(this).selectAll('text.lz-data_layer-genes.lz-label')\n                    .data([gene], (d) => `${d.gene_name}_label`);\n\n                labels.enter()\n                    .append('text')\n                    .attr('class', 'lz-data_layer-genes lz-label')\n                    .merge(labels)\n                    .attr('text-anchor', (d) => d.display_range.text_anchor)\n                    .text((d) => (d.strand === '+') ? `${d.gene_name}` : `${d.gene_name}`)\n                    .style('font-size', gene.parent.layout.label_font_size)\n                    .attr('x', (d) => {\n                        if (d.display_range.text_anchor === 'middle') {\n                            return d.display_range.start + (d.display_range.width / 2);\n                        } else if (d.display_range.text_anchor === 'start') {\n                            return d.display_range.start + data_layer.layout.bounding_box_padding;\n                        } else if (d.display_range.text_anchor === 'end') {\n                            return d.display_range.end - data_layer.layout.bounding_box_padding;\n                        }\n                    })\n                    .attr('y', (d) => ((d.track - 1) * data_layer.getTrackHeight())\n                        + data_layer.layout.bounding_box_padding\n                        + data_layer.layout.label_font_size,\n                    );\n\n                labels.exit()\n                    .remove();\n\n                // Render exon rects (first transcript only, for now)\n                // Exons: by default color on gene properties for consistency with the gene boundary track- hence color uses d.parent.parent\n                const exons = d3.select(this).selectAll('rect.lz-data_layer-genes.lz-exon')\n                    .data(gene.transcripts[gene.parent.transcript_idx].exons, (d) => d.exon_id);\n\n                height = data_layer.layout.exon_height;\n\n                exons.enter()\n                    .append('rect')\n                    .attr('class', 'lz-data_layer-genes lz-exon')\n                    .merge(exons)\n                    .style('fill', (d, i) => self.resolveScalableParameter(self.layout.color, d.parent.parent, i))\n                    .style('stroke', (d, i) => self.resolveScalableParameter(self.layout.stroke, d.parent.parent, i))\n                    .attr('width', (d) => data_layer.parent.x_scale(d.end) - data_layer.parent.x_scale(d.start))\n                    .attr('height', height)\n                    .attr('x', (d) => data_layer.parent.x_scale(d.start))\n                    .attr('y', () => {\n                        return ((gene.track - 1) * data_layer.getTrackHeight())\n                            + data_layer.layout.bounding_box_padding\n                            + data_layer.layout.label_font_size\n                            + data_layer.layout.label_exon_spacing;\n                    });\n\n                exons.exit()\n                    .remove();\n\n                // Render gene click area\n                const clickareas = d3.select(this).selectAll('rect.lz-data_layer-genes.lz-clickarea')\n                    .data([gene], (d) => `${d.gene_name}_clickarea`);\n\n                height = data_layer.getTrackHeight() - data_layer.layout.track_vertical_spacing;\n                clickareas.enter()\n                    .append('rect')\n                    .attr('class', 'lz-data_layer-genes lz-clickarea')\n                    .merge(clickareas)\n                    .attr('id', (d) => `${data_layer.getElementId(d)}_clickarea`)\n                    .attr('rx', data_layer.layout.bounding_box_padding)\n                    .attr('ry', data_layer.layout.bounding_box_padding)\n                    .attr('width', (d) => d.display_range.width)\n                    .attr('height', height)\n                    .attr('x', (d) => d.display_range.start)\n                    .attr('y', (d) => ((d.track - 1) * data_layer.getTrackHeight()));\n\n                // Remove old clickareas as needed\n                clickareas.exit()\n                    .remove();\n            });\n\n        // Remove old elements as needed\n        selection.exit()\n            .remove();\n\n        // Apply mouse behaviors & events to clickareas\n        this.svg.group\n            .on('click.event_emitter', (element) => this.parent.emit('element_clicked', element, true))\n            .call(this.applyBehaviors.bind(this));\n    }\n\n    _getTooltipPosition(tooltip) {\n        const gene_bbox_id = this.getElementStatusNodeId(tooltip.data);\n        const gene_bbox = d3.select(`#${gene_bbox_id}`).node().getBBox();\n        return {\n            x_min: this.parent.x_scale(tooltip.data.start),\n            x_max: this.parent.x_scale(tooltip.data.end),\n            y_min: gene_bbox.y,\n            y_max: gene_bbox.y + gene_bbox.height,\n        };\n    }\n}\n\nexport {Genes as default};\n","import * as d3 from 'd3';\n\nimport BaseDataLayer from './base';\nimport {merge} from '../../helpers/layouts';\nimport {STATUSES} from '../constants';\nimport {applyStyles} from '../../helpers/common';\n\n/**\n * @memberof module:LocusZoom_DataLayers~line\n */\nconst default_layout = {\n    style: {\n        fill: 'none',\n        'stroke-width': '2px',\n    },\n    interpolate: 'curveLinear',\n    x_axis: { field: 'x' },\n    y_axis: { field: 'y', axis: 1 },\n    hitarea_width: 5,\n    tooltip: null,\n};\n\n/*********************\n * Line Data Layer\n * Implements a standard line plot, representing either a trace or a filled curve. Only one line is drawn per layer used.\n * @alias module:LocusZoom_DataLayers~line\n * @see {@link module:LocusZoom_DataLayers~BaseDataLayer} for additional layout options\n*/\nclass Line extends BaseDataLayer {\n    /**\n     * @param {object} [layout.style] CSS properties to control how the line is drawn\n     * @param {string} [layout.style.fill='none'] Fill color for the area under the curve\n     * @param {string} [layout.style.stroke]\n     * @param {string} [layout.style.stroke-width='2px']\n     * @param {string} [layout.interpolate='curveLinear'] The name of the d3 interpolator to use. This determines how to smooth the line in between data points.\n     * @param {number} [layout.hitarea_width=5] The size of mouse event hitareas to use. If tooltips are not used, hitareas are not very important.\n     */\n    constructor(layout) {\n        layout = merge(layout, default_layout);\n        if (layout.tooltip) {\n            throw new Error('The line / filled curve layer does not support tooltips');\n        }\n        super(...arguments);\n    }\n\n    /**\n     * Implement the main render function\n     */\n    render() {\n        // Several vars needed to be in scope\n        const panel = this.parent;\n        const x_field = this.layout.x_axis.field;\n        const y_field = this.layout.y_axis.field;\n\n        // Join data to the line selection\n        const selection = this.svg.group\n            .selectAll('path.lz-data_layer-line')\n            .data([this.data]);\n\n        // Create path element, apply class\n        this.path = selection.enter()\n            .append('path')\n            .attr('class', 'lz-data_layer-line');\n\n        // Generate the line\n        let line;\n        const x_scale = panel['x_scale'];\n        const y_scale = panel[`y${this.layout.y_axis.axis}_scale`];\n        if (this.layout.style.fill && this.layout.style.fill !== 'none') {\n            // Filled curve: define the line as a filled boundary\n            line = d3.area()\n                .x((d) => +x_scale(d[x_field]))\n                .y0(+y_scale(0))\n                .y1((d) => +y_scale(d[y_field]));\n        } else {\n            // Basic line\n            line = d3.line()\n                .x((d) => +x_scale(d[x_field]))\n                .y((d) => +y_scale(d[y_field]))\n                .curve(d3[this.layout.interpolate]);\n        }\n\n        // Apply line and style\n        selection.merge(this.path)\n            .attr('d', line)\n            .call(applyStyles, this.layout.style);\n\n        // Remove old elements as needed\n        selection.exit()\n            .remove();\n\n    }\n\n    /**\n     * Redefine setElementStatus family of methods as line data layers will only ever have a single path element\n     * @param {String} status A member of `LocusZoom.DataLayer.Statuses.adjectives`\n     * @param {String|Object} element\n     * @param {Boolean} toggle\n     */\n    setElementStatus(status, element, toggle) {\n        return this.setAllElementStatus(status, toggle);\n    }\n\n    setAllElementStatus(status, toggle) {\n        // Sanity check\n        if (typeof status == 'undefined' || !STATUSES.adjectives.includes(status)) {\n            throw new Error('Invalid status');\n        }\n        if (typeof this._layer_state.status_flags[status] == 'undefined') {\n            return this;\n        }\n        if (typeof toggle == 'undefined') {\n            toggle = true;\n        }\n\n        // Update global status flag\n        this._global_statuses[status] = toggle;\n\n        // Apply class to path based on global status flags\n        let path_class = 'lz-data_layer-line';\n        Object.keys(this._global_statuses).forEach((global_status) => {\n            if (this._global_statuses[global_status]) {\n                path_class += ` lz-data_layer-line-${global_status}`;\n            }\n        });\n        this.path.attr('class', path_class);\n\n        // Trigger layout changed event hook\n        this.parent.emit('layout_changed', true);\n        return this;\n    }\n}\n\n/**\n * @memberof module:LocusZoom_DataLayers~orthogonal_line\n */\nconst default_orthogonal_layout = {\n    style: {\n        'stroke': '#D3D3D3',\n        'stroke-width': '3px',\n        'stroke-dasharray': '10px 10px',\n    },\n    orientation: 'horizontal',\n    x_axis: {\n        axis: 1,\n        decoupled: true,\n    },\n    y_axis: {\n        axis: 1,\n        decoupled: true,\n    },\n    tooltip_positioning: 'vertical',\n    offset: 0,\n};\n\n\n/**\n *  Orthogonal Line Data Layer\n *  Draw a horizontal or vertical line given an orientation and an offset in the layout\n *  Does not require a data source or fields.\n * @alias module:LocusZoom_DataLayers~orthogonal_line\n * @see {@link module:LocusZoom_DataLayers~BaseDataLayer} for additional layout options\n */\nclass OrthogonalLine extends BaseDataLayer {\n    /**\n     * @param {string} [layout.style.stroke='#D3D3D3']\n     * @param {string} [layout.style.stroke-width='3px']\n     * @param {string} [layout.style.stroke-dasharray='10px 10px']\n     * @param {'horizontal'|'vertical'} [layout.orientation] The orientation of the horizontal line\n     * @param {boolean} [layout.x_axis.decoupled=true] If true, the data in this layer will not influence the x-extent of the panel.\n     * @param {boolean} [layout.y_axis.decoupled=true] If true, the data in this layer will not influence the y-extent of the panel.\n     * @param {'horizontal'|'vertical'} [layout.tooltip_positioning='vertical'] Where to draw the tooltip relative to the mouse pointer.\n     * @param {number} [layout.offset=0] Where the line intercepts the orthogonal axis (eg, the y coordinate for a horizontal line, or x for a vertical line)\n     */\n    constructor(layout) {\n        layout = merge(layout, default_orthogonal_layout);\n        // Require that orientation be \"horizontal\" or \"vertical\" only\n        if (!['horizontal', 'vertical'].includes(layout.orientation)) {\n            layout.orientation = 'horizontal';\n        }\n        super(...arguments);\n    }\n\n    getElementId(element) {\n        // There is only one line per datalayer, so this is sufficient.\n        return this.getBaseId();\n    }\n\n    /**\n     * Implement the main render function\n     */\n    render() {\n        // Several vars needed to be in scope\n        const panel = this.parent;\n        const x_scale = 'x_scale';\n        const y_scale = `y${this.layout.y_axis.axis}_scale`;\n        const x_extent = 'x_extent';\n        const y_extent = `y${this.layout.y_axis.axis}_extent`;\n        const x_range = 'x_range';\n\n        // Generate data using extents depending on orientation\n        if (this.layout.orientation === 'horizontal') {\n            this.data = [\n                { x: panel[x_extent][0], y: this.layout.offset },\n                { x: panel[x_extent][1], y: this.layout.offset },\n            ];\n        } else if (this.layout.orientation === 'vertical') {\n            this.data = [\n                { x: this.layout.offset, y: panel[y_extent][0] },\n                { x: this.layout.offset, y: panel[y_extent][1] },\n            ];\n        } else {\n            throw new Error('Unrecognized vertical line type. Must be \"vertical\" or \"horizontal\"');\n        }\n\n        // Join data to the line selection\n        const selection = this.svg.group\n            .selectAll('path.lz-data_layer-line')\n            .data([this.data]);\n\n        // In some cases, a vertical line may overlay a track that has no inherent y-values (extent)\n        //  When that happens, provide a default height based on the current panel dimensions (accounting\n        //      for any resizing that happened after the panel was created)\n        const default_y = [panel.layout.cliparea.height, 0];\n\n        // Generate the line\n        const line = d3.line()\n            .x((d, i) => {\n                const x = +panel[x_scale](d['x']);\n                return isNaN(x) ? panel[x_range][i] : x;\n            })\n            .y((d, i) => {\n                const y = +panel[y_scale](d['y']);\n                return isNaN(y) ? default_y[i] : y;\n            });\n\n        // Create path element, apply class\n        this.path = selection.enter()\n            .append('path')\n            .attr('class', 'lz-data_layer-line')\n            .merge(selection)\n            .attr('d', line)\n            .call(applyStyles, this.layout.style)\n            // Allow the layer to respond to mouseover events and show a tooltip.\n            .call(this.applyBehaviors.bind(this));\n\n        // Remove old elements as needed\n        selection.exit()\n            .remove();\n    }\n\n    _getTooltipPosition(tooltip) {\n        try {\n            const coords = d3.mouse(this.svg.container.node());\n            const x = coords[0];\n            const y = coords[1];\n            return { x_min: x - 1, x_max: x + 1, y_min: y - 1, y_max: y + 1 };\n        } catch (e) {\n            // On redraw, there won't be a mouse event, so skip tooltip repositioning.\n            return null;\n        }\n    }\n\n}\n\n\nexport { Line as line, OrthogonalLine as orthogonal_line };\n","import * as d3 from 'd3';\nimport BaseDataLayer from './base';\nimport {applyStyles} from '../../helpers/common';\nimport {parseFields} from '../../helpers/display';\nimport {merge, nameToSymbol} from '../../helpers/layouts';\nimport {coalesce_scatter_points} from '../../helpers/render';\n\n/**\n * @memberof module:LocusZoom_DataLayers~scatter\n */\nconst default_layout = {\n    point_size: 40,\n    point_shape: 'circle',\n    tooltip_positioning: 'horizontal',\n    color: '#888888',\n    coalesce: {\n        active: false,\n        max_points: 800, // Many plots are 800-2400 px wide, so, more than 1 datum per pixel of average region width\n        // Define the \"region of interest\", like \"bottom half of plot\"; any points outside this region are taken as is\n        //   Values are expressed in terms of data value and will be converted to pixels internally.\n        x_min: '-Infinity',  // JSON doesn't handle some valid JS numbers. Kids, don't get a career in computers.\n        x_max: 'Infinity',\n        y_min: 0,\n        y_max: 3.0,\n        x_gap: 7,\n        y_gap: 7,\n    },\n    fill_opacity: 1,\n    y_axis: {\n        axis: 1,\n    },\n    id_field: 'id',\n};\n\n/**\n * Options that control point-coalescing in scatter plots\n * @typedef {object} module:LocusZoom_DataLayers~scatter~coalesce_options\n * @property {boolean} [active=false] Whether to use this feature. Typically used for GWAS plots, but\n *   not other scatter plots such as PheWAS.\n * @property {number} [max_points=800] Only attempt to reduce DOM size if there are at least this many\n *  points. Many plots are 800-2400 px wide, so, more than 1 datum per pixel of average region width. For more\n *  sparse datasets, all points will be faithfully rendered even if coalesce.active=true.\n * @property {number} [x_min='-Infinity'] Min x coordinate of the region where points will be coalesced\n * @property {number} [x_max='Infinity'] Max x coordinate of the region where points will be coalesced\n * @property {number} [y_min=0] Min y coordinate of the region where points will be coalesced.\n * @property {number} [y_max=3.0] Max y coordinate of the region where points will be coalesced\n * @property {number} [x_gap=7] Max number of pixels between the center of two points that can be\n *   coalesced. For circles, area 40 = radius ~3.5; aim for ~1 diameter distance.\n * @property {number} [y_gap=7]\n */\n\n/**\n * Scatter Data Layer\n * Implements a standard scatter plot\n * @alias module:LocusZoom_DataLayers~scatter\n */\nclass Scatter extends BaseDataLayer {\n    /**\n     * @param {number|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.point_size=40] The size (area) of the point for each datum\n     * @param {string|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.point_shape='circle'] Shape of the point for each datum. Supported values map to the d3 SVG Symbol Types (i.e.: \"circle\", \"cross\", \"diamond\", \"square\", \"triangle\", \"star\", and \"wye\"), plus \"triangledown\".\n     * @param {string|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.color='#888888'] The color of the point for each datum\n     * @param {module:LocusZoom_DataLayers~scatter~coalesce_options} [layout.coalesce] Options to control whether and how to combine adjacent insignificant (\"within region of interest\") points\n     *   to improve rendering performance. These options are primarily aimed at GWAS region plots. Within a specified\n     *   rectangle area (eg \"insignificant point cutoff\"), we choose only points far enough part to be seen.\n     *   The defaults are specifically tuned for GWAS plots with -log(p) on the y-axis.\n     * @param {number|module:LocusZoom_DataLayers~ScalableParameter[]} [layout.fill_opacity=1] Opacity (0..1) for each datum point\n     * @param {string} [layout.label.text] Similar to tooltips: a template string that can reference datum fields for label text.\n     * @param {number} [layout.label.spacing] Distance (in px) between the label and the center of the datum.\n     * @param {object} [layout.label.lines.style] CSS style options for how the line is rendered\n     * @param {number} [layout.label.filters] Filters that describe which points to label. For performance reasons,\n     *   we recommend labeling only a small subset of most interesting points.\n     * @param {object} [layout.label.style] CSS style options for label text\n     */\n    constructor(layout) {\n        layout = merge(layout, default_layout);\n\n        // Extra default for layout spacing\n        // Not in default layout since that would make the label attribute always present\n        if (layout.label && isNaN(layout.label.spacing)) {\n            layout.label.spacing = 4;\n        }\n        super(...arguments);\n    }\n\n    // Implement tooltip position to be layer-specific\n    _getTooltipPosition(tooltip) {\n        const x_center = this.parent.x_scale(tooltip.data[this.layout.x_axis.field]);\n        const y_scale = `y${this.layout.y_axis.axis}_scale`;\n        const y_center = this.parent[y_scale](tooltip.data[this.layout.y_axis.field]);\n        const point_size = this.resolveScalableParameter(this.layout.point_size, tooltip.data);\n        const offset = Math.sqrt(point_size / Math.PI);\n\n        return {\n            x_min: x_center - offset, x_max: x_center + offset,\n            y_min: y_center - offset, y_max: y_center + offset,\n        };\n    }\n\n    // Function to flip labels from being anchored at the start of the text to the end\n    // Both to keep labels from running outside the data layer and  also as a first\n    // pass on recursive separation\n    flip_labels() {\n        const data_layer = this;\n        // Base positions on the default point size (which is what resolve scalable param returns if no data provided)\n        const point_size = data_layer.resolveScalableParameter(data_layer.layout.point_size, {});\n        const spacing = data_layer.layout.label.spacing;\n        const handle_lines = Boolean(data_layer.layout.label.lines);\n        const min_x = 2 * spacing;\n        const max_x = this.parent_plot.layout.width - this.parent.layout.margin.left - this.parent.layout.margin.right - (2 * spacing);\n\n        const flip = (dn, dnl) => {\n            const dnx = +dn.attr('x');\n            const text_swing = (2 * spacing) + (2 * Math.sqrt(point_size));\n            let dnlx2;\n            let line_swing;\n            if (handle_lines) {\n                dnlx2 = +dnl.attr('x2');\n                line_swing = spacing + (2 * Math.sqrt(point_size));\n            }\n            if (dn.style('text-anchor') === 'start') {\n                dn.style('text-anchor', 'end');\n                dn.attr('x', dnx - text_swing);\n                if (handle_lines) {\n                    dnl.attr('x2', dnlx2 - line_swing);\n                }\n            } else {\n                dn.style('text-anchor', 'start');\n                dn.attr('x', dnx + text_swing);\n                if (handle_lines) {\n                    dnl.attr('x2', dnlx2 + line_swing);\n                }\n            }\n        };\n        // Flip any going over the right edge from the right side to the left side\n        // (all labels start on the right side)\n        data_layer._label_texts.each(function (d, i) {\n            const a = this;\n            const da = d3.select(a);\n            const dax = +da.attr('x');\n            const abound = da.node().getBoundingClientRect();\n            if (dax + abound.width + spacing > max_x) {\n                const dal = handle_lines ? d3.select(data_layer._label_lines.nodes()[i]) : null;\n                flip(da, dal);\n            }\n        });\n        // Second pass to flip any others that haven't flipped yet if they collide with another label\n        data_layer._label_texts.each(function (d, i) {\n            const a = this;\n            const da = d3.select(a);\n            if (da.style('text-anchor') === 'end') {\n                return;\n            }\n            let dax = +da.attr('x');\n            const abound = da.node().getBoundingClientRect();\n            const dal = handle_lines ? d3.select(data_layer._label_lines.nodes()[i]) : null;\n            data_layer._label_texts.each(function () {\n                const b = this;\n                const db = d3.select(b);\n                const bbound = db.node().getBoundingClientRect();\n                const collision = abound.left < bbound.left + bbound.width + (2 * spacing) &&\n                    abound.left + abound.width + (2 * spacing) > bbound.left &&\n                    abound.top < bbound.top + bbound.height + (2 * spacing) &&\n                    abound.height + abound.top + (2 * spacing) > bbound.top;\n                if (collision) {\n                    flip(da, dal);\n                    // Double check that this flip didn't push the label past min_x. If it did, immediately flip back.\n                    dax = +da.attr('x');\n                    if (dax - abound.width - spacing < min_x) {\n                        flip(da, dal);\n                    }\n                }\n            });\n        });\n    }\n\n    // Recursive function to space labels apart immediately after initial render\n    // Adapted from thudfactor's fiddle here: https://jsfiddle.net/thudfactor/HdwTH/\n    // TODO: Make labels also aware of data elements\n    separate_labels() {\n        this._label_iterations++;\n        const data_layer = this;\n        const alpha = 0.5;\n        if (!this.layout.label) {\n            // Guard against layout changing in the midst of iterative rerender\n            return;\n        }\n        const spacing = this.layout.label.spacing;\n        let again = false;\n        data_layer._label_texts.each(function () {\n            // TODO: O(n2) algorithm; revisit performance?\n            const a = this;\n            const da = d3.select(a);\n            const y1 = da.attr('y');\n            data_layer._label_texts.each(function () {\n                const b = this;\n                // a & b are the same element and don't collide.\n                if (a === b) {\n                    return;\n                }\n                const db = d3.select(b);\n                // a & b are on opposite sides of the chart and\n                // don't collide\n                if (da.attr('text-anchor') !== db.attr('text-anchor')) {\n                    return;\n                }\n                // Determine if the  bounding rects for the two text elements collide\n                const abound = da.node().getBoundingClientRect();\n                const bbound = db.node().getBoundingClientRect();\n                const collision = abound.left < bbound.left + bbound.width + (2 * spacing) &&\n                    abound.left + abound.width + (2 * spacing) > bbound.left &&\n                    abound.top < bbound.top + bbound.height + (2 * spacing) &&\n                    abound.height + abound.top + (2 * spacing) > bbound.top;\n                if (!collision) {\n                    return;\n                }\n                again = true;\n                // If the labels collide, we'll push each\n                // of the two labels up and down a little bit.\n                const y2 = db.attr('y');\n                const sign = abound.top < bbound.top ? 1 : -1;\n                const adjust = sign * alpha;\n                let new_a_y = +y1 - adjust;\n                let new_b_y = +y2 + adjust;\n                // Keep new values from extending outside the data layer\n                const min_y = 2 * spacing;\n                const max_y = data_layer.parent.layout.height - data_layer.parent.layout.margin.top - data_layer.parent.layout.margin.bottom - (2 * spacing);\n                let delta;\n                if (new_a_y - (abound.height / 2) < min_y) {\n                    delta = +y1 - new_a_y;\n                    new_a_y = +y1;\n                    new_b_y += delta;\n                } else if (new_b_y - (bbound.height / 2) < min_y) {\n                    delta = +y2 - new_b_y;\n                    new_b_y = +y2;\n                    new_a_y += delta;\n                }\n                if (new_a_y + (abound.height / 2) > max_y) {\n                    delta = new_a_y - +y1;\n                    new_a_y = +y1;\n                    new_b_y -= delta;\n                } else if (new_b_y + (bbound.height / 2) > max_y) {\n                    delta = new_b_y - +y2;\n                    new_b_y = +y2;\n                    new_a_y -= delta;\n                }\n                da.attr('y', new_a_y);\n                db.attr('y', new_b_y);\n            });\n        });\n        if (again) {\n            // Adjust lines to follow the labels\n            if (data_layer.layout.label.lines) {\n                const label_elements = data_layer._label_texts.nodes();\n                data_layer._label_lines.attr('y2', (d, i) => {\n                    const label_line = d3.select(label_elements[i]);\n                    return label_line.attr('y');\n                });\n            }\n            // After ~150 iterations we're probably beyond diminising returns, so stop recursing\n            if (this._label_iterations < 150) {\n                setTimeout(() => {\n                    this.separate_labels();\n                }, 1);\n            }\n        }\n    }\n\n    // Implement the main render function\n    render() {\n        const data_layer = this;\n        const x_scale = this.parent['x_scale'];\n        const y_scale = this.parent[`y${this.layout.y_axis.axis}_scale`];\n\n        const xcs = Symbol.for('lzX');\n        const ycs = Symbol.for('lzY');\n\n        // Apply filters to only render a specified set of points\n        let track_data = this._applyFilters();\n\n        // Add coordinates before rendering, so we can coalesce\n        track_data.forEach((item) => {\n            let x = x_scale(item[this.layout.x_axis.field]);\n            let y = y_scale(item[this.layout.y_axis.field]);\n            if (isNaN(x)) {\n                x = -1000;\n            }\n            if (isNaN(y)) {\n                y = -1000;\n            }\n            item[xcs] = x;\n            item[ycs] = y;\n        });\n\n        if (this.layout.coalesce.active && track_data.length > this.layout.coalesce.max_points) {\n            let { x_min, x_max, y_min, y_max, x_gap, y_gap } = this.layout.coalesce;\n            // Convert x and y \"significant region\" range from data values to pixels\n            const x_min_px = isFinite(x_min) ? x_scale(+x_min) : -Infinity;\n            const x_max_px = isFinite(x_max) ? x_scale(+x_max) : Infinity;\n            // For y px, we flip the data min/max b/c in SVG coord system +y is down: smaller data y = larger px y\n            const y_min_px = isFinite(y_max) ? y_scale(+y_max) : -Infinity;\n            const y_max_px = isFinite(y_min) ? y_scale(+y_min) : Infinity;\n            track_data = coalesce_scatter_points(track_data, x_min_px, x_max_px, x_gap, y_min_px, y_max_px, y_gap);\n        }\n\n        if (this.layout.label) {\n            let label_data;\n            const filters = data_layer.layout.label.filters || [];\n            if (!filters.length) {\n                label_data = track_data;\n            } else {\n                const func = this.filter.bind(this, filters);\n                label_data = track_data.filter(func);\n            }\n\n            // Render label groups\n            this._label_groups = this.svg.group\n                .selectAll(`g.lz-data_layer-${this.layout.type}-label`)\n                .data(label_data, (d) => `${d[this.layout.id_field]}_label`);\n\n            const style_class = `lz-data_layer-${this.layout.type}-label`;\n            const groups_enter = this._label_groups.enter()\n                .append('g')\n                .attr('class', style_class);\n\n            if (this._label_texts) {\n                this._label_texts.remove();\n            }\n\n            this._label_texts = this._label_groups.merge(groups_enter)\n                .append('text')\n                .text((d) => parseFields(data_layer.layout.label.text || '', d, this.getElementAnnotation(d)))\n                .attr('x', (d) => {\n                    return d[xcs]\n                        + Math.sqrt(data_layer.resolveScalableParameter(data_layer.layout.point_size, d))\n                        + data_layer.layout.label.spacing;\n                })\n                .attr('y', (d) => d[ycs])\n                .attr('text-anchor', 'start')\n                .call(applyStyles, data_layer.layout.label.style || {});\n\n            // Render label lines\n            if (data_layer.layout.label.lines) {\n                if (this._label_lines) {\n                    this._label_lines.remove();\n                }\n                this._label_lines = this._label_groups.merge(groups_enter)\n                    .append('line')\n                    .attr('x1', (d) => d[xcs])\n                    .attr('y1', (d) => d[ycs])\n                    .attr('x2', (d) => {\n                        return d[xcs]\n                            + Math.sqrt(data_layer.resolveScalableParameter(data_layer.layout.point_size, d))\n                            + (data_layer.layout.label.spacing / 2);\n                    })\n                    .attr('y2', (d) => d[ycs])\n                    .call(applyStyles, data_layer.layout.label.lines.style || {});\n            }\n            // Remove labels when they're no longer in the filtered data set\n            this._label_groups.exit()\n                .remove();\n        } else {\n            // If the layout definition has changed (& no longer specifies labels), strip any previously rendered\n            if (this._label_texts) {\n                this._label_texts.remove();\n            }\n            if (this._label_lines) {\n                this._label_lines.remove();\n            }\n            if (this._label_groups) {\n                this._label_groups.remove();\n            }\n        }\n\n        // Generate main scatter data elements\n        const selection = this.svg.group\n            .selectAll(`path.lz-data_layer-${this.layout.type}`)\n            .data(track_data, (d) => d[this.layout.id_field]);\n\n        // Create elements, apply class, ID, and initial position\n        // Generate new values (or functions for them) for position, color, size, and shape\n        const transform = (d) => `translate(${d[xcs]}, ${d[ycs]})`;\n\n        const shape = d3.symbol()\n            .size((d, i) => this.resolveScalableParameter(this.layout.point_size, d, i))\n            .type((d, i) => nameToSymbol(this.resolveScalableParameter(this.layout.point_shape, d, i)));\n\n        const style_class = `lz-data_layer-${this.layout.type}`;\n        selection.enter()\n            .append('path')\n            .attr('class', style_class)\n            .attr('id', (d) => this.getElementId(d))\n            .merge(selection)\n            .attr('transform', transform)\n            .attr('fill', (d, i) => this.resolveScalableParameter(this.layout.color, d, i))\n            .attr('fill-opacity', (d, i) => this.resolveScalableParameter(this.layout.fill_opacity, d, i))\n            .attr('d', shape);\n\n        // Remove old elements as needed\n        selection.exit()\n            .remove();\n\n        // Apply method to keep labels from overlapping each other\n        if (this.layout.label) {\n            this.flip_labels();\n            this._label_iterations = 0;\n            this.separate_labels();\n        }\n\n        // Apply default event emitters & mouse behaviors. Apply to the container, not per element,\n        // to reduce number of event listeners. These events will apply to both scatter points and labels.\n        this.svg.group\n            .on('click.event_emitter', () => {\n                // D3 doesn't natively support bubbling very well; we need to find the data for the bubbled event\n                const item_data = d3.select(d3.event.target).datum();\n                this.parent.emit('element_clicked', item_data, true);\n            })\n            .call(this.applyBehaviors.bind(this));\n    }\n\n    /**\n     * A new LD reference variant has been selected (usually by clicking within a GWAS scatter plot)\n     *   This event only fires for manually selected variants. It does not fire if the LD reference variant is\n     *   automatically selected (eg by choosing the most significant hit in the region)\n     * @event set_ldrefvar\n     * @property {object} data { ldrefvar } The variant identifier of the LD reference variant\n     * @see event:any_lz_event\n     */\n\n    /**\n     * Method to set a passed element as the LD reference variant in the plot-level state. Triggers a re-render\n     *   so that the plot will update with the new LD information.\n     * This is useful in tooltips, eg the \"make LD reference\" action link for GWAS scatter plots.\n     * @param {object} element The data associated with a particular plot element\n     * @fires event:set_ldrefvar\n     * @return {Promise}\n      */\n    makeLDReference(element) {\n        let ref = null;\n        if (typeof element == 'undefined') {\n            throw new Error('makeLDReference requires one argument of any type');\n        } else if (typeof element == 'object') {\n            if (this.layout.id_field && typeof element[this.layout.id_field] != 'undefined') {\n                ref = element[this.layout.id_field].toString();\n            } else if (typeof element['id'] != 'undefined') {\n                ref = element['id'].toString();\n            } else {\n                ref = element.toString();\n            }\n        } else {\n            ref = element.toString();\n        }\n        this.parent.emit('set_ldrefvar', { ldrefvar: ref }, true);\n        return this.parent_plot.applyState({ ldrefvar: ref });\n    }\n}\n\n/**\n * A scatter plot in which the x-axis represents categories, rather than individual positions.\n * For example, this can be used by PheWAS plots to show related groups. This plot allows the categories and color options to be\n *   determined dynamically when data is first loaded.\n * @alias module:LocusZoom_DataLayers~category_scatter\n */\nclass CategoryScatter extends Scatter {\n    /**\n     * @param {string} layout.x_axis.category_field The datum field to use in auto-generating tick marks, color scheme, and point ordering.\n     */\n    constructor(layout) {\n        super(...arguments);\n        /**\n         * Define category names and extents (boundaries) for plotting.\n         * In the form {category_name: [min_x, max_x]}\n         * @private\n         * @member {Object.<String, Number[]>}\n         */\n        this._categories = {};\n    }\n\n    /**\n     * This plot layer makes certain assumptions about the data passed in. Transform the raw array of records from\n     *   the datasource to prepare it for plotting, as follows:\n     * 1. The scatter plot assumes that all records are given in sequence (pre-grouped by `category_field`)\n     * 2. It assumes that all records have an x coordinate for individual plotting\n     * @private\n     */\n    _prepareData() {\n        const xField = this.layout.x_axis.field || 'x';\n        // The (namespaced) field from `this.data` that will be used to assign datapoints to a given category & color\n        const category_field = this.layout.x_axis.category_field;\n        if (!category_field) {\n            throw new Error(`Layout for ${this.layout.id} must specify category_field`);\n        }\n        // Sort the data so that things in the same category are adjacent (case-insensitive by specified field)\n        const sourceData = this.data\n            .sort((a, b) => {\n                const ak = a[category_field];\n                const bk = b[category_field];\n                const av = (typeof ak === 'string') ? ak.toLowerCase() : ak;\n                const bv = (typeof bk === 'string') ? bk.toLowerCase() : bk;\n                return (av === bv) ? 0 : (av < bv ? -1 : 1);\n            });\n        sourceData.forEach((d, i) => {\n            // Implementation detail: Scatter plot requires specifying an x-axis value, and most datasources do not\n            //   specify plotting positions. If a point is missing this field, fill in a synthetic value.\n            d[xField] = d[xField] || i;\n        });\n        return sourceData;\n    }\n\n    /**\n     * Identify the unique categories on the plot, and update the layout with an appropriate color scheme.\n     * Also identify the min and max x value associated with the category, which will be used to generate ticks\n     * @private\n     * @returns {Object.<String, Number[]>} Series of entries used to build category name ticks {category_name: [min_x, max_x]}\n     */\n    _generateCategoryBounds() {\n        // TODO: API may return null values in category_field; should we add placeholder category label?\n        // The (namespaced) field from `this.data` that will be used to assign datapoints to a given category & color\n        const category_field = this.layout.x_axis.category_field;\n        const xField = this.layout.x_axis.field || 'x';\n        const uniqueCategories = {};\n        this.data.forEach((item) => {\n            const category = item[category_field];\n            const x = item[xField];\n            const bounds = uniqueCategories[category] || [x, x];\n            uniqueCategories[category] = [Math.min(bounds[0], x), Math.max(bounds[1], x)];\n        });\n\n        const categoryNames = Object.keys(uniqueCategories);\n        this._setDynamicColorScheme(categoryNames);\n\n        return uniqueCategories;\n    }\n\n    /**\n     * This layer relies on defining its own category-based color scheme. Find the correct color config object to\n     *  be modified.\n     * @param [from_source]\n     * @returns {Object} A mutable reference to the layout configuration object\n     * @private\n     */\n    _getColorScale(from_source) {\n        from_source = from_source || this.layout;\n        // If the layout does not use a supported coloring scheme, or is already complete, this method should do nothing\n\n        // For legacy reasons, layouts can specify color as an object (only one way to set color), as opposed to the\n        //  preferred mechanism of array (multiple coloring options)\n        let color_params = from_source.color || []; // Object or scalar, no other options allowed\n        if (Array.isArray(color_params)) {\n            color_params = color_params.find((item) => item.scale_function === 'categorical_bin');\n        }\n        if (!color_params || color_params.scale_function !== 'categorical_bin') {\n            throw new Error('This layer requires that color options be provided as a `categorical_bin`');\n        }\n        return color_params;\n    }\n\n    /**\n     * Automatically define a color scheme for the layer based on data returned from the server.\n     *   If part of the color scheme has been specified, it will fill in remaining missing information.\n     *\n     * There are three scenarios:\n     * 1. The layout does not specify either category names or (color) values. Dynamically build both based on\n     *    the data and update the layout.\n     * 2. The layout specifies colors, but not categories. Use that exact color information provided, and dynamically\n     *     determine what categories are present in the data. (cycle through the available colors, reusing if there\n     *     are a lot of categories)\n     * 3. The layout specifies exactly what colors and categories to use (and they match the data!). This is useful to\n     *    specify an explicit mapping between color scheme and category names, when you want to be sure that the\n     *    plot matches a standard color scheme.\n     *    (If the layout specifies categories that do not match the data, the user specified categories will be ignored)\n     *\n     * This method will only act if the layout defines a `categorical_bin` scale function for coloring. It may be\n     *   overridden in a subclass to suit other types of coloring methods.\n     *\n     * @param {String[]} categoryNames\n     * @private\n     */\n    _setDynamicColorScheme(categoryNames) {\n        const colorParams = this._getColorScale(this.layout).parameters;\n        const baseParams = this._getColorScale(this._base_layout).parameters;\n\n        if (baseParams.categories.length && baseParams.values.length) {\n            // If there are preset category/color combos, make sure that they apply to the actual dataset\n            const parameters_categories_hash = {};\n            baseParams.categories.forEach((category) => {\n                parameters_categories_hash[category] = 1;\n            });\n            if (categoryNames.every((name) => Object.prototype.hasOwnProperty.call(parameters_categories_hash, name))) {\n                // The layout doesn't have to specify categories in order, but make sure they are all there\n                colorParams.categories = baseParams.categories;\n            } else {\n                colorParams.categories = categoryNames;\n            }\n        } else {\n            colorParams.categories = categoryNames;\n        }\n        // Prefer user-specified colors if provided. Make sure that there are enough colors for all the categories.\n        let colors;\n        if (baseParams.values.length) {\n            colors = baseParams.values;\n        } else {\n            // Originally from d3v3 category20\n            colors = ['#1f77b4', '#aec7e8', '#ff7f0e', '#ffbb78', '#2ca02c', '#98df8a', '#d62728', '#ff9896', '#9467bd', '#c5b0d5', '#8c564b', '#c49c94', '#e377c2', '#f7b6d2', '#7f7f7f', '#c7c7c7', '#bcbd22', '#dbdb8d', '#17becf', '#9edae5'];\n        }\n        while (colors.length < categoryNames.length) {\n            colors = colors.concat(colors);\n        }\n        colors = colors.slice(0, categoryNames.length);  // List of hex values, should be of same length as categories array\n        colorParams.values = colors;\n    }\n\n    /**\n     *\n     * @param dimension\n     * @param {Object} [config] Parameters that customize how ticks are calculated (not style)\n     * @param {('left'|'center'|'right')} [config.position='left'] Align ticks with the center or edge of category\n     * @returns {Array}\n     */\n    getTicks(dimension, config) { // Overrides parent method\n        if (!['x', 'y1', 'y2'].includes(dimension)) {\n            throw new Error('Invalid dimension identifier');\n        }\n        const position = config.position || 'left';\n        if (!['left', 'center', 'right'].includes(position)) {\n            throw new Error('Invalid tick position');\n        }\n\n        const categoryBounds = this._categories;\n        if (!categoryBounds || !Object.keys(categoryBounds).length) {\n            return [];\n        }\n\n        if (dimension === 'y') {\n            return [];\n        }\n\n        if (dimension === 'x') {\n            // If colors have been defined by this layer, use them to make tick colors match scatterplot point colors\n            const colors = this._getColorScale(this.layout);\n            const knownCategories = colors.parameters.categories || [];\n            const knownColors = colors.parameters.values || [];\n\n            return Object.keys(categoryBounds).map((category, index) => {\n                const bounds = categoryBounds[category];\n                let xPos;\n\n                switch (position) {\n                case 'left':\n                    xPos = bounds[0];\n                    break;\n                case 'center':\n                    // Center tick under one or many elements as appropriate\n                    // eslint-disable-next-line no-case-declarations\n                    const diff = bounds[1] - bounds[0];\n                    xPos = bounds[0] + (diff !== 0 ? diff : bounds[0]) / 2;\n                    break;\n                case 'right':\n                    xPos = bounds[1];\n                    break;\n                }\n                return {\n                    x: xPos,\n                    text: category,\n                    style: {\n                        'fill': knownColors[knownCategories.indexOf(category)] || '#000000',\n                    },\n                };\n            });\n        }\n    }\n\n    applyCustomDataMethods() {\n        this.data = this._prepareData();\n        this._categories = this._generateCategoryBounds();\n        return this;\n    }\n}\n\n\nexport { Scatter as scatter, CategoryScatter as category_scatter };\n","/**\n * Helper functions targeted at rendering operations\n * @module\n * @private\n*/\n\n\n/**\n * A very simple function aimed at scatter plots: attempts to coalesce \"low-significance\" SNPs that are too close to\n *  visually distinguish, thus creating a dataset with fewer points that can be rendered more quickly.\n *\n *  This depends on the strong and explicit assumption that points are ordered (typically in x position), so that\n *    nearby points can be grouped by iterating over the data in sequence.\n *\n * @param {Object[]} data Plot data, annotated with calculated `xc` and `yc` symbols for x and y coordinates (in px).\n * @param {Number} x_min The smallest x value of an \"insignificant region\" rectangle\n * @param {Number} x_max The largest x value of an \"insignificant region\" rectangle\n * @param {Number} x_gap Max px distance, in x direction, from the first point in a set, to qualify for grouping\n * @param {Number} y_min The smallest y value of an \"insignificant region\" rectangle\n * @param {Number} y_max The largest y value of an \"insignificant region\" rectangle\n * @param {Number} y_gap Max px distance, in y direction, from the first point in a set, to qualify for grouping\n * @return {Object[]} The simplified dataset with fewer points\n */\nfunction coalesce_scatter_points (data, x_min, x_max, x_gap, y_min, y_max, y_gap) {\n    let final_data = [];\n\n    const xcs = Symbol.for('lzX');\n    const ycs = Symbol.for('lzY');\n\n    let x_start = null;\n    let y_start = null;\n    let current_group = [];\n\n    function _combine () {\n        if (current_group.length) {\n            // If there are points near each other, return the middle item to represent the group\n            // We use a real point (rather than a synthetic average point) to best handle extra fields\n            const item = current_group[Math.floor((current_group.length - 1) / 2)];\n            final_data.push(item);\n        }\n        x_start = y_start = null;\n        current_group = [];\n    }\n\n    function _start_run(x, y, item) {\n        x_start = x;\n        y_start = y;\n        current_group.push(item);\n    }\n\n    data.forEach((item) => {\n        const x = item[xcs];\n        const y = item[ycs];\n\n        const in_combine_region = (x >= x_min && x <= x_max && y >= y_min && y <= y_max);\n        if (item.lz_is_match || !in_combine_region) {\n            // If an item is marked as interesting in some way, always render it explicitly\n            // (and coalesce the preceding points if a run was in progress, to preserve ordering)\n            _combine();\n            final_data.push(item);\n        } else if (x_start === null) {\n            // If not tracking a group, start tracking\n            _start_run(x, y, item);\n        } else {\n            // Otherwise, the decision to render the point depends on whether it is close to a run of other\n            //  insignificant points\n            const near_prior = Math.abs(x - x_start) <= x_gap && Math.abs(y - y_start) <= y_gap;\n\n            if (near_prior) {\n                current_group.push(item);\n            } else {\n                // \"if in combine region, and not near a prior point, coalesce all prior items, then track this point\n                //  as part of the next run that could be grouped\"\n                _combine();\n                _start_run(x, y, item);\n            }\n        }\n    });\n    // At the end of the dataset, check whether any runs of adjacent points were in progress, and coalesce if so\n    _combine();\n\n    return final_data;\n}\n\nexport { coalesce_scatter_points };\n","/**\n * @module\n * @private\n */\nimport {ClassRegistry} from './base';\nimport * as layers from '../components/data_layer';\n\n/**\n * A plugin registry that allows plots to use both pre-defined and user-provided data rendering types (data layers).\n * @alias module:LocusZoom~DataLayers\n * @type {module:registry/base~ClassRegistry}\n */\nconst registry = new ClassRegistry();\nfor (let [name, type] of Object.entries(layers)) {\n    registry.add(name, type);\n}\n\n\nexport default registry;\n","/**\n * Predefined layouts that describe how to draw common types of data, as well as what interactive features to use.\n *  Each plot contains multiple panels (rows), and each row can stack several kinds of data in layers\n *  (eg scatter plot and line of significance). Layouts provide the building blocks to provide interactive experiences\n *  and user-friendly tooltips for common kinds of genetic data.\n *\n * Many of these layouts (like the standard association plot) assume that field names are the same as those provided\n *  in the UMich [portaldev API](https://portaldev.sph.umich.edu/docs/api/v1/). Although layouts can be used on many\n *  kinds of data, it is often less work to write an adapter that uses the same field names, rather than to modify\n *  every single reference to a field anywhere in the layout.\n *\n * See the Layouts Tutorial for details on how to customize nested layouts.\n *\n * @module LocusZoom_Layouts\n */\n\nimport version from '../version';\nimport {deepCopy, merge} from '../helpers/layouts';\n\nconst LZ_SIG_THRESHOLD_LOGP = 7.301; // -log10(.05/1e6)\n\n/*\n * Tooltip Layouts\n */\nconst standard_association_tooltip = {\n    closable: true,\n    show: { or: ['highlighted', 'selected'] },\n    hide: { and: ['unhighlighted', 'unselected'] },\n    html: `<strong>{{assoc:variant|htmlescape}}</strong><br>\n        P Value: <strong>{{assoc:log_pvalue|logtoscinotation|htmlescape}}</strong><br>\n        Ref. Allele: <strong>{{assoc:ref_allele|htmlescape}}</strong><br>\n        {{#if lz_is_ld_refvar}}<strong>LD Reference Variant</strong>{{#else}}\n        <a href=\"javascript:void(0);\" \n        onclick=\"var data = this.parentNode.__data__;\n                 data.getDataLayer().makeLDReference(data);\"\n                 >Make LD Reference</a>{{/if}}<br>`,\n};\n\nconst standard_association_tooltip_with_label = function() {\n    // Add a special \"toggle label\" button to the base tooltip. This must be used in tandem with a custom layout\n    //   directive (label.filters should check a boolean annotation field called \"lz_show_label\").\n    const base = deepCopy(standard_association_tooltip);\n    base.html += `<a href=\"javascript:void(0);\" \n                  onclick=\"var item = this.parentNode.__data__, layer = item.getDataLayer(); \n                  var current = layer.getElementAnnotation(item, 'lz_show_label'); \n                  layer.setElementAnnotation(item, 'lz_show_label', !current );\n                  layer.parent_plot.applyState();\">{{#if lz_show_label}}Hide{{#else}}Show{{/if}} label</a>`;\n    return base;\n}();\n\nconst standard_genes_tooltip = {\n    closable: true,\n    show: { or: ['highlighted', 'selected'] },\n    hide: { and: ['unhighlighted', 'unselected'] },\n    html: '<h4><strong><i>{{gene_name|htmlescape}}</i></strong></h4>'\n        + 'Gene ID: <a href=\"https://useast.ensembl.org/homo_sapiens/Gene/Summary?g={{gene_id|htmlescape}}&db=core\" target=\"_blank\" rel=\"noopener\">{{gene_id|htmlescape}}</a><br>'\n        + 'Transcript ID: <strong>{{transcript_id|htmlescape}}</strong><br>'\n        + '{{#if pLI}}<table>'\n        + '<tr><th>Constraint</th><th>Expected variants</th><th>Observed variants</th><th>Const. Metric</th></tr>'\n        + '<tr><td>Synonymous</td><td>{{exp_syn}}</td><td>{{obs_syn}}</td><td>z = {{syn_z}}<br>o/e = {{oe_syn}} ({{oe_syn_lower}} - {{oe_syn_upper}})</td></tr>'\n        + '<tr><td>Missense</td><td>{{exp_mis}}</td><td>{{obs_mis}}</td><td>z = {{mis_z}}<br>o/e = {{oe_mis}} ({{oe_mis_lower}} - {{oe_mis_upper}})</td></tr>'\n        + '<tr><td>pLoF</td><td>{{exp_lof}}</td><td>{{obs_lof}}</td><td>pLI = {{pLI}}<br>o/e = {{oe_lof}} ({{oe_lof_lower}} - {{oe_lof_upper}})</td></tr>'\n        + '</table><br>{{/if}}'\n        + '<a href=\"https://gnomad.broadinstitute.org/gene/{{gene_id|htmlescape}}\" target=\"_blank\" rel=\"noopener\">More data on gnomAD</a>',\n};\n\nconst catalog_variant_tooltip = {\n    closable: true,\n    show: { or: ['highlighted', 'selected'] },\n    hide: { and: ['unhighlighted', 'unselected'] },\n    html: '<strong>{{catalog:variant|htmlescape}}</strong><br>'\n        + 'Catalog entries: <strong>{{n_catalog_matches|htmlescape}}</strong><br>'\n        + 'Top Trait: <strong>{{catalog:trait|htmlescape}}</strong><br>'\n        + 'Top P Value: <strong>{{catalog:log_pvalue|logtoscinotation}}</strong><br>'\n        // User note: if a different catalog is used, the tooltip will need to be replaced with a different link URL\n        + 'More: <a href=\"https://www.ebi.ac.uk/gwas/search?query={{catalog:rsid|htmlescape}}\" target=\"_blank\" rel=\"noopener\">GWAS catalog</a> / <a href=\"https://www.ncbi.nlm.nih.gov/snp/{{catalog:rsid|htmlescape}}\" target=\"_blank\" rel=\"noopener\">dbSNP</a>',\n};\n\nconst coaccessibility_tooltip = {\n    closable: true,\n    show: { or: ['highlighted', 'selected'] },\n    hide: { and: ['unhighlighted', 'unselected'] },\n    // TODO: Is there a more generic terminology? (eg not every technique is in terms of cis-regulatory element)\n    html: '<strong>Regulatory element</strong><br>' +\n        '{{access:start1|htmlescape}}-{{access:end1|htmlescape}}<br>' +\n        '<strong>Promoter</strong><br>' +\n        '{{access:start2|htmlescape}}-{{access:end2|htmlescape}}<br>' +\n        '{{#if access:target}}<strong>Target</strong>: {{access:target|htmlescape}}<br>{{/if}}' +\n        '<strong>Score</strong>: {{access:score|htmlescape}}',\n};\n\n/*\n * Data Layer Layouts: represent specific information given provided data.\n */\n\n/**\n * A horizontal line of GWAS significance at the standard threshold of p=5e-8\n * @name significance\n * @type data_layer\n */\nconst significance_layer = {\n    id: 'significance',\n    type: 'orthogonal_line',\n    tag: 'significance',\n    orientation: 'horizontal',\n    offset: LZ_SIG_THRESHOLD_LOGP,\n};\n\n/**\n * A simple curve representing the genetic recombination rate, drawn from the UM API\n * @name recomb_rate\n * @type data_layer\n */\nconst recomb_rate_layer = {\n    id: 'recombrate',\n    namespace: { 'recomb': 'recomb' },\n    data_operations: [\n        { type: 'fetch', from: ['recomb'] },\n    ],\n    type: 'line',\n    tag: 'recombination',\n    z_index: 1,\n    style: {\n        'stroke': '#0000FF',\n        'stroke-width': '1.5px',\n    },\n    x_axis: {\n        field: 'recomb:position',\n    },\n    y_axis: {\n        axis: 2,\n        field: 'recomb:recomb_rate',\n        floor: 0,\n        ceiling: 100,\n    },\n};\n\n/**\n * A scatter plot of GWAS association summary statistics, with preset field names matching the UM portaldev api\n * @name association_pvalues\n * @type data_layer\n */\nconst association_pvalues_layer = {\n    namespace: { 'assoc': 'assoc', 'ld': 'ld' },\n    data_operations: [\n        {\n            type: 'fetch',\n            from: ['assoc', 'ld(assoc)'],\n        },\n        {\n            type: 'left_match',\n            name: 'assoc_plus_ld',\n            requires: ['assoc', 'ld'],\n            params: ['assoc:position', 'ld:position2'],  // FIXME: old LZ used position, because it was less sensitive to format. We'd like to match assoc:variant = ld:variant2, but not every assoc source provides variant data in the way we need. This would need to be fixed via special formatting adjustment later.\n        },\n    ],\n    id: 'associationpvalues',\n    type: 'scatter',\n    tag: 'association',\n    id_field: 'assoc:variant',\n    coalesce: {\n        active: true,\n    },\n    point_shape: [\n        {\n            scale_function: 'if',\n            field: 'lz_is_ld_refvar',\n            parameters: {\n                field_value: true,\n                then: 'diamond',\n            },\n        },\n        {\n            // Not every dataset will provide these params\n            scale_function: 'effect_direction',\n            parameters: {\n                '+': 'triangle',\n                '-': 'triangledown',\n                // The scale function receives the entire datum object, so it needs to be told where to find individual fields\n                beta_field: 'assoc:beta',\n                stderr_beta_field: 'assoc:se',\n            },\n        },\n        'circle',\n    ],\n    point_size: {\n        scale_function: 'if',\n        field: 'lz_is_ld_refvar',\n        parameters: {\n            field_value: true,\n            then: 80,\n            else: 40,\n        },\n    },\n    color: [\n        {\n            scale_function: 'if',\n            field: 'lz_is_ld_refvar',\n            parameters: {\n                field_value: true,\n                then: '#9632b8',\n            },\n        },\n        {\n            scale_function: 'numerical_bin',\n            field: 'ld:correlation',\n            parameters: {\n                breaks: [0, 0.2, 0.4, 0.6, 0.8],\n                // Derived from Google \"Turbo\" colormap, breakpoints [0.05, 0.25, 0.45, 0.65, 0.85]\n                values: ['rgb(70, 54, 153)', 'rgb(38, 188, 225)', 'rgb(110, 254, 104)', 'rgb(248, 195, 42)', 'rgb(219, 61, 17)'],\n            },\n        },\n        '#AAAAAA',\n    ],\n    legend: [\n        {  label: 'LD (r)', label_size: 14 }, // We're omitting the refvar symbol for now, but can show it with // shape: 'diamond', color: '#9632b8'\n        {\n            shape: 'ribbon',\n            orientation: 'vertical',\n            width: 10,\n            height: 15,\n            color_stops: ['rgb(70, 54, 153)', 'rgb(38, 188, 225)', 'rgb(110, 254, 104)', 'rgb(248, 195, 42)', 'rgb(219, 61, 17)'],\n            tick_labels: [0, 0.2, 0.4, 0.6, 0.8, 1.0],\n        },\n    ],\n    label: null,\n    z_index: 2,\n    x_axis: {\n        field: 'assoc:position',\n    },\n    y_axis: {\n        axis: 1,\n        field: 'assoc:log_pvalue',\n        floor: 0,\n        upper_buffer: 0.10,\n        min_extent: [0, 10],\n    },\n    behaviors: {\n        onmouseover: [\n            { action: 'set', status: 'highlighted' },\n        ],\n        onmouseout: [\n            { action: 'unset', status: 'highlighted' },\n        ],\n        onclick: [\n            { action: 'toggle', status: 'selected', exclusive: true },\n        ],\n    },\n    tooltip: deepCopy(standard_association_tooltip),\n};\n\n/**\n * An arc track that shows arcs representing chromatic coaccessibility\n * @name coaccessibility\n * @type data_layer\n */\nconst coaccessibility_layer = {\n    id: 'coaccessibility',\n    type: 'arcs',\n    tag: 'coaccessibility',\n    namespace: { 'access': 'access' },\n    data_operations: [\n        { type: 'fetch', from: ['access'] },\n    ],\n    match: { send: 'access:target', receive: 'access:target' },\n    // Note: in the datasets this was tested with, these fields together defined a unique loop. Other datasets might work differently and need a different ID.\n    id_field: '{{access:start1}}_{{access:end1}}_{{access:start2}}_{{access:end2}}_{{access:score}}_{{access:target}}',\n    filters: [\n        { field: 'access:score', operator: '!=', value: null },\n    ],\n    color: [\n        {\n            field: 'lz_is_match', // Special field name whose presence triggers custom rendering\n            scale_function: 'if',\n            parameters: {\n                field_value: true,\n                then: '#4285f4',\n            },\n        },\n        {\n            field: 'lz_is_match', // Special field name whose presence triggers custom rendering\n            scale_function: 'if',\n            parameters: {\n                field_value: false,\n                then: '#EAE6E6',\n            },\n        },\n        {\n            scale_function: 'ordinal_cycle',\n            parameters: {\n                values: ['#1f77b4', '#aec7e8', '#ff7f0e', '#ffbb78', '#2ca02c', '#98df8a', '#d62728', '#ff9896', '#9467bd', '#c5b0d5', '#8c564b', '#c49c94', '#e377c2', '#f7b6d2', '#7f7f7f', '#c7c7c7', '#bcbd22', '#dbdb8d', '#17becf', '#9edae5'], // Drawn from d3v3 \"category20\"\n            },\n        },\n    ],\n    x_axis: {\n        field1: 'access:start1',\n        field2: 'access:start2',\n    },\n    y_axis: {\n        axis: 1,\n        field: 'access:score',\n        upper_buffer: 0.1,\n        min_extent: [0, 1],\n    },\n    behaviors: {\n        onmouseover: [\n            { action: 'set', status: 'highlighted' },\n        ],\n        onmouseout: [\n            { action: 'unset', status: 'highlighted' },\n        ],\n        onclick: [\n            { action: 'toggle', status: 'selected', exclusive: true },\n        ],\n    },\n    tooltip: deepCopy(coaccessibility_tooltip),\n};\n\n/**\n * A scatter plot of GWAS summary statistics, with additional tooltip fields showing GWAS catalog annotations\n * @name association_pvalues_catalog\n * @type data_layer\n */\nconst association_pvalues_catalog_layer = function () {\n    // Slightly modify an existing layout\n    let base = deepCopy(association_pvalues_layer);\n    base = merge({ id: 'associationpvaluescatalog', fill_opacity: 0.7 }, base);\n\n    base.data_operations.push({\n        type: 'assoc_to_gwas_catalog',\n        name: 'assoc_catalog',\n        requires: ['assoc_plus_ld', 'catalog'],\n        params: ['assoc:position', 'catalog:pos', 'catalog:log_pvalue'],\n    });\n\n    base.tooltip.html += '{{#if catalog:rsid}}<br><a href=\"https://www.ebi.ac.uk/gwas/search?query={{catalog:rsid|htmlescape}}\" target=\"_blank\" rel=\"noopener\">See hits in GWAS catalog</a>{{/if}}';\n    base.namespace.catalog = 'catalog';\n    return base;\n}();\n\n\n/**\n * A scatter plot of PheWAS pvalues, with preset field names matching the UM Portaldev API\n * @name phewas_pvalues\n * @type data_layer\n */\nconst phewas_pvalues_layer = {\n    id: 'phewaspvalues',\n    type: 'category_scatter',\n    tag: 'phewas',\n    namespace: { 'phewas': 'phewas' },\n    data_operations: [\n        { type: 'fetch', from: ['phewas'] },\n    ],\n    point_shape: [\n        {\n            scale_function: 'effect_direction',\n            parameters: {\n                '+': 'triangle',\n                '-': 'triangledown',\n                // The scale function receives the entire datum object, so it needs to be told where to find individual fields\n                beta_field: 'phewas:beta',\n                stderr_beta_field: 'phewas:se',\n            },\n        },\n        'circle',\n    ],\n    point_size: 70,\n    tooltip_positioning: 'vertical',\n    id_field: '{{phewas:trait_group}}_{{phewas:trait_label}}',\n    x_axis: {\n        field: 'lz_auto_x', // Automatically added by the category_scatter layer\n        category_field: 'phewas:trait_group',\n        lower_buffer: 0.025,\n        upper_buffer: 0.025,\n    },\n    y_axis: {\n        axis: 1,\n        field: 'phewas:log_pvalue',\n        floor: 0,\n        upper_buffer: 0.15,\n    },\n    color: [{\n        field: 'phewas:trait_group',\n        scale_function: 'categorical_bin',\n        parameters: {\n            categories: [],\n            values: [],\n            null_value: '#B8B8B8',\n        },\n    }],\n    fill_opacity: 0.7,\n    tooltip: {\n        closable: true,\n        show: { or: ['highlighted', 'selected'] },\n        hide: { and: ['unhighlighted', 'unselected'] },\n        html: `<strong>Trait:</strong> {{phewas:trait_label|htmlescape}}<br>\n<strong>Trait Category:</strong> {{phewas:trait_group|htmlescape}}<br>\n<strong>P-value:</strong> {{phewas:log_pvalue|logtoscinotation|htmlescape}}\n{{#if phewas:beta|is_numeric}}<br><strong>&beta;:</strong> {{phewas:beta|scinotation|htmlescape}}<br>{{/if}}\n{{#if phewas:se|is_numeric}}<strong>SE (&beta;):</strong> {{phewas:se|scinotation|htmlescape}}{{/if}}`,\n    },\n    behaviors: {\n        onmouseover: [\n            { action: 'set', status: 'highlighted' },\n        ],\n        onmouseout: [\n            { action: 'unset', status: 'highlighted' },\n        ],\n        onclick: [\n            { action: 'toggle', status: 'selected', exclusive: true },\n        ],\n    },\n    label: {\n        text: '{{phewas:trait_label}}',\n        spacing: 6,\n        lines: {\n            style: {\n                'stroke-width': '2px',\n                'stroke': '#333333',\n                'stroke-dasharray': '2px 2px',\n            },\n        },\n        filters: [\n            {\n                field: 'phewas:log_pvalue',\n                operator: '>=',\n                value: 20,\n            },\n        ],\n        style: {\n            'font-size': '14px',\n            'font-weight': 'bold',\n            'fill': '#333333',\n        },\n    },\n};\n\n/**\n * Shows genes in the specified region, with names and formats drawn from the UM Portaldev API and GENCODE datasource\n * @type data_layer\n */\nconst genes_layer = {\n    namespace: { 'gene': 'gene', 'constraint': 'constraint' },\n    data_operations: [\n        {\n            type: 'fetch',\n            from: ['gene', 'constraint(gene)'],\n        },\n        {\n            name: 'gene_constraint',\n            type: 'genes_to_gnomad_constraint',\n            requires: ['gene', 'constraint'],\n        },\n    ],\n    id: 'genes',\n    type: 'genes',\n    tag: 'genes',\n    id_field: 'gene_id',\n    behaviors: {\n        onmouseover: [\n            { action: 'set', status: 'highlighted' },\n        ],\n        onmouseout: [\n            { action: 'unset', status: 'highlighted' },\n        ],\n        onclick: [\n            { action: 'toggle', status: 'selected', exclusive: true },\n        ],\n    },\n    tooltip: deepCopy(standard_genes_tooltip),\n};\n\n/**\n * A genes data layer that uses filters to limit what information is shown by default. This layer hides a curated\n *  list of  GENCODE gene_types that are of less interest to most analysts.\n * Often used in tandem with a panel-level toolbar \"show all\" button so that the user can toggle to a full view.\n * @name genes_filtered\n * @type data_layer\n */\nconst genes_layer_filtered = merge({\n    filters: [\n        {\n            field: 'gene_type',\n            operator: 'in',\n            // A manually curated subset of Gencode biotypes, based on user suggestions\n            //  See full list: https://www.gencodegenes.org/human/stats.html\n            // This is approximately intended to cover elements of generally known function, and exclude things\n            //  like pseudogenes.\n            value: [\n                'protein_coding',\n                'IG_C_gene', 'IG_D_gene', 'IG_J_gene', 'IG_V_gene',\n                'TR_C_gene', 'TR_D_gene', 'TR_J_gene', 'TR_V_gene',\n                'rRNA',\n                'Mt_rRNA', 'Mt_tRNA',\n            ],\n        },\n    ],\n}, deepCopy(genes_layer));\n\n/**\n * An annotation / rug track that shows tick marks for each position in which a variant is present in the provided\n *  association data, *and* has a significant claim in the EBI GWAS catalog.\n * @type data_layer\n */\nconst annotation_catalog_layer = {\n    // Identify GWAS hits that are present in the GWAS catalog\n    namespace: { 'assoc': 'assoc', 'catalog': 'catalog' },\n    data_operations: [\n        {\n            type: 'fetch', from: ['assoc', 'catalog'],\n        },\n        {\n            type: 'assoc_to_gwas_catalog',\n            name: 'assoc_plus_ld',\n            requires: ['assoc', 'catalog'],\n            params: ['assoc:position', 'catalog:pos', 'catalog:log_pvalue'],\n        },\n    ],\n    id: 'annotation_catalog',\n    type: 'annotation_track',\n    tag: 'gwascatalog',\n    id_field: 'assoc:variant',\n    x_axis: {\n        field: 'assoc:position',\n    },\n    color: '#0000CC',\n    filters: [\n        // Specify which points to show on the track. Any selection must satisfy ALL filters\n        { field: 'catalog:rsid', operator: '!=', value: null },\n        { field: 'catalog:log_pvalue', operator: '>', value: LZ_SIG_THRESHOLD_LOGP },\n    ],\n    behaviors: {\n        onmouseover: [\n            { action: 'set', status: 'highlighted' },\n        ],\n        onmouseout: [\n            { action: 'unset', status: 'highlighted' },\n        ],\n        onclick: [\n            { action: 'toggle', status: 'selected', exclusive: true },\n        ],\n    },\n    tooltip: deepCopy(catalog_variant_tooltip),\n    tooltip_positioning: 'top',\n};\n\n/*\n * Individual toolbar buttons\n */\n\n/**\n * A dropdown menu that can be used to control the LD population used with the LDServer Adapter. Population\n *  names are provided for the 1000G dataset that is used by the offical UM LD Server.\n * @name ldlz2_pop_selector\n * @type toolbar_widgets\n */\nconst ldlz2_pop_selector_menu = {\n    // **Note**: this widget is aimed at the LDServer datasource, and the UM 1000G LDServer\n    type: 'set_state',\n    tag: 'ld_population',\n    position: 'right',\n    color: 'blue',\n    button_html: 'LD Population: ',\n    show_selected: true,\n    button_title: 'Select LD Population: ',\n    custom_event_name: 'widget_set_ldpop',\n    state_field: 'ld_pop',\n    // This list below is hardcoded to work with the UMich LDServer, default 1000G populations\n    //  It can be customized to work with other LD servers that specify population differently\n    // https://portaldev.sph.umich.edu/ld/genome_builds/GRCh37/references/1000G/populations\n    options: [\n        { display_name: 'ALL (default)', value: 'ALL' },\n        { display_name: 'AFR', value: 'AFR' },\n        { display_name: 'AMR', value: 'AMR' },\n        { display_name: 'EAS', value: 'EAS' },\n        { display_name: 'EUR', value: 'EUR' },\n        { display_name: 'SAS', value: 'SAS' },\n    ],\n};\n\n/**\n * A dropdown menu that selects which types of genes to show in the plot. The provided options are curated sets of\n *   interesting gene types based on the GENCODE dataset.\n * @type toolbar_widgets\n */\nconst gene_selector_menu = {\n    type: 'display_options',\n    tag: 'gene_filter',\n    custom_event_name: 'widget_gene_filter_choice',\n    position: 'right',\n    color: 'blue',\n    // Below: special config specific to this widget\n    button_html: 'Filter...',\n    button_title: 'Choose which genes to show',\n    layer_name: 'genes',\n    default_config_display_name: 'Coding genes & rRNA',\n    options: [\n        {\n            display_name: 'All features',\n            display: {\n                filters: null,\n            },\n        },\n    ],\n};\n\n/*\n * Toolbar Layouts: Collections of toolbar buttons etc\n */\n\n/**\n * Basic options to remove and reorder panels\n * @name standard_panel\n * @type toolbar\n */\nconst standard_panel_toolbar = {\n    widgets: [\n        {\n            type: 'remove_panel',\n            position: 'right',\n            color: 'red',\n            group_position: 'end',\n        },\n        {\n            type: 'move_panel_up',\n            position: 'right',\n            group_position: 'middle',\n        },\n        {\n            type: 'move_panel_down',\n            position: 'right',\n            group_position: 'start',\n            style: { 'margin-left': '0.75em' },\n        },\n    ],\n};\n\n/**\n * A simple plot toolbar with buttons to download as image\n * @name standard_plot\n * @type toolbar\n */\nconst standard_plot_toolbar = {\n    // Suitable for most any type of plot drawn with LZ. Title and download buttons.\n    widgets: [\n        {\n            type: 'title',\n            title: 'LocusZoom',\n            subtitle: `<a href=\"https://statgen.github.io/locuszoom/\" target=\"_blank\" rel=\"noopener\">v${version}</a>`,\n            position: 'left',\n        },\n        {\n            type: 'download',\n            position: 'right',\n            group_position: 'end',\n        },\n        {\n            type: 'download_png',\n            position: 'right',\n            group_position: 'start',\n        },\n    ],\n};\n\n/**\n * A plot toolbar that adds a button for controlling LD population. This is useful for plots intended to show\n *  GWAS summary stats, which is one of the most common usages of LocusZoom.\n * @type toolbar\n */\nconst standard_association_toolbar = function () {\n    // Suitable for association plots (adds a button for LD data)\n    const base = deepCopy(standard_plot_toolbar);\n    base.widgets.push(deepCopy(ldlz2_pop_selector_menu));\n    return base;\n}();\n\n/**\n * A basic plot toolbar with buttons to scroll sideways or zoom in. Useful for all region-based plots.\n * @name region_nav_plot\n * @type toolbar\n */\nconst region_nav_plot_toolbar = function () {\n    // Generic region nav buttons\n    const base = deepCopy(standard_plot_toolbar);\n    base.widgets.push(\n        {\n            type: 'shift_region',\n            step: 500000,\n            button_html: '>>',\n            position: 'right',\n            group_position: 'end',\n        }, {\n            type: 'shift_region',\n            step: 50000,\n            button_html: '>',\n            position: 'right',\n            group_position: 'middle',\n        },\n        {\n            type: 'zoom_region',\n            step: 0.2,\n            position: 'right',\n            group_position: 'middle',\n        },\n        {\n            type: 'zoom_region',\n            step: -0.2,\n            position: 'right',\n            group_position: 'middle',\n        },\n        {\n            type: 'shift_region',\n            step: -50000,\n            button_html: '<',\n            position: 'right',\n            group_position: 'middle',\n        },\n        {\n            type: 'shift_region',\n            step: -500000,\n            button_html: '<<',\n            position: 'right',\n            group_position: 'start',\n        },\n    );\n    return base;\n}();\n\n/*\n * Panel Layouts\n */\n\n\n/**\n * A panel that describes the most common kind of LocusZoom plot, with line of GWAS significance, recombination rate,\n *  and a scatter plot superimposed.\n * @name association\n * @type panel\n */\nconst association_panel = {\n    id: 'association',\n    tag: 'association',\n    min_height: 200,\n    height: 300,\n    margin: { top: 35, right: 55, bottom: 40, left: 70 },\n    inner_border: 'rgb(210, 210, 210)',\n    toolbar: (function () {\n        const base = deepCopy(standard_panel_toolbar);\n        base.widgets.push({\n            type: 'toggle_legend',\n            position: 'right',\n        });\n        return base;\n    })(),\n    axes: {\n        x: {\n            label: 'Chromosome {{chr}} (Mb)',\n            label_offset: 38,\n            tick_format: 'region',\n            extent: 'state',\n        },\n        y1: {\n            label: '-log10 p-value',\n            label_offset: 50,\n        },\n        y2: {\n            label: 'Recombination Rate (cM/Mb)',\n            label_offset: 46,\n        },\n    },\n    legend: {\n        orientation: 'vertical',\n        origin: { x: 75, y: 40 },\n        hidden: true,\n    },\n    interaction: {\n        drag_background_to_pan: true,\n        drag_x_ticks_to_scale: true,\n        drag_y1_ticks_to_scale: true,\n        drag_y2_ticks_to_scale: true,\n        scroll_to_zoom: true,\n        x_linked: true,\n    },\n    data_layers: [\n        deepCopy(significance_layer),\n        deepCopy(recomb_rate_layer),\n        deepCopy(association_pvalues_layer),\n    ],\n};\n\n/**\n * A panel showing chromatin coaccessibility arcs with some common display options\n * @type panel\n */\nconst coaccessibility_panel = {\n    id: 'coaccessibility',\n    tag: 'coaccessibility',\n    min_height: 150,\n    height: 180,\n    margin: { top: 35, right: 55, bottom: 40, left: 70 },\n    inner_border: 'rgb(210, 210, 210)',\n    toolbar: deepCopy(standard_panel_toolbar),\n    axes: {\n        x: {\n            label: 'Chromosome {{chr}} (Mb)',\n            label_offset: 38,\n            tick_format: 'region',\n            extent: 'state',\n        },\n        y1: {\n            label: 'Score',\n            label_offset: 40,\n            render: false,  // We are mainly concerned with the relative magnitudes: hide y axis to avoid clutter.\n        },\n    },\n    interaction: {\n        drag_background_to_pan: true,\n        drag_x_ticks_to_scale: true,\n        drag_y1_ticks_to_scale: true,\n        scroll_to_zoom: true,\n        x_linked: true,\n    },\n    data_layers: [\n        deepCopy(coaccessibility_layer),\n    ],\n};\n\n/**\n * A panel showing GWAS summary statistics, plus annotations for connecting it to the EBI GWAS catalog\n * @type panel\n */\nconst association_catalog_panel = function () {\n    let base = deepCopy(association_panel);\n    base = merge({\n        id: 'associationcatalog',\n    }, base);\n\n    base.toolbar.widgets.push({\n        type: 'display_options',\n        position: 'right',\n        color: 'blue',\n        // Below: special config specific to this widget\n        button_html: 'Display options...',\n        button_title: 'Control how plot items are displayed',\n\n        layer_name: 'associationpvaluescatalog',\n        default_config_display_name: 'No catalog labels (default)', // display name for the default plot color option (allow user to revert to plot defaults)\n\n        options: [\n            {\n                // First dropdown menu item\n                display_name: 'Label catalog traits',  // Human readable representation of field name\n                display: {  // Specify layout directives that control display of the plot for this option\n                    label: {\n                        text: '{{catalog:trait}}',\n                        spacing: 6,\n                        lines: {\n                            style: {\n                                'stroke-width': '2px',\n                                'stroke': '#333333',\n                                'stroke-dasharray': '2px 2px',\n                            },\n                        },\n                        filters: [\n                            // Only label points if they are significant for some trait in the catalog, AND in high LD\n                            //  with the top hit of interest\n                            { field: 'catalog:trait', operator: '!=', value: null },\n                            { field: 'catalog:log_pvalue', operator: '>', value: LZ_SIG_THRESHOLD_LOGP },\n                            { field: 'ld:correlation', operator: '>', value: 0.4 },\n                        ],\n                        style: {\n                            'font-size': '12px',\n                            'font-weight': 'bold',\n                            'fill': '#333333',\n                        },\n                    },\n                },\n            },\n        ],\n    });\n    base.data_layers = [\n        deepCopy(significance_layer),\n        deepCopy(recomb_rate_layer),\n        deepCopy(association_pvalues_catalog_layer),\n    ];\n    return base;\n}();\n\n/**\n * A panel showing genes in the specified region. This panel lets the user choose which genes are shown.\n * @type panel\n */\nconst genes_panel = {\n    id: 'genes',\n    tag: 'genes',\n    min_height: 150,\n    height: 225,\n    margin: { top: 20, right: 55, bottom: 20, left: 70 },\n    axes: {},\n    interaction: {\n        drag_background_to_pan: true,\n        scroll_to_zoom: true,\n        x_linked: true,\n    },\n    toolbar: (function () {\n        const base = deepCopy(standard_panel_toolbar);\n        base.widgets.push(\n            {\n                type: 'resize_to_data',\n                position: 'right',\n                button_html: 'Resize',\n            },\n            deepCopy(gene_selector_menu),\n        );\n        return base;\n    })(),\n    data_layers: [\n        deepCopy(genes_layer_filtered),\n    ],\n};\n\n/**\n * A panel that displays PheWAS scatter plots and automatically generates a color scheme\n * @type panel\n */\nconst phewas_panel = {\n    id: 'phewas',\n    tag: 'phewas',\n    min_height: 300,\n    height: 300,\n    margin: { top: 20, right: 55, bottom: 120, left: 70 },\n    inner_border: 'rgb(210, 210, 210)',\n    axes: {\n        x: {\n            ticks: {  // Object based config (shared defaults; allow layers to specify ticks)\n                style: {\n                    'font-weight': 'bold',\n                    'font-size': '11px',\n                    'text-anchor': 'start',\n                },\n                transform: 'rotate(50)',\n                position: 'left',  // Special param recognized by `category_scatter` layers\n            },\n        },\n        y1: {\n            label: '-log10 p-value',\n            label_offset: 50,\n        },\n    },\n    data_layers: [\n        deepCopy(significance_layer),\n        deepCopy(phewas_pvalues_layer),\n    ],\n};\n\n/**\n * A panel that shows a simple annotation track connecting GWAS results\n * @name annotation_catalog\n * @type panel\n */\nconst annotation_catalog_panel = {\n    id: 'annotationcatalog',\n    tag: 'gwascatalog',\n    min_height: 50,\n    height: 50,\n    margin: { top: 25, right: 55, bottom: 10, left: 70 },\n    inner_border: 'rgb(210, 210, 210)',\n    toolbar: deepCopy(standard_panel_toolbar),\n    axes: {\n        x: { extent: 'state', render: false },\n    },\n    interaction: {\n        drag_background_to_pan: true,\n        scroll_to_zoom: true,\n        x_linked: true,\n    },\n    data_layers: [\n        deepCopy(annotation_catalog_layer),\n    ],\n};\n\n/*\n * Plot Layouts\n */\n\n/**\n * Describes how to fetch and draw each part of the most common LocusZoom plot (with field names that reference the portaldev API)\n * @name standard_association\n * @type plot\n */\nconst standard_association_plot = {\n    state: {},\n    width: 800,\n    responsive_resize: true,\n    min_region_scale: 20000,\n    max_region_scale: 1000000,\n    toolbar: standard_association_toolbar,\n    panels: [\n        deepCopy(association_panel),\n        deepCopy(genes_panel),\n    ],\n};\n\n/**\n * A modified version of the standard LocusZoom plot, which adds a track that shows which SNPs in the plot also have claims in the EBI GWAS catalog.\n * @name association_catalog\n * @type plot\n */\nconst association_catalog_plot = {\n    state: {},\n    width: 800,\n    responsive_resize: true,\n    min_region_scale: 20000,\n    max_region_scale: 1000000,\n    toolbar: standard_association_toolbar,\n    panels: [\n        annotation_catalog_panel,\n        association_catalog_panel,\n        genes_panel,\n    ],\n};\n\n/**\n * A PheWAS scatter plot with an additional track showing nearby genes, to put the region in biological context.\n * @name standard_phewas\n * @type plot\n */\nconst standard_phewas_plot = {\n    width: 800,\n    responsive_resize: true,\n    toolbar: standard_plot_toolbar,\n    panels: [\n        deepCopy(phewas_panel),\n        merge({\n            height: 300,\n            margin: { bottom: 40 },\n            axes: {\n                x: {\n                    label: 'Chromosome {{chr}} (Mb)',\n                    label_offset: 38,\n                    tick_format: 'region',\n                    extent: 'state',\n                },\n            },\n        }, deepCopy(genes_panel)),\n    ],\n    mouse_guide: false,\n};\n\n/**\n * Show chromatin coaccessibility arcs, with additional features that connect these arcs to nearby genes to show regulatory interactions.\n * @name coaccessibility\n * @type plot\n */\nconst coaccessibility_plot = {\n    state: {},\n    width: 800,\n    responsive_resize: true,\n    min_region_scale: 20000,\n    max_region_scale: 1000000,\n    toolbar: deepCopy(standard_plot_toolbar),\n    panels: [\n        deepCopy(coaccessibility_panel),\n        function () {\n            // Take the default genes panel, and add a custom feature to highlight gene tracks based on short name\n            // This is a companion to the \"match\" directive in the coaccessibility panel\n            const base = Object.assign(\n                { height: 270 },\n                deepCopy(genes_panel),\n            );\n            const layer = base.data_layers[0];\n            layer.match = { send: 'gene_name', receive: 'gene_name' };\n            const color_config = [\n                {\n                    field: 'lz_is_match', // Special field name whose presence triggers custom rendering\n                    scale_function: 'if',\n                    parameters: {\n                        field_value: true,\n                        then: '#4285f4',\n                    },\n                },\n                {\n                    field: 'lz_is_match', // Special field name whose presence triggers custom rendering\n                    scale_function: 'if',\n                    parameters: {\n                        field_value: false,\n                        then: '#EAE6E6',\n                    },\n                },\n                '#363696',\n            ];\n            layer.color = color_config;\n            layer.stroke = color_config;\n            return base;\n        }(),\n    ],\n};\n\n\nexport const tooltip = {\n    standard_association: standard_association_tooltip,\n    standard_association_with_label: standard_association_tooltip_with_label,\n    standard_genes: standard_genes_tooltip,\n    catalog_variant: catalog_variant_tooltip,\n    coaccessibility: coaccessibility_tooltip,\n};\n\nexport const toolbar_widgets = {\n    ldlz2_pop_selector: ldlz2_pop_selector_menu,\n    gene_selector_menu,\n};\n\nexport const toolbar = {\n    standard_panel: standard_panel_toolbar,\n    standard_plot: standard_plot_toolbar,\n    standard_association: standard_association_toolbar,\n    region_nav_plot: region_nav_plot_toolbar,\n};\n\nexport const data_layer = {\n    significance: significance_layer,\n    recomb_rate: recomb_rate_layer,\n    association_pvalues: association_pvalues_layer,\n    coaccessibility: coaccessibility_layer,\n    association_pvalues_catalog: association_pvalues_catalog_layer,\n    phewas_pvalues: phewas_pvalues_layer,\n    genes: genes_layer,\n    genes_filtered: genes_layer_filtered,\n    annotation_catalog: annotation_catalog_layer,\n};\n\nexport const panel = {\n    association: association_panel,\n    coaccessibility: coaccessibility_panel,\n    association_catalog: association_catalog_panel,\n    genes: genes_panel,\n    phewas: phewas_panel,\n    annotation_catalog: annotation_catalog_panel,\n};\n\nexport const plot = {\n    standard_association: standard_association_plot,\n    association_catalog: association_catalog_plot,\n    standard_phewas: standard_phewas_plot,\n    coaccessibility: coaccessibility_plot,\n};\n","import {RegistryBase} from './base';\nimport {applyNamespaces, deepCopy, mutate_attrs, merge, query_attrs, renameField, findFields} from '../helpers/layouts';\nimport * as layouts from '../layouts';\n\n/**\n * Helper for working with predefined layouts\n *\n * This is part of the public interface with LocusZoom and a major way that users interact to configure plots.\n *\n * Each layout object that is added or retrieved here is a deep copy and totally independent from any other object\n * @public\n * @extends module:registry/base:RegistryBase\n * @inheritDoc\n */\nclass LayoutRegistry extends RegistryBase {\n    // Implemented as a \"registry of registries\"- one lookup each for panels, plots, etc...\n    get(type, name, overrides = {}) {\n        if (!(type && name)) {\n            throw new Error('Must specify both the type and name for the layout desired. See .list() for available options');\n        }\n        // This is a registry of registries. Fetching an item may apply additional custom behaviors, such as\n        //  applying overrides or applying namespaces.\n        let base = super.get(type).get(name);\n\n        // Most keys are merged directly. Namespaces are handled a little differently, as they act like global overrides.\n        //  (eg ask for plot layout, and modify multiple nested data layers where a particular namespace is referenced)\n        const custom_namespaces = overrides.namespace;\n        if (!base.namespace) {\n            // Iff namespaces are a top level key, we'll allow them to be merged directly with the base layout\n            // NOTE: The \"merge namespace\" behavior means that data layers can add new data easily, but this method\n            //   can't be used to remove namespaces when extending something. (you'll need to layout.namespaces = {} separately).\n            delete overrides.namespace;\n        }\n        let result = merge(overrides, base);\n\n        if (custom_namespaces) {\n            result = applyNamespaces(result, custom_namespaces);\n        }\n        return deepCopy(result);\n    }\n\n    /**\n     * Add a type of layout to the registry\n     * @param {String} type The type of layout to add (plot, panel, data_layer, toolbar, toolbar_widgets, or tooltip)\n     * @param {String} name The name of the layout object to add\n     * @param {Object} item The layout object describing parameters\n     * @param {boolean} override Whether to replace an existing item by that name\n     * @return {*}\n     */\n    add(type, name, item, override = false) {\n        if (!(type && name && item)) {\n            throw new Error('To add a layout, type, name, and item must all be specified');\n        }\n        if (!(typeof item === 'object')) {\n            throw new Error('The configuration to be added must be an object');\n        }\n\n        if (!this.has(type)) {\n            super.add(type, new RegistryBase());\n        }\n        // Ensure that each use of a layout can be modified, by returning a copy is independent\n        const copy = deepCopy(item);\n\n        // Special behavior for datalayers: all registry data layers will attempt to identify the fields requested\n        //   from external sources. This is purely a hint, because not every layout is generated through the registry.\n        if (type === 'data_layer' && copy.namespace) {\n            copy._auto_fields = [...findFields(copy, Object.keys(copy.namespace))].sort();\n        }\n\n        return super.get(type).add(name, copy, override);\n    }\n\n    /**\n     * List all available types of layout (eg toolbar, panel, etc). If a specific type name is provided, list the\n     *  layouts for that type of element (\"just predefined panels\").\n     * @param {String} [type] The type of layout (eg toolbar, panel, etc)\n     * @return {String[]|Object}\n     */\n    list(type) {\n        if (!type) {\n            let result = {};\n            for (let [type, contents] of this._items) {\n                result[type] = contents.list();\n            }\n            return result;\n        }\n        return super.get(type).list();\n    }\n\n    /**\n     * Static alias to a helper method. Preserved for backwards compatibility, so that UMD users can access this method.\n     * @static\n     * @private\n     */\n    merge(custom_layout, default_layout) {\n        return merge(custom_layout, default_layout);\n    }\n\n    /**\n     * Static alias to a helper method. Allows renaming fields\n     * @static\n     * @private\n     */\n    renameField() {\n        return renameField(...arguments);\n    }\n\n    /**\n     * Static alias to a helper method. Allows mutating nested layout attributes\n     * @static\n     * @private\n     */\n    mutate_attrs() {\n        return mutate_attrs(...arguments);\n    }\n\n    /**\n     * Static alias to a helper method. Allows mutating nested layout attributes\n     * @static\n     * @private\n     */\n    query_attrs() {\n        return query_attrs(...arguments);\n    }\n}\n\n/**\n * A plugin registry that allows plots to use both pre-defined and user-provided data adapters.\n * @alias module:LocusZoom~Layouts\n * @type {LayoutRegistry}\n */\nconst registry = new LayoutRegistry();\n\nfor (let [type, entries] of Object.entries(layouts)) {\n    for (let [name, config] of Object.entries(entries)) {\n        registry.add(type, name, config);\n    }\n}\n\n\nexport default registry;\n\n// Export base class for unit testing\nexport {LayoutRegistry as _LayoutRegistry};\n","/**\n * \"Data operation\" functions, with call signature ({plot_state, data_layer}, [recordsetA, recordsetB...], ...params) => combined_results\n *\n * After data is retrieved from adapters, Data Operations will be run on the resulting data. The most common operation\n *  is a \"join\", such as combining association + LD together into a single set of records for plotting. Several join\n *  functions (that operate by analogy to SQL) are provided built-in.\n *\n * Other use cases (even if no examples are in the built in code, see unit tests for what is possible):\n * 1. Grouping or filtering records; data operations can consider dynamic properties stored in plot.state.\n *   (in the future, adapters may cache more aggressively; if you want to provide your own code for filtering returned data,\n *    this is the recommended path to do so)\n * 2. Since the context argument also contains a reference to the data layer instance (and thus the parent panel and plot),\n *    a data operation can modify the layout when new data is received, without having to create a custom data layer class. Eg,\n *    for datasets where the categories are not known before first render, this could generate automatic x-axis ticks\n *    (PheWAS), automatic panel legends or color schemes (BED tracks), etc.\n *\n * Usually, a data operation receives two recordsets (the left and right members of the join, like \"assoc\" and \"ld\").\n * In practice, any number of recordsets can be passed to one join function. There are performance penalties to making too many network\n *   requests when rendering a web page, so in practice, joining too many distinct data entities in this fashion is\n *   uncommon. (if possible, try to provide your data with fewer adapters/network requests!)\n *\n * In a few cases, the rules of how to combine datasets are very specific to those two types of data. Some,\n *   particularly for advanced features, may carry assumptions about field names/ formatting.\n *   (example: choosing the best EBI GWAS catalog entry for a variant may look for a field called `log_pvalue` instead of `pvalue`,\n *   or it may match two datasets based on a specific way of identifying the variant)\n *\n * @module LocusZoom_DataFunctions\n */\nimport {joins} from '../data/undercomplicate';\n\nimport {RegistryBase} from './base';\n\n/**\n * A plugin registry that allows plots to use both pre-defined and user-provided \"data join\" functions.\n * @alias module:LocusZoom~DataFunctions\n * @type {module:registry/base~RegistryBase}\n */\nconst registry = new RegistryBase();\n\nfunction _wrap_join(handle) {\n    // Validate number of arguments and convert call signature from (context, deps, ...params) to (left, right, ...params).\n\n    // Many of our join functions are implemented with a different number of arguments than what a datafunction\n    //   actually receives. (eg, a join function is generic and doesn't care about \"context\" information like plot.state)\n    // This wrapper is simple shared code to handle required validation and conversion stuff.\n    return (context, deps, ...params) => {\n        if (deps.length !== 2) {\n            throw new Error('Join functions must receive exactly two recordsets');\n        }\n        return handle(...deps, ...params);\n    };\n}\n\n// Highly specialized join: connect assoc data to GWAS catalog data. This isn't a simple left join, because it tries to\n//  pick the most significant claim in the catalog for a variant, rather than joining every possible match.\n// This is specifically intended for sources that obey the ASSOC and CATALOG fields contracts.\nfunction assoc_to_gwas_catalog(assoc_data, catalog_data, assoc_key, catalog_key, catalog_logp_name) {\n    if (!assoc_data.length) {\n        return assoc_data;\n    }\n\n    // Prepare the genes catalog: group the data by variant, create simplified dataset with top hit for each\n    const catalog_by_variant = joins.groupBy(catalog_data, catalog_key);\n\n    const catalog_flat = [];  // Store only the top significant claim for each catalog variant entry\n    for (let claims of catalog_by_variant.values()) {\n        // Find max item within this set of claims, push that to catalog_\n        let best = 0;\n        let best_variant;\n        for (let item of claims) {\n            const val = item[catalog_logp_name];\n            if ( val >= best) {\n                best_variant = item;\n                best = val;\n            }\n        }\n        best_variant.n_catalog_matches = claims.length;\n        catalog_flat.push(best_variant);\n    }\n    return joins.left_match(assoc_data, catalog_flat, assoc_key, catalog_key);\n}\n\n// Highly specialized join: connect gnomAD constraint data to genes data. These are two very nonstandard payloads and need a special function to connect them.\nfunction genes_to_gnomad_constraint(genes_data, constraint_data) {\n    genes_data.forEach(function(gene) {\n        // Find payload keys that match gene names in this response\n        const alias = `_${gene.gene_name.replace(/[^A-Za-z0-9_]/g, '_')}`;  // aliases are modified gene names\n        const constraint = constraint_data[alias] && constraint_data[alias]['gnomad_constraint']; // gnomad API has two ways of specifying missing data for a requested gene\n        if (constraint) {\n            // Add all fields from constraint data- do not override fields present in the gene source\n            Object.keys(constraint).forEach(function (key) {\n                let val = constraint[key];\n                if (typeof gene[key] === 'undefined') {\n                    if (typeof val == 'number' && val.toString().includes('.')) {\n                        val = parseFloat(val.toFixed(2));\n                    }\n                    gene[key] = val;   // These two sources are both designed to bypass namespacing\n                }\n            });\n        }\n    });\n    return genes_data;\n}\n\n\n/**\n * Perform a left outer join, based on records where the field values at `left_key` and `right_key` are identical\n *\n * By analogy with SQL, the result will include all values in the left recordset, annotated (where applicable) with all keys from matching records in the right recordset\n *\n * @function\n * @name left_match\n * @param {Object} plot_state\n * @param {Array[]} recordsets\n * @param {String} left_key\n * @params {String} right_key\n */\nregistry.add('left_match', _wrap_join(joins.left_match));\n\n/**\n * Perform an inner join, based on records where the field values at `left_key` and `right_key` are identical\n *\n * By analogy with SQL, the result will include all fields from both recordsets, but only for records where both the left and right keys are defined, and equal. If a record is not in one or both recordsets, it will be excluded from the result.\n *\n * @function\n * @name inner_match\n * @param {Object} plot_state\n * @param {Array[]} recordsets\n * @param {String} left_key\n * @params {String} right_key\n */\nregistry.add('inner_match', _wrap_join(joins.inner_match));\n\n/**\n * Perform a full outer join, based on records where the field values at `left_key` and `right_key` are identical\n *\n * By analogy with SQL, the result will include all records from both the left and right recordsets. If there are matching records, then the relevant items will include fields from both records combined into one.\n *\n * @function\n * @name full_outer_match\n * @param {Object} plot_state\n * @param {Array[]} recordsets\n * @param {String} left_key\n * @params {String} right_key\n */\nregistry.add('full_outer_match', _wrap_join(joins.full_outer_match));\n\n/**\n * A single purpose join function that combines GWAS data with best claim from the EBI GWAS catalog. Essentially this is a left join modified to make further decisions about which records to use.\n *\n * @function\n * @name assoc_to_gwas_catalog\n * @param {Object} plot_state\n * @param {Array[]} recordsets An array with two items: assoc records, then catalog records\n * @param {String} assoc_key The name of the key field in association data, eg variant ID\n * @param {String} catalog_key The name of the key field in gwas catalog data, eg variant ID\n * @param {String} catalog_log_p_name The name of the \"log_pvalue\" field in gwas catalog data, used to choose the most significant claim for a given variant\n */\nregistry.add('assoc_to_gwas_catalog', _wrap_join(assoc_to_gwas_catalog));\n\n/**\n * A single purpose join function that combines gene data (UM Portaldev API format) with gene constraint data (gnomAD api format).\n *\n * This acts as a left join that has to perform custom operations to parse two very unusual recordset formats.\n *\n * @function\n * @name genes_to_gnomad_constraint\n * @param {Object} plot_state\n * @param {Array[]} recordsets An array with two items: UM Portaldev API gene records, then gnomAD gene constraint data\n */\nregistry.add('genes_to_gnomad_constraint', _wrap_join(genes_to_gnomad_constraint));\n\nexport default registry;\n","import {RegistryBase} from '../registry/base';\nimport { ADAPTERS } from '../registry';\n\n/**\n * Create and coordinate an ensemble of (namespaced) data adapter instances.\n * This is the mechanism by which users tell a plot how to retrieve data for a specific plot: adapters are created\n *  through this object rather than instantiating directly.\n *\n * @public\n * @alias module:LocusZoom~DataSources\n * @extends module:registry/base~RegistryBase\n * @inheritDoc\n */\nclass DataSources extends RegistryBase {\n    /**\n     * @param {RegistryBase} [registry] Primarily used for unit testing. When creating sources by name, specify where to\n     *  find the registry of known sources.\n     */\n    constructor(registry) {\n        super();\n        // This both acts as a registry (of the instantiated sources for this plot), and references a registry\n        //   (to locate adapter classes by name, when creating from config)\n        this._registry = registry || ADAPTERS;\n    }\n\n    /**\n     * For data sources, there is a special behavior of \"create item from config, then add\"\n     * @param {String} namespace Uniquely identify this datasource\n     * @param {BaseAdapter|Array} item An instantiated datasource, or an array of arguments that can be used to\n     *   create a known datasource type.\n     * @param [override=false] Whether to allow existing sources to be redefined\n     * @return {DataSources} Most registries return the created instance, but this registry returns a reference to\n     *  itself (to support chaining)\n     */\n    add(namespace, item, override = false) {\n        if (this._registry.has(namespace)) {\n            throw new Error(`The namespace ${namespace} is already in use by another source`);\n        }\n\n        if (namespace.match(/[^A-Za-z0-9_]/)) {\n            throw new Error(`Data source namespace names can only contain alphanumeric characters or underscores. Invalid name: ${namespace}`);\n        }\n        if (Array.isArray(item)) {\n            const [type, options] = item;\n            item = this._registry.create(type, options);\n        }\n        // Each datasource in the chain should be aware of its assigned namespace\n        item.source_id = namespace;\n\n        super.add(namespace, item, override);\n        return this;\n    }\n}\n\n\nexport default DataSources;\n","/**\n * Whether imported (ES6 modules) or loaded via script tag (UMD), this module represents\n *  the \"public interface\" via which core LocusZoom features and plugins are exposed for programmatic usage.\n *\n * A library using this file will need to load `locuszoom.css` separately in order for styles to appear.\n *\n * @module LocusZoom\n */\nimport version from './version';\n\nimport {default as DataSources} from './data';\nimport { populate } from './helpers/display';\n\nimport {\n    ADAPTERS as Adapters,\n    DATA_LAYERS as DataLayers,\n    DATA_OPS as DataFunctions,\n    LAYOUTS as Layouts,\n    MATCHERS as MatchFunctions,\n    SCALABLE as ScaleFunctions,\n    TRANSFORMS as TransformationFunctions,\n    WIDGETS as Widgets,\n} from './registry';\n\n\nconst LocusZoom = {\n    version,\n    // Helpers for creating plots- the main public interface for most use cases\n    populate,\n    DataSources,\n    // Registries for plugin system\n    Adapters,\n    DataLayers,\n    DataFunctions,\n    Layouts,\n    MatchFunctions,\n    ScaleFunctions,\n    TransformationFunctions,\n    Widgets,\n\n    get KnownDataSources() { // Backwards- compatibility alias\n        console.warn('Deprecation warning: KnownDataSources has been renamed to \"Adapters\"');\n        return Adapters;\n    },\n};\n\n\n/**\n * @callback pluginCallback\n * @param {Object} LocusZoom The global LocusZoom object\n * @param args Any additional arguments passed to LocusZoom.use will be passed to the function when the plugin is loaded\n */\n\n\nconst INSTALLED_PLUGINS = [];\n\n/**\n * @alias module:LocusZoom.use\n * @param {pluginCallback} plugin The plugin should be a module that exports the function as either the default export,\n *  or as a member named \"install\"\n * @param args Additional options to be passed when creating the plugin\n */\nLocusZoom.use = function(plugin, ...args) {\n    // Deliberately similar implementation to Vue.js .use() plugin system\n    if (INSTALLED_PLUGINS.includes(plugin)) {\n        // Avoid double-installation of a plugin\n        return;\n    }\n\n    args.unshift(LocusZoom); // All plugins are passed a reference to LocusZoom object\n    if (typeof plugin.install === 'function') {\n        plugin.install.apply(plugin, args);\n    } else if (typeof plugin === 'function') {\n        plugin.apply(null, args);\n    } else {\n        throw new Error('Plugin must export a function that receives the LocusZoom object as an argument');\n    }\n    INSTALLED_PLUGINS.push(plugin);\n};\n\n\nexport default LocusZoom;\n"],"sourceRoot":""}