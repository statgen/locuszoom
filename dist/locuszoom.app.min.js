/*! Locuszoom 0.14.0-beta.3 */
var LocusZoom;(()=>{var t={483:(t,e,s)=>{"use strict";const i=s(919);t.exports=function(t,...e){if(!t){if(1===e.length&&e[0]instanceof Error)throw e[0];throw new i(e)}}},919:(t,e,s)=>{"use strict";const i=s(820);t.exports=class extends Error{constructor(t){super(t.filter((t=>""!==t)).map((t=>"string"==typeof t?t:t instanceof Error?t.message:i(t))).join(" ")||"Unknown error"),"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e.assert)}}},820:t=>{"use strict";t.exports=function(...t){try{return JSON.stringify.apply(null,t)}catch(t){return"[Cannot display object: "+t.message+"]"}}},681:(t,e,s)=>{"use strict";const i=s(483),a={};e.B=class{constructor(){this._items=[],this.nodes=[]}add(t,e){const s=[].concat((e=e||{}).before||[]),a=[].concat(e.after||[]),n=e.group||"?",o=e.sort||0;i(!s.includes(n),`Item cannot come before itself: ${n}`),i(!s.includes("?"),"Item cannot come before unassociated items"),i(!a.includes(n),`Item cannot come after itself: ${n}`),i(!a.includes("?"),"Item cannot come after unassociated items"),Array.isArray(t)||(t=[t]);for(const e of t){const t={seq:this._items.length,sort:o,before:s,after:a,group:n,node:e};this._items.push(t)}if(!e.manual){const t=this._sort();i(t,"item","?"!==n?`added into group ${n}`:"","created a dependencies error")}return this.nodes}merge(t){Array.isArray(t)||(t=[t]);for(const e of t)if(e)for(const t of e._items)this._items.push(Object.assign({},t));this._items.sort(a.mergeSort);for(let t=0;t<this._items.length;++t)this._items[t].seq=t;const e=this._sort();return i(e,"merge created a dependencies error"),this.nodes}sort(){const t=this._sort();return i(t,"sort created a dependencies error"),this.nodes}_sort(){const t={},e=Object.create(null),s=Object.create(null);for(const i of this._items){const a=i.seq,n=i.group;s[n]=s[n]||[],s[n].push(a),t[a]=i.before;for(const t of i.after)e[t]=e[t]||[],e[t].push(a)}for(const e in t){const i=[];for(const a in t[e]){const n=t[e][a];s[n]=s[n]||[],i.push(...s[n])}t[e]=i}for(const i in e)if(s[i])for(const a of s[i])t[a].push(...e[i]);const i={};for(const e in t){const s=t[e];for(const t of s)i[t]=i[t]||[],i[t].push(e)}const a={},n=[];for(let t=0;t<this._items.length;++t){let e=t;if(i[t]){e=null;for(let t=0;t<this._items.length;++t){if(!0===a[t])continue;i[t]||(i[t]=[]);const s=i[t].length;let n=0;for(let e=0;e<s;++e)a[i[t][e]]&&++n;if(n===s){e=t;break}}}null!==e&&(a[e]=!0,n.push(e))}if(n.length!==this._items.length)return!1;const o={};for(const t of this._items)o[t.seq]=t;this._items=[],this.nodes=[];for(const t of n){const e=o[t];this.nodes.push(e.node),this._items.push(e)}return!0}},a.mergeSort=(t,e)=>t.sort===e.sort?0:t.sort<e.sort?-1:1},957:t=>{function e(t){if("string"==typeof t.source.flags)return t.source.flags;var e=[];return t.global&&e.push("g"),t.ignoreCase&&e.push("i"),t.multiline&&e.push("m"),t.sticky&&e.push("y"),t.unicode&&e.push("u"),e.join("")}t.exports=function t(s){if("function"==typeof s)return s;var i=Array.isArray(s)?[]:{};for(var a in s){var n=s[a],o={}.toString.call(n).slice(8,-1);i[a]="Array"==o||"Object"==o?t(n):"Date"==o?new Date(n.getTime()):"RegExp"==o?RegExp(n.source,e(n)):n}return i}}},e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={exports:{}};return t[i](a,a.exports,s),a.exports}s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i={};(()=>{"use strict";s.d(i,{default:()=>ds});var t={};s.r(t),s.d(t,{AssociationLZ:()=>M,BaseAdapter:()=>$,BaseApiAdapter:()=>z,BaseLZAdapter:()=>k,BaseUMAdapter:()=>E,GeneConstraintLZ:()=>A,GeneLZ:()=>N,GwasCatalogLZ:()=>S,LDServer:()=>O,PheWASLZ:()=>j,RecombLZ:()=>T,StaticSource:()=>L});var e={};s.r(e),s.d(e,{htmlescape:()=>F,is_numeric:()=>H,log10:()=>D,logtoscinotation:()=>U,neglog10:()=>B,scinotation:()=>q,urlencode:()=>G});var a={};s.r(a),s.d(a,{BaseWidget:()=>yt,_Button:()=>ft,display_options:()=>Ot,download:()=>vt,download_png:()=>wt,filter_field:()=>xt,menu:()=>St,move_panel_down:()=>kt,move_panel_up:()=>zt,region_scale:()=>bt,remove_panel:()=>$t,resize_to_data:()=>Nt,set_state:()=>Tt,shift_region:()=>Et,title:()=>mt,toggle_legend:()=>At,zoom_region:()=>Mt});var n={};s.r(n),s.d(n,{categorical_bin:()=>Vt,effect_direction:()=>Qt,if_value:()=>Zt,interpolate:()=>Xt,numerical_bin:()=>Kt,ordinal_cycle:()=>Wt,stable_choice:()=>Yt});var o={};s.r(o),s.d(o,{BaseDataLayer:()=>ie,annotation_track:()=>ne,arcs:()=>he,category_scatter:()=>me,genes:()=>de,highlight_regions:()=>re,line:()=>_e,orthogonal_line:()=>ge,scatter:()=>fe});var r={};s.r(r),s.d(r,{data_layer:()=>es,panel:()=>ss,plot:()=>is,toolbar:()=>ts,toolbar_widgets:()=>Qe,tooltip:()=>Xe});const l="0.14.0-beta.3";class h{constructor(){this._items=new Map}get(t){if(!this._items.has(t))throw new Error(`Item not found: ${t}`);return this._items.get(t)}add(t,e,s=!1){if(!s&&this._items.has(t))throw new Error(`Item ${t} is already defined`);return this._items.set(t,e),e}remove(t){return this._items.delete(t)}has(t){return this._items.has(t)}list(){return Array.from(this._items.keys())}}class c extends h{create(t,...e){return new(this.get(t))(...e)}extend(t,e,s){if(console.warn("Deprecation warning: .extend method will be removed in future versions, in favor of explicit ES6 subclasses"),3!==arguments.length)throw new Error("Invalid arguments to .extend");const i=this.get(t);class a extends i{}return Object.assign(a.prototype,s,i),this.add(e,a),a}}class d{constructor(t,e,s={},i=null,a=null){this.key=t,this.value=e,this.metadata=s,this.prev=i,this.next=a}}class u{constructor(t=3){if(this._max_size=t,this._cur_size=0,this._store=new Map,this._head=null,this._tail=null,null===t||t<0)throw new Error('Cache "max_size" must be >= 0')}has(t){return this._store.has(t)}get(t){const e=this._store.get(t);return e?(this._head!==e&&this.add(t,e.value),e.value):null}add(t,e,s={}){if(0===this._max_size)return;const i=this._store.get(t);i&&this._remove(i);const a=new d(t,e,s,null,this._head);if(this._head?this._head.prev=a:this._tail=a,this._head=a,this._store.set(t,a),this._max_size>=0&&this._cur_size>=this._max_size){const t=this._tail;this._tail=this._tail.prev,this._remove(t)}this._cur_size+=1}clear(){this._head=null,this._tail=null,this._cur_size=0,this._store=new Map}remove(t){const e=this._store.get(t);return!!e&&(this._remove(e),!0)}_remove(t){null!==t.prev?t.prev.next=t.next:this._head=t.next,null!==t.next?t.next.prev=t.prev:this._tail=t.prev,this._store.delete(t.key),this._cur_size-=1}find(t){let e=this._head;for(;e;){const s=e.next;if(t(e))return e;e=s}}}var _=s(957),p=s.n(_);function g(t){return"object"!=typeof t?t:p()(t)}var y=s(681);function f(t,e,s,i=!0){if(!s.length)return[];const a=s.map((t=>function(t){const e=/^(?<name_alone>\w+)$|((?<name_deps>\w+)+\(\s*(?<deps>[^)]+?)\s*\))/.exec(t);if(!e)throw new Error(`Unable to parse dependency specification: ${t}`);let{name_alone:s,name_deps:i,deps:a}=e.groups;return s?[s,[]]:(a=a.split(/\s*,\s*/),[i,a])}(t))),n=new Map(a),o=new y.B;for(let[t,e]of n.entries())try{o.add(t,{after:e,group:t})}catch(e){throw new Error(`Invalid or possible circular dependency specification for: ${t}`)}const r=o.nodes,l=new Map;for(let s of r){const i=e.get(s);if(!i)throw new Error(`Data has been requested from source '${s}', but no matching source was provided`);const a=n.get(s)||[],o=Promise.all(a.map((t=>l.get(t)))).then((e=>{const a=Object.assign({_provider_name:s},t);return i.getData(a,...e)}));l.set(s,o)}return Promise.all([...l.values()]).then((t=>i?t[t.length-1]:t))}function m(t,e){const s=new Map;for(let i of t){const t=i[e];if(void 0===t)throw new Error(`All records must specify a value for the field "${e}"`);if("object"==typeof t)throw new Error("Attempted to group on a field with non-primitive values");let a=s.get(t);a||(a=[],s.set(t,a)),a.push(i)}return s}function b(t,e,s,i,a){const n=m(s,a),o=[];for(let s of e){const e=s[i],a=n.get(e)||[];a.length?o.push(...a.map((t=>Object.assign({},g(t),g(s))))):"inner"!==t&&o.push(g(s))}if("outer"===t){const t=m(e,i);for(let e of s){const s=e[a];(t.get(s)||[]).length||o.push(g(e))}}return o}function x(t,e,s,i){return b("left",...arguments)}const v=/^(?:chr)?([a-zA-Z0-9]+?)[_:-](\d+)[_:|-]?(\w+)?[/_:|-]?([^_]+)?_?(.*)?/;function w(t,e=!1){const s=t&&t.match(v);if(s)return s.slice(1);if(e)return null;throw new Error(`Could not understand marker format for ${t}. Should be of format chr:pos or chr:pos_ref/alt`)}class ${constructor(){throw new Error('The "BaseAdapter" and "BaseApiAdapter" classes have been replaced in LocusZoom 0.14. See migration guide for details.')}}class z extends ${}class k extends class extends class{constructor(t={}){this._config=t;const{cache_enabled:e=!0,cache_size:s=3}=t;this._enable_cache=e,this._cache=new u(s)}_buildRequestOptions(t,e){return Object.assign({},t)}_getCacheKey(t){if(this._enable_cache)throw new Error("Method not implemented");return null}_performRequest(t){throw new Error("Not implemented")}_normalizeResponse(t,e){return t}_annotateRecords(t,e){return t}_postProcessResponse(t,e){return t}getData(t={},...e){t=this._buildRequestOptions(t,...e);const s=this._getCacheKey(t);let i;return this._enable_cache&&this._cache.has(s)?i=this._cache.get(s):(i=Promise.resolve(this._performRequest(t)).then((e=>this._normalizeResponse(e,t))),this._cache.add(s,i,t._cache_meta),i.catch((t=>this._cache.remove(s)))),i.then((t=>g(t))).then((e=>this._annotateRecords(e,t))).then((e=>this._postProcessResponse(e,t)))}}{constructor(t={}){super(t),this._url=t.url}_getCacheKey(t){return this._getURL(t)}_getURL(t){return this._url}_performRequest(t){const e=this._getURL(t);if(!this._url)throw new Error('Web based resources must specify a resource URL as option "url"');return fetch(e).then((t=>{if(!t.ok)throw new Error(t.statusText);return t.text()}))}_normalizeResponse(t,e){return"string"==typeof t?JSON.parse(t):t}}{constructor(t={}){t.params&&(console.warn('Deprecation warning: all options in "config.params" should now be specified as top level keys.'),Object.assign(t,t.params||{}),delete t.params),super(t);const{prefix_namespace:e=!0,limit_fields:s}=t;this._prefix_namespace=e,this._limit_fields=!!s&&new Set(s)}_getCacheKey(t){let{chr:e,start:s,end:i}=t;const a=this._cache.find((({metadata:t})=>e===t.chr&&s>=t.start&&i<=t.end));return a&&({chr:e,start:s,end:i}=a.metadata),t._cache_meta={chr:e,start:s,end:i},`${e}_${s}_${i}`}_postProcessResponse(t,e){if(!this._prefix_namespace||!Array.isArray(t))return t;const{_limit_fields:s}=this,{_provider_name:i}=e;return t.map((t=>Object.entries(t).reduce(((t,[e,a])=>(s&&!s.has(e)||(t[`${i}:${e}`]=a),t)),{})))}_findPrefixedKey(t,e){const s=new RegExp(`:${e}$`),i=Object.keys(t).find((t=>s.test(t)));if(!i)throw new Error(`Could not locate the required key name: ${e} in dependent data`);return i}}class E extends k{constructor(t={}){super(t),this._genome_build=t.genome_build||t.build}_validateBuildSource(t,e){if(t&&e||!t&&!e)throw new Error(`${this.constructor.name} must provide a parameter specifying either "build" or "source". It should not specify both.`);if(t&&!["GRCh37","GRCh38"].includes(t))throw new Error(`${this.constructor.name} must specify a valid 'genome_build'`)}_normalizeResponse(t,e){let s=super._normalizeResponse(...arguments);if(s=s.data||s,Array.isArray(s))return s;const i=Object.keys(s),a=s[i[0]].length;if(!i.every((function(t){return s[t].length===a})))throw new Error(`${this.constructor.name} expects a response in which all arrays of data are the same length`);const n=[],o=Object.keys(s);for(let t=0;t<a;t++){const e={};for(let i=0;i<o.length;i++)e[o[i]]=s[o[i]][t];n.push(e)}return n}}class M extends E{constructor(t={}){super(t);const{source:e}=t;this._source_id=e}_getURL(t){const{chr:e,start:s,end:i}=t;return`${super._getURL(t)}results/?filter=analysis in ${this._source_id} and chromosome in  '${e}' and position ge ${s} and position le ${i}`}}class S extends E{constructor(t){t.limit_fields||(t.limit_fields=["log_pvalue","pos","rsid","trait","variant"]),super(t)}_getURL(t){const e=t.genome_build||this._config.build,s=this._config.source;this._validateBuildSource(e,s);const i=e?`&build=${e}`:` and id eq ${s}`;return`${super._getURL(t)}?format=objects&sort=pos&filter=chrom eq '${t.chr}' and pos ge ${t.start} and pos le ${t.end}${i}`}}class N extends E{constructor(t={}){super(t),this._prefix_namespace=!1}_getURL(t){const e=t.genome_build||this._config.build;let s=this._config.source;this._validateBuildSource(e,s);const i=e?`&build=${e}`:` and source in ${s}`;return`${super._getURL(t)}?filter=chrom eq '${t.chr}' and start le ${t.end} and end ge ${t.start}${i}`}}class A extends k{constructor(t={}){super(t),this._prefix_namespace=!1}_buildRequestOptions(t,e){const s=t.genome_build||this._config.build;if(!s)throw new Error(`Adapter ${this.constructor.name} must specify a 'genome_build' option`);const i=new Set;for(let t of e)i.add(t.gene_name);return t.query=[...i.values()].map((function(t){return`${`_${t.replace(/[^A-Za-z0-9_]/g,"_")}`}: gene(gene_symbol: "${t}", reference_genome: ${s}) { gnomad_constraint { exp_syn obs_syn syn_z oe_syn oe_syn_lower oe_syn_upper exp_mis obs_mis mis_z oe_mis oe_mis_lower oe_mis_upper exp_lof obs_lof pLI oe_lof oe_lof_lower oe_lof_upper } } `})),t.build=s,Object.assign({},t)}_performRequest(t){let{query:e,build:s}=t;if(!e.length||e.length>25||"GRCh38"===s)return Promise.resolve([]);e=`{${e.join(" ")} }`;const i=this._getURL(t),a=JSON.stringify({query:e});return fetch(i,{method:"POST",body:a,headers:{"Content-Type":"application/json"}}).then((t=>t.ok?t.text():[])).catch((t=>[]))}_normalizeResponse(t){if("string"!=typeof t)return t;return JSON.parse(t).data}}class O extends E{constructor(t){t.limit_fields||(t.limit_fields=["variant2","position2","correlation"]),super(t)}__find_ld_refvar(t,e){const s=this._findPrefixedKey(e[0],"variant"),i=this._findPrefixedKey(e[0],"log_pvalue");let a,n={};if(t.ldrefvar)a=t.ldrefvar,n=e.find((t=>t[s]===a))||{};else{let t=0;for(let o of e){const{[s]:e,[i]:r}=o;r>t&&(t=r,a=e,n=o)}}n.lz_is_ld_refvar=!0;const o=w(a,!0);if(!o)throw new Error("Could not request LD for a missing or incomplete marker format");const[r,l,h,c]=o;a=`${r}:${l}`,h&&c&&(a+=`_${h}/${c}`);const d=+l;return d&&t.ldrefvar&&t.chr&&(r!==String(t.chr)||d<t.start||d>t.end)?(t.ldrefvar=null,this.__find_ld_refvar(t,e)):a}_buildRequestOptions(t,e){if(!e)throw new Error("LD request must depend on association data");const s=super._buildRequestOptions(...arguments);if(!e.length)return s._skip_request=!0,s;s.ld_refvar=this.__find_ld_refvar(t,e);const i=t.genome_build||this._config.build||"GRCh37";let a=t.ld_source||this._config.source||"1000G";const n=t.ld_pop||this._config.population||"ALL";return"1000G"===a&&"GRCh38"===i&&(a="1000G-FRZ09"),this._validateBuildSource(i,null),Object.assign({},s,{genome_build:i,ld_source:a,ld_population:n})}_getURL(t){const e=this._config.method||"rsquare",{chr:s,start:i,end:a,ld_refvar:n,genome_build:o,ld_source:r,ld_population:l}=t;return[super._getURL(t),"genome_builds/",o,"/references/",r,"/populations/",l,"/variants","?correlation=",e,"&variant=",encodeURIComponent(n),"&chrom=",encodeURIComponent(s),"&start=",encodeURIComponent(i),"&stop=",encodeURIComponent(a)].join("")}_getCacheKey(t){const e=super._getCacheKey(t),{ld_refvar:s,ld_source:i,ld_population:a}=t;return`${e}_${s}_${i}_${a}`}_performRequest(t){if(t._skip_request)return Promise.resolve([]);const e=this._getURL(t);let s={data:{}},i=function(t){return fetch(t).then().then((t=>{if(!t.ok)throw new Error(t.statusText);return t.text()})).then((function(t){return t=JSON.parse(t),Object.keys(t.data).forEach((function(e){s.data[e]=(s.data[e]||[]).concat(t.data[e])})),t.next?i(t.next):s}))};return i(e)}}class T extends E{constructor(t){t.limit_fields||(t.limit_fields=["position","recomb_rate"]),super(t)}_getURL(t){const e=t.genome_build||this._config.build;let s=this._config.source;this._validateBuildSource(e,s);const i=e?`&build=${e}`:` and id in ${s}`;return`${super._getURL(t)}?filter=chromosome eq '${t.chr}' and position le ${t.end} and position ge ${t.start}${i}`}}class L extends k{constructor(t={}){super(...arguments);const{data:e}=t;if(!e||Array.isArray(t))throw new Error("'StaticSource' must provide data as required option 'config.data'");this._data=e}_performRequest(t){return Promise.resolve(this._data)}}class j extends E{_getURL(t){const e=(t.genome_build?[t.genome_build]:null)||this._config.build;if(!e||!Array.isArray(e)||!e.length)throw new Error(["Adapter",this.constructor.name,"requires that you specify array of one or more desired genome build names"].join(" "));return[super._getURL(t),"?filter=variant eq '",encodeURIComponent(t.variant),"'&format=objects&",e.map((function(t){return`build=${encodeURIComponent(t)}`})).join("&")].join("")}_getCacheKey(t){return this._getURL(t)}}const P=new c;for(let[e,s]of Object.entries(t))P.add(e,s);P.add("StaticJSON",L),P.add("LDLZ2",O);const R=P,I=d3,C={verbs:["highlight","select","fade","hide"],adjectives:["highlighted","selected","faded","hidden"]};function D(t){return isNaN(t)||t<=0?null:Math.log(t)/Math.LN10}function B(t){return isNaN(t)||t<=0?null:-Math.log(t)/Math.LN10}function U(t){if(isNaN(t))return"NaN";if(0===t)return"1";const e=Math.ceil(t),s=e-t,i=Math.pow(10,s);return 1===e?(i/10).toFixed(4):2===e?(i/100).toFixed(3):`${i.toFixed(2)} × 10^-${e}`}function q(t){if(isNaN(t))return"NaN";if(0===t)return"0";const e=Math.abs(t);let s;return s=e>1?Math.ceil(Math.log(e)/Math.LN10):Math.floor(Math.log(e)/Math.LN10),Math.abs(s)<=3?t.toFixed(3):t.toExponential(2).replace("+","").replace("e"," × 10^")}function F(t){return t?(t=`${t}`).replace(/['"<>&`]/g,(function(t){switch(t){case"'":return"&#039;";case'"':return"&quot;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"`":return"&#x60;"}})):""}function H(t){return"number"==typeof t}function G(t){return encodeURIComponent(t)}const J=new class extends h{_collectTransforms(t){const e=t.match(/\|([^|]+)/g).map((t=>super.get(t.substring(1))));return t=>e.reduce(((t,e)=>e(t)),t)}get(t){return t?"|"===t.substring(0,1)?this._collectTransforms(t):super.get(t):null}};for(let[t,s]of Object.entries(e))J.add(t,s);const Z=J;class K{constructor(t){if(!/^(?:\w+:\w+|^\w+)(?:\|\w+)*$/.test(t))throw new Error(`Invalid field specifier: '${t}'`);const[e,...s]=t.split("|");this.full_name=t,this.field_name=e,this.transformations=s.map((t=>Z.get(t)))}_applyTransformations(t){return this.transformations.forEach((function(e){t=e(t)})),t}resolve(t,e){if(void 0===t[this.full_name]){let s=null;void 0!==t[this.field_name]?s=t[this.field_name]:e&&void 0!==e[this.field_name]&&(s=e[this.field_name]),t[this.full_name]=this._applyTransformations(s)}return t[this.full_name]}}const V=/^(\*|[\w]+)/,W=/^\[\?\(@((?:\.[\w]+)+) *===? *([0-9.eE-]+|"[^"]*"|'[^']*')\)\]/;function Y(t){if(".."===t.substr(0,2)){if("["===t[2])return{text:"..",attr:"*",depth:".."};const e=V.exec(t.substr(2));if(!e)throw`Cannot parse ${JSON.stringify(t)} as dotdot_attr.`;return{text:`..${e[0]}`,attr:e[1],depth:".."}}if("."===t[0]){const e=V.exec(t.substr(1));if(!e)throw`Cannot parse ${JSON.stringify(t)} as dot_attr.`;return{text:`.${e[0]}`,attr:e[1],depth:"."}}if("["===t[0]){const e=W.exec(t);if(!e)throw`Cannot parse ${JSON.stringify(t)} as expr.`;let s;try{s=JSON.parse(e[2])}catch(t){s=JSON.parse(e[2].replace(/^'|'$/g,'"'))}return{text:e[0],attrs:e[1].substr(1).split("."),value:s}}throw`The query ${JSON.stringify(t)} doesn't look valid.`}function X(t,e){let s;for(let i of e)s=t,t=t[i];return[s,e[e.length-1],t]}function Q(t,e){if(!e.length)return[[]];const s=e[0],i=e.slice(1);let a=[];if(s.attr&&"."===s.depth&&"*"!==s.attr){const n=t[s.attr];1===e.length?void 0!==n&&a.push([s.attr]):a.push(...Q(n,i).map((t=>[s.attr].concat(t))))}else if(s.attr&&"."===s.depth&&"*"===s.attr)for(let[e,s]of Object.entries(t))a.push(...Q(s,i).map((t=>[e].concat(t))));else if(s.attr&&".."===s.depth){if("object"==typeof t&&null!==t){"*"!==s.attr&&s.attr in t&&a.push(...Q(t[s.attr],i).map((t=>[s.attr].concat(t))));for(let[n,o]of Object.entries(t))a.push(...Q(o,e).map((t=>[n].concat(t)))),"*"===s.attr&&a.push(...Q(o,i).map((t=>[n].concat(t))))}}else if(s.attrs)for(let[e,n]of Object.entries(t)){const[t,o,r]=X(n,s.attrs);r===s.value&&a.push(...Q(n,i).map((t=>[e].concat(t))))}const n=(o=a,r=JSON.stringify,[...new Map(o.map((t=>[r(t),t]))).values()]);var o,r;return n.sort(((t,e)=>e.length-t.length||JSON.stringify(t).localeCompare(JSON.stringify(e)))),n}function tt(t,e){const s=function(t,e){let s=[];for(let i of Q(t,e))s.push(X(t,i));return s}(t,function(t){t=function(t){return t?(["$","["].includes(t[0])||(t=`$.${t}`),"$"===t[0]&&(t=t.substr(1)),t):""}(t);let e=[];for(;t.length;){const s=Y(t);t=t.substr(s.text.length),e.push(s)}return e}(e));return s.length||console.warn(`No items matched the specified query: '${e}'`),s}const et=Math.sqrt(3),st={draw(t,e){const s=-Math.sqrt(e/(3*et));t.moveTo(0,2*-s),t.lineTo(-et*s,s),t.lineTo(et*s,s),t.closePath()}};function it(t,e){if(e=e||{},!t||"object"!=typeof t||"object"!=typeof e)throw new Error("Layout and shared namespaces must be provided as objects");for(let[s,i]of Object.entries(t))"namespace"===s?Object.keys(i).forEach((t=>{const s=e[t];s&&(i[t]=s)})):null!==i&&"object"==typeof i&&(t[s]=it(i,e));return t}function at(t,e){if("object"!=typeof t||"object"!=typeof e)throw new Error(`LocusZoom.Layouts.merge only accepts two layout objects; ${typeof t}, ${typeof e} given`);for(let s in e){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=null===t[s]?"undefined":typeof t[s],a=typeof e[s];if("object"===i&&Array.isArray(t[s])&&(i="array"),"object"===a&&Array.isArray(e[s])&&(a="array"),"function"===i||"function"===a)throw new Error("LocusZoom.Layouts.merge encountered an unsupported property type");"undefined"!==i?"object"!==i||"object"!==a||(t[s]=at(t[s],e[s])):t[s]=nt(e[s])}return t}function nt(t){return JSON.parse(JSON.stringify(t))}function ot(t){if(!t)return null;if("triangledown"===t)return st;const e=`symbol${t.charAt(0).toUpperCase()+t.slice(1)}`;return I[e]||null}function rt(t,e,s=null){const i=new Set;if(!s){if(!e.length)return i;const t=e.join("|");s=new RegExp(`(?:{{)?(?:#if *)?((?:${t}):\\w+)`,"g")}for(const a of Object.values(t)){const t=typeof a;let n=[];if("string"===t){let t;for(;null!==(t=s.exec(a));)n.push(t[1])}else{if(null===a||"object"!==t)continue;n=rt(a,e,s)}for(let t of n)i.add(t)}return i}function lt(t,e,s,i=!0){const a=typeof t;if(Array.isArray(t))return t.map((t=>lt(t,e,s,i)));if("object"===a&&null!==t)return Object.keys(t).reduce(((a,n)=>(a[n]=lt(t[n],e,s,i),a)),{});if("string"!==a)return t;{const a=e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&");if(i){const e=new RegExp(`${a}\\|\\w+`,"g");(t.match(e)||[]).forEach((t=>console.warn(`renameFields is renaming a field that uses transform functions: was '${t}' . Verify that these transforms are still appropriate.`)))}const n=new RegExp(`${a}(?!\\w+)`,"g");return t.replace(n,s)}}function ht(t,e,s){return function(t,e,s){return tt(t,e).map((([t,e,i])=>{const a="function"==typeof s?s(i):s;return t[e]=a,a}))}(t,e,s)}function ct(t,e){return function(t,e){return tt(t,e).map((t=>t[2]))}(t,e)}class dt{constructor(t,e,s){this._callable=ls.get(t),this._initiator=e,this._params=s||[]}getData(t,...e){const s={plot_state:t,data_layer:this._initiator};return Promise.resolve(this._callable(s,e,...this._params))}}const ut=class{constructor(t){this._sources=t}config_to_sources(t={},e=[],s){const i=new Map,a=Object.keys(t);let n=e.find((t=>"fetch"===t.type));n||(n={type:"fetch",from:a},e.unshift(n));const o=/^\w+$/;for(let[e,s]of Object.entries(t)){if(!o.test(e))throw new Error(`Invalid namespace name: '${e}'. Must contain only alphanumeric characters`);const t=this._sources.get(s);if(!t)throw new Error(`A data layer has requested an item not found in DataSources: data type '${e}' from ${s}`);i.set(e,t),n.from.find((t=>t.split("(")[0]===e))||n.from.push(e)}let r=Array.from(n.from);for(let t of e){let{type:e,name:a,requires:n,params:o}=t;if("fetch"!==e){let l=0;if(a||(a=t.name=`join${l}`,l+=1),i.has(a))throw new Error(`Configuration error: within a layer, join name '${a}' must be unique`);n.forEach((t=>{if(!i.has(t))throw new Error(`Data operation cannot operate on unknown provider '${t}'`)}));const h=new dt(e,s,o);i.set(a,h),r.push(`${a}(${n.join(", ")})`)}}return[i,r]}getData(t,e,s){return s.length?f(t,e,s,!0):Promise.resolve([])}};function _t(){return{showing:!1,selector:null,content_selector:null,hide_delay:null,show:(t,e)=>(this.curtain.showing||(this.curtain.selector=I.select(this.parent_plot.svg.node().parentNode).insert("div").attr("class","lz-curtain").attr("id",`${this.id}.curtain`),this.curtain.content_selector=this.curtain.selector.append("div").attr("class","lz-curtain-content"),this.curtain.selector.append("div").attr("class","lz-curtain-dismiss").html("Dismiss").on("click",(()=>this.curtain.hide())),this.curtain.showing=!0),this.curtain.update(t,e)),update:(t,e)=>{if(!this.curtain.showing)return this.curtain;clearTimeout(this.curtain.hide_delay),"object"==typeof e&&gt(this.curtain.selector,e);const s=this._getPageOrigin(),i=this.layout.height||this._total_height;return this.curtain.selector.style("top",`${s.y}px`).style("left",`${s.x}px`).style("width",`${this.parent_plot.layout.width}px`).style("height",`${i}px`),this.curtain.content_selector.style("max-width",this.parent_plot.layout.width-40+"px").style("max-height",i-40+"px"),"string"==typeof t&&this.curtain.content_selector.html(t),this.curtain},hide:t=>this.curtain.showing?"number"==typeof t?(clearTimeout(this.curtain.hide_delay),this.curtain.hide_delay=setTimeout(this.curtain.hide,t),this.curtain):(this.curtain.selector.remove(),this.curtain.selector=null,this.curtain.content_selector=null,this.curtain.showing=!1,this.curtain):this.curtain}}function pt(){return{showing:!1,selector:null,content_selector:null,progress_selector:null,cancel_selector:null,show:t=>(this.loader.showing||(this.loader.selector=I.select(this.parent_plot.svg.node().parentNode).insert("div").attr("class","lz-loader").attr("id",`${this.id}.loader`),this.loader.content_selector=this.loader.selector.append("div").attr("class","lz-loader-content"),this.loader.progress_selector=this.loader.selector.append("div").attr("class","lz-loader-progress-container").append("div").attr("class","lz-loader-progress"),this.loader.showing=!0,void 0===t&&(t="Loading...")),this.loader.update(t)),update:(t,e)=>{if(!this.loader.showing)return this.loader;clearTimeout(this.loader.hide_delay),"string"==typeof t&&this.loader.content_selector.html(t);const s=this._getPageOrigin(),i=this.loader.selector.node().getBoundingClientRect();return this.loader.selector.style("top",s.y+this.layout.height-i.height-6+"px").style("left",`${s.x+6}px`),"number"==typeof e&&this.loader.progress_selector.style("width",`${Math.min(Math.max(e,1),100)}%`),this.loader},animate:()=>(this.loader.progress_selector.classed("lz-loader-progress-animated",!0),this.loader),setPercentCompleted:t=>(this.loader.progress_selector.classed("lz-loader-progress-animated",!1),this.loader.update(null,t)),hide:t=>this.loader.showing?"number"==typeof t?(clearTimeout(this.loader.hide_delay),this.loader.hide_delay=setTimeout(this.loader.hide,t),this.loader):(this.loader.selector.remove(),this.loader.selector=null,this.loader.content_selector=null,this.loader.progress_selector=null,this.loader.cancel_selector=null,this.loader.showing=!1,this.loader):this.loader}}function gt(t,e){e=e||{};for(let[s,i]of Object.entries(e))t.style(s,i)}class yt{constructor(t,e){this.layout=t||{},this.layout.color||(this.layout.color="gray"),this.parent=e||null,this.parent_panel=null,this.parent_plot=null,this.parent_svg=null,this.parent&&("panel"===this.parent.type?(this.parent_panel=this.parent.parent,this.parent_plot=this.parent.parent.parent,this.parent_svg=this.parent_panel):(this.parent_plot=this.parent.parent,this.parent_svg=this.parent_plot)),this.selector=null,this.button=null,this.persist=!1,this.layout.position||(this.layout.position="left")}show(){if(this.parent&&this.parent.selector){if(!this.selector){const t=["start","middle","end"].includes(this.layout.group_position)?` lz-toolbar-group-${this.layout.group_position}`:"";this.selector=this.parent.selector.append("div").attr("class",`lz-toolbar-${this.layout.position}${t}`),this.layout.style&&gt(this.selector,this.layout.style),"function"==typeof this.initialize&&this.initialize()}return this.button&&"highlighted"===this.button.status&&this.button.menu.show(),this.selector.style("visibility","visible"),this.update(),this.position()}}update(){}position(){return this.button&&this.button.menu.position(),this}shouldPersist(){return!!this.persist||!(!this.button||!this.button.persist)}hide(){return!this.selector||this.shouldPersist()||(this.button&&this.button.menu.hide(),this.selector.style("visibility","hidden")),this}destroy(t){return void 0===t&&(t=!1),this.selector?(this.shouldPersist()&&!t||(this.button&&this.button.menu&&this.button.menu.destroy(),this.selector.remove(),this.selector=null,this.button=null),this):this}}class ft{constructor(t){if(!(t instanceof yt))throw new Error("Unable to create toolbar widget button, invalid parent");this.parent=t,this.parent_panel=this.parent.parent_panel,this.parent_plot=this.parent.parent_plot,this.parent_svg=this.parent.parent_svg,this.parent_toolbar=this.parent.parent,this.selector=null,this.tag="a",this.html="",this.title="",this.color="gray",this.style={},this.persist=!1,this.permanent=!1,this.status="",this.menu={outer_selector:null,inner_selector:null,scroll_position:0,hidden:!0,show:()=>(this.menu.outer_selector||(this.menu.outer_selector=I.select(this.parent_plot.svg.node().parentNode).append("div").attr("class",`lz-toolbar-menu lz-toolbar-menu-${this.color}`).attr("id",`${this.parent_svg.getBaseId()}.toolbar.menu`),this.menu.inner_selector=this.menu.outer_selector.append("div").attr("class","lz-toolbar-menu-content"),this.menu.inner_selector.on("scroll",(()=>{this.menu.scroll_position=this.menu.inner_selector.node().scrollTop}))),this.menu.outer_selector.style("visibility","visible"),this.menu.hidden=!1,this.menu.update()),update:()=>this.menu.outer_selector?(this.menu.populate(),this.menu.inner_selector&&(this.menu.inner_selector.node().scrollTop=this.menu.scroll_position),this.menu.position()):this.menu,position:()=>{if(!this.menu.outer_selector)return this.menu;this.menu.outer_selector.style("height",null);const t=this.parent_svg._getPageOrigin(),e=document.documentElement.scrollTop||document.body.scrollTop,s=this.parent_plot.getContainerOffset(),i=this.parent_toolbar.selector.node().getBoundingClientRect(),a=this.selector.node().getBoundingClientRect(),n=this.menu.outer_selector.node().getBoundingClientRect(),o=this.menu.inner_selector.node().scrollHeight;let r,l;"panel"===this.parent_toolbar.type?(r=t.y+i.height+6,l=Math.max(t.x+this.parent_plot.layout.width-n.width-3,t.x+3)):(r=a.bottom+e+3-s.top,l=Math.max(a.left+a.width-n.width-s.left,t.x+3));const h=Math.max(this.parent_plot.layout.width-6-20,20),c=h,d=h-12,u=Math.max(this.parent_svg.layout.height-30-14,14),_=Math.min(o+14,u);return this.menu.outer_selector.style("top",`${r}px`).style("left",`${l}px`).style("max-width",`${c}px`).style("max-height",`${u}px`).style("height",`${_}px`),this.menu.inner_selector.style("max-width",`${d}px`),this.menu.inner_selector.node().scrollTop=this.menu.scroll_position,this.menu},hide:()=>this.menu.outer_selector?(this.menu.outer_selector.style("visibility","hidden"),this.menu.hidden=!0,this.menu):this.menu,destroy:()=>this.menu.outer_selector?(this.menu.inner_selector.remove(),this.menu.outer_selector.remove(),this.menu.inner_selector=null,this.menu.outer_selector=null,this.menu):this.menu,populate:()=>{throw new Error("Method must be implemented")},setPopulate:t=>("function"==typeof t?(this.menu.populate=t,this.setOnclick((()=>{this.menu.hidden?(this.menu.show(),this.highlight().update(),this.persist=!0):(this.menu.hide(),this.highlight(!1).update(),this.permanent||(this.persist=!1))}))):this.setOnclick(),this)}}setColor(t){return void 0!==t&&(["gray","red","orange","yellow","green","blue","purple"].includes(t)?this.color=t:this.color="gray"),this}setPermanent(t){return t=void 0===t||Boolean(t),this.permanent=t,this.permanent&&(this.persist=!0),this}shouldPersist(){return this.permanent||this.persist}setStyle(t){return void 0!==t&&(this.style=t),this}getClass(){const t=["start","middle","end"].includes(this.parent.layout.group_position)?` lz-toolbar-button-group-${this.parent.layout.group_position}`:"";return`lz-toolbar-button lz-toolbar-button-${this.color}${this.status?`-${this.status}`:""}${t}`}setStatus(t){return void 0!==t&&["","highlighted","disabled"].includes(t)&&(this.status=t),this.update()}highlight(t){return(t=void 0===t||Boolean(t))?this.setStatus("highlighted"):"highlighted"===this.status?this.setStatus(""):this}disable(t){return(t=void 0===t||Boolean(t))?this.setStatus("disabled"):"disabled"===this.status?this.setStatus(""):this}onmouseover(){}setOnMouseover(t){return this.onmouseover="function"==typeof t?t:function(){},this}onmouseout(){}setOnMouseout(t){return this.onmouseout="function"==typeof t?t:function(){},this}onclick(){}setOnclick(t){return this.onclick="function"==typeof t?t:function(){},this}setTitle(t){return void 0!==t&&(this.title=t.toString()),this}setHtml(t){return void 0!==t&&(this.html=t.toString()),this}show(){if(this.parent)return this.selector||(this.selector=this.parent.selector.append(this.tag).attr("class",this.getClass())),this.update()}preUpdate(){return this}update(){return this.selector?(this.preUpdate(),this.selector.attr("class",this.getClass()).attr("title",this.title).on("mouseover","disabled"===this.status?null:this.onmouseover).on("mouseout","disabled"===this.status?null:this.onmouseout).on("click","disabled"===this.status?null:this.onclick).html(this.html).call(gt,this.style),this.menu.update(),this.postUpdate(),this):this}postUpdate(){return this}hide(){return this.selector&&!this.shouldPersist()&&(this.selector.remove(),this.selector=null),this}}class mt extends yt{show(){return this.div_selector||(this.div_selector=this.parent.selector.append("div").attr("class",`lz-toolbar-title lz-toolbar-${this.layout.position}`),this.title_selector=this.div_selector.append("h3")),this.update()}update(){let t=this.layout.title.toString();return this.layout.subtitle&&(t+=` <small>${this.layout.subtitle}</small>`),this.title_selector.html(t),this}}class bt extends yt{update(){return isNaN(this.parent_plot.state.start)||isNaN(this.parent_plot.state.end)||null===this.parent_plot.state.start||null===this.parent_plot.state.end?this.selector.style("display","none"):(this.selector.style("display",null),this.selector.html(qt(this.parent_plot.state.end-this.parent_plot.state.start,null,!0))),this.layout.class&&this.selector.attr("class",this.layout.class),this.layout.style&&gt(this.selector,this.layout.style),this}}class xt extends yt{constructor(t,e){if(super(t,e),!this.parent_panel)throw new Error("Filter widget can only be used in panel toolbars");if(this._data_layer=this.parent_panel.data_layers[t.layer_name],!this._data_layer)throw new Error(`Filter widget could not locate the specified layer_name: '${t.layer_name}'`);if(this._event_name=t.custom_event_name||"widget_filter_field_action",this._field=t.field,this._field_display_html=t.field_display_html,this._operator=t.operator,this._filter_id=null,this._data_type=t.data_type||"number",!["number","string"].includes(this._data_type))throw new Error("Filter must be either string or number");this._value_selector=null}_getTarget(){this._data_layer.layout.filters||(this._data_layer.layout.filters=[]);let t=this._data_layer.layout.filters.find((t=>t.field===this._field&&t.operator===this._operator&&(!this._filter_id||t.id===this._filter_id)));return t||(t={field:this._field,operator:this._operator,value:null},this._filter_id&&(t.id=this._filter_id),this._data_layer.layout.filters.push(t)),t}_clearFilter(){if(this._data_layer.layout.filters){const t=this._data_layer.layout.filters.indexOf(this._getTarget());this._data_layer.layout.filters.splice(t,1)}}_setFilter(t){if(null===t)this._value_selector.style("border","1px solid red").style("color","red"),this._clearFilter();else{this._getTarget().value=t}this.parent_svg.emit(this._event_name,{field:this._field,operator:this._operator,value:t,filter_id:this._filter_id},!0)}_getValue(){let t=this._value_selector.property("value");return null===t||""===t||"number"===this._data_type&&(t=+t,Number.isNaN(t))?null:t}update(){this._value_selector||(this.selector.style("padding","0 6px"),this.selector.append("span").html(this._field_display_html).style("background","#fff").style("padding-left","3px"),this.selector.append("span").text(this._operator).style("padding","0 3px").style("background","#fff"),this._value_selector=this.selector.append("input").attr("size",this.layout.input_size||4).on("input",function(t,e=500){let s;return()=>{clearTimeout(s),s=setTimeout((()=>t.apply(this,arguments)),e)}}((()=>{this._value_selector.style("border",null).style("color",null);const t=this._getValue();this._setFilter(t),this.parent_panel.render()}),750)))}}class vt extends yt{constructor(t,e){super(t,e),this._filename=this.layout.filename||"locuszoom.svg",this._button_html=this.layout.button_html||"Save SVG",this._button_title=this.layout.button_title||"Download hi-res image",this._event_name=t.custom_event_name||"widget_save_svg"}update(){return this.button||(this.button=new ft(this).setColor(this.layout.color).setHtml(this._button_html).setTitle(this._button_title).setOnMouseover((()=>{this.button.selector.classed("lz-toolbar-button-gray-disabled",!0).html("Preparing Image"),this._getBlobUrl().then((t=>{const e=this.button.selector.attr("href");e&&URL.revokeObjectURL(e),this.button.selector.attr("href",t).classed("lz-toolbar-button-gray-disabled",!1).classed("lz-toolbar-button-gray-highlighted",!0).html(this._button_html)}))})).setOnMouseout((()=>{this.button.selector.classed("lz-toolbar-button-gray-highlighted",!1)})),this.button.show(),this.button.selector.attr("href-lang","image/svg+xml").attr("download",this._filename).on("click",(()=>this.parent_svg.emit(this._event_name,{filename:this._filename},!0)))),this}_getCSS(t){const e=/^svg\.lz-locuszoom\s*/;let s="";for(let t=0;t<document.styleSheets.length;t++){const i=document.styleSheets[t];try{if(!i.cssRules)continue}catch(t){if("SecurityError"!==t.name)throw t;continue}let a=i.cssRules;for(let t=0;t<a.length;t++){const i=a[t];i.selectorText&&i.selectorText.match(e)&&(s+=i.cssText)}}return s}_appendCSS(t,e){var s=document.createElement("style");s.setAttribute("type","text/css"),s.innerHTML=t;var i=e.hasChildNodes()?e.children[0]:null;e.insertBefore(s,i)}_getDimensions(){let{width:t,height:e}=this.parent_plot.svg.node().getBoundingClientRect();const s=2400/t;return[s*t,s*e]}_generateSVG(){return new Promise((t=>{let e=this.parent_plot.svg.node().cloneNode(!0);e.setAttribute("xlink","http://www.w3.org/1999/xlink"),e=I.select(e),e.selectAll("g.lz-curtain").remove(),e.selectAll("g.lz-mouse_guide").remove(),e.selectAll("g.tick text").each((function(){const t=10*+I.select(this).attr("dy").substring(-2).slice(0,-2);I.select(this).attr("dy",t)}));const s=new XMLSerializer;e=e.node();const[i,a]=this._getDimensions();e.setAttribute("width",i),e.setAttribute("height",a),this._appendCSS(this._getCSS(e),e),t(s.serializeToString(e))}))}_getBlobUrl(){return this._generateSVG().then((t=>{const e=new Blob([t],{type:"image/svg+xml"});return URL.createObjectURL(e)}))}}class wt extends vt{constructor(t,e){super(...arguments),this._filename=this.layout.filename||"locuszoom.png",this._button_html=this.layout.button_html||"Save PNG",this._button_title=this.layout.button_title||"Download image",this._event_name=t.custom_event_name||"widget_save_png"}_getBlobUrl(){return super._getBlobUrl().then((t=>{const e=document.createElement("canvas"),s=e.getContext("2d"),[i,a]=this._getDimensions();return e.width=i,e.height=a,new Promise(((n,o)=>{const r=new Image;r.onload=()=>{s.drawImage(r,0,0,i,a),URL.revokeObjectURL(t),e.toBlob((t=>{n(URL.createObjectURL(t))}))},r.src=t}))}))}}class $t extends yt{update(){return this.button||(this.button=new ft(this).setColor(this.layout.color).setHtml("×").setTitle("Remove panel").setOnclick((()=>{if(!this.layout.suppress_confirm&&!confirm("Are you sure you want to remove this panel? This cannot be undone."))return!1;const t=this.parent_panel;return t.toolbar.hide(!0),I.select(t.parent.svg.node().parentNode).on(`mouseover.${t.getBaseId()}.toolbar`,null),I.select(t.parent.svg.node().parentNode).on(`mouseout.${t.getBaseId()}.toolbar`,null),t.parent.removePanel(t.id)})),this.button.show()),this}}class zt extends yt{update(){if(this.button){const t=0===this.parent_panel.layout.y_index;return this.button.disable(t),this}return this.button=new ft(this).setColor(this.layout.color).setHtml("▴").setTitle("Move panel up").setOnclick((()=>{this.parent_panel.moveUp(),this.update()})),this.button.show(),this.update()}}class kt extends yt{update(){if(this.button){const t=this.parent_panel.layout.y_index===this.parent_plot._panel_ids_by_y_index.length-1;return this.button.disable(t),this}return this.button=new ft(this).setColor(this.layout.color).setHtml("▾").setTitle("Move panel down").setOnclick((()=>{this.parent_panel.moveDown(),this.update()})),this.button.show(),this.update()}}class Et extends yt{constructor(t,e){if((isNaN(t.step)||0===t.step)&&(t.step=5e4),"string"!=typeof t.button_html&&(t.button_html=t.step>0?">":"<"),"string"!=typeof t.button_title&&(t.button_title=`Shift region by ${t.step>0?"+":"-"}${qt(Math.abs(t.step),null,!0)}`),super(t,e),isNaN(this.parent_plot.state.start)||isNaN(this.parent_plot.state.end))throw new Error("Unable to add shift_region toolbar widget: plot state does not have region bounds")}update(){return this.button||(this.button=new ft(this).setColor(this.layout.color).setHtml(this.layout.button_html).setTitle(this.layout.button_title).setOnclick((()=>{this.parent_plot.applyState({start:Math.max(this.parent_plot.state.start+this.layout.step,1),end:this.parent_plot.state.end+this.layout.step})})),this.button.show()),this}}class Mt extends yt{constructor(t,e){if((isNaN(t.step)||0===t.step)&&(t.step=.2),"string"!=typeof t.button_html&&(t.button_html=t.step>0?"z–":"z+"),"string"!=typeof t.button_title&&(t.button_title=`Zoom region ${t.step>0?"out":"in"} by ${(100*Math.abs(t.step)).toFixed(1)}%`),super(t,e),isNaN(this.parent_plot.state.start)||isNaN(this.parent_plot.state.end))throw new Error("Unable to add zoom_region toolbar widget: plot state does not have region bounds")}update(){if(this.button){let t=!0;const e=this.parent_plot.state.end-this.parent_plot.state.start;return this.layout.step>0&&!isNaN(this.parent_plot.layout.max_region_scale)&&e>=this.parent_plot.layout.max_region_scale&&(t=!1),this.layout.step<0&&!isNaN(this.parent_plot.layout.min_region_scale)&&e<=this.parent_plot.layout.min_region_scale&&(t=!1),this.button.disable(!t),this}return this.button=new ft(this).setColor(this.layout.color).setHtml(this.layout.button_html).setTitle(this.layout.button_title).setOnclick((()=>{const t=this.parent_plot.state.end-this.parent_plot.state.start;let e=t*(1+this.layout.step);isNaN(this.parent_plot.layout.max_region_scale)||(e=Math.min(e,this.parent_plot.layout.max_region_scale)),isNaN(this.parent_plot.layout.min_region_scale)||(e=Math.max(e,this.parent_plot.layout.min_region_scale));const s=Math.floor((e-t)/2);this.parent_plot.applyState({start:Math.max(this.parent_plot.state.start-s,1),end:this.parent_plot.state.end+s})})),this.button.show(),this}}class St extends yt{update(){return this.button||(this.button=new ft(this).setColor(this.layout.color).setHtml(this.layout.button_html).setTitle(this.layout.button_title),this.button.menu.setPopulate((()=>{this.button.menu.inner_selector.html(this.layout.menu_html)})),this.button.show()),this}}class Nt extends yt{constructor(t){super(...arguments)}update(){return this.button||(this.button=new ft(this).setColor(this.layout.color).setHtml(this.layout.button_html||"Resize to Data").setTitle(this.layout.button_title||"Automatically resize this panel to show all data available").setOnclick((()=>{this.parent_panel.scaleHeightToData(),this.update()})),this.button.show()),this}}class At extends yt{update(){const t=this.parent_panel.legend.layout.hidden?"Show Legend":"Hide Legend";return this.button?(this.button.setHtml(t).show(),this.parent.position(),this):(this.button=new ft(this).setColor(this.layout.color).setTitle("Show or hide the legend for this panel").setOnclick((()=>{this.parent_panel.legend.layout.hidden=!this.parent_panel.legend.layout.hidden,this.parent_panel.legend.render(),this.update()})),this.update())}}class Ot extends yt{constructor(t,e){"string"!=typeof t.button_html&&(t.button_html="Display options..."),"string"!=typeof t.button_title&&(t.button_title="Control how plot items are displayed"),super(...arguments),this._event_name=t.custom_event_name||"widget_display_options_choice";const s=t.fields_whitelist||["color","fill_opacity","filters","label","legend","point_shape","point_size","tooltip","tooltip_positioning"],i=this.parent_panel.data_layers[t.layer_name];if(!i)throw new Error(`Display options could not locate the specified layer_name: '${t.layer_name}'`);const a=i.layout,n={};s.forEach((t=>{const e=a[t];void 0!==e&&(n[t]=nt(e))})),this._selected_item="default",this.button=new ft(this).setColor(t.color).setHtml(t.button_html).setTitle(t.button_title).setOnclick((()=>{this.button.menu.populate()})),this.button.menu.setPopulate((()=>{const t=Math.floor(1e4*Math.random()).toString();this.button.menu.inner_selector.html("");const e=this.button.menu.inner_selector.append("table"),a=this.layout,o=(a,o,r)=>{const l=e.append("tr"),h=`${t}${r}`;l.append("td").append("input").attr("id",h).attr("type","radio").attr("name",`display-option-${t}`).attr("value",r).style("margin",0).property("checked",r===this._selected_item).on("click",(()=>{s.forEach((t=>{const e=void 0!==o[t];i.layout[t]=e?o[t]:n[t]})),this.parent_svg.emit(this._event_name,{choice:a},!0),this._selected_item=r,this.parent_panel.render();const t=this.parent_panel.legend;t&&t.render()})),l.append("td").append("label").style("font-weight","normal").attr("for",h).text(a)},r=a.default_config_display_name||"Default style";return o(r,n,"default"),a.options.forEach(((t,e)=>o(t.display_name,t.display,e))),this}))}update(){return this.button.show(),this}}class Tt extends yt{constructor(t,e){if("string"!=typeof t.button_html&&(t.button_html="Set option..."),"string"!=typeof t.button_title&&(t.button_title="Choose an option to customize the plot"),super(t,e),this.parent_panel)throw new Error("This widget is designed to set global options, so it can only be used at the top (plot) level");if(!t.state_field)throw new Error("Must specify the `state_field` that this widget controls");if(this._event_name=t.custom_event_name||"widget_set_state_choice",this._selected_item=this.parent_plot.state[t.state_field]||t.options[0].value,!t.options.find((t=>t.value===this._selected_item)))throw new Error("There is an existing state value that does not match the known values in this widget");this.button=new ft(this).setColor(t.color).setHtml(t.button_html+(t.show_selected?this._selected_item:"")).setTitle(t.button_title).setOnclick((()=>{this.button.menu.populate()})),this.button.menu.setPopulate((()=>{const e=Math.floor(1e4*Math.random()).toString();this.button.menu.inner_selector.html("");const s=this.button.menu.inner_selector.append("table"),i=(i,a,n)=>{const o=s.append("tr"),r=`${e}${n}`;o.append("td").append("input").attr("id",r).attr("type","radio").attr("name",`set-state-${e}`).attr("value",n).style("margin",0).property("checked",a===this._selected_item).on("click",(()=>{const e={};e[t.state_field]=a,this._selected_item=a,this.parent_plot.applyState(e),this.button.setHtml(t.button_html+(t.show_selected?this._selected_item:"")),this.parent_svg.emit(this._event_name,{choice_name:i,choice_value:a,state_field:t.state_field},!0)})),o.append("td").append("label").style("font-weight","normal").attr("for",r).text(i)};return t.options.forEach(((t,e)=>i(t.display_name,t.value,e))),this}))}update(){return this.button.show(),this}}const Lt=new c;for(let[t,e]of Object.entries(a))Lt.add(t,e);const jt=Lt;class Pt{constructor(t){this.parent=t,this.id=`${this.parent.getBaseId()}.toolbar`,this.type=this.parent.parent?"panel":"plot",this.parent_plot=this.parent.parent_plot,this.selector=null,this.widgets=[],this.hide_timeout=null,this.persist=!1,this.initialize()}initialize(){const t=this.parent.layout.toolbar.widgets;return Array.isArray(t)&&t.forEach((t=>{this.addWidget(t)})),"panel"===this.type&&I.select(this.parent.parent.svg.node().parentNode).on(`mouseover.${this.id}`,(()=>{clearTimeout(this.hide_timeout),this.selector&&"hidden"!==this.selector.style("visibility")||this.show()})).on(`mouseout.${this.id}`,(()=>{clearTimeout(this.hide_timeout),this.hide_timeout=setTimeout((()=>{this.hide()}),300)})),this}addWidget(t){try{const e=jt.create(t.type,t,this);return this.widgets.push(e),e}catch(t){console.warn("Failed to create widget"),console.error(t)}}shouldPersist(){if(this.persist)return!0;let t=!1;return this.widgets.forEach((e=>{t=t||e.shouldPersist()})),t=t||this.parent_plot._panel_boundaries.dragging||this.parent_plot._interaction.dragging,!!t}show(){if(!this.selector){switch(this.type){case"plot":this.selector=I.select(this.parent.svg.node().parentNode).insert("div",":first-child");break;case"panel":this.selector=I.select(this.parent.parent.svg.node().parentNode).insert("div",".lz-data_layer-tooltip, .lz-toolbar-menu, .lz-curtain").classed("lz-panel-toolbar",!0);break;default:throw new Error(`Toolbar cannot be a child of ${this.type}`)}this.selector.classed("lz-toolbar",!0).classed(`lz-${this.type}-toolbar`,!0).attr("id",this.id)}return this.widgets.forEach((t=>t.show())),this.selector.style("visibility","visible"),this.update()}update(){return this.selector?(this.widgets.forEach((t=>t.update())),this.position()):this}position(){if(!this.selector)return this;if("panel"===this.type){const t=this.parent._getPageOrigin(),e=`${(t.y+3.5).toString()}px`,s=`${t.x.toString()}px`,i=`${(this.parent_plot.layout.width-4).toString()}px`;this.selector.style("position","absolute").style("top",e).style("left",s).style("width",i)}return this.widgets.forEach((t=>t.position())),this}hide(){return!this.selector||this.shouldPersist()||(this.widgets.forEach((t=>t.hide())),this.selector.style("visibility","hidden")),this}destroy(t){return void 0===t&&(t=!1),this.selector?(this.shouldPersist()&&!t||(this.widgets.forEach((t=>t.destroy(!0))),this.widgets=[],this.selector.remove(),this.selector=null),this):this}}const Rt={orientation:"vertical",origin:{x:0,y:0},width:10,height:10,padding:5,label_size:14,hidden:!1};class It{constructor(t){return this.parent=t,this.id=`${this.parent.getBaseId()}.legend`,this.parent.layout.legend=at(this.parent.layout.legend||{},Rt),this.layout=this.parent.layout.legend,this.selector=null,this.background_rect=null,this.elements=[],this.elements_group=null,this.hidden=!1,this.render()}render(){this.selector||(this.selector=this.parent.svg.group.append("g").attr("id",`${this.parent.getBaseId()}.legend`).attr("class","lz-legend")),this.background_rect||(this.background_rect=this.selector.append("rect").attr("width",100).attr("height",100).attr("class","lz-legend-background")),this.elements_group||(this.elements_group=this.selector.append("g")),this.elements.forEach((t=>t.remove())),this.elements=[];const t=+this.layout.padding||1;let e=t,s=t,i=0;this.parent._data_layer_ids_by_z_index.slice().reverse().forEach((a=>{const n=this.parent.data_layers[a].layout.legend;Array.isArray(n)&&n.forEach((a=>{const n=this.elements_group.append("g").attr("transform",`translate(${e}, ${s})`),o=+a.label_size||+this.layout.label_size;let r=0,l=o/2+t/2;i=Math.max(i,o+t);const h=a.shape||"",c=ot(h);if("line"===h){const e=+a.length||16,s=o/4+t/2;n.append("path").attr("class",a.class||"").attr("d",`M0,${s}L${e},${s}`).call(gt,a.style||{}),r=e+t}else if("rect"===h){const e=+a.width||16,s=+a.height||e;n.append("rect").attr("class",a.class||"").attr("width",e).attr("height",s).attr("fill",a.color||{}).call(gt,a.style||{}),r=e+t,i=Math.max(i,s+t)}else if("ribbon"===h){const e=+a.width||25,s=+a.height||e,i="horizontal"===(a.orientation||"vertical");let o=a.color_stops;const h=n.append("g"),c=h.append("g"),d=h.append("g");let u=0;if(a.tick_labels){let t;t=i?[0,e*o.length-1]:[s*o.length-1,0];const n=I.scaleLinear().domain(I.extent(a.tick_labels)).range(t),r=(i?I.axisTop:I.axisRight)(n).tickSize(3).tickValues(a.tick_labels).tickFormat((t=>t));d.call(r).attr("class","lz-axis"),u=d.node().getBoundingClientRect().height}i?(d.attr("transform",`translate(0, ${u})`),c.attr("transform",`translate(0, ${u})`)):(h.attr("transform","translate(5, 0)"),d.attr("transform",`translate(${e}, 0)`)),i||(o=o.slice(),o.reverse());for(let t=0;t<o.length;t++){const n=o[t],r=i?`translate(${e*t}, 0)`:`translate(0, ${s*t})`;c.append("rect").attr("class",a.class||"").attr("stroke","black").attr("transform",r).attr("stroke-width",.5).attr("width",e).attr("height",s).attr("fill",n).call(gt,a.style||{})}if(!i&&a.label)throw new Error("Legend labels not supported for vertical ribbons (use a separate legend item as text instead)");r=e*o.length+t,l+=u}else if(c){const e=+a.size||40,s=Math.ceil(Math.sqrt(e/Math.PI));n.append("path").attr("class",a.class||"").attr("d",I.symbol().size(e).type(c)).attr("transform",`translate(${s}, ${s+t/2})`).attr("fill",a.color||{}).call(gt,a.style||{}),r=2*s+t,l=Math.max(2*s+t/2,l),i=Math.max(i,2*s+t)}n.append("text").attr("text-anchor","left").attr("class","lz-label").attr("x",r).attr("y",l).style("font-size",o).text(a.label);const d=n.node().getBoundingClientRect();if("vertical"===this.layout.orientation)s+=d.height+t,i=0;else{const a=this.layout.origin.x+e+d.width;e>t&&a>this.parent.parent.layout.width&&(s+=i,e=t,n.attr("transform",`translate(${e}, ${s})`)),e+=d.width+3*t}this.elements.push(n)}))}));const a=this.elements_group.node().getBoundingClientRect();return this.layout.width=a.width+2*this.layout.padding,this.layout.height=a.height+2*this.layout.padding,this.background_rect.attr("width",this.layout.width).attr("height",this.layout.height),this.selector.style("visibility",this.layout.hidden?"hidden":"visible"),this.position()}position(){if(!this.selector)return this;const t=this.selector.node().getBoundingClientRect();isNaN(+this.layout.pad_from_bottom)||(this.layout.origin.y=this.parent.layout.height-t.height-+this.layout.pad_from_bottom),isNaN(+this.layout.pad_from_right)||(this.layout.origin.x=this.parent.parent.layout.width-t.width-+this.layout.pad_from_right),this.selector.attr("transform",`translate(${this.layout.origin.x}, ${this.layout.origin.y})`)}hide(){this.layout.hidden=!0,this.render()}show(){this.layout.hidden=!1,this.render()}}const Ct={id:"",tag:"custom_data_type",title:{text:"",style:{},x:10,y:22},y_index:null,min_height:1,height:1,origin:{x:0,y:null},margin:{top:0,right:0,bottom:0,left:0},background_click:"clear_selections",toolbar:{widgets:[]},cliparea:{height:0,width:0,origin:{x:0,y:0}},axes:{x:{},y1:{},y2:{}},legend:null,interaction:{drag_background_to_pan:!1,drag_x_ticks_to_scale:!1,drag_y1_ticks_to_scale:!1,drag_y2_ticks_to_scale:!1,scroll_to_zoom:!1,x_linked:!1,y1_linked:!1,y2_linked:!1},show_loading_indicator:!0,data_layers:[]};class Dt{constructor(t,e){if("object"!=typeof t)throw new Error("Unable to create panel, invalid layout");if(this.parent=e||null,this.parent_plot=e,"string"!=typeof t.id||!t.id)throw new Error('Panel layouts must specify "id"');if(this.parent&&void 0!==this.parent.panels[t.id])throw new Error(`Cannot create panel with id [${t.id}]; panel with that id already exists`);this.id=t.id,this._initialized=!1,this._layout_idx=null,this.svg={},this.layout=at(t||{},Ct),this.parent?(this.state=this.parent.state,this._state_id=this.id,this.state[this._state_id]=this.state[this._state_id]||{}):(this.state=null,this._state_id=null),this.data_layers={},this._data_layer_ids_by_z_index=[],this._data_promises=[],this.x_scale=null,this.y1_scale=null,this.y2_scale=null,this.x_extent=null,this.y1_extent=null,this.y2_extent=null,this.x_ticks=[],this.y1_ticks=[],this.y2_ticks=[],this._zoom_timeout=null,this._event_hooks={},this.initializeLayout()}on(t,e){if("string"!=typeof t)throw new Error(`Unable to register event hook. Event name must be a string: ${t.toString()}`);if("function"!=typeof e)throw new Error("Unable to register event hook, invalid hook function passed");return this._event_hooks[t]||(this._event_hooks[t]=[]),this._event_hooks[t].push(e),e}off(t,e){const s=this._event_hooks[t];if("string"!=typeof t||!Array.isArray(s))throw new Error(`Unable to remove event hook, invalid event: ${t.toString()}`);if(void 0===e)this._event_hooks[t]=[];else{const t=s.indexOf(e);if(-1===t)throw new Error("The specified event listener is not registered and therefore cannot be removed");s.splice(t,1)}return this}emit(t,e,s){if(s=s||!1,"string"!=typeof t)throw new Error(`LocusZoom attempted to throw an invalid event: ${t.toString()}`);"boolean"==typeof e&&2===arguments.length&&(s=e,e=null);const i={sourceID:this.getBaseId(),target:this,data:e||null};return this._event_hooks[t]&&this._event_hooks[t].forEach((t=>{t.call(this,i)})),s&&this.parent&&this.parent.emit(t,i),this}setTitle(t){if("string"==typeof this.layout.title){const t=this.layout.title;this.layout.title={text:t,x:0,y:0,style:{}}}return"string"==typeof t?this.layout.title.text=t:"object"==typeof t&&null!==t&&(this.layout.title=at(t,this.layout.title)),this.layout.title.text.length?this.title.attr("display",null).attr("x",parseFloat(this.layout.title.x)).attr("y",parseFloat(this.layout.title.y)).text(this.layout.title.text).call(gt,this.layout.title.style):this.title.attr("display","none"),this}addDataLayer(t){if("object"!=typeof t||"string"!=typeof t.id||!t.id.length)throw new Error("Invalid data layer layout");if(void 0!==this.data_layers[t.id])throw new Error(`Cannot create data_layer with id '${t.id}'; data layer with that id already exists in the panel`);if("string"!=typeof t.type)throw new Error("Invalid data layer type");"object"!=typeof t.y_axis||void 0!==t.y_axis.axis&&[1,2].includes(t.y_axis.axis)||(t.y_axis.axis=1);const e=xe.create(t.type,t,this);if(this.data_layers[e.id]=e,null!==e.layout.z_index&&!isNaN(e.layout.z_index)&&this._data_layer_ids_by_z_index.length>0)e.layout.z_index<0&&(e.layout.z_index=Math.max(this._data_layer_ids_by_z_index.length+e.layout.z_index,0)),this._data_layer_ids_by_z_index.splice(e.layout.z_index,0,e.id),this._data_layer_ids_by_z_index.forEach(((t,e)=>{this.data_layers[t].layout.z_index=e}));else{const t=this._data_layer_ids_by_z_index.push(e.id);this.data_layers[e.id].layout.z_index=t-1}let s=null;return this.layout.data_layers.forEach(((t,i)=>{t.id===e.id&&(s=i)})),null===s&&(s=this.layout.data_layers.push(this.data_layers[e.id].layout)-1),this.data_layers[e.id]._layout_idx=s,this.data_layers[e.id]}removeDataLayer(t){const e=this.data_layers[t];if(!e)throw new Error(`Unable to remove data layer, ID not found: ${t}`);return e.destroyAllTooltips(),e.svg.container&&e.svg.container.remove(),this.layout.data_layers.splice(e._layout_idx,1),delete this.state[e._state_id],delete this.data_layers[t],this._data_layer_ids_by_z_index.splice(this._data_layer_ids_by_z_index.indexOf(t),1),this.applyDataLayerZIndexesToDataLayerLayouts(),this.layout.data_layers.forEach(((t,e)=>{this.data_layers[t.id]._layout_idx=e})),this}clearSelections(){return this._data_layer_ids_by_z_index.forEach((t=>{this.data_layers[t].setAllElementStatus("selected",!1)})),this}render(){this.svg.container.attr("transform",`translate(${this.layout.origin.x}, ${this.layout.origin.y})`),this.svg.clipRect.attr("width",this.parent_plot.layout.width).attr("height",this.layout.height);const{cliparea:t}=this.layout,{margin:e}=this.layout;this.inner_border.attr("x",e.left).attr("y",e.top).attr("width",this.parent_plot.layout.width-(e.left+e.right)).attr("height",this.layout.height-(e.top+e.bottom)),this.layout.inner_border&&this.inner_border.style("stroke-width",1).style("stroke",this.layout.inner_border),this.setTitle(),this.generateExtents();const s=function(t,e){const s=Math.pow(-10,e),i=Math.pow(-10,-e),a=Math.pow(10,-e),n=Math.pow(10,e);return t===1/0&&(t=n),t===-1/0&&(t=s),0===t&&(t=a),t>0&&(t=Math.max(Math.min(t,n),a)),t<0&&(t=Math.max(Math.min(t,i),s)),t},i={},a=this.layout.axes;if(this.x_extent){const t={start:0,end:this.layout.cliparea.width};a.x.range&&(t.start=a.x.range.start||t.start,t.end=a.x.range.end||t.end),i.x=[t.start,t.end],i.x_shifted=[t.start,t.end]}if(this.y1_extent){const e={start:t.height,end:0};a.y1.range&&(e.start=a.y1.range.start||e.start,e.end=a.y1.range.end||e.end),i.y1=[e.start,e.end],i.y1_shifted=[e.start,e.end]}if(this.y2_extent){const e={start:t.height,end:0};a.y2.range&&(e.start=a.y2.range.start||e.start,e.end=a.y2.range.end||e.end),i.y2=[e.start,e.end],i.y2_shifted=[e.start,e.end]}let{_interaction:n}=this.parent;const o=n.dragging;if(n.panel_id&&(n.panel_id===this.id||n.linked_panel_ids.includes(this.id))){let a,r=null;if(n.zooming&&"function"==typeof this.x_scale){const s=Math.abs(this.x_extent[1]-this.x_extent[0]),o=Math.round(this.x_scale.invert(i.x_shifted[1]))-Math.round(this.x_scale.invert(i.x_shifted[0]));let r=n.zooming.scale;const l=Math.floor(o*(1/r));r<1&&!isNaN(this.parent.layout.max_region_scale)?r=1/(Math.min(l,this.parent.layout.max_region_scale)/o):r>1&&!isNaN(this.parent.layout.min_region_scale)&&(r=1/(Math.max(l,this.parent.layout.min_region_scale)/o));const h=Math.floor(s*r);a=n.zooming.center-e.left-this.layout.origin.x;const c=a/t.width,d=Math.max(Math.floor(this.x_scale.invert(i.x_shifted[0])-(h-o)*c),1);i.x_shifted=[this.x_scale(d),this.x_scale(d+h)]}else if(o)switch(o.method){case"background":i.x_shifted[0]=+o.dragged_x,i.x_shifted[1]=t.width+o.dragged_x;break;case"x_tick":I.event&&I.event.shiftKey?(i.x_shifted[0]=+o.dragged_x,i.x_shifted[1]=t.width+o.dragged_x):(a=o.start_x-e.left-this.layout.origin.x,r=s(a/(a+o.dragged_x),3),i.x_shifted[0]=0,i.x_shifted[1]=Math.max(t.width*(1/r),1));break;case"y1_tick":case"y2_tick":{const n=`y${o.method[1]}_shifted`;I.event&&I.event.shiftKey?(i[n][0]=t.height+o.dragged_y,i[n][1]=+o.dragged_y):(a=t.height-(o.start_y-e.top-this.layout.origin.y),r=s(a/(a-o.dragged_y),3),i[n][0]=t.height,i[n][1]=t.height-t.height*(1/r))}}}if(["x","y1","y2"].forEach((t=>{this[`${t}_extent`]&&(this[`${t}_scale`]=I.scaleLinear().domain(this[`${t}_extent`]).range(i[`${t}_shifted`]),this[`${t}_extent`]=[this[`${t}_scale`].invert(i[t][0]),this[`${t}_scale`].invert(i[t][1])],this[`${t}_scale`]=I.scaleLinear().domain(this[`${t}_extent`]).range(i[t]),this.renderAxis(t))})),this.layout.interaction.scroll_to_zoom){const t=()=>{if(!I.event.shiftKey&&!I.event.altKey)return void(this.parent._canInteract(this.id)&&this.loader.show("Press <tt>[SHIFT]</tt> or <tt>[ALT]</tt> while scrolling to zoom").hide(1e3));if(I.event.preventDefault(),!this.parent._canInteract(this.id))return;const t=I.mouse(this.svg.container.node()),e=Math.max(-1,Math.min(1,I.event.wheelDelta||-I.event.detail||-I.event.deltaY));0!==e&&(this.parent._interaction={panel_id:this.id,linked_panel_ids:this.getLinkedPanelIds("x"),zooming:{scale:e<1?.9:1.1,center:t[0]}},this.render(),n=this.parent._interaction,n.linked_panel_ids.forEach((t=>{this.parent.panels[t].render()})),null!==this._zoom_timeout&&clearTimeout(this._zoom_timeout),this._zoom_timeout=setTimeout((()=>{this.parent._interaction={},this.parent.applyState({start:this.x_extent[0],end:this.x_extent[1]})}),500))};this.svg.container.on("wheel.zoom",t).on("mousewheel.zoom",t).on("DOMMouseScroll.zoom",t)}return this._data_layer_ids_by_z_index.forEach((t=>{this.data_layers[t].draw().render()})),this.legend&&this.legend.render(),this}addBasicLoader(t=!0){return this.layout.show_loading_indicator&&this._initialized||(t&&this.loader.show("Loading...").animate(),this.on("data_requested",(()=>{this.loader.show("Loading...").animate()})),this.on("data_rendered",(()=>{this.loader.hide()})),this.layout.show_loading_indicator=!0),this}applyDataLayerZIndexesToDataLayerLayouts(){this._data_layer_ids_by_z_index.forEach(((t,e)=>{this.data_layers[t].layout.z_index=e}))}getBaseId(){return`${this.parent.id}.${this.id}`}_getPageOrigin(){const t=this.parent._getPageOrigin();return{x:t.x+this.layout.origin.x,y:t.y+this.layout.origin.y}}initializeLayout(){return this.setDimensions(),this.setOrigin(),this.setMargin(),this.x_range=[0,this.layout.cliparea.width],this.y1_range=[this.layout.cliparea.height,0],this.y2_range=[this.layout.cliparea.height,0],["x","y1","y2"].forEach((t=>{const e=this.layout.axes[t];Object.keys(e).length&&!1!==e.render?(e.render=!0,e.label=e.label||null):e.render=!1})),this.layout.data_layers.forEach((t=>{this.addDataLayer(t)})),this}setDimensions(t,e){const s=this.layout;return void 0!==t&&void 0!==e&&!isNaN(t)&&t>=0&&!isNaN(e)&&e>=0&&(this.parent.layout.width=Math.round(+t),s.height=Math.max(Math.round(+e),s.min_height)),s.cliparea.width=Math.max(this.parent_plot.layout.width-(s.margin.left+s.margin.right),0),s.cliparea.height=Math.max(s.height-(s.margin.top+s.margin.bottom),0),this.svg.clipRect&&this.svg.clipRect.attr("width",this.parent.layout.width).attr("height",s.height),this._initialized&&(this.render(),this.curtain.update(),this.loader.update(),this.toolbar.update(),this.legend&&this.legend.position()),this}setOrigin(t,e){return!isNaN(t)&&t>=0&&(this.layout.origin.x=Math.max(Math.round(+t),0)),!isNaN(e)&&e>=0&&(this.layout.origin.y=Math.max(Math.round(+e),0)),this._initialized&&this.render(),this}setMargin(t,e,s,i){let a;const{cliparea:n,margin:o}=this.layout;return!isNaN(t)&&t>=0&&(o.top=Math.max(Math.round(+t),0)),!isNaN(e)&&e>=0&&(o.right=Math.max(Math.round(+e),0)),!isNaN(s)&&s>=0&&(o.bottom=Math.max(Math.round(+s),0)),!isNaN(i)&&i>=0&&(o.left=Math.max(Math.round(+i),0)),o.top+o.bottom>this.layout.height&&(a=Math.floor((o.top+o.bottom-this.layout.height)/2),o.top-=a,o.bottom-=a),o.left+o.right>this.parent_plot.layout.width&&(a=Math.floor((o.left+o.right-this.parent_plot.layout.width)/2),o.left-=a,o.right-=a),["top","right","bottom","left"].forEach((t=>{o[t]=Math.max(o[t],0)})),n.width=Math.max(this.parent_plot.layout.width-(o.left+o.right),0),n.height=Math.max(this.layout.height-(o.top+o.bottom),0),n.origin.x=o.left,n.origin.y=o.top,this._initialized&&this.render(),this}initialize(){const t=this.getBaseId();this.svg.container=this.parent.svg.append("g").attr("id",`${t}.panel_container`).attr("transform",`translate(${this.layout.origin.x||0}, ${this.layout.origin.y||0})`);const e=this.svg.container.append("clipPath").attr("id",`${t}.clip`);if(this.svg.clipRect=e.append("rect").attr("width",this.parent_plot.layout.width).attr("height",this.layout.height),this.svg.group=this.svg.container.append("g").attr("id",`${t}.panel`).attr("clip-path",`url(#${t}.clip)`),this.curtain=_t.call(this),this.loader=pt.call(this),this.layout.show_loading_indicator&&this.addBasicLoader(!1),this.toolbar=new Pt(this),this.inner_border=this.svg.group.append("rect").attr("class","lz-panel-background").on("click",(()=>{"clear_selections"===this.layout.background_click&&this.clearSelections()})),this.title=this.svg.group.append("text").attr("class","lz-panel-title"),void 0!==this.layout.title&&this.setTitle(),this.svg.x_axis=this.svg.group.append("g").attr("id",`${t}.x_axis`).attr("class","lz-x lz-axis"),this.layout.axes.x.render&&(this.svg.x_axis_label=this.svg.x_axis.append("text").attr("class","lz-x lz-axis lz-label").attr("text-anchor","middle")),this.svg.y1_axis=this.svg.group.append("g").attr("id",`${t}.y1_axis`).attr("class","lz-y lz-y1 lz-axis"),this.layout.axes.y1.render&&(this.svg.y1_axis_label=this.svg.y1_axis.append("text").attr("class","lz-y1 lz-axis lz-label").attr("text-anchor","middle")),this.svg.y2_axis=this.svg.group.append("g").attr("id",`${t}.y2_axis`).attr("class","lz-y lz-y2 lz-axis"),this.layout.axes.y2.render&&(this.svg.y2_axis_label=this.svg.y2_axis.append("text").attr("class","lz-y2 lz-axis lz-label").attr("text-anchor","middle")),this._data_layer_ids_by_z_index.forEach((t=>{this.data_layers[t].initialize()})),this.legend=null,this.layout.legend&&(this.legend=new It(this)),this.layout.interaction.drag_background_to_pan){const t=`.${this.parent.id}.${this.id}.interaction.drag`,e=()=>this.parent.startDrag(this,"background");this.svg.container.select(".lz-panel-background").on(`mousedown${t}.background`,e).on(`touchstart${t}.background`,e)}return this}resortDataLayers(){const t=[];this._data_layer_ids_by_z_index.forEach((e=>{t.push(this.data_layers[e].layout.z_index)})),this.svg.group.selectAll("g.lz-data_layer-container").data(t).sort(I.ascending),this.applyDataLayerZIndexesToDataLayerLayouts()}getLinkedPanelIds(t){const e=[];return["x","y1","y2"].includes(t=t||null)&&this.layout.interaction[`${t}_linked`]?(this.parent._panel_ids_by_y_index.forEach((s=>{s!==this.id&&this.parent.panels[s].layout.interaction[`${t}_linked`]&&e.push(s)})),e):e}moveUp(){const{parent:t}=this,e=this.layout.y_index;return t._panel_ids_by_y_index[e-1]&&(t._panel_ids_by_y_index[e]=t._panel_ids_by_y_index[e-1],t._panel_ids_by_y_index[e-1]=this.id,t.applyPanelYIndexesToPanelLayouts(),t.positionPanels()),this}moveDown(){const{_panel_ids_by_y_index:t}=this.parent;return t[this.layout.y_index+1]&&(t[this.layout.y_index]=t[this.layout.y_index+1],t[this.layout.y_index+1]=this.id,this.parent.applyPanelYIndexesToPanelLayouts(),this.parent.positionPanels()),this}reMap(){this.emit("data_requested"),this._data_promises=[],this.curtain.hide();for(let t in this.data_layers)try{this._data_promises.push(this.data_layers[t].reMap())}catch(t){console.error(t),this.curtain.show(t.message||t)}return Promise.all(this._data_promises).then((()=>{this._initialized=!0,this.render(),this.emit("layout_changed",!0),this.emit("data_rendered")})).catch((t=>{console.error(t),this.curtain.show(t.message||t)}))}generateExtents(){["x","y1","y2"].forEach((t=>{this[`${t}_extent`]=null}));for(let t in this.data_layers){const e=this.data_layers[t];if(e.layout.x_axis&&!e.layout.x_axis.decoupled&&(this.x_extent=I.extent((this.x_extent||[]).concat(e.getAxisExtent("x")))),e.layout.y_axis&&!e.layout.y_axis.decoupled){const t=`y${e.layout.y_axis.axis}`;this[`${t}_extent`]=I.extent((this[`${t}_extent`]||[]).concat(e.getAxisExtent("y")))}}return this.layout.axes.x&&"state"===this.layout.axes.x.extent&&(this.x_extent=[this.state.start,this.state.end]),this}generateTicks(t){if(this.layout.axes[t].ticks){const e=this.layout.axes[t].ticks;if(Array.isArray(e))return e;if("object"==typeof e){const s=this,i={position:e.position};return this._data_layer_ids_by_z_index.reduce(((e,a)=>{const n=s.data_layers[a];return e.concat(n.getTicks(t,i))}),[]).map((t=>{let s={};return s=at(s,e),at(s,t)}))}}return this[`${t}_extent`]?function(t,e,s){(void 0===s||isNaN(parseInt(s)))&&(s=5);const i=(s=+s)/3,a=.75,n=1.5,o=.5+1.5*n,r=Math.abs(t[0]-t[1]);let l=r/s;Math.log(r)/Math.LN10<-2&&(l=Math.max(Math.abs(r))*a/i);const h=Math.pow(10,Math.floor(Math.log(l)/Math.LN10));let c=0;h<1&&0!==h&&(c=Math.abs(Math.round(Math.log(h)/Math.LN10)));let d=h;2*h-l<n*(l-d)&&(d=2*h,5*h-l<o*(l-d)&&(d=5*h,10*h-l<n*(l-d)&&(d=10*h)));let u=[],_=parseFloat((Math.floor(t[0]/d)*d).toFixed(c));for(;_<t[1];)u.push(_),_+=d,c>0&&(_=parseFloat(_.toFixed(c)));u.push(_),(void 0===e||-1===["low","high","both","neither"].indexOf(e))&&(e="neither");"low"!==e&&"both"!==e||u[0]<t[0]&&(u=u.slice(1));"high"!==e&&"both"!==e||u[u.length-1]>t[1]&&u.pop();return u}(this[`${t}_extent`],"both"):[]}renderAxis(t){if(!["x","y1","y2"].includes(t))throw new Error(`Unable to render axis; invalid axis identifier: ${t}`);const e=this.layout.axes[t].render&&"function"==typeof this[`${t}_scale`]&&!isNaN(this[`${t}_scale`](0));if(this[`${t}_axis`]&&this.svg.container.select(`g.lz-axis.lz-${t}`).style("display",e?null:"none"),!e)return this;const s={x:{position:`translate(${this.layout.margin.left}, ${this.layout.height-this.layout.margin.bottom})`,orientation:"bottom",label_x:this.layout.cliparea.width/2,label_y:this.layout.axes[t].label_offset||0,label_rotate:null},y1:{position:`translate(${this.layout.margin.left}, ${this.layout.margin.top})`,orientation:"left",label_x:-1*(this.layout.axes[t].label_offset||0),label_y:this.layout.cliparea.height/2,label_rotate:-90},y2:{position:`translate(${this.parent_plot.layout.width-this.layout.margin.right}, ${this.layout.margin.top})`,orientation:"right",label_x:this.layout.axes[t].label_offset||0,label_y:this.layout.cliparea.height/2,label_rotate:-90}};this[`${t}_ticks`]=this.generateTicks(t);const i=(t=>{for(let e=0;e<t.length;e++)if(isNaN(t[e]))return!1;return!0})(this[`${t}_ticks`]);let a;switch(s[t].orientation){case"right":a=I.axisRight;break;case"left":a=I.axisLeft;break;case"bottom":a=I.axisBottom;break;default:throw new Error("Unrecognized axis orientation")}if(this[`${t}_axis`]=a(this[`${t}_scale`]).tickPadding(3),i)this[`${t}_axis`].tickValues(this[`${t}_ticks`]),"region"===this.layout.axes[t].tick_format&&this[`${t}_axis`].tickFormat((t=>qt(t,6)));else{let e=this[`${t}_ticks`].map((e=>e[t.substr(0,1)]));this[`${t}_axis`].tickValues(e).tickFormat(((e,s)=>this[`${t}_ticks`][s].text))}if(this.svg[`${t}_axis`].attr("transform",s[t].position).call(this[`${t}_axis`]),!i){const e=I.selectAll(`g#${this.getBaseId().replace(".","\\.")}\\.${t}_axis g.tick`),s=this;e.each((function(e,i){const a=I.select(this).select("text");s[`${t}_ticks`][i].style&&gt(a,s[`${t}_ticks`][i].style),s[`${t}_ticks`][i].transform&&a.attr("transform",s[`${t}_ticks`][i].transform)}))}const n=this.layout.axes[t].label||null;return null!==n&&(this.svg[`${t}_axis_label`].attr("x",s[t].label_x).attr("y",s[t].label_y).text(Ht(n,this.state)).attr("fill","currentColor"),null!==s[t].label_rotate&&this.svg[`${t}_axis_label`].attr("transform",`rotate(${s[t].label_rotate} ${s[t].label_x}, ${s[t].label_y})`)),["x","y1","y2"].forEach((t=>{if(this.layout.interaction[`drag_${t}_ticks_to_scale`]){const e=`.${this.parent.id}.${this.id}.interaction.drag`,s=function(){"function"==typeof I.select(this).node().focus&&I.select(this).node().focus();let i="x"===t?"ew-resize":"ns-resize";I.event&&I.event.shiftKey&&(i="move"),I.select(this).style("font-weight","bold").style("cursor",i).on(`keydown${e}`,s).on(`keyup${e}`,s)};this.svg.container.selectAll(`.lz-axis.lz-${t} .tick text`).attr("tabindex",0).on(`mouseover${e}`,s).on(`mouseout${e}`,(function(){I.select(this).style("font-weight","normal").on(`keydown${e}`,null).on(`keyup${e}`,null)})).on(`mousedown${e}`,(()=>{this.parent.startDrag(this,`${t}_tick`)}))}})),this}scaleHeightToData(t){null===(t=+t||null)&&this._data_layer_ids_by_z_index.forEach((e=>{const s=this.data_layers[e].getAbsoluteDataHeight();+s&&(t=null===t?+s:Math.max(t,+s))})),+t&&(t+=+this.layout.margin.top+ +this.layout.margin.bottom,this.setDimensions(this.parent_plot.layout.width,t),this.parent.setDimensions(),this.parent.positionPanels())}setAllElementStatus(t,e){this._data_layer_ids_by_z_index.forEach((s=>{this.data_layers[s].setAllElementStatus(t,e)}))}}C.verbs.forEach(((t,e)=>{const s=C.adjectives[e],i=`un${t}`;Dt.prototype[`${t}AllElements`]=function(){return this.setAllElementStatus(s,!0),this},Dt.prototype[`${i}AllElements`]=function(){return this.setAllElementStatus(s,!1),this}}));const Bt={state:{},width:800,min_width:400,min_region_scale:null,max_region_scale:null,responsive_resize:!1,panels:[],toolbar:{widgets:[]},panel_boundaries:!0,mouse_guide:!0};class Ut{constructor(t,e,s){this._initialized=!1,this.parent_plot=this,this.id=t,this.container=null,this.svg=null,this.panels={},this._panel_ids_by_y_index=[],this._remap_promises=[],this.layout=s,at(this.layout,Bt),this._base_layout=nt(this.layout),this.state=this.layout.state,this.lzd=new ut(e),this._external_listeners=new Map,this._event_hooks={},this._interaction={},this.initializeLayout()}on(t,e){if("string"!=typeof t)throw new Error(`Unable to register event hook. Event name must be a string: ${t.toString()}`);if("function"!=typeof e)throw new Error("Unable to register event hook, invalid hook function passed");return this._event_hooks[t]||(this._event_hooks[t]=[]),this._event_hooks[t].push(e),e}off(t,e){const s=this._event_hooks[t];if("string"!=typeof t||!Array.isArray(s))throw new Error(`Unable to remove event hook, invalid event: ${t.toString()}`);if(void 0===e)this._event_hooks[t]=[];else{const t=s.indexOf(e);if(-1===t)throw new Error("The specified event listener is not registered and therefore cannot be removed");s.splice(t,1)}return this}emit(t,e){const s=this._event_hooks[t];if("string"!=typeof t)throw new Error(`LocusZoom attempted to throw an invalid event: ${t.toString()}`);if(!s&&!this._event_hooks.any_lz_event)return this;const i=this.getBaseId();let a;if(a=e&&e.sourceID?e:{sourceID:i,target:this,data:e||null},s&&s.forEach((t=>{t.call(this,a)})),"any_lz_event"!==t){const e=Object.assign({event_name:t},a);this.emit("any_lz_event",e)}return this}addPanel(t){if("object"!=typeof t)throw new Error("Invalid panel layout");const e=new Dt(t,this);if(this.panels[e.id]=e,null!==e.layout.y_index&&!isNaN(e.layout.y_index)&&this._panel_ids_by_y_index.length>0)e.layout.y_index<0&&(e.layout.y_index=Math.max(this._panel_ids_by_y_index.length+e.layout.y_index,0)),this._panel_ids_by_y_index.splice(e.layout.y_index,0,e.id),this.applyPanelYIndexesToPanelLayouts();else{const t=this._panel_ids_by_y_index.push(e.id);this.panels[e.id].layout.y_index=t-1}let s=null;return this.layout.panels.forEach(((t,i)=>{t.id===e.id&&(s=i)})),null===s&&(s=this.layout.panels.push(this.panels[e.id].layout)-1),this.panels[e.id]._layout_idx=s,this._initialized&&(this.positionPanels(),this.panels[e.id].initialize(),this.panels[e.id].reMap(),this.setDimensions(this.layout.width,this._total_height)),this.panels[e.id]}clearPanelData(t,e){let s;return e=e||"wipe",s=t?[t]:Object.keys(this.panels),s.forEach((t=>{this.panels[t]._data_layer_ids_by_z_index.forEach((s=>{const i=this.panels[t].data_layers[s];i.destroyAllTooltips(),delete i._layer_state,delete this.layout.state[i._state_id],"reset"===e&&i._setDefaultState()}))})),this}removePanel(t){const e=this.panels[t];if(!e)throw new Error(`Unable to remove panel, ID not found: ${t}`);return this._panel_boundaries.hide(),this.clearPanelData(t),e.loader.hide(),e.toolbar.destroy(!0),e.curtain.hide(),e.svg.container&&e.svg.container.remove(),this.layout.panels.splice(e._layout_idx,1),delete this.panels[t],delete this.layout.state[t],this.layout.panels.forEach(((t,e)=>{this.panels[t.id]._layout_idx=e})),this._panel_ids_by_y_index.splice(this._panel_ids_by_y_index.indexOf(t),1),this.applyPanelYIndexesToPanelLayouts(),this._initialized&&(this.positionPanels(),this.setDimensions(this.layout.width,this._total_height)),this.emit("panel_removed",t),this}refresh(){return this.applyState()}subscribeToData(t,e){const{from_layer:s,namespace:i,data_operations:a,onerror:n}=t,o=n||function(t){console.error("An error occurred while acting on an external callback",t)};if(s){const t=`${this.getBaseId()}.`,i=s.startsWith(t)?s:`${t}${s}`;let a=!1;for(let t of Object.values(this.panels))if(a=Object.values(t.data_layers).some((t=>t.getBaseId()===i)),a)break;if(!a)throw new Error(`Could not subscribe to unknown data layer ${i}`);const n=t=>{if(t.data.layer===i)try{e(t.data.content,this)}catch(t){o(t)}};return this.on("data_from_layer",n),n}if(!i)throw new Error("subscribeToData must specify the desired data: either 'from_layer' or 'namespace' option");const[r,l]=this.lzd.config_to_sources(i,a),h=()=>{try{this.lzd.getData(this.state,r,l).then((t=>e(t,this))).catch(o)}catch(t){o(t)}};return this.on("data_rendered",h),h}applyState(t){if("object"!=typeof(t=t||{}))throw new Error(`applyState only accepts an object; ${typeof t} given`);let e={chr:this.state.chr,start:this.state.start,end:this.state.end};for(let s in t)e[s]=t[s];e=function(t,e){e=e||{};let s,i=!1,a=null;if(void 0!==(t=t||{}).chr&&void 0!==t.start&&void 0!==t.end){if(t.start=Math.max(parseInt(t.start),1),t.end=Math.max(parseInt(t.end),1),isNaN(t.start)&&isNaN(t.end))t.start=1,t.end=1,a=.5,s=0;else if(isNaN(t.start)||isNaN(t.end))a=t.start||t.end,s=0,t.start=isNaN(t.start)?t.end:t.start,t.end=isNaN(t.end)?t.start:t.end;else{if(a=Math.round((t.start+t.end)/2),s=t.end-t.start,s<0){const e=t.start;t.end=t.start,t.start=e,s=t.end-t.start}a<0&&(t.start=1,t.end=1,s=0)}i=!0}return e.min_region_scale&&i&&s<e.min_region_scale&&(t.start=Math.max(a-Math.floor(e.min_region_scale/2),1),t.end=t.start+e.min_region_scale),e.max_region_scale&&i&&s>e.max_region_scale&&(t.start=Math.max(a-Math.floor(e.max_region_scale/2),1),t.end=t.start+e.max_region_scale),t}(e,this.layout);for(let t in e)this.state[t]=e[t];this.emit("data_requested"),this._remap_promises=[],this.loading_data=!0;for(let t in this.panels)this._remap_promises.push(this.panels[t].reMap());return Promise.all(this._remap_promises).catch((t=>{console.error(t),this.curtain.show(t.message||t),this.loading_data=!1})).then((()=>{this.toolbar.update(),this._panel_ids_by_y_index.forEach((t=>{const e=this.panels[t];e.toolbar.update(),e._data_layer_ids_by_z_index.forEach((t=>{e.data_layers[t].applyAllElementStatus()}))})),this.emit("layout_changed"),this.emit("data_rendered"),this.emit("state_changed",t);const{chr:e,start:s,end:i}=this.state;Object.keys(t).some((t=>["chr","start","end"].includes(t)))&&this.emit("region_changed",{chr:e,start:s,end:i}),this.loading_data=!1}))}trackExternalListener(t,e,s){this._external_listeners.has(t)||this._external_listeners.set(t,new Map);const i=this._external_listeners.get(t),a=i.get(e)||[];a.includes(s)||a.push(s),i.set(e,a)}destroy(){for(let[t,e]of this._external_listeners.entries())for(let[s,i]of e)for(let e of i)t.removeEventListener(s,e);const t=this.svg.node().parentNode;if(!t)throw new Error("Plot has already been removed");for(;t.lastElementChild;)t.removeChild(t.lastElementChild);t.outerHTML=t.outerHTML,this._initialized=!1,this.svg=null,this.panels=null}mutateLayout(){Object.values(this.panels).forEach((t=>{Object.values(t.data_layers).forEach((t=>t.mutateLayout()))}))}_canInteract(t){t=t||null;const{_interaction:e}=this;return t?(void 0===e.panel_id||e.panel_id===t)&&!this.loading_data:!(e.dragging||e.zooming||this.loading_data)}_getPageOrigin(){const t=this.svg.node().getBoundingClientRect();let e=document.documentElement.scrollLeft||document.body.scrollLeft,s=document.documentElement.scrollTop||document.body.scrollTop,i=this.svg.node();for(;null!==i.parentNode;)if(i=i.parentNode,i!==document&&"static"!==I.select(i).style("position")){e=-1*i.getBoundingClientRect().left,s=-1*i.getBoundingClientRect().top;break}return{x:e+t.left,y:s+t.top,width:t.width,height:t.height}}getContainerOffset(){const t={top:0,left:0};let e=this.container.offsetParent||null;for(;null!==e;)t.top+=e.offsetTop,t.left+=e.offsetLeft,e=e.offsetParent||null;return t}applyPanelYIndexesToPanelLayouts(){this._panel_ids_by_y_index.forEach(((t,e)=>{this.panels[t].layout.y_index=e}))}getBaseId(){return this.id}rescaleSVG(){const t=this.svg.node().getBoundingClientRect();return this.setDimensions(t.width,t.height),this}initializeLayout(){if(isNaN(this.layout.width)||this.layout.width<=0)throw new Error("Plot layout parameter `width` must be a positive number");return this.layout.responsive_resize=!!this.layout.responsive_resize,this.layout.panels.forEach((t=>{this.addPanel(t)})),this}setDimensions(t,e){if(!isNaN(t)&&t>=0&&!isNaN(e)&&e>=0){const s=e/this._total_height;this.layout.width=Math.max(Math.round(+t),this.layout.min_width),this.layout.responsive_resize&&this.svg&&(this.layout.width=Math.max(this.svg.node().parentNode.getBoundingClientRect().width,this.layout.min_width));let i=0;this._panel_ids_by_y_index.forEach((t=>{const e=this.panels[t],a=this.layout.width,n=e.layout.height*s;e.setDimensions(a,n),e.setOrigin(0,i),i+=n,e.toolbar.update()}))}const s=this._total_height;return null!==this.svg&&(this.svg.attr("viewBox",`0 0 ${this.layout.width} ${s}`),this.svg.attr("width",this.layout.width).attr("height",s)),this._initialized&&(this._panel_boundaries.position(),this.toolbar.update(),this.curtain.update(),this.loader.update()),this.emit("layout_changed")}positionPanels(){const t={left:0,right:0};for(let e of Object.values(this.panels))e.layout.interaction.x_linked&&(t.left=Math.max(t.left,e.layout.margin.left),t.right=Math.max(t.right,e.layout.margin.right));let e=0;return this._panel_ids_by_y_index.forEach((s=>{const i=this.panels[s],a=i.layout;if(i.setOrigin(0,e),e+=this.panels[s].layout.height,a.interaction.x_linked){const e=Math.max(t.left-a.margin.left,0)+Math.max(t.right-a.margin.right,0);a.width+=e,a.margin.left=t.left,a.margin.right=t.right,a.cliparea.origin.x=t.left}})),this.setDimensions(),this._panel_ids_by_y_index.forEach((t=>{const e=this.panels[t];e.setDimensions(this.layout.width,e.layout.height)})),this}initialize(){if(this.layout.responsive_resize){I.select(this.container).classed("lz-container-responsive",!0);const t=()=>this.rescaleSVG();if(window.addEventListener("resize",t),this.trackExternalListener(window,"resize",t),"undefined"!=typeof IntersectionObserver){const t={root:document.documentElement,threshold:.9};new IntersectionObserver(((t,e)=>{t.some((t=>t.intersectionRatio>0))&&this.rescaleSVG()}),t).observe(this.container)}const e=()=>this.setDimensions();window.addEventListener("load",e),this.trackExternalListener(window,"load",e)}if(this.layout.mouse_guide){const t=this.svg.append("g").attr("class","lz-mouse_guide").attr("id",`${this.id}.mouse_guide`),e=t.append("rect").attr("class","lz-mouse_guide-vertical").attr("x",-1),s=t.append("rect").attr("class","lz-mouse_guide-horizontal").attr("y",-1);this._mouse_guide={svg:t,vertical:e,horizontal:s}}this.curtain=_t.call(this),this.loader=pt.call(this),this._panel_boundaries={parent:this,hide_timeout:null,showing:!1,dragging:!1,selectors:[],corner_selector:null,show:function(){if(!this.showing&&!this.parent.curtain.showing){this.showing=!0,this.parent._panel_ids_by_y_index.forEach(((t,e)=>{const s=I.select(this.parent.svg.node().parentNode).insert("div",".lz-data_layer-tooltip").attr("class","lz-panel-boundary").attr("title","Resize panel");s.append("span");const i=I.drag();i.on("start",(()=>{this.dragging=!0})),i.on("end",(()=>{this.dragging=!1})),i.on("drag",(()=>{const t=this.parent.panels[this.parent._panel_ids_by_y_index[e]],s=t.layout.height;t.setDimensions(this.parent.layout.width,t.layout.height+I.event.dy);const i=t.layout.height-s;this.parent._panel_ids_by_y_index.forEach(((t,s)=>{const a=this.parent.panels[this.parent._panel_ids_by_y_index[s]];s>e&&(a.setOrigin(a.layout.origin.x,a.layout.origin.y+i),a.toolbar.position())})),this.parent.positionPanels(),this.position()})),s.call(i),this.parent._panel_boundaries.selectors.push(s)}));const t=I.select(this.parent.svg.node().parentNode).insert("div",".lz-data_layer-tooltip").attr("class","lz-panel-corner-boundary").attr("title","Resize plot");t.append("span").attr("class","lz-panel-corner-boundary-outer"),t.append("span").attr("class","lz-panel-corner-boundary-inner");const e=I.drag();e.on("start",(()=>{this.dragging=!0})),e.on("end",(()=>{this.dragging=!1})),e.on("drag",(()=>{this.parent.setDimensions(this.parent.layout.width+I.event.dx,this.parent._total_height+I.event.dy)})),t.call(e),this.parent._panel_boundaries.corner_selector=t}return this.position()},position:function(){if(!this.showing)return this;const t=this.parent._getPageOrigin();this.selectors.forEach(((e,s)=>{const i=this.parent.panels[this.parent._panel_ids_by_y_index[s]],a=i._getPageOrigin(),n=t.x,o=a.y+i.layout.height-12,r=this.parent.layout.width-1;e.style("top",`${o}px`).style("left",`${n}px`).style("width",`${r}px`),e.select("span").style("width",`${r}px`)}));return this.corner_selector.style("top",t.y+this.parent._total_height-10-16+"px").style("left",t.x+this.parent.layout.width-10-16+"px"),this},hide:function(){return this.showing?(this.showing=!1,this.selectors.forEach((t=>{t.remove()})),this.selectors=[],this.corner_selector.remove(),this.corner_selector=null,this):this}},this.layout.panel_boundaries&&I.select(this.svg.node().parentNode).on(`mouseover.${this.id}.panel_boundaries`,(()=>{clearTimeout(this._panel_boundaries.hide_timeout),this._panel_boundaries.show()})).on(`mouseout.${this.id}.panel_boundaries`,(()=>{this._panel_boundaries.hide_timeout=setTimeout((()=>{this._panel_boundaries.hide()}),300)})),this.toolbar=new Pt(this).show();for(let t in this.panels)this.panels[t].initialize();const t=`.${this.id}`;if(this.layout.mouse_guide){const e=()=>{this._mouse_guide.vertical.attr("x",-1),this._mouse_guide.horizontal.attr("y",-1)},s=()=>{const t=I.mouse(this.svg.node());this._mouse_guide.vertical.attr("x",t[0]),this._mouse_guide.horizontal.attr("y",t[1])};this.svg.on(`mouseout${t}-mouse_guide`,e).on(`touchleave${t}-mouse_guide`,e).on(`mousemove${t}-mouse_guide`,s)}const e=()=>{this.stopDrag()},s=()=>{const{_interaction:t}=this;if(t.dragging){const e=I.mouse(this.svg.node());I.event&&I.event.preventDefault(),t.dragging.dragged_x=e[0]-t.dragging.start_x,t.dragging.dragged_y=e[1]-t.dragging.start_y,this.panels[t.panel_id].render(),t.linked_panel_ids.forEach((t=>{this.panels[t].render()}))}};this.svg.on(`mouseup${t}`,e).on(`touchend${t}`,e).on(`mousemove${t}`,s).on(`touchmove${t}`,s);const i=I.select("body").node();i&&(i.addEventListener("mouseup",e),i.addEventListener("touchend",e),this.trackExternalListener(i,"mouseup",e),this.trackExternalListener(i,"touchend",e)),this.on("match_requested",(t=>{const e=t.data,s=e.active?e.value:null,i=t.target.id;Object.values(this.panels).forEach((t=>{t.id!==i&&Object.values(t.data_layers).forEach((t=>t.destroyAllTooltips(!1)))})),this.applyState({lz_match_value:s})})),this._initialized=!0;const a=this.svg.node().getBoundingClientRect(),n=a.width?a.width:this.layout.width,o=a.height?a.height:this._total_height;return this.setDimensions(n,o),this}startDrag(t,e){t=t||null;let s=null;switch(e=e||null){case"background":case"x_tick":s="x";break;case"y1_tick":s="y1";break;case"y2_tick":s="y2"}if(!(t instanceof Dt&&s&&this._canInteract()))return this.stopDrag();const i=I.mouse(this.svg.node());return this._interaction={panel_id:t.id,linked_panel_ids:t.getLinkedPanelIds(s),dragging:{method:e,start_x:i[0],start_y:i[1],dragged_x:0,dragged_y:0,axis:s}},this.svg.style("cursor","all-scroll"),this}stopDrag(){const{_interaction:t}=this;if(!t.dragging)return this;if("object"!=typeof this.panels[t.panel_id])return this._interaction={},this;const e=this.panels[t.panel_id],s=(t,s,i)=>{e._data_layer_ids_by_z_index.forEach((a=>{const n=e.data_layers[a].layout[`${t}_axis`];n.axis===s&&(n.floor=i[0],n.ceiling=i[1],delete n.lower_buffer,delete n.upper_buffer,delete n.min_extent,delete n.ticks)}))};switch(t.dragging.method){case"background":case"x_tick":0!==t.dragging.dragged_x&&(s("x",1,e.x_extent),this.applyState({start:e.x_extent[0],end:e.x_extent[1]}));break;case"y1_tick":case"y2_tick":if(0!==t.dragging.dragged_y){const i=parseInt(t.dragging.method[1]);s("y",i,e[`y${i}_extent`])}}return this._interaction={},this.svg.style("cursor",null),this}get _total_height(){return this.layout.panels.reduce(((t,e)=>e.height+t),0)}}function qt(t,e,s){const i={0:"",3:"K",6:"M",9:"G"};if(s=s||!1,isNaN(e)||null===e){const s=Math.log(t)/Math.LN10;e=Math.min(Math.max(s-s%3,0),9)}const a=e-Math.floor((Math.log(t)/Math.LN10).toFixed(e+3)),n=Math.min(Math.max(e,0),2),o=Math.min(Math.max(a,n),12);let r=`${(t/Math.pow(10,e)).toFixed(o)}`;return s&&void 0!==i[e]&&(r+=` ${i[e]}b`),r}function Ft(t){let e=t.toUpperCase();e=e.replace(/,/g,"");const s=/([KMG])[B]*$/,i=s.exec(e);let a=1;return i&&(a="M"===i[1]?1e6:"G"===i[1]?1e9:1e3,e=e.replace(s,"")),e=Number(e)*a,e}function Ht(t,e,s){if("object"!=typeof e)throw new Error("invalid arguments: data is not an object");if("string"!=typeof t)throw new Error("invalid arguments: html is not a string");const i=[],a=/{{(?:(#if )?([\w+_:|]+)|(#else)|(\/if))}}/;for(;t.length>0;){const e=a.exec(t);e?0!==e.index?(i.push({text:t.slice(0,e.index)}),t=t.slice(e.index)):"#if "===e[1]?(i.push({condition:e[2]}),t=t.slice(e[0].length)):e[2]?(i.push({variable:e[2]}),t=t.slice(e[0].length)):"#else"===e[3]?(i.push({branch:"else"}),t=t.slice(e[0].length)):"/if"===e[4]?(i.push({close:"if"}),t=t.slice(e[0].length)):(console.error(`Error tokenizing tooltip when remaining template is ${JSON.stringify(t)} and previous tokens are ${JSON.stringify(i)} and current regex match is ${JSON.stringify([e[1],e[2],e[3]])}`),t=t.slice(e[0].length)):(i.push({text:t}),t="")}const n=function(){const t=i.shift();if(void 0!==t.text||t.variable)return t;if(t.condition){let e=t.then=[];for(t.else=[];i.length>0;){if("if"===i[0].close){i.shift();break}"else"===i[0].branch&&(i.shift(),e=t.else),e.push(n())}return t}return console.error(`Error making tooltip AST due to unknown token ${JSON.stringify(t)}`),{text:""}},o=[];for(;i.length>0;)o.push(n());const r=function(t){return Object.prototype.hasOwnProperty.call(r.cache,t)||(r.cache[t]=new K(t).resolve(e,s)),r.cache[t]};r.cache={};const l=function(t){if(void 0!==t.text)return t.text;if(t.variable){try{const e=r(t.variable);if(-1!==["string","number","boolean"].indexOf(typeof e))return e;if(null===e)return""}catch(e){console.error(`Error while processing variable ${JSON.stringify(t.variable)}`)}return`{{${t.variable}}}`}if(t.condition){try{if(r(t.condition))return t.then.map(l).join("");if(t.else)return t.else.map(l).join("")}catch(e){console.error(`Error while processing condition ${JSON.stringify(t.variable)}`)}return""}console.error(`Error rendering tooltip due to unknown AST node ${JSON.stringify(t)}`)};return o.map(l).join("")}const Gt=new h;Gt.add("=",((t,e)=>t===e)),Gt.add("!=",((t,e)=>t!=e)),Gt.add("<",((t,e)=>t<e)),Gt.add("<=",((t,e)=>t<=e)),Gt.add(">",((t,e)=>t>e)),Gt.add(">=",((t,e)=>t>=e)),Gt.add("%",((t,e)=>t%e)),Gt.add("in",((t,e)=>e&&e.includes(t))),Gt.add("match",((t,e)=>t&&t.includes(e)));const Jt=Gt,Zt=(t,e)=>void 0===e||t.field_value!==e?void 0!==t.else?t.else:null:t.then,Kt=(t,e)=>{const s=t.breaks||[],i=t.values||[];if(null==e||isNaN(+e))return t.null_value?t.null_value:null;const a=s.reduce((function(t,s){return+e<t||+e>=t&&+e<s?t:s}));return i[s.indexOf(a)]},Vt=(t,e)=>void 0!==e&&t.categories.includes(e)?t.values[t.categories.indexOf(e)]:t.null_value?t.null_value:null,Wt=(t,e,s)=>{const i=t.values;return i[s%i.length]};let Yt=(t,e,s)=>{const i=t._cache=t._cache||new Map,a=t.max_cache_size||500;if(i.size>=a&&i.clear(),i.has(e))return i.get(e);let n=0;e=String(e);for(let t=0;t<e.length;t++){n=(n<<5)-n+e.charCodeAt(t),n|=0}const o=t.values,r=o[Math.abs(n)%o.length];return i.set(e,r),r};const Xt=(t,e)=>{var s=t.breaks||[],i=t.values||[],a=t.null_value?t.null_value:null;if(s.length<2||s.length!==i.length)return a;if(null==e||isNaN(+e))return a;if(+e<=t.breaks[0])return i[0];if(+e>=t.breaks[t.breaks.length-1])return i[s.length-1];{var n=null;if(s.forEach((function(t,i){i&&s[i-1]<=+e&&s[i]>=+e&&(n=i)})),null===n)return a;const t=(+e-s[n-1])/(s[n]-s[n-1]);return isFinite(t)?I.interpolate(i[n-1],i[n])(t):a}};function Qt(t,e){if(void 0===e)return null;const{beta_field:s,stderr_beta_field:i,"+":a=null,"-":n=null}=t;if(!s||!i)throw new Error("effect_direction must specify how to find required 'beta' and 'stderr_beta' fields");const o=e[s],r=e[i];if(void 0!==o)if(void 0!==r){if(o-1.96*r>0)return a;if(o+1.96*r<0)return n||null}else{if(o>0)return a;if(o<0)return n}return null}const te=new h;for(let[t,e]of Object.entries(n))te.add(t,e);te.add("if",Zt);const ee=te,se={id:"",type:"",tag:"custom_data_type",namespace:{},data_operations:[],id_field:"id",filters:null,match:{},x_axis:{},y_axis:{},legend:null,tooltip:{},tooltip_positioning:"horizontal",behaviors:{}};class ie{constructor(t,e){this._initialized=!1,this._layout_idx=null,this.id=null,this._base_id=null,this.parent=e||null,this.svg={},this.parent_plot=null,e&&(this.parent_plot=e.parent),this.layout=at(t||{},se),this.layout.id&&(this.id=this.layout.id),this._filter_func=null,this.layout.x_axis!=={}&&"number"!=typeof this.layout.x_axis.axis&&(this.layout.x_axis.axis=1),this.layout.y_axis!=={}&&"number"!=typeof this.layout.y_axis.axis&&(this.layout.y_axis.axis=1),this._base_layout=nt(this.layout),this.state={},this._state_id=null,this._layer_state=null,this._setDefaultState(),this.data=[],this.layout.tooltip&&(this._tooltips={}),this._global_statuses={highlighted:!1,selected:!1,faded:!1,hidden:!1},this._data_contract=new Set,this._entities=new Map,this._dependencies=[],this.mutateLayout()}render(){throw new Error("Method must be implemented")}moveForward(){const t=this.parent._data_layer_ids_by_z_index,e=this.layout.z_index;return t[e+1]&&(t[e]=t[e+1],t[e+1]=this.id,this.parent.resortDataLayers()),this}moveBack(){const t=this.parent._data_layer_ids_by_z_index,e=this.layout.z_index;return t[e-1]&&(t[e]=t[e-1],t[e-1]=this.id,this.parent.resortDataLayers()),this}setElementAnnotation(t,e,s){const i=this.getElementId(t);return this._layer_state.extra_fields[i]||(this._layer_state.extra_fields[i]={}),this._layer_state.extra_fields[i][e]=s,this}setFilter(t){console.warn("The setFilter method is deprecated and will be removed in the future; please use the layout API with a custom filter function instead"),this._filter_func=t}mutateLayout(){if(this.parent_plot){const{namespace:t,data_operations:e}=this.layout;this._data_contract=rt(this.layout,Object.keys(t));const[s,i]=this.parent_plot.lzd.config_to_sources(t,e,this);this._entities=s,this._dependencies=i}}_getDataExtent(t,e){return t=t||this.data,I.extent(t,(t=>+new K(e.field).resolve(t)))}getElementId(t){const e=Symbol.for("lzID");if(t[e])return t[e];const s=this.layout.id_field;let i=t[s];if(void 0===i&&/{{[^{}]*}}/.test(s)&&(i=Ht(s,t,{})),null==i)throw new Error("Unable to generate element ID");const a=i.toString().replace(/\W/g,""),n=`${this.getBaseId()}-${a}`.replace(/([:.[\],])/g,"_");return t[e]=n,n}getElementStatusNodeId(t){return null}getElementById(t){const e=I.select(`#${t.replace(/([:.[\],])/g,"\\$1")}`);return!e.empty()&&e.data()&&e.data().length?e.data()[0]:null}applyDataMethods(){const t=this.layout.match&&this.layout.match.receive,e=Jt.get(this.layout.match&&this.layout.match.operator||"="),s=this.parent_plot.state.lz_match_value,i=t?new K(t):null;if(this.data.length&&this._data_contract.size){const t=new Set(this._data_contract);for(let e of this.data)if(Object.keys(e).forEach((e=>t.delete(e))),!t.size)break;t.size&&console.debug(`Data layer '${this.getBaseId()}' did not receive all expected fields from retrieved data. Missing fields are: ${[...t]}\n  Common reasons for this error include API payloads with missing fields, or data layer layouts that use two kinds of data and need join logic in "data_operations"                \n  If this field is optional, you can safely ignore this message. Examples include {{#if value}} tags or conditional color rules.\n`)}return this.data.forEach(((a,n)=>{t&&null!=s&&(a.lz_is_match=e(i.resolve(a),s)),a.getDataLayer=()=>this,a.getPanel=()=>this.parent||null,a.getPlot=()=>{const t=this.parent;return t?t.parent:null}})),this.applyCustomDataMethods(),this}applyCustomDataMethods(){return this}resolveScalableParameter(t,e,s){let i=null;if(Array.isArray(t)){let a=0;for(;null===i&&a<t.length;)i=this.resolveScalableParameter(t[a],e,s),a++}else switch(typeof t){case"number":case"string":i=t;break;case"object":if(t.scale_function){const a=ee.get(t.scale_function);if(t.field){const n=new K(t.field);let o;try{o=this.getElementAnnotation(e)}catch(t){o=null}i=a(t.parameters||{},n.resolve(e,o),s)}else i=a(t.parameters||{},e,s)}}return i}getAxisExtent(t){if(!["x","y"].includes(t))throw new Error("Invalid dimension identifier");const e=`${t}_axis`,s=this.layout[e];if(!isNaN(s.floor)&&!isNaN(s.ceiling))return[+s.floor,+s.ceiling];let i=[];if(s.field&&this.data){if(this.data.length){i=this._getDataExtent(this.data,s);const t=i[1]-i[0];if(isNaN(s.lower_buffer)||(i[0]-=t*s.lower_buffer),isNaN(s.upper_buffer)||(i[1]+=t*s.upper_buffer),"object"==typeof s.min_extent){const t=s.min_extent[0],e=s.min_extent[1];isNaN(t)||isNaN(e)||(i[0]=Math.min(i[0],t)),isNaN(e)||(i[1]=Math.max(i[1],e))}return[isNaN(s.floor)?i[0]:s.floor,isNaN(s.ceiling)?i[1]:s.ceiling]}return i=s.min_extent||[],i}return"x"!==t||isNaN(this.state.start)||isNaN(this.state.end)?[]:[this.state.start,this.state.end]}getTicks(t,e){if(!["x","y1","y2"].includes(t))throw new Error(`Invalid dimension identifier ${t}`);return[]}_getTooltipPosition(t){const e=this.parent,s=e[`y${this.layout.y_axis.axis}_scale`],i=e[`y${this.layout.y_axis.axis}_extent`],a=e.x_scale(e.x_extent[0]),n=s(i[0]);return{x_min:a,x_max:a,y_min:n,y_max:n}}_drawTooltip(t,e,s,i,a,n){const o=this.parent.layout,r=this.parent_plot.layout,l=this.layout,h=this._getPageOrigin(),c=t.selector.node().getBoundingClientRect(),d=o.height-(o.margin.top+o.margin.bottom),u=r.width-(o.margin.left+o.margin.right),_=((s=Math.max(s,0))+(i=Math.min(i,u)))/2,p=((a=Math.max(a,0))+(n=Math.min(n,d)))/2;let g,y,f,m,b,x=i-_,v=n-p,w=l.tooltip_positioning;if("vertical"===w?(x=0,w=c.height+8>d-(p+v)?"top":"bottom"):"horizontal"===w&&(v=0,w=_<=r.width/2?"left":"right"),"top"===w||"bottom"===w){const t=Math.max(c.width/2-_,0),e=Math.max(c.width/2+_-u,0);y=h.x+_-c.width/2-e+t,b=h.x+_-y-7,"top"===w?(g=h.y+p-(v+c.height+8),f="down",m=c.height-1):(g=h.y+p+v+8,f="up",m=-8)}else{if("left"!==w&&"right"!==w)throw new Error("Unrecognized placement value");"left"===w?(y=h.x+_+x+8,f="left",b=-8):(y=h.x+_-c.width-x-8,f="right",b=c.width-1),p-c.height/2<=0?(g=h.y+p-10.5-6,m=6):p+c.height/2>=d?(g=h.y+p+7+6-c.height,m=c.height-14-6):(g=h.y+p-c.height/2,m=c.height/2-7)}return t.selector.style("left",`${y}px`).style("top",`${g}px`),t.arrow||(t.arrow=t.selector.append("div").style("position","absolute")),t.arrow.attr("class",`lz-data_layer-tooltip-arrow_${f}`).style("left",`${b}px`).style("top",`${m}px`),this}filter(t,e,s,i){let a=!0;return t.forEach((t=>{const{field:s,operator:i,value:n}=t,o=Jt.get(i),r=this.getElementAnnotation(e);o(s?new K(s).resolve(e,r):e,n)||(a=!1)})),a}getElementAnnotation(t,e){const s=this.getElementId(t),i=this._layer_state.extra_fields[s];return e?i&&i[e]:i}_applyFilters(t){return t=t||this.data,this._filter_func?t=t.filter(this._filter_func):this.layout.filters&&(t=t.filter(this.filter.bind(this,this.layout.filters))),t}_setDefaultState(){const t={status_flags:{},extra_fields:{}},e=t.status_flags;C.adjectives.forEach((t=>{e[t]=e[t]||new Set})),e.has_tooltip=e.has_tooltip||new Set,this.parent&&(this._state_id=`${this.parent.id}.${this.id}`,this.state=this.parent.state,this.state[this._state_id]=t),this._layer_state=t}getBaseId(){return this._base_id?this._base_id:this.parent?`${this.parent_plot.id}.${this.parent.id}.${this.id}`:(this.id||"").toString()}getAbsoluteDataHeight(){return this.svg.group.node().getBoundingClientRect().height}initialize(){this._base_id=this.getBaseId();const t=this.getBaseId();return this.svg.container=this.parent.svg.group.append("g").attr("class","lz-data_layer-container").attr("id",`${t}.data_layer_container`),this.svg.clipRect=this.svg.container.append("clipPath").attr("id",`${t}.clip`).append("rect"),this.svg.group=this.svg.container.append("g").attr("id",`${t}.data_layer`).attr("clip-path",`url(#${t}.clip)`),this}createTooltip(t){if("object"!=typeof this.layout.tooltip)throw new Error(`DataLayer [${this.id}] layout does not define a tooltip`);const e=this.getElementId(t);if(!this._tooltips[e])return this._tooltips[e]={data:t,arrow:null,selector:I.select(this.parent_plot.svg.node().parentNode).append("div").attr("class","lz-data_layer-tooltip").attr("id",`${e}-tooltip`)},this._layer_state.status_flags.has_tooltip.add(e),this.updateTooltip(t),this;this.positionTooltip(e)}updateTooltip(t,e){return void 0===e&&(e=this.getElementId(t)),this._tooltips[e].selector.html(""),this._tooltips[e].arrow=null,this.layout.tooltip.html&&this._tooltips[e].selector.html(Ht(this.layout.tooltip.html,t,this.getElementAnnotation(t))),this.layout.tooltip.closable&&this._tooltips[e].selector.insert("button",":first-child").attr("class","lz-tooltip-close-button").attr("title","Close").text("×").on("click",(()=>{this.destroyTooltip(e)})),this._tooltips[e].selector.data([t]),this.positionTooltip(e),this}destroyTooltip(t,e){let s;if(s="string"==typeof t?t:this.getElementId(t),this._tooltips[s]&&("object"==typeof this._tooltips[s].selector&&this._tooltips[s].selector.remove(),delete this._tooltips[s]),!e){this._layer_state.status_flags.has_tooltip.delete(s)}return this}destroyAllTooltips(t=!0){for(let e in this._tooltips)this.destroyTooltip(e,t);return this}positionTooltip(t){if("string"!=typeof t)throw new Error("Unable to position tooltip: id is not a string");if(!this._tooltips[t])throw new Error("Unable to position tooltip: id does not point to a valid tooltip");const e=this._tooltips[t],s=this._getTooltipPosition(e);if(!s)return null;this._drawTooltip(e,this.layout.tooltip_positioning,s.x_min,s.x_max,s.y_min,s.y_max)}positionAllTooltips(){for(let t in this._tooltips)this.positionTooltip(t);return this}showOrHideTooltip(t,e){const s=this.layout.tooltip;if("object"!=typeof s)return this;const i=this.getElementId(t),a=(t,e,s)=>{let i=null;if("object"!=typeof t||null===t)return null;if(Array.isArray(e))s=s||"and",i=1===e.length?t[e[0]]:e.reduce(((e,i)=>"and"===s?t[e]&&t[i]:"or"===s?t[e]||t[i]:null));else{if("object"!=typeof e)return!1;{let n;for(let o in e)n=a(t,e[o],o),null===i?i=n:"and"===s?i=i&&n:"or"===s&&(i=i||n)}}return i};let n={};"string"==typeof s.show?n={and:[s.show]}:"object"==typeof s.show&&(n=s.show);let o={};"string"==typeof s.hide?o={and:[s.hide]}:"object"==typeof s.hide&&(o=s.hide);const r=this._layer_state;var l={};C.adjectives.forEach((t=>{const e=`un${t}`;l[t]=r.status_flags[t].has(i),l[e]=!l[t]}));const h=a(l,n),c=a(l,o),d=r.status_flags.has_tooltip.has(i);return!h||!e&&!d||c?this.destroyTooltip(t):this.createTooltip(t),this}setElementStatus(t,e,s,i){if("has_tooltip"===t)return this;let a;void 0===s&&(s=!0);try{a=this.getElementId(e)}catch(t){return this}i&&this.setAllElementStatus(t,!s),I.select(`#${a}`).classed(`lz-data_layer-${this.layout.type}-${t}`,s);const n=this.getElementStatusNodeId(e);null!==n&&I.select(`#${n}`).classed(`lz-data_layer-${this.layout.type}-statusnode-${t}`,s);const o=!this._layer_state.status_flags[t].has(a);s&&o&&this._layer_state.status_flags[t].add(a),s||o||this._layer_state.status_flags[t].delete(a),this.showOrHideTooltip(e,o),o&&this.parent.emit("layout_changed",!0);const r="selected"===t;!r||!o&&s||this.parent.emit("element_selection",{element:e,active:s},!0);const l=this.layout.match&&this.layout.match.send;return!r||void 0===l||!o&&s||this.parent.emit("match_requested",{value:new K(l).resolve(e),active:s},!0),this}setAllElementStatus(t,e){if(void 0===t||!C.adjectives.includes(t))throw new Error("Invalid status");if(void 0===this._layer_state.status_flags[t])return this;if(void 0===e&&(e=!0),e)this.data.forEach((e=>this.setElementStatus(t,e,!0)));else{new Set(this._layer_state.status_flags[t]).forEach((e=>{const s=this.getElementById(e);"object"==typeof s&&null!==s&&this.setElementStatus(t,s,!1)})),this._layer_state.status_flags[t]=new Set}return this._global_statuses[t]=e,this}applyBehaviors(t){"object"==typeof this.layout.behaviors&&Object.keys(this.layout.behaviors).forEach((e=>{const s=/(click|mouseover|mouseout)/.exec(e);s&&t.on(`${s[0]}.${e}`,this.executeBehaviors(e,this.layout.behaviors[e]))}))}executeBehaviors(t,e){const s=t.includes("ctrl"),i=t.includes("shift"),a=this;return function(t){t=t||I.select(I.event.target).datum(),s===!!I.event.ctrlKey&&i===!!I.event.shiftKey&&e.forEach((e=>{if("object"==typeof e&&null!==e)switch(e.action){case"set":a.setElementStatus(e.status,t,!0,e.exclusive);break;case"unset":a.setElementStatus(e.status,t,!1,e.exclusive);break;case"toggle":var s=a._layer_state.status_flags[e.status].has(a.getElementId(t)),i=e.exclusive&&!s;a.setElementStatus(e.status,t,!s,i);break;case"link":if("string"==typeof e.href){const s=Ht(e.href,t,a.getElementAnnotation(t));"string"==typeof e.target?window.open(s,e.target):window.location.href=s}}}))}}_getPageOrigin(){const t=this.parent._getPageOrigin();return{x:t.x+this.parent.layout.margin.left,y:t.y+this.parent.layout.margin.top}}applyAllElementStatus(){const t=this._layer_state.status_flags,e=this;for(let s in t)Object.prototype.hasOwnProperty.call(t,s)&&t[s].forEach((t=>{try{this.setElementStatus(s,this.getElementById(t),!0)}catch(t){console.warn(`Unable to apply state: ${e._state_id}, ${s}`),console.error(t)}}))}draw(){return this.svg.container.attr("transform",`translate(${this.parent.layout.cliparea.origin.x}, ${this.parent.layout.cliparea.origin.y})`),this.svg.clipRect.attr("width",this.parent.layout.cliparea.width).attr("height",this.parent.layout.cliparea.height),this.positionAllTooltips(),this}reMap(){return this.destroyAllTooltips(),this.parent_plot.lzd.getData(this.state,this._entities,this._dependencies).then((t=>{this.data=t,this.applyDataMethods(),this._initialized=!0,this.parent.emit("data_from_layer",{layer:this.getBaseId(),content:nt(t)},!0)}))}}C.verbs.forEach(((t,e)=>{const s=C.adjectives[e],i=`un${t}`;ie.prototype[`${t}Element`]=function(t,e=!1){return e=!!e,this.setElementStatus(s,t,!0,e),this},ie.prototype[`${i}Element`]=function(t,e){return e=void 0!==e&&!!e,this.setElementStatus(s,t,!1,e),this},ie.prototype[`${t}AllElements`]=function(){return this.setAllElementStatus(s,!0),this},ie.prototype[`${i}AllElements`]=function(){return this.setAllElementStatus(s,!1),this}}));const ae={color:"#000000",filters:null,tooltip_positioning:"vertical",hitarea_width:8};class ne extends ie{constructor(t){if(!Array.isArray(t.filters))throw new Error("Annotation track must specify array of filters for selecting points to annotate");at(t,ae),super(...arguments)}initialize(){super.initialize(),this._hitareas_group=this.svg.group.append("g").attr("class",`lz-data_layer-${this.layout.type}-hit_areas`),this._visible_lines_group=this.svg.group.append("g").attr("class",`lz-data_layer-${this.layout.type}-visible_lines`)}render(){const t=this._applyFilters(),e=this._hitareas_group.selectAll(`rect.lz-data_layer-${this.layout.type}`).data(t,(t=>t[this.layout.id_field])),s=(e,s)=>{const i=this.parent.x_scale(e[this.layout.x_axis.field]);let a=i-this.layout.hitarea_width/2;if(s>=1){const e=t[s-1],n=this.parent.x_scale(e[this.layout.x_axis.field]);a=Math.max(a,(i+n)/2)}return[a,i]};e.enter().append("rect").attr("class",`lz-data_layer-${this.layout.type}`).merge(e).attr("id",(t=>this.getElementId(t))).attr("height",this.parent.layout.height).attr("opacity",0).attr("x",((t,e)=>s(t,e)[0])).attr("width",((t,e)=>{const i=s(t,e);return i[1]-i[0]+this.layout.hitarea_width/2}));const i=this._visible_lines_group.selectAll(`rect.lz-data_layer-${this.layout.type}`).data(t,(t=>t[this.layout.id_field]));i.enter().append("rect").attr("class",`lz-data_layer-${this.layout.type}`).merge(i).attr("id",(t=>this.getElementId(t))).attr("x",(t=>this.parent.x_scale(t[this.layout.x_axis.field])-.5)).attr("width",1).attr("height",this.parent.layout.height).attr("fill",((t,e)=>this.resolveScalableParameter(this.layout.color,t,e))),i.exit().remove(),this.svg.group.call(this.applyBehaviors.bind(this)),e.exit().remove()}_getTooltipPosition(t){const e=this.parent,s=e.layout.height-(e.layout.margin.top+e.layout.margin.bottom),i=e.x_scale(t.data[this.layout.x_axis.field]),a=s/2;return{x_min:i-1,x_max:i+1,y_min:a-e.layout.margin.top,y_max:a+e.layout.margin.bottom}}}const oe={color:"#CCCCCC",fill_opacity:.5,filters:null,regions:[],id_field:"id",start_field:"start",end_field:"end",merge_field:null};class re extends ie{constructor(t){if(at(t,oe),t.interaction||t.behaviors)throw new Error("highlight_regions layer does not support mouse events");if(t.regions.length&&t.namespace&&Object.keys(t.namespace).length)throw new Error('highlight_regions layer can specify "regions" in layout, OR external data "fields", but not both');super(...arguments)}_mergeNodes(t){const{end_field:e,merge_field:s,start_field:i}=this.layout;if(!s)return t;t.sort(((t,e)=>I.ascending(t[s],e[s])||I.ascending(t[i],e[i])));let a=[];return t.forEach((function(t,n){const o=a[a.length-1]||t;if(t[s]===o[s]&&t[i]<=o[e]){const s=Math.min(o[i],t[i]),n=Math.max(o[e],t[e]);t=Object.assign({},o,t,{[i]:s,[e]:n}),a.pop()}a.push(t)})),a}render(){const{x_scale:t}=this.parent;let e=this.layout.regions.length?this.layout.regions:this.data;e.forEach(((t,e)=>t.id||(t.id=e))),e=this._applyFilters(e),e=this._mergeNodes(e);const s=this.svg.group.selectAll(`rect.lz-data_layer-${this.layout.type}`).data(e);s.enter().append("rect").attr("class",`lz-data_layer-${this.layout.type}`).merge(s).attr("id",(t=>this.getElementId(t))).attr("x",(e=>t(e[this.layout.start_field]))).attr("width",(e=>t(e[this.layout.end_field])-t(e[this.layout.start_field]))).attr("height",this.parent.layout.height).attr("fill",((t,e)=>this.resolveScalableParameter(this.layout.color,t,e))).attr("fill-opacity",((t,e)=>this.resolveScalableParameter(this.layout.fill_opacity,t,e))),s.exit().remove(),this.svg.group.style("pointer-events","none")}_getTooltipPosition(t){throw new Error("This layer does not support tooltips")}}const le={color:"seagreen",hitarea_width:"10px",style:{fill:"none","stroke-width":"1px","stroke-opacity":"100%"},tooltip_positioning:"top"};class he extends ie{constructor(t){t=at(t,le),super(...arguments)}render(){const t=this,e=t.layout,s=t.parent.x_scale,i=t.parent[`y${e.y_axis.axis}_scale`],a=this._applyFilters();function n(t){const a=t[e.x_axis.field1],n=t[e.x_axis.field2],o=(a+n)/2,r=[[s(a),i(0)],[s(o),i(t[e.y_axis.field])],[s(n),i(0)]];return I.line().x((t=>t[0])).y((t=>t[1])).curve(I.curveNatural)(r)}const o=this.svg.group.selectAll("path.lz-data_layer-arcs-hitarea").data(a,(t=>this.getElementId(t))),r=this.svg.group.selectAll("path.lz-data_layer-arcs").data(a,(t=>this.getElementId(t)));return this.svg.group.call(gt,e.style),o.enter().append("path").attr("class","lz-data_layer-arcs-hitarea").merge(o).attr("id",(t=>this.getElementId(t))).style("fill","none").style("stroke-width",e.hitarea_width).style("stroke-opacity",0).style("stroke","transparent").attr("d",(t=>n(t))),r.enter().append("path").attr("class","lz-data_layer-arcs").merge(r).attr("id",(t=>this.getElementId(t))).attr("stroke",((t,e)=>this.resolveScalableParameter(this.layout.color,t,e))).attr("d",((t,e)=>n(t))),r.exit().remove(),o.exit().remove(),this.svg.group.call(this.applyBehaviors.bind(this)),this}_getTooltipPosition(t){const e=this.parent,s=this.layout,i=t.data[s.x_axis.field1],a=t.data[s.x_axis.field2],n=e[`y${s.y_axis.axis}_scale`];return{x_min:e.x_scale(Math.min(i,a)),x_max:e.x_scale(Math.max(i,a)),y_min:n(t.data[s.y_axis.field]),y_max:n(0)}}}const ce={stroke:"rgb(54, 54, 150)",color:"#363696",label_font_size:15,label_exon_spacing:3,exon_height:10,bounding_box_padding:3,track_vertical_spacing:5,tooltip_positioning:"top"};class de extends ie{constructor(t){t=at(t,ce),super(...arguments),this.transcript_idx=0,this.tracks=1,this.gene_track_index={1:[]}}getElementStatusNodeId(t){return`${this.getElementId(t)}-statusnode`}getTrackHeight(){return 2*this.layout.bounding_box_padding+this.layout.label_font_size+this.layout.label_exon_spacing+this.layout.exon_height+this.layout.track_vertical_spacing}assignTracks(t){const e=(t,e)=>{try{const s=this.svg.group.append("text").attr("x",0).attr("y",0).attr("class","lz-data_layer-genes lz-label").style("font-size",e).text(`${t}→`),i=s.node().getBBox().width;return s.remove(),i}catch(t){return 0}};return this.tracks=1,this.gene_track_index={1:[]},t.filter((t=>!(t.end<this.state.start||t.start>this.state.end))).map((t=>{if(t.gene_id&&t.gene_id.indexOf(".")){const e=t.gene_id.split(".");t.gene_id=e[0],t.gene_version=e[1]}if(t.transcript_id=t.transcripts[this.transcript_idx].transcript_id,t.display_range={start:this.parent.x_scale(Math.max(t.start,this.state.start)),end:this.parent.x_scale(Math.min(t.end,this.state.end))},t.display_range.label_width=e(t.gene_name,this.layout.label_font_size),t.display_range.width=t.display_range.end-t.display_range.start,t.display_range.text_anchor="middle",t.display_range.width<t.display_range.label_width){if(t.start<this.state.start)t.display_range.end=t.display_range.start+t.display_range.label_width+this.layout.label_font_size,t.display_range.text_anchor="start";else if(t.end>this.state.end)t.display_range.start=t.display_range.end-t.display_range.label_width-this.layout.label_font_size,t.display_range.text_anchor="end";else{const e=(t.display_range.label_width-t.display_range.width)/2+this.layout.label_font_size;t.display_range.start-e<this.parent.x_scale(this.state.start)?(t.display_range.start=this.parent.x_scale(this.state.start),t.display_range.end=t.display_range.start+t.display_range.label_width,t.display_range.text_anchor="start"):t.display_range.end+e>this.parent.x_scale(this.state.end)?(t.display_range.end=this.parent.x_scale(this.state.end),t.display_range.start=t.display_range.end-t.display_range.label_width,t.display_range.text_anchor="end"):(t.display_range.start-=e,t.display_range.end+=e)}t.display_range.width=t.display_range.end-t.display_range.start}t.display_range.start-=this.layout.bounding_box_padding,t.display_range.end+=this.layout.bounding_box_padding,t.display_range.width+=2*this.layout.bounding_box_padding,t.display_domain={start:this.parent.x_scale.invert(t.display_range.start),end:this.parent.x_scale.invert(t.display_range.end)},t.display_domain.width=t.display_domain.end-t.display_domain.start,t.track=null;let s=1;for(;null===t.track;){let e=!1;this.gene_track_index[s].map((s=>{if(!e){const i=Math.min(s.display_range.start,t.display_range.start);Math.max(s.display_range.end,t.display_range.end)-i<s.display_range.width+t.display_range.width&&(e=!0)}})),e?(s++,s>this.tracks&&(this.tracks=s,this.gene_track_index[s]=[])):(t.track=s,this.gene_track_index[s].push(t))}return t.parent=this,t.transcripts.map(((e,s)=>{t.transcripts[s].parent=t,t.transcripts[s].exons.map(((e,i)=>t.transcripts[s].exons[i].parent=t.transcripts[s]))})),t}))}render(){const t=this;let e,s=this._applyFilters();s=this.assignTracks(s);const i=this.svg.group.selectAll("g.lz-data_layer-genes").data(s,(t=>t.gene_name));i.enter().append("g").attr("class","lz-data_layer-genes").merge(i).attr("id",(t=>this.getElementId(t))).each((function(s){const i=s.parent,a=I.select(this).selectAll("rect.lz-data_layer-genes.lz-data_layer-genes-statusnode").data([s],(t=>i.getElementStatusNodeId(t)));e=i.getTrackHeight()-i.layout.track_vertical_spacing,a.enter().append("rect").attr("class","lz-data_layer-genes lz-data_layer-genes-statusnode").merge(a).attr("id",(t=>i.getElementStatusNodeId(t))).attr("rx",i.layout.bounding_box_padding).attr("ry",i.layout.bounding_box_padding).attr("width",(t=>t.display_range.width)).attr("height",e).attr("x",(t=>t.display_range.start)).attr("y",(t=>(t.track-1)*i.getTrackHeight())),a.exit().remove();const n=I.select(this).selectAll("rect.lz-data_layer-genes.lz-boundary").data([s],(t=>`${t.gene_name}_boundary`));e=1,n.enter().append("rect").attr("class","lz-data_layer-genes lz-boundary").merge(n).attr("width",(t=>i.parent.x_scale(t.end)-i.parent.x_scale(t.start))).attr("height",e).attr("x",(t=>i.parent.x_scale(t.start))).attr("y",(t=>(t.track-1)*i.getTrackHeight()+i.layout.bounding_box_padding+i.layout.label_font_size+i.layout.label_exon_spacing+Math.max(i.layout.exon_height,3)/2)).style("fill",((e,s)=>t.resolveScalableParameter(t.layout.color,e,s))).style("stroke",((e,s)=>t.resolveScalableParameter(t.layout.stroke,e,s))),n.exit().remove();const o=I.select(this).selectAll("text.lz-data_layer-genes.lz-label").data([s],(t=>`${t.gene_name}_label`));o.enter().append("text").attr("class","lz-data_layer-genes lz-label").merge(o).attr("text-anchor",(t=>t.display_range.text_anchor)).text((t=>"+"===t.strand?`${t.gene_name}→`:`←${t.gene_name}`)).style("font-size",s.parent.layout.label_font_size).attr("x",(t=>"middle"===t.display_range.text_anchor?t.display_range.start+t.display_range.width/2:"start"===t.display_range.text_anchor?t.display_range.start+i.layout.bounding_box_padding:"end"===t.display_range.text_anchor?t.display_range.end-i.layout.bounding_box_padding:void 0)).attr("y",(t=>(t.track-1)*i.getTrackHeight()+i.layout.bounding_box_padding+i.layout.label_font_size)),o.exit().remove();const r=I.select(this).selectAll("rect.lz-data_layer-genes.lz-exon").data(s.transcripts[s.parent.transcript_idx].exons,(t=>t.exon_id));e=i.layout.exon_height,r.enter().append("rect").attr("class","lz-data_layer-genes lz-exon").merge(r).style("fill",((e,s)=>t.resolveScalableParameter(t.layout.color,e.parent.parent,s))).style("stroke",((e,s)=>t.resolveScalableParameter(t.layout.stroke,e.parent.parent,s))).attr("width",(t=>i.parent.x_scale(t.end)-i.parent.x_scale(t.start))).attr("height",e).attr("x",(t=>i.parent.x_scale(t.start))).attr("y",(()=>(s.track-1)*i.getTrackHeight()+i.layout.bounding_box_padding+i.layout.label_font_size+i.layout.label_exon_spacing)),r.exit().remove();const l=I.select(this).selectAll("rect.lz-data_layer-genes.lz-clickarea").data([s],(t=>`${t.gene_name}_clickarea`));e=i.getTrackHeight()-i.layout.track_vertical_spacing,l.enter().append("rect").attr("class","lz-data_layer-genes lz-clickarea").merge(l).attr("id",(t=>`${i.getElementId(t)}_clickarea`)).attr("rx",i.layout.bounding_box_padding).attr("ry",i.layout.bounding_box_padding).attr("width",(t=>t.display_range.width)).attr("height",e).attr("x",(t=>t.display_range.start)).attr("y",(t=>(t.track-1)*i.getTrackHeight())),l.exit().remove()})),i.exit().remove(),this.svg.group.on("click.event_emitter",(t=>this.parent.emit("element_clicked",t,!0))).call(this.applyBehaviors.bind(this))}_getTooltipPosition(t){const e=this.getElementStatusNodeId(t.data),s=I.select(`#${e}`).node().getBBox();return{x_min:this.parent.x_scale(t.data.start),x_max:this.parent.x_scale(t.data.end),y_min:s.y,y_max:s.y+s.height}}}const ue={style:{fill:"none","stroke-width":"2px"},interpolate:"curveLinear",x_axis:{field:"x"},y_axis:{field:"y",axis:1},hitarea_width:5,tooltip:null};class _e extends ie{constructor(t){if((t=at(t,ue)).tooltip)throw new Error("The line / filled curve layer does not support tooltips");super(...arguments)}render(){const t=this.parent,e=this.layout.x_axis.field,s=this.layout.y_axis.field,i=this.svg.group.selectAll("path.lz-data_layer-line").data([this.data]);let a;this.path=i.enter().append("path").attr("class","lz-data_layer-line");const n=t.x_scale,o=t[`y${this.layout.y_axis.axis}_scale`];a=this.layout.style.fill&&"none"!==this.layout.style.fill?I.area().x((t=>+n(t[e]))).y0(+o(0)).y1((t=>+o(t[s]))):I.line().x((t=>+n(t[e]))).y((t=>+o(t[s]))).curve(I[this.layout.interpolate]),i.merge(this.path).attr("d",a).call(gt,this.layout.style),i.exit().remove()}setElementStatus(t,e,s){return this.setAllElementStatus(t,s)}setAllElementStatus(t,e){if(void 0===t||!C.adjectives.includes(t))throw new Error("Invalid status");if(void 0===this._layer_state.status_flags[t])return this;void 0===e&&(e=!0),this._global_statuses[t]=e;let s="lz-data_layer-line";return Object.keys(this._global_statuses).forEach((t=>{this._global_statuses[t]&&(s+=` lz-data_layer-line-${t}`)})),this.path.attr("class",s),this.parent.emit("layout_changed",!0),this}}const pe={style:{stroke:"#D3D3D3","stroke-width":"3px","stroke-dasharray":"10px 10px"},orientation:"horizontal",x_axis:{axis:1,decoupled:!0},y_axis:{axis:1,decoupled:!0},tooltip_positioning:"vertical",offset:0};class ge extends ie{constructor(t){t=at(t,pe),["horizontal","vertical"].includes(t.orientation)||(t.orientation="horizontal"),super(...arguments)}getElementId(t){return this.getBaseId()}render(){const t=this.parent,e=`y${this.layout.y_axis.axis}_scale`,s=`y${this.layout.y_axis.axis}_extent`;if("horizontal"===this.layout.orientation)this.data=[{x:t.x_extent[0],y:this.layout.offset},{x:t.x_extent[1],y:this.layout.offset}];else{if("vertical"!==this.layout.orientation)throw new Error('Unrecognized vertical line type. Must be "vertical" or "horizontal"');this.data=[{x:this.layout.offset,y:t[s][0]},{x:this.layout.offset,y:t[s][1]}]}const i=this.svg.group.selectAll("path.lz-data_layer-line").data([this.data]),a=[t.layout.cliparea.height,0],n=I.line().x(((e,s)=>{const i=+t.x_scale(e.x);return isNaN(i)?t.x_range[s]:i})).y(((s,i)=>{const n=+t[e](s.y);return isNaN(n)?a[i]:n}));this.path=i.enter().append("path").attr("class","lz-data_layer-line").merge(i).attr("d",n).call(gt,this.layout.style).call(this.applyBehaviors.bind(this)),i.exit().remove()}_getTooltipPosition(t){try{const t=I.mouse(this.svg.container.node()),e=t[0],s=t[1];return{x_min:e-1,x_max:e+1,y_min:s-1,y_max:s+1}}catch(t){return null}}}const ye={point_size:40,point_shape:"circle",tooltip_positioning:"horizontal",color:"#888888",coalesce:{active:!1,max_points:800,x_min:"-Infinity",x_max:"Infinity",y_min:0,y_max:3,x_gap:7,y_gap:7},fill_opacity:1,y_axis:{axis:1},id_field:"id"};class fe extends ie{constructor(t){(t=at(t,ye)).label&&isNaN(t.label.spacing)&&(t.label.spacing=4),super(...arguments)}_getTooltipPosition(t){const e=this.parent.x_scale(t.data[this.layout.x_axis.field]),s=`y${this.layout.y_axis.axis}_scale`,i=this.parent[s](t.data[this.layout.y_axis.field]),a=this.resolveScalableParameter(this.layout.point_size,t.data),n=Math.sqrt(a/Math.PI);return{x_min:e-n,x_max:e+n,y_min:i-n,y_max:i+n}}flip_labels(){const t=this,e=t.resolveScalableParameter(t.layout.point_size,{}),s=t.layout.label.spacing,i=Boolean(t.layout.label.lines),a=2*s,n=this.parent_plot.layout.width-this.parent.layout.margin.left-this.parent.layout.margin.right-2*s,o=(t,a)=>{const n=+t.attr("x"),o=2*s+2*Math.sqrt(e);let r,l;i&&(r=+a.attr("x2"),l=s+2*Math.sqrt(e)),"start"===t.style("text-anchor")?(t.style("text-anchor","end"),t.attr("x",n-o),i&&a.attr("x2",r-l)):(t.style("text-anchor","start"),t.attr("x",n+o),i&&a.attr("x2",r+l))};t._label_texts.each((function(e,a){const r=I.select(this);if(+r.attr("x")+r.node().getBoundingClientRect().width+s>n){const e=i?I.select(t._label_lines.nodes()[a]):null;o(r,e)}})),t._label_texts.each((function(e,n){const r=I.select(this);if("end"===r.style("text-anchor"))return;let l=+r.attr("x");const h=r.node().getBoundingClientRect(),c=i?I.select(t._label_lines.nodes()[n]):null;t._label_texts.each((function(){const t=I.select(this).node().getBoundingClientRect();h.left<t.left+t.width+2*s&&h.left+h.width+2*s>t.left&&h.top<t.top+t.height+2*s&&h.height+h.top+2*s>t.top&&(o(r,c),l=+r.attr("x"),l-h.width-s<a&&o(r,c))}))}))}separate_labels(){this._label_iterations++;const t=this;if(!this.layout.label)return;const e=this.layout.label.spacing;let s=!1;if(t._label_texts.each((function(){const i=this,a=I.select(i),n=a.attr("y");t._label_texts.each((function(){if(i===this)return;const o=I.select(this);if(a.attr("text-anchor")!==o.attr("text-anchor"))return;const r=a.node().getBoundingClientRect(),l=o.node().getBoundingClientRect();if(!(r.left<l.left+l.width+2*e&&r.left+r.width+2*e>l.left&&r.top<l.top+l.height+2*e&&r.height+r.top+2*e>l.top))return;s=!0;const h=o.attr("y"),c=.5*(r.top<l.top?1:-1);let d=+n-c,u=+h+c;const _=2*e,p=t.parent.layout.height-t.parent.layout.margin.top-t.parent.layout.margin.bottom-2*e;let g;d-r.height/2<_?(g=+n-d,d=+n,u+=g):u-l.height/2<_&&(g=+h-u,u=+h,d+=g),d+r.height/2>p?(g=d-+n,d=+n,u-=g):u+l.height/2>p&&(g=u-+h,u=+h,d-=g),a.attr("y",d),o.attr("y",u)}))})),s){if(t.layout.label.lines){const e=t._label_texts.nodes();t._label_lines.attr("y2",((t,s)=>I.select(e[s]).attr("y")))}this._label_iterations<150&&setTimeout((()=>{this.separate_labels()}),1)}}render(){const t=this,e=this.parent.x_scale,s=this.parent[`y${this.layout.y_axis.axis}_scale`],i=Symbol.for("lzX"),a=Symbol.for("lzY");let n=this._applyFilters();if(n.forEach((t=>{let n=e(t[this.layout.x_axis.field]),o=s(t[this.layout.y_axis.field]);isNaN(n)&&(n=-1e3),isNaN(o)&&(o=-1e3),t[i]=n,t[a]=o})),this.layout.coalesce.active&&n.length>this.layout.coalesce.max_points){let{x_min:t,x_max:i,y_min:a,y_max:o,x_gap:r,y_gap:l}=this.layout.coalesce;n=function(t,e,s,i,a,n,o){let r=[];const l=Symbol.for("lzX"),h=Symbol.for("lzY");let c=null,d=null,u=[];function _(){if(u.length){const t=u[Math.floor((u.length-1)/2)];r.push(t)}c=d=null,u=[]}function p(t,e,s){c=t,d=e,u.push(s)}return t.forEach((t=>{const g=t[l],y=t[h],f=g>=e&&g<=s&&y>=a&&y<=n;t.lz_is_match||!f?(_(),r.push(t)):null===c?p(g,y,t):Math.abs(g-c)<=i&&Math.abs(y-d)<=o?u.push(t):(_(),p(g,y,t))})),_(),r}(n,isFinite(t)?e(+t):-1/0,isFinite(i)?e(+i):1/0,r,isFinite(o)?s(+o):-1/0,isFinite(a)?s(+a):1/0,l)}if(this.layout.label){let e;const s=t.layout.label.filters||[];if(s.length){const t=this.filter.bind(this,s);e=n.filter(t)}else e=n;this._label_groups=this.svg.group.selectAll(`g.lz-data_layer-${this.layout.type}-label`).data(e,(t=>`${t[this.layout.id_field]}_label`));const o=`lz-data_layer-${this.layout.type}-label`,r=this._label_groups.enter().append("g").attr("class",o);this._label_texts&&this._label_texts.remove(),this._label_texts=this._label_groups.merge(r).append("text").text((e=>Ht(t.layout.label.text||"",e,this.getElementAnnotation(e)))).attr("x",(e=>e[i]+Math.sqrt(t.resolveScalableParameter(t.layout.point_size,e))+t.layout.label.spacing)).attr("y",(t=>t[a])).attr("text-anchor","start").call(gt,t.layout.label.style||{}),t.layout.label.lines&&(this._label_lines&&this._label_lines.remove(),this._label_lines=this._label_groups.merge(r).append("line").attr("x1",(t=>t[i])).attr("y1",(t=>t[a])).attr("x2",(e=>e[i]+Math.sqrt(t.resolveScalableParameter(t.layout.point_size,e))+t.layout.label.spacing/2)).attr("y2",(t=>t[a])).call(gt,t.layout.label.lines.style||{})),this._label_groups.exit().remove()}else this._label_texts&&this._label_texts.remove(),this._label_lines&&this._label_lines.remove(),this._label_groups&&this._label_groups.remove();const o=this.svg.group.selectAll(`path.lz-data_layer-${this.layout.type}`).data(n,(t=>t[this.layout.id_field])),r=I.symbol().size(((t,e)=>this.resolveScalableParameter(this.layout.point_size,t,e))).type(((t,e)=>ot(this.resolveScalableParameter(this.layout.point_shape,t,e)))),l=`lz-data_layer-${this.layout.type}`;o.enter().append("path").attr("class",l).attr("id",(t=>this.getElementId(t))).merge(o).attr("transform",(t=>`translate(${t[i]}, ${t[a]})`)).attr("fill",((t,e)=>this.resolveScalableParameter(this.layout.color,t,e))).attr("fill-opacity",((t,e)=>this.resolveScalableParameter(this.layout.fill_opacity,t,e))).attr("d",r),o.exit().remove(),this.layout.label&&(this.flip_labels(),this._label_iterations=0,this.separate_labels()),this.svg.group.on("click.event_emitter",(()=>{const t=I.select(I.event.target).datum();this.parent.emit("element_clicked",t,!0)})).call(this.applyBehaviors.bind(this))}makeLDReference(t){let e=null;if(void 0===t)throw new Error("makeLDReference requires one argument of any type");return e="object"==typeof t?this.layout.id_field&&void 0!==t[this.layout.id_field]?t[this.layout.id_field].toString():void 0!==t.id?t.id.toString():t.toString():t.toString(),this.parent.emit("set_ldrefvar",{ldrefvar:e},!0),this.parent_plot.applyState({ldrefvar:e})}}class me extends fe{constructor(t){super(...arguments),this._categories={}}_prepareData(){const t=this.layout.x_axis.field||"x",e=this.layout.x_axis.category_field;if(!e)throw new Error(`Layout for ${this.layout.id} must specify category_field`);const s=this.data.sort(((t,s)=>{const i=t[e],a=s[e],n="string"==typeof i?i.toLowerCase():i,o="string"==typeof a?a.toLowerCase():a;return n===o?0:n<o?-1:1}));return s.forEach(((e,s)=>{e[t]=e[t]||s})),s}_generateCategoryBounds(){const t=this.layout.x_axis.category_field,e=this.layout.x_axis.field||"x",s={};this.data.forEach((i=>{const a=i[t],n=i[e],o=s[a]||[n,n];s[a]=[Math.min(o[0],n),Math.max(o[1],n)]}));const i=Object.keys(s);return this._setDynamicColorScheme(i),s}_getColorScale(t){let e=(t=t||this.layout).color||[];if(Array.isArray(e)&&(e=e.find((t=>"categorical_bin"===t.scale_function))),!e||"categorical_bin"!==e.scale_function)throw new Error("This layer requires that color options be provided as a `categorical_bin`");return e}_setDynamicColorScheme(t){const e=this._getColorScale(this.layout).parameters,s=this._getColorScale(this._base_layout).parameters;if(s.categories.length&&s.values.length){const i={};s.categories.forEach((t=>{i[t]=1})),t.every((t=>Object.prototype.hasOwnProperty.call(i,t)))?e.categories=s.categories:e.categories=t}else e.categories=t;let i;for(i=s.values.length?s.values:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"];i.length<t.length;)i=i.concat(i);i=i.slice(0,t.length),e.values=i}getTicks(t,e){if(!["x","y1","y2"].includes(t))throw new Error("Invalid dimension identifier");const s=e.position||"left";if(!["left","center","right"].includes(s))throw new Error("Invalid tick position");const i=this._categories;if(!i||!Object.keys(i).length)return[];if("y"===t)return[];if("x"===t){const t=this._getColorScale(this.layout),e=t.parameters.categories||[],a=t.parameters.values||[];return Object.keys(i).map(((t,n)=>{const o=i[t];let r;switch(s){case"left":r=o[0];break;case"center":const t=o[1]-o[0];r=o[0]+(0!==t?t:o[0])/2;break;case"right":r=o[1]}return{x:r,text:t,style:{fill:a[e.indexOf(t)]||"#000000"}}}))}}applyCustomDataMethods(){return this.data=this._prepareData(),this._categories=this._generateCategoryBounds(),this}}const be=new c;for(let[t,e]of Object.entries(o))be.add(t,e);const xe=be,ve=7.301,we={closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:'<strong>{{assoc:variant|htmlescape}}</strong><br>\n        P Value: <strong>{{assoc:log_pvalue|logtoscinotation|htmlescape}}</strong><br>\n        Ref. Allele: <strong>{{assoc:ref_allele|htmlescape}}</strong><br>\n        {{#if lz_is_ld_refvar}}<strong>LD Reference Variant</strong>{{#else}}\n        <a href="javascript:void(0);" \n        onclick="var data = this.parentNode.__data__;\n                 data.getDataLayer().makeLDReference(data);"\n                 >Make LD Reference</a>{{/if}}<br>'},$e=function(){const t=nt(we);return t.html+="<a href=\"javascript:void(0);\" \n                  onclick=\"var item = this.parentNode.__data__, layer = item.getDataLayer(); \n                  var current = layer.getElementAnnotation(item, 'lz_show_label'); \n                  layer.setElementAnnotation(item, 'lz_show_label', !current );\n                  layer.parent_plot.applyState();\">{{#if lz_show_label}}Hide{{#else}}Show{{/if}} label</a>",t}(),ze={closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:'<h4><strong><i>{{gene_name|htmlescape}}</i></strong></h4>Gene ID: <a href="https://useast.ensembl.org/homo_sapiens/Gene/Summary?g={{gene_id|htmlescape}}&db=core" target="_blank" rel="noopener">{{gene_id|htmlescape}}</a><br>Transcript ID: <strong>{{transcript_id|htmlescape}}</strong><br>{{#if pLI}}<table><tr><th>Constraint</th><th>Expected variants</th><th>Observed variants</th><th>Const. Metric</th></tr><tr><td>Synonymous</td><td>{{exp_syn}}</td><td>{{obs_syn}}</td><td>z = {{syn_z}}<br>o/e = {{oe_syn}} ({{oe_syn_lower}} - {{oe_syn_upper}})</td></tr><tr><td>Missense</td><td>{{exp_mis}}</td><td>{{obs_mis}}</td><td>z = {{mis_z}}<br>o/e = {{oe_mis}} ({{oe_mis_lower}} - {{oe_mis_upper}})</td></tr><tr><td>pLoF</td><td>{{exp_lof}}</td><td>{{obs_lof}}</td><td>pLI = {{pLI}}<br>o/e = {{oe_lof}} ({{oe_lof_lower}} - {{oe_lof_upper}})</td></tr></table><br>{{/if}}<a href="https://gnomad.broadinstitute.org/gene/{{gene_id|htmlescape}}" target="_blank" rel="noopener">More data on gnomAD</a>'},ke={closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:'<strong>{{catalog:variant|htmlescape}}</strong><br>Catalog entries: <strong>{{n_catalog_matches|htmlescape}}</strong><br>Top Trait: <strong>{{catalog:trait|htmlescape}}</strong><br>Top P Value: <strong>{{catalog:log_pvalue|logtoscinotation}}</strong><br>More: <a href="https://www.ebi.ac.uk/gwas/search?query={{catalog:rsid|htmlescape}}" target="_blank" rel="noopener">GWAS catalog</a> / <a href="https://www.ncbi.nlm.nih.gov/snp/{{catalog:rsid|htmlescape}}" target="_blank" rel="noopener">dbSNP</a>'},Ee={closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:"<strong>Regulatory element</strong><br>{{access:start1|htmlescape}}-{{access:end1|htmlescape}}<br><strong>Promoter</strong><br>{{access:start2|htmlescape}}-{{access:end2|htmlescape}}<br>{{#if access:target}}<strong>Target</strong>: {{access:target|htmlescape}}<br>{{/if}}<strong>Score</strong>: {{access:score|htmlescape}}"},Me={id:"significance",type:"orthogonal_line",tag:"significance",orientation:"horizontal",offset:ve},Se={id:"recombrate",namespace:{recomb:"recomb"},data_operations:[{type:"fetch",from:["recomb"]}],type:"line",tag:"recombination",z_index:1,style:{stroke:"#0000FF","stroke-width":"1.5px"},x_axis:{field:"recomb:position"},y_axis:{axis:2,field:"recomb:recomb_rate",floor:0,ceiling:100}},Ne={namespace:{assoc:"assoc",ld:"ld"},data_operations:[{type:"fetch",from:["assoc","ld(assoc)"]},{type:"left_match",name:"assoc_plus_ld",requires:["assoc","ld"],params:["assoc:position","ld:position2"]}],id:"associationpvalues",type:"scatter",tag:"association",id_field:"assoc:variant",coalesce:{active:!0},point_shape:[{scale_function:"if",field:"lz_is_ld_refvar",parameters:{field_value:!0,then:"diamond"}},{scale_function:"effect_direction",parameters:{"+":"triangle","-":"triangledown",beta_field:"assoc:beta",stderr_beta_field:"assoc:se"}},"circle"],point_size:{scale_function:"if",field:"lz_is_ld_refvar",parameters:{field_value:!0,then:80,else:40}},color:[{scale_function:"if",field:"lz_is_ld_refvar",parameters:{field_value:!0,then:"#9632b8"}},{scale_function:"numerical_bin",field:"ld:correlation",parameters:{breaks:[0,.2,.4,.6,.8],values:["rgb(70, 54, 153)","rgb(38, 188, 225)","rgb(110, 254, 104)","rgb(248, 195, 42)","rgb(219, 61, 17)"]}},"#AAAAAA"],legend:[{label:"LD (r²)",label_size:14},{shape:"ribbon",orientation:"vertical",width:10,height:15,color_stops:["rgb(70, 54, 153)","rgb(38, 188, 225)","rgb(110, 254, 104)","rgb(248, 195, 42)","rgb(219, 61, 17)"],tick_labels:[0,.2,.4,.6,.8,1]}],label:null,z_index:2,x_axis:{field:"assoc:position"},y_axis:{axis:1,field:"assoc:log_pvalue",floor:0,upper_buffer:.1,min_extent:[0,10]},behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}]},tooltip:nt(we)},Ae={id:"coaccessibility",type:"arcs",tag:"coaccessibility",namespace:{access:"access"},data_operations:[{type:"fetch",from:["access"]}],match:{send:"access:target",receive:"access:target"},id_field:"{{access:start1}}_{{access:end1}}_{{access:start2}}_{{access:end2}}_{{access:score}}_{{access:target}}",filters:[{field:"access:score",operator:"!=",value:null}],color:[{field:"lz_is_match",scale_function:"if",parameters:{field_value:!0,then:"#4285f4"}},{field:"lz_is_match",scale_function:"if",parameters:{field_value:!1,then:"#EAE6E6"}},{scale_function:"ordinal_cycle",parameters:{values:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]}}],x_axis:{field1:"access:start1",field2:"access:start2"},y_axis:{axis:1,field:"access:score",upper_buffer:.1,min_extent:[0,1]},behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}]},tooltip:nt(Ee)},Oe=function(){let t=nt(Ne);return t=at({id:"associationpvaluescatalog",fill_opacity:.7},t),t.data_operations.push({type:"assoc_to_gwas_catalog",name:"assoc_catalog",requires:["assoc_plus_ld","catalog"],params:["assoc:position","catalog:pos","catalog:log_pvalue"]}),t.tooltip.html+='{{#if catalog:rsid}}<br><a href="https://www.ebi.ac.uk/gwas/search?query={{catalog:rsid|htmlescape}}" target="_blank" rel="noopener">See hits in GWAS catalog</a>{{/if}}',t.namespace.catalog="catalog",t}(),Te={id:"phewaspvalues",type:"category_scatter",tag:"phewas",namespace:{phewas:"phewas"},data_operations:[{type:"fetch",from:["phewas"]}],point_shape:[{scale_function:"effect_direction",parameters:{"+":"triangle","-":"triangledown",beta_field:"phewas:beta",stderr_beta_field:"phewas:se"}},"circle"],point_size:70,tooltip_positioning:"vertical",id_field:"{{phewas:trait_group}}_{{phewas:trait_label}}",x_axis:{field:"lz_auto_x",category_field:"phewas:trait_group",lower_buffer:.025,upper_buffer:.025},y_axis:{axis:1,field:"phewas:log_pvalue",floor:0,upper_buffer:.15},color:[{field:"phewas:trait_group",scale_function:"categorical_bin",parameters:{categories:[],values:[],null_value:"#B8B8B8"}}],fill_opacity:.7,tooltip:{closable:!0,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:"<strong>Trait:</strong> {{phewas:trait_label|htmlescape}}<br>\n<strong>Trait Category:</strong> {{phewas:trait_group|htmlescape}}<br>\n<strong>P-value:</strong> {{phewas:log_pvalue|logtoscinotation|htmlescape}}\n{{#if phewas:beta|is_numeric}}<br><strong>&beta;:</strong> {{phewas:beta|scinotation|htmlescape}}<br>{{/if}}\n{{#if phewas:se|is_numeric}}<strong>SE (&beta;):</strong> {{phewas:se|scinotation|htmlescape}}{{/if}}"},behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}]},label:{text:"{{phewas:trait_label}}",spacing:6,lines:{style:{"stroke-width":"2px",stroke:"#333333","stroke-dasharray":"2px 2px"}},filters:[{field:"phewas:log_pvalue",operator:">=",value:20}],style:{"font-size":"14px","font-weight":"bold",fill:"#333333"}}},Le={namespace:{gene:"gene",constraint:"constraint"},data_operations:[{type:"fetch",from:["gene","constraint(gene)"]},{name:"gene_constraint",type:"genes_to_gnomad_constraint",requires:["gene","constraint"]}],id:"genes",type:"genes",tag:"genes",id_field:"gene_id",behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}]},tooltip:nt(ze)},je=at({filters:[{field:"gene_type",operator:"in",value:["protein_coding","IG_C_gene","IG_D_gene","IG_J_gene","IG_V_gene","TR_C_gene","TR_D_gene","TR_J_gene","TR_V_gene","rRNA","Mt_rRNA","Mt_tRNA"]}]},nt(Le)),Pe={namespace:{assoc:"assoc",catalog:"catalog"},data_operations:[{type:"fetch",from:["assoc","catalog"]},{type:"assoc_to_gwas_catalog",name:"assoc_plus_ld",requires:["assoc","catalog"],params:["assoc:position","catalog:pos","catalog:log_pvalue"]}],id:"annotation_catalog",type:"annotation_track",tag:"gwascatalog",id_field:"assoc:variant",x_axis:{field:"assoc:position"},color:"#0000CC",filters:[{field:"catalog:rsid",operator:"!=",value:null},{field:"catalog:log_pvalue",operator:">",value:ve}],behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}]},tooltip:nt(ke),tooltip_positioning:"top"},Re={type:"set_state",tag:"ld_population",position:"right",color:"blue",button_html:"LD Population: ",show_selected:!0,button_title:"Select LD Population: ",custom_event_name:"widget_set_ldpop",state_field:"ld_pop",options:[{display_name:"ALL (default)",value:"ALL"},{display_name:"AFR",value:"AFR"},{display_name:"AMR",value:"AMR"},{display_name:"EAS",value:"EAS"},{display_name:"EUR",value:"EUR"},{display_name:"SAS",value:"SAS"}]},Ie={type:"display_options",tag:"gene_filter",custom_event_name:"widget_gene_filter_choice",position:"right",color:"blue",button_html:"Filter...",button_title:"Choose which genes to show",layer_name:"genes",default_config_display_name:"Coding genes & rRNA",options:[{display_name:"All features",display:{filters:null}}]},Ce={widgets:[{type:"remove_panel",position:"right",color:"red",group_position:"end"},{type:"move_panel_up",position:"right",group_position:"middle"},{type:"move_panel_down",position:"right",group_position:"start",style:{"margin-left":"0.75em"}}]},De={widgets:[{type:"title",title:"LocusZoom",subtitle:`<a href="https://statgen.github.io/locuszoom/" target="_blank" rel="noopener">v${l}</a>`,position:"left"},{type:"download",position:"right",group_position:"end"},{type:"download_png",position:"right",group_position:"start"}]},Be=function(){const t=nt(De);return t.widgets.push(nt(Re)),t}(),Ue=function(){const t=nt(De);return t.widgets.push({type:"shift_region",step:5e5,button_html:">>",position:"right",group_position:"end"},{type:"shift_region",step:5e4,button_html:">",position:"right",group_position:"middle"},{type:"zoom_region",step:.2,position:"right",group_position:"middle"},{type:"zoom_region",step:-.2,position:"right",group_position:"middle"},{type:"shift_region",step:-5e4,button_html:"<",position:"right",group_position:"middle"},{type:"shift_region",step:-5e5,button_html:"<<",position:"right",group_position:"start"}),t}(),qe={id:"association",tag:"association",min_height:200,height:300,margin:{top:35,right:55,bottom:40,left:70},inner_border:"rgb(210, 210, 210)",toolbar:function(){const t=nt(Ce);return t.widgets.push({type:"toggle_legend",position:"right"}),t}(),axes:{x:{label:"Chromosome {{chr}} (Mb)",label_offset:38,tick_format:"region",extent:"state"},y1:{label:"-log10 p-value",label_offset:50},y2:{label:"Recombination Rate (cM/Mb)",label_offset:46}},legend:{orientation:"vertical",origin:{x:75,y:40},hidden:!0},interaction:{drag_background_to_pan:!0,drag_x_ticks_to_scale:!0,drag_y1_ticks_to_scale:!0,drag_y2_ticks_to_scale:!0,scroll_to_zoom:!0,x_linked:!0},data_layers:[nt(Me),nt(Se),nt(Ne)]},Fe={id:"coaccessibility",tag:"coaccessibility",min_height:150,height:180,margin:{top:35,right:55,bottom:40,left:70},inner_border:"rgb(210, 210, 210)",toolbar:nt(Ce),axes:{x:{label:"Chromosome {{chr}} (Mb)",label_offset:38,tick_format:"region",extent:"state"},y1:{label:"Score",label_offset:40,render:!1}},interaction:{drag_background_to_pan:!0,drag_x_ticks_to_scale:!0,drag_y1_ticks_to_scale:!0,scroll_to_zoom:!0,x_linked:!0},data_layers:[nt(Ae)]},He=function(){let t=nt(qe);return t=at({id:"associationcatalog"},t),t.toolbar.widgets.push({type:"display_options",position:"right",color:"blue",button_html:"Display options...",button_title:"Control how plot items are displayed",layer_name:"associationpvaluescatalog",default_config_display_name:"No catalog labels (default)",options:[{display_name:"Label catalog traits",display:{label:{text:"{{catalog:trait}}",spacing:6,lines:{style:{"stroke-width":"2px",stroke:"#333333","stroke-dasharray":"2px 2px"}},filters:[{field:"catalog:trait",operator:"!=",value:null},{field:"catalog:log_pvalue",operator:">",value:ve},{field:"ld:correlation",operator:">",value:.4}],style:{"font-size":"12px","font-weight":"bold",fill:"#333333"}}}}]}),t.data_layers=[nt(Me),nt(Se),nt(Oe)],t}(),Ge={id:"genes",tag:"genes",min_height:150,height:225,margin:{top:20,right:55,bottom:20,left:70},axes:{},interaction:{drag_background_to_pan:!0,scroll_to_zoom:!0,x_linked:!0},toolbar:function(){const t=nt(Ce);return t.widgets.push({type:"resize_to_data",position:"right",button_html:"Resize"},nt(Ie)),t}(),data_layers:[nt(je)]},Je={id:"phewas",tag:"phewas",min_height:300,height:300,margin:{top:20,right:55,bottom:120,left:70},inner_border:"rgb(210, 210, 210)",axes:{x:{ticks:{style:{"font-weight":"bold","font-size":"11px","text-anchor":"start"},transform:"rotate(50)",position:"left"}},y1:{label:"-log10 p-value",label_offset:50}},data_layers:[nt(Me),nt(Te)]},Ze={id:"annotationcatalog",tag:"gwascatalog",min_height:50,height:50,margin:{top:25,right:55,bottom:10,left:70},inner_border:"rgb(210, 210, 210)",toolbar:nt(Ce),axes:{x:{extent:"state",render:!1}},interaction:{drag_background_to_pan:!0,scroll_to_zoom:!0,x_linked:!0},data_layers:[nt(Pe)]},Ke={state:{},width:800,responsive_resize:!0,min_region_scale:2e4,max_region_scale:1e6,toolbar:Be,panels:[nt(qe),nt(Ge)]},Ve={state:{},width:800,responsive_resize:!0,min_region_scale:2e4,max_region_scale:1e6,toolbar:Be,panels:[Ze,He,Ge]},We={width:800,responsive_resize:!0,toolbar:De,panels:[nt(Je),at({height:300,margin:{bottom:40},axes:{x:{label:"Chromosome {{chr}} (Mb)",label_offset:38,tick_format:"region",extent:"state"}}},nt(Ge))],mouse_guide:!1},Ye={state:{},width:800,responsive_resize:!0,min_region_scale:2e4,max_region_scale:1e6,toolbar:nt(De),panels:[nt(Fe),function(){const t=Object.assign({height:270},nt(Ge)),e=t.data_layers[0];e.match={send:"gene_name",receive:"gene_name"};const s=[{field:"lz_is_match",scale_function:"if",parameters:{field_value:!0,then:"#4285f4"}},{field:"lz_is_match",scale_function:"if",parameters:{field_value:!1,then:"#EAE6E6"}},"#363696"];return e.color=s,e.stroke=s,t}()]},Xe={standard_association:we,standard_association_with_label:$e,standard_genes:ze,catalog_variant:ke,coaccessibility:Ee},Qe={ldlz2_pop_selector:Re,gene_selector_menu:Ie},ts={standard_panel:Ce,standard_plot:De,standard_association:Be,region_nav_plot:Ue},es={significance:Me,recomb_rate:Se,association_pvalues:Ne,coaccessibility:Ae,association_pvalues_catalog:Oe,phewas_pvalues:Te,genes:Le,genes_filtered:je,annotation_catalog:Pe},ss={association:qe,coaccessibility:Fe,association_catalog:He,genes:Ge,phewas:Je,annotation_catalog:Ze},is={standard_association:Ke,association_catalog:Ve,standard_phewas:We,coaccessibility:Ye};const as=new class extends h{get(t,e,s={}){if(!t||!e)throw new Error("Must specify both the type and name for the layout desired. See .list() for available options");let i=super.get(t).get(e);const a=s.namespace;i.namespace||delete s.namespace;let n=at(s,i);return a&&(n=it(n,a)),nt(n)}add(t,e,s,i=!1){if(!(t&&e&&s))throw new Error("To add a layout, type, name, and item must all be specified");if("object"!=typeof s)throw new Error("The configuration to be added must be an object");this.has(t)||super.add(t,new h);const a=nt(s);return"data_layer"===t&&a.namespace&&(a._auto_fields=[...rt(a,Object.keys(a.namespace))].sort()),super.get(t).add(e,a,i)}list(t){if(!t){let t={};for(let[e,s]of this._items)t[e]=s.list();return t}return super.get(t).list()}merge(t,e){return at(t,e)}renameField(){return lt(...arguments)}mutate_attrs(){return ht(...arguments)}query_attrs(){return ct(...arguments)}};for(let[t,e]of Object.entries(r))for(let[s,i]of Object.entries(e))as.add(t,s,i);const ns=as,os=new h;function rs(t){return(e,s,...i)=>{if(2!==s.length)throw new Error("Join functions must receive exactly two recordsets");return t(...s,...i)}}os.add("left_match",rs(x)),os.add("inner_match",rs((function(t,e,s,i){return b("inner",...arguments)}))),os.add("full_outer_match",rs((function(t,e,s,i){return b("outer",...arguments)}))),os.add("assoc_to_gwas_catalog",rs((function(t,e,s,i,a){if(!t.length)return t;const n=m(e,i),o=[];for(let t of n.values()){let e,s=0;for(let i of t){const t=i[a];t>=s&&(e=i,s=t)}e.n_catalog_matches=t.length,o.push(e)}return x(t,o,s,i)}))),os.add("genes_to_gnomad_constraint",rs((function(t,e){return t.forEach((function(t){const s=`_${t.gene_name.replace(/[^A-Za-z0-9_]/g,"_")}`,i=e[s]&&e[s].gnomad_constraint;i&&Object.keys(i).forEach((function(e){let s=i[e];void 0===t[e]&&("number"==typeof s&&s.toString().includes(".")&&(s=parseFloat(s.toFixed(2))),t[e]=s)}))})),t})));const ls=os;const hs={version:l,populate:function(t,e,s){if(void 0===t)throw new Error("LocusZoom.populate selector not defined");let i;return I.select(t).html(""),I.select(t).call((function(t){if(void 0===t.node().id){let e=0;for(;!I.select(`#lz-${e}`).empty();)e++;t.attr("id",`#lz-${e}`)}if(i=new Ut(t.node().id,e,s),i.container=t.node(),void 0!==t.node().dataset&&void 0!==t.node().dataset.region){const e=function(t){const e=/^(\w+):([\d,.]+[kmgbKMGB]*)$/;let s=/^(\w+):([\d,.]+[kmgbKMGB]*)([-+])([\d,.]+[kmgbKMGB]*)$/.exec(t);if(s){if("+"===s[3]){const t=Ft(s[2]),e=Ft(s[4]);return{chr:s[1],start:t-e,end:t+e}}return{chr:s[1],start:Ft(s[2]),end:Ft(s[4])}}if(s=e.exec(t),s)return{chr:s[1],position:Ft(s[2])};return null}(t.node().dataset.region);Object.keys(e).forEach((function(t){i.state[t]=e[t]}))}i.svg=I.select(`div#${i.id}`).append("svg").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("id",`${i.id}_svg`).attr("class","lz-locuszoom").call(gt,i.layout.style),i.setDimensions(),i.positionPanels(),i.initialize(),e&&i.refresh()})),i},DataSources:class extends h{constructor(t){super(),this._registry=t||R}add(t,e,s=!1){if(this._registry.has(t))throw new Error(`The namespace ${t} is already in use by another source`);if(t.match(/[^A-Za-z0-9_]/))throw new Error(`Data source namespace names can only contain alphanumeric characters or underscores. Invalid name: ${t}`);if(Array.isArray(e)){const[t,s]=e;e=this._registry.create(t,s)}return e.source_id=t,super.add(t,e,s),this}},Adapters:R,DataLayers:xe,DataFunctions:ls,Layouts:ns,MatchFunctions:Jt,ScaleFunctions:ee,TransformationFunctions:Z,Widgets:jt,get KnownDataSources(){return console.warn('Deprecation warning: KnownDataSources has been renamed to "Adapters"'),R}},cs=[];hs.use=function(t,...e){if(!cs.includes(t)){if(e.unshift(hs),"function"==typeof t.install)t.install.apply(t,e);else{if("function"!=typeof t)throw new Error("Plugin must export a function that receives the LocusZoom object as an argument");t.apply(null,e)}cs.push(t)}};const ds=hs})(),LocusZoom=i.default})();
//# sourceMappingURL=locuszoom.app.min.js.map