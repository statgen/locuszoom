!function(){try{var t="3.5.6";if("object"!=typeof d3)throw"LocusZoom unable to load: d3 dependency not met. Library missing.";if(d3.version<t)throw"LocusZoom unable to load: d3 dependency not met. Outdated version detected.\nRequired d3 version: "+t+" or higher (found: "+d3.version+").";if("function"!=typeof Q)throw"LocusZoom unable to load: Q dependency not met. Library missing.";var e={version:"0.3.9"};e.populate=function(t,i,a,s){if("undefined"==typeof t)throw"LocusZoom.populate selector not defined";if(d3.select(t).html(""),"undefined"!=typeof s){console.warn("Warning: state passed to LocusZoom.populate as fourth argument. This behavior is deprecated. Please include state as a parameter of layout");var n={state:s},o=a||{};a=e.mergeLayouts(n,o)}var r;return d3.select(t).call(function(){if("undefined"==typeof this.node().id){for(var t=0;!d3.select("#lz-"+t).empty();)t++;this.attr("id","#lz-"+t)}if(r=new e.Instance(this.node().id,i,a),"undefined"!=typeof this.node().dataset&&"undefined"!=typeof this.node().dataset.region){var s=e.parsePositionQuery(this.node().dataset.region);Object.keys(s).forEach(function(t){r.state[t]=s[t]})}r.svg=d3.select("div#"+r.id).append("svg").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("id",r.id+"_svg").attr("class","lz-locuszoom"),r.setDimensions(),r.positionPanels(),r.initialize(),"object"==typeof i&&Object.keys(i).length&&r.refresh()}),r},e.populateAll=function(t,i,a,s){var n=[];return d3.selectAll(t).each(function(t,o){n[o]=e.populate(this,i,a,s)}),n},e.positionIntToString=function(t){var e=Math.min(Math.max(6-Math.floor((Math.log(t)/Math.LN10).toFixed(9)),2),12);return""+(t/Math.pow(10,6)).toFixed(e)},e.positionStringToInt=function(t){var e=t.toUpperCase();e=e.replace(/,/g,"");var i=/([KMG])[B]*$/,a=i.exec(e),s=1;return a&&(s="M"==a[1]?1e6:"G"==a[1]?1e9:1e3,e=e.replace(i,"")),e=Number(e)*s},e.parsePositionQuery=function(t){var i=/^(\w+):([\d,.]+[kmgbKMGB]*)([-+])([\d,.]+[kmgbKMGB]*)$/,a=/^(\w+):([\d,.]+[kmgbKMGB]*)$/,s=i.exec(t);if(s){if("+"==s[3]){var n=e.positionStringToInt(s[2]),o=e.positionStringToInt(s[4]);return{chr:s[1],start:n-o,end:n+o}}return{chr:s[1],start:e.positionStringToInt(s[2]),end:e.positionStringToInt(s[4])}}return s=a.exec(t),s?{chr:s[1],position:e.positionStringToInt(s[2])}:null},e.prettyTicks=function(t,e,i){("undefined"==typeof i||isNaN(parseInt(i)))&&(i=5),i=parseInt(i);var a=i/3,s=.75,n=1.5,o=.5+1.5*n,r=Math.abs(t[0]-t[1]),l=r/i;Math.log(r)/Math.LN10<-2&&(l=Math.max(Math.abs(r))*s/a);var h=Math.pow(10,Math.floor(Math.log(l)/Math.LN10)),d=0;1>h&&0!=h&&(d=Math.abs(Math.round(Math.log(h)/Math.LN10)));var u=h;n*(l-u)>2*h-l&&(u=2*h,o*(l-u)>5*h-l&&(u=5*h,n*(l-u)>10*h-l&&(u=10*h)));for(var p=[],c=parseFloat((Math.floor(t[0]/u)*u).toFixed(d));c<t[1];)p.push(c),c+=u,d>0&&(c=parseFloat(c.toFixed(d)));return p.push(c),("undefined"==typeof e||-1==["low","high","both","neither"].indexOf(e))&&(e="neither"),("low"==e||"both"==e)&&p[0]<t[0]&&(p=p.slice(1)),("high"==e||"both"==e)&&p[p.length-1]>t[1]&&p.pop(),p},e.createCORSPromise=function(t,e,i,a){var s=Q.defer(),n=new XMLHttpRequest;return"withCredentials"in n?n.open(t,e,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(t,e)):n=null,n&&(n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status||0===n.status)try{var t=JSON.parse(n.responseText);s.resolve(t)}catch(i){s.reject("Unable to parse JSON response:"+i)}else s.reject("HTTP "+n.status+" for "+e)},a&&setTimeout(s.reject,a),i="undefined"!=typeof i?i:"",n.send(i)),s.promise},e.createResolvedPromise=function(){var t=Q.defer();return t.resolve(Array.prototype.slice.call(arguments)),t.promise},e.mergeLayouts=function(t,i){if("object"!=typeof t||"object"!=typeof i)throw"LocusZoom.mergeLayouts only accepts two layout objects; "+typeof t+", "+typeof i+" given";for(var a in i)if(i.hasOwnProperty(a)){var s=null==t[a]?"undefined":typeof t[a],n=typeof i[a];if("object"==s&&Array.isArray(t[a])&&(s="array"),"object"==n&&Array.isArray(i[a])&&(n="array"),"function"==s||"function"==n)throw"LocusZoom.mergeLayouts encountered an unsupported property type";"undefined"!=s?"object"!=s||"object"!=n||(t[a]=e.mergeLayouts(t[a],i[a])):t[a]=JSON.parse(JSON.stringify(i[a]))}return t},e.parseFields=function(t,e){if("object"!=typeof t)throw"LocusZoom.parseFields invalid arguments: data is not an object";if("string"!=typeof e)throw"LocusZoom.parseFields invalid arguments: html is not a string";var i;for(var a in t)t.hasOwnProperty(a)&&("string"==typeof t[a]||"number"==typeof t[a]||"boolean"==typeof t[a])&&(i=new RegExp("\\{\\{"+a.replace("|","\\|").replace(":","\\:")+"\\}\\}","g"),e=e.replace(i,t[a]));return e},e.KnownDataSources=[],e.StandardLayout={state:{},width:800,height:450,resizable:"responsive",aspect_ratio:16/9,panels:{positions:{title:"Analysis ID: 3",description:"<b>Lorem ipsum</b> dolor sit amet, consectetur adipiscing elit.",width:800,height:225,origin:{x:0,y:0},min_width:400,min_height:200,proportional_width:1,proportional_height:.5,proportional_origin:{x:0,y:0},margin:{top:35,right:50,bottom:40,left:50},inner_border:"rgba(210, 210, 210, 0.85)",axes:{x:{label_function:"chromosome",label_offset:32,tick_format:"region"},y1:{label:"-log10 p-value",label_offset:28},y2:{label:"Recombination Rate (cM/Mb)",label_offset:40}},data_layers:{significance:{type:"line",fields:["sig:x","sig:y"],z_index:0,style:{stroke:"#D3D3D3","stroke-width":"3px","stroke-dasharray":"10px 10px"},x_axis:{field:"sig:x",decoupled:!0},y_axis:{axis:1,field:"sig:y"},tooltip:{html:"Significance Threshold: 3 × 10^-5"}},recomb:{type:"line",fields:["recomb:position","recomb:recomb_rate"],z_index:1,style:{stroke:"#0000FF","stroke-width":"1.5px"},x_axis:{field:"recomb:position"},y_axis:{axis:2,field:"recomb:recomb_rate",floor:0,ceiling:100}},positions:{type:"scatter",point_shape:"circle",point_size:40,fields:["id","position","pvalue|scinotation","pvalue|neglog10","refAllele","ld:state"],z_index:2,x_axis:{field:"position"},y_axis:{axis:1,field:"pvalue|neglog10",floor:0,upper_buffer:.05,min_extent:[0,10]},color:{field:"ld:state",scale_function:"numerical_bin",parameters:{breaks:[0,.2,.4,.6,.8],values:["#357ebd","#46b8da","#5cb85c","#eea236","#d43f3a"],null_value:"#B8B8B8"}},tooltip:{divs:[{html:"<strong>{{id}}</strong>"},{html:"P Value: <strong>{{pvalue|scinotation}}</strong>"},{html:"Ref. Allele: <strong>{{refAllele}}</strong>"}]}}}},genes:{width:800,height:225,origin:{x:0,y:225},min_width:400,min_height:112.5,proportional_width:1,proportional_height:.5,proportional_origin:{x:0,y:.5},margin:{top:20,right:50,bottom:20,left:50},axes:{},data_layers:{genes:{type:"genes",fields:["gene:gene"],tooltip:{divs:[{html:"<strong><i>{{gene_name}}</i></strong>"},{html:"Gene ID: <strong>{{gene_id}}</strong>"},{html:"Transcript ID: <strong>{{transcript_id}}</strong>"},{html:'<a href="http://exac.broadinstitute.org/gene/{{gene_id}}" target="_new">ExAC Page</a>'}]}}}}}},e.Data=e.Data||{},e.Data.Requester=function(t){function i(t){var i={},a=/^(?:([^:]+):)?([^:\|]*)(\|.+)*$/;return t.forEach(function(t){var s=a.exec(t),n=s[1]||"base",o=s[2],r=e.TransformationFunctions.get(s[3]);"undefined"==typeof i[n]&&(i[n]={outnames:[],fields:[],trans:[]}),i[n].outnames.push(t),i[n].fields.push(o),i[n].trans.push(r)}),i}this.getData=function(e,a){for(var s=i(a),n=Object.keys(s).map(function(i){if(!t.get(i))throw"Datasource for namespace "+i+" not found";return t.get(i).getData(e,s[i].fields,s[i].outnames,s[i].trans)}),o=Q.when({header:{},body:{}}),r=0;r<n.length;r++)o=o.then(n[r]);return o}},e.Data.Source=function(){},e.Data.Source.prototype.parseInit=function(t){if("string"==typeof t?(this.url=t,this.params={}):(this.url=t.url,this.params=t.params||{}),!this.url)throw"Source not initialized with required URL"},e.Data.Source.prototype.getRequest=function(t,i,a){return e.createCORSPromise("GET",this.getURL(t,i,a))},e.Data.Source.prototype.getData=function(t,e,i,a){if(this.preGetData){var s=this.preGetData(t,e,i,a);this.pre&&(t=s.state||t,e=s.fields||e,i=s.outnames||i,a=s.trans||a)}return function(s){return this.getRequest(t,s,e).then(function(t){return this.parseResponse(t,s,e,i,a)}.bind(this))}.bind(this)},e.Data.Source.prototype.parseResponse=function(t,e,i,a,s){var n=this.parseData(t.data||t,i,a,s),o={header:e.header||{},body:n};return o},e.Data.Source.prototype.parseArraysToObjects=function(t,e,i,a){var s=[];e.forEach(function(e,a){if(!(e in t))throw"field "+e+" not found in response for "+i[a]});for(var n=t[Object.keys(t)[1]].length,o=0;n>o;o++){for(var r={},l=0;l<e.length;l++){var h=t[e[l]][o];a&&a[l]&&(h=a[l](h)),r[i[l]]=h}s.push(r)}return s},e.Data.Source.prototype.parseObjectsToObjects=function(t,e,i,a){for(var s=[],n=[],o=0;o<e.length;o++)n[o]=0;for(var r=0;r<t.length;r++){for(var l={},h=0;h<e.length;h++){var d=t[r][e[h]];"undefined"!=typeof d&&(n[h]=1),a&&a[h]&&(d=a[h](d)),l[i[h]]=d}s.push(l)}return n.forEach(function(t,a){if(!t)throw"field "+e[a]+" not found in response for "+i[a]}),s},e.Data.Source.prototype.parseData=function(t,e,i,a){return Array.isArray(t)?this.parseObjectsToObjects(t,e,i,a):this.parseArraysToObjects(t,e,i,a)},e.Data.Source.extend=function(t,i){return t=t||function(){},t.prototype=Object.create(e.Data.Source.prototype),t.prototype.constructor=t,i&&(t.SOURCE_NAME=i,e.KnownDataSources.push(t)),t},e.Data.Source.prototype.toJSON=function(){return[Object.getPrototypeOf(this).constructor.SOURCE_NAME,{url:this.url,params:this.params}]},e.Data.AssociationSource=e.Data.Source.extend(function(t){this.parseInit(t)},"AssociationLZ"),e.Data.AssociationSource.prototype.preGetData=function(t,e,i,a){return["id","position"].forEach(function(t){-1==e.indexOf(t)&&(e.unshift(t),i.unshift(t),a.unshift(null))}),{fields:e,outnames:i,trans:a}},e.Data.AssociationSource.prototype.getURL=function(t,e,i){var a=t.analysis||e.header.analysis||this.params.analysis||3;return this.url+"results/?filter=analysis in "+a+" and chromosome in  '"+t.chr+"' and position ge "+t.start+" and position le "+t.end},e.Data.LDSource=e.Data.Source.extend(function(t){this.parseInit(t),this.params.id_field||(this.params.id_field="id"),this.params.position_field||(this.params.position_field="position"),this.params.pvalue_field||(this.params.pvalue_field="pvalue|neglog10")},"LDLZ"),e.Data.LDSource.prototype.preGetData=function(t,e){if(e.length>1)throw"LD currently only supports one field"},e.Data.LDSource.prototype.getURL=function(t,e,i){var a=function(t,e,i){e=e||"pvalue",i=i||1;for(var a=t[0][e],s=0,n=1;n<t.length;n++)t[n][e]*i>a&&(a=t[n][e]*i,s=n);return s},s=t.ldrefsource||e.header.ldrefsource||1,n=i[0];if("state"==n&&(n=t.ldrefvar||e.header.ldrefvar||"best"),"best"==n){if(!e.body)throw"No association data found to find best pvalue";n=e.body[a(e.body,this.params.pvalue_field)][this.params.id_field]}return e.header||(e.header={}),e.header.ldrefvar=n,this.url+"results/?filter=reference eq "+s+" and chromosome2 eq '"+t.chr+"' and position2 ge "+t.start+" and position2 le "+t.end+" and variant1 eq '"+n+"'&fields=chr,pos,rsquare"},e.Data.LDSource.prototype.parseResponse=function(t,e,i,a){var s=this,n=function(t,e,i,a){for(var n=0,o=0;n<t.length&&o<e.position2.length;)t[n][s.params.position_field]==e.position2[o]?(t[n][i]=e[a][o],n++,o++):t[n][s.params.position_field]<e.position2[o]?n++:o++};return n(e.body,t.data,a[0],"rsquare"),e},e.Data.GeneSource=e.Data.Source.extend(function(t){this.parseInit(t)},"GeneLZ"),e.Data.GeneSource.prototype.getURL=function(t,e,i){var a=t.source||e.header.source||this.params.source||2;return this.url+"?filter=source in "+a+" and chrom eq '"+t.chr+"' and start le "+t.end+" and end ge "+t.start},e.Data.GeneSource.prototype.parseResponse=function(t,e,i,a){return{header:e.header,body:t.data}},e.Data.RecombinationRateSource=e.Data.Source.extend(function(t){this.parseInit(t)},"RecombLZ"),e.Data.RecombinationRateSource.prototype.getURL=function(t,e,i){var a=t.recombsource||e.header.recombsource||this.params.source||15;return this.url+"?filter=id in "+a+" and chromosome eq '"+t.chr+"' and position le "+t.end+" and position ge "+t.start},e.Data.StaticSource=e.Data.Source.extend(function(t){this._data=t},"StaticJSON"),e.Data.StaticSource.prototype.getRequest=function(t,e,i){return Q.fcall(function(){return this._data}.bind(this))},e.Data.StaticSource.prototype.toJSON=function(){return[Object.getPrototypeOf(this).constructor.SOURCE_NAME,this._data]},e.Instance=function(t,i,a){return this.initialized=!1,this.id=t,this.svg=null,this.panels={},this.panel_ids_by_y_index=[],this.applyPanelYIndexesToPanelLayouts=function(){this.panel_ids_by_y_index.forEach(function(t,e){this.panels[t].layout.y_index=e}.bind(this))},this.remap_promises=[],"undefined"==typeof a?this.layout=e.mergeLayouts(e.StandardLayout,e.Instance.DefaultLayout):this.layout=e.mergeLayouts(a,e.Instance.DefaultLayout),this.state=this.layout.state,this.lzd=new e.Data.Requester(i),this.window_onresize=null,this.onUpdateFunctions=[],this.getPageOrigin=function(){for(var t=this.svg.node().getBoundingClientRect(),e=document.documentElement.scrollLeft||document.body.scrollLeft,i=document.documentElement.scrollTop||document.body.scrollTop,a=this.svg.node();null!=a.parentNode;)if(a=a.parentNode,a!=document&&"static"!=d3.select(a).style("position")){e=-1*a.getBoundingClientRect().left,i=-1*a.getBoundingClientRect().top;break}return{x:e+t.left,y:i+t.top}},this.initializeLayout(),this},e.Instance.DefaultLayout={state:{},width:1,height:1,min_width:1,min_height:1,resizable:!1,aspect_ratio:1,panels:{},controls:{show:"onmouseover",hide_delay:300},panel_boundaries:!0},e.Instance.prototype.sumProportional=function(t){if("height"!=t&&"width"!=t)throw"Bad dimension value passed to LocusZoom.Instance.prototype.sumProportional";var e=0;for(var i in this.panels)this.panels[i].layout["proportional_"+t]||(this.panels[i].layout["proportional_"+t]=1/Object.keys(this.panels).length),e+=this.panels[i].layout["proportional_"+t];return e},e.Instance.prototype.onUpdate=function(t){if("undefined"==typeof t)for(t in this.onUpdateFunctions)this.onUpdateFunctions[t]();else"function"==typeof t&&this.onUpdateFunctions.push(t)},e.Instance.prototype.initializeLayout=function(){if(isNaN(this.layout.width)||this.layout.width<=0)throw"Instance layout parameter `width` must be a positive number";if(isNaN(this.layout.height)||this.layout.height<=0)throw"Instance layout parameter `width` must be a positive number";if(isNaN(this.layout.aspect_ratio)||this.layout.aspect_ratio<=0)throw"Instance layout parameter `aspect_ratio` must be a positive number";"responsive"==this.layout.resizable&&(this.window_onresize=d3.select(window).on("resize.lz-"+this.id,function(){var t=this.svg.node().parentNode.getBoundingClientRect();this.setDimensions(t.width,t.height)}.bind(this)),d3.select(window).on("load.lz-"+this.id,function(){this.setDimensions()}.bind(this)));var t;for(t in this.layout.panels)this.addPanel(t,this.layout.panels[t])},e.Instance.prototype.setDimensions=function(t,e){var i=null,a=null;for(var s in this.panels)i=Math.max(i,this.panels[s].layout.min_width),a=Math.max(a,this.panels[s].layout.min_height/this.panels[s].layout.proportional_height);if(this.layout.min_width=Math.max(i,1),this.layout.min_height=Math.max(a,1),!isNaN(t)&&t>=0&&!isNaN(e)&&e>=0){this.layout.width=Math.max(Math.round(+t),this.layout.min_width),this.layout.height=Math.max(Math.round(+e),this.layout.min_height),"responsive"==this.layout.resizable&&(this.svg&&(this.layout.width=Math.max(this.svg.node().parentNode.getBoundingClientRect().width,this.layout.min_width)),this.layout.height=this.layout.width/this.layout.aspect_ratio,this.layout.height<this.layout.min_height&&(this.layout.height=this.layout.min_height,this.layout.width=this.layout.height*this.layout.aspect_ratio));var n=0;this.panel_ids_by_y_index.forEach(function(t){var e=this.layout.width,i=this.panels[t].layout.proportional_height*this.layout.height;this.panels[t].setDimensions(e,i),this.panels[t].setOrigin(0,n),this.panels[t].layout.proportional_origin.x=0,this.panels[t].layout.proportional_origin.y=n/this.layout.height,n+=i,this.panels[t].controls.selector&&this.panels[t].controls.position()}.bind(this)),this.panel_boundaries&&this.panel_boundaries.showing&&this.panel_boundaries.position()}else if(Object.keys(this.panels).length){this.layout.width=0,this.layout.height=0;for(var s in this.panels)this.layout.width=Math.max(this.panels[s].layout.width,this.layout.width),this.layout.height+=this.panels[s].layout.height;this.layout.width=Math.max(this.layout.width,this.layout.min_width),this.layout.height=Math.max(this.layout.height,this.layout.min_height)}return this.layout.aspect_ratio=this.layout.width/this.layout.height,null!=this.svg&&("responsive"==this.layout.resizable?this.svg.attr("viewBox","0 0 "+this.layout.width+" "+this.layout.height).attr("preserveAspectRatio","xMinYMin meet"):this.svg.attr("width",this.layout.width).attr("height",this.layout.height)),this.initialized&&this.ui.render(),this.onUpdate(),this},e.Instance.prototype.addPanel=function(t,i){if("string"!=typeof t)throw"Invalid panel id passed to LocusZoom.Instance.prototype.addPanel()";if("undefined"!=typeof this.panels[t])throw"Cannot create panel with id ["+t+"]; panel with that id already exists";if("object"!=typeof i)throw"Invalid panel layout passed to LocusZoom.Instance.prototype.addPanel()";var a=new e.Panel(t,i,this);if(this.panels[a.id]=a,null!=a.layout.y_index&&!isNaN(a.layout.y_index)&&this.panel_ids_by_y_index.length>0)a.layout.y_index<0&&(a.layout.y_index=Math.max(this.panel_ids_by_y_index.length+a.layout.y_index,0)),this.panel_ids_by_y_index.splice(a.layout.y_index,0,a.id),this.applyPanelYIndexesToPanelLayouts();else{var s=this.panel_ids_by_y_index.push(a.id);this.panels[a.id].layout.y_index=s-1}return"undefined"==typeof this.layout.panels[a.id]&&(this.layout.panels[a.id]=this.panels[a.id].layout),this.initialized&&(this.positionPanels(),this.panels[a.id].initialize(),this.panels[a.id].reMap(),this.setDimensions(this.layout.width,this.layout.height)),this.panels[a.id]},e.Instance.prototype.removePanel=function(t){if(!this.panels[t])throw"Unable to remove panel, ID not found: "+t;return this.panels[t].data_layer_ids_by_z_index.forEach(function(e){this.panels[t].data_layers[e].destroyAllTooltips(),delete this.layout.state[t+"."+e]}.bind(this)),this.panels[t].svg.container&&this.panels[t].svg.container.remove(),delete this.panels[t],delete this.layout.panels[t],delete this.layout.state[t],this.panel_ids_by_y_index.splice(this.panel_ids_by_y_index.indexOf(t),1),this.initialized&&(this.positionPanels(),this.setDimensions(this.layout.width,this.layout.height)),this},e.Instance.prototype.positionPanels=function(){for(var t in this.panels)null==this.panels[t].layout.proportional_height&&(this.panels[t].layout.proportional_height=this.panels[t].layout.height/this.layout.height),null==this.panels[t].layout.proportional_width&&(this.panels[t].layout.proportional_width=1);var e=this.sumProportional("height");if(!e)return this;var i=1/e;for(var t in this.panels)this.panels[t].layout.proportional_height*=i;var a=0;this.panel_ids_by_y_index.forEach(function(t){this.panels[t].setOrigin(0,a),this.panels[t].layout.proportional_origin.x=0,a+=this.panels[t].layout.height}.bind(this));var s=a;this.panel_ids_by_y_index.forEach(function(t){this.panels[t].layout.proportional_origin.y=this.panels[t].layout.origin.y/s}.bind(this)),this.setDimensions(),this.panel_ids_by_y_index.forEach(function(t){this.panels[t].setDimensions(this.layout.width*this.panels[t].layout.proportional_width,this.layout.height*this.panels[t].layout.proportional_height)}.bind(this))},e.Instance.prototype.initialize=function(){var t=this.svg.append("g").attr("class","lz-mouse_guide").attr("id",this.id+".mouse_guide"),e=t.append("rect").attr("class","lz-mouse_guide-vertical").attr("x",-1),i=t.append("rect").attr("class","lz-mouse_guide-horizontal").attr("y",-1);this.mouse_guide={svg:t,vertical:e,horizontal:i};var a=this.svg.append("g").attr("class","lz-ui").attr("id",this.id+".ui").style("display","none");this.ui={svg:a,parent:this,hide_timeout:null,is_resize_dragging:!1,show:function(){this.svg.style("display",null)},hide:function(){this.svg.style("display","none")},initialize:function(){if("manual"==this.parent.layout.resizable){this.resize_handle=this.svg.append("g").attr("id",this.parent.id+".ui.resize_handle"),this.resize_handle.append("path").attr("class","lz-ui-resize_handle").attr("d","M 0,16, L 16,0, L 16,16 Z");var t=d3.behavior.drag();t.on("dragstart",function(){this.resize_handle.select("path").attr("class","lz-ui-resize_handle_dragging"),this.is_resize_dragging=!0}.bind(this)),t.on("dragend",function(){this.resize_handle.select("path").attr("class","lz-ui-resize_handle"),this.is_resize_dragging=!1}.bind(this)),t.on("drag",function(){this.setDimensions(this.layout.width+d3.event.dx,this.layout.height+d3.event.dy)}.bind(this.parent)),this.resize_handle.call(t)}this.render()},render:function(){"manual"==this.parent.layout.resizable&&this.resize_handle.attr("transform","translate("+(this.parent.layout.width-17)+", "+(this.parent.layout.height-17)+")")}},this.ui.initialize();var s=this.svg.append("g").attr("class","lz-curtain").style("display","none").attr("id",this.id+".curtain");this.curtain={svg:s,drop:function(t){if(this.svg.style("display",null),"undefined"!=typeof t)try{this.svg.select("text").selectAll("tspan").remove(),t.split("\n").forEach(function(t){this.svg.select("text").append("tspan").attr("x","1em").attr("dy","1.5em").text(t)}.bind(this)),this.svg.select("text").append("tspan").attr("x","1em").attr("dy","2.5em").attr("class","dismiss").text("Dismiss").on("click",function(){this.raise()}.bind(this))}catch(e){console.error("LocusZoom tried to render an error message but it's not a string:",t)}},raise:function(){this.svg.style("display","none")}},this.curtain.svg.append("rect").attr("width","100%").attr("height","100%"),this.curtain.svg.append("text").attr("id",this.id+".curtain_text").attr("x","1em").attr("y","0em"),this.panel_boundaries={parent:this,hide_timeout:null,showing:!1,dragging:!1,selectors:[],show:function(){this.showing||(this.parent.panel_ids_by_y_index.forEach(function(t,e){var i=d3.select(this.parent.svg.node().parentNode).append("div").attr("class","lz-panel-boundary").attr("title","Resize panels"),a=d3.behavior.drag();a.on("dragstart",function(){this.dragging=!0}.bind(this)),a.on("dragend",function(){this.dragging=!1}.bind(this)),a.on("drag",function(){var t=this.parent.panels[this.parent.panel_ids_by_y_index[e]],i=t.layout.height;t.setDimensions(t.layout.width,t.layout.height+d3.event.dy);var a=t.layout.height-i,s=this.parent.layout.height+a;this.parent.panel_ids_by_y_index.forEach(function(t,i){var n=this.parent.panels[this.parent.panel_ids_by_y_index[i]];n.layout.proportional_height=n.layout.height/s,i>e&&(n.setOrigin(n.layout.origin.x,n.layout.origin.y+a),n.layout.controls&&n.controls.position())}.bind(this)),this.parent.positionPanels(),this.position()}.bind(this)),i.call(a),this.parent.panel_boundaries.selectors.push(i)}.bind(this)),this.showing=!0),this.position()},position:function(){var t=this.parent.getPageOrigin();this.selectors.forEach(function(e,i){var a=this.parent.panels[this.parent.panel_ids_by_y_index[i]].getPageOrigin(),s=t.x,n=a.y+this.parent.panels[this.parent.panel_ids_by_y_index[i]].layout.height-2,o=this.parent.layout.width-1;e.style({top:n+"px",left:s+"px",width:o+"px"})}.bind(this))},hide:function(){this.selectors.forEach(function(t){t.remove()}),this.selectors=[],this.showing=!1}},this.layout.panel_boundaries&&(d3.select(this.svg.node().parentNode).on("mouseover."+this.id+".panel_boundaries",function(){clearTimeout(this.panel_boundaries.hide_timeout),this.panel_boundaries.show()}.bind(this)),d3.select(this.svg.node().parentNode).on("mouseout."+this.id+".panel_boundaries",function(){this.panel_boundaries.hide_timeout=setTimeout(function(){this.panel_boundaries.hide()}.bind(this),300)}.bind(this)));var n="";for(var o in Object.keys(document.styleSheets))if(null!=document.styleSheets[o].href&&-1!=document.styleSheets[o].href.indexOf("locuszoom.css")){for(var r in document.styleSheets[o].cssRules)"undefined"!=typeof document.styleSheets[o].cssRules[r].cssText&&(n+=document.styleSheets[o].cssRules[r].cssText+" ");break}this.controls={parent:this,showing:!1,css_string:n,show:function(){this.showing||(this.div=d3.select(this.parent.svg.node().parentNode).append("div").attr("class","lz-locuszoom-controls").attr("id",this.parent.id+".controls"),this.links=this.div.append("div").attr("id",this.parent.id+".controls.links").style("float","left"),this.download_svg_button=this.links.append("a").attr("class","lz-controls-button").attr("href-lang","image/svg+xml").attr("title","Download SVG as locuszoom.svg").attr("download","locuszoom.svg").text("Download SVG").on("mouseover",function(){this.download_svg_button.attr("class","lz-controls-button-disabled").text("Preparing SVG"),this.generateBase64SVG().then(function(t){this.download_svg_button.attr("href","data:image/svg+xml;base64,\n"+t),this.download_svg_button.attr("class","lz-controls-button").text("Download SVG")}.bind(this))}.bind(this)),this.dimensions=this.div.append("div").attr("class","lz-controls-info").attr("id",this.parent.id+".controls.dimensions").style("float","right"),this.clear=this.div.append("div").attr("id",this.parent.id+".controls.clear").style("clear","both"),this.showing=!0),this.update()},update:function(){this.div.attr("width",this.parent.layout.width);var t=-1==this.parent.layout.width.toString().indexOf(".")?this.parent.layout.width:this.parent.layout.width.toFixed(2),e=-1==this.parent.layout.height.toString().indexOf(".")?this.parent.layout.height:this.parent.layout.height.toFixed(2);this.dimensions.text(t+"px × "+e+"px")},hide:function(){this.div.remove(),this.showing=!1},generateBase64SVG:function(){return Q.fcall(function(){var t=this.div.append("div").style("display","none").html(this.parent.svg.node().outerHTML);t.selectAll("g.lz-curtain").remove(),t.selectAll("g.lz-ui").remove(),t.selectAll("g.lz-mouse_guide").remove();var e=d3.select(t.select("svg").node().parentNode).html(),i='<style type="text/css"><![CDATA[ '+this.css_string+" ]]></style>",a=e.indexOf(">")+1;return e=e.slice(0,a)+i+e.slice(a),t.remove(),btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode("0x"+e)}))}.bind(this))}},"always"==this.layout.controls.show?this.controls.show():"onmouseover"==this.layout.controls.show&&(d3.select(this.svg.node().parentNode).on("mouseover."+this.id+".controls",function(){clearTimeout(this.controls.hide_timeout),this.controls.show()}.bind(this)),d3.select(this.svg.node().parentNode).on("mouseout."+this.id+".controls",function(){this.controls.hide_timeout=setTimeout(function(){this.controls.hide()}.bind(this),this.layout.controls.hide_delay)}.bind(this)));for(var l in this.panels)this.panels[l].initialize();return this.svg.on("mouseover",function(){this.ui.is_resize_dragging||(clearTimeout(this.ui.hide_timeout),this.ui.show())}.bind(this)),this.svg.on("mouseout",function(){this.ui.is_resize_dragging||(this.ui.hide_timeout=setTimeout(function(){this.ui.hide()}.bind(this),300)),this.mouse_guide.vertical.attr("x",-1),this.mouse_guide.horizontal.attr("y",-1)}.bind(this)),this.svg.on("mousemove",function(){var t=d3.mouse(this.svg.node());this.mouse_guide.vertical.attr("x",t[0]),this.mouse_guide.horizontal.attr("y",t[1]),-1!=["onmouseover","always"].indexOf(this.layout.controls.show)&&this.controls.update()}.bind(this)),this.initialized=!0,this.setDimensions(this.layout.width,this.layout.height),this},e.Instance.prototype.mapTo=function(t,e,i){console.warn("Warning: use of LocusZoom.Instance.mapTo() is deprecated. Use LocusZoom.Instance.applyState() instead."),this.state.chr=+t,this.state.start=+e,this.state.end=+i,this.remap_promises=[];for(var a in this.panels)this.remap_promises.push(this.panels[a].reMap());return Q.all(this.remap_promises)["catch"](function(t){console.log(t),this.curtain.drop(t)}.bind(this)).done(function(){this.onUpdate()}.bind(this)),this},e.Instance.prototype.refresh=function(){this.applyState({})},e.Instance.prototype.applyState=function(t){if("object"!=typeof t)throw"LocusZoom.applyState only accepts an object; "+typeof t+" given";for(var e in t)this.state[e]=t[e];this.remap_promises=[];for(var i in this.panels)this.remap_promises.push(this.panels[i].reMap());return Q.all(this.remap_promises)["catch"](function(t){console.log(t),this.curtain.drop(t)}.bind(this)).done(function(){this.onUpdate()}.bind(this)),this},e.Panel=function(t,i,a){return this.initialized=!1,this.id=t,this.parent=a||null,this.svg={},this.layout=e.mergeLayouts(i||{},e.Panel.DefaultLayout),this.parent?(this.state=this.parent.state,this.state_id=this.id,this.state[this.state_id]=this.state[this.state_id]||{}):(this.state=null,this.state_id=null),this.data_layers={},this.data_layer_ids_by_z_index=[],this.data_promises=[],this.x_extent=null,this.y1_extent=null,this.y2_extent=null,this.x_ticks=[],this.y1_ticks=[],this.y2_ticks=[],this.getBaseId=function(){return this.parent.id+"."+this.id},this.onUpdate=function(){this.parent.onUpdate()},this.getPageOrigin=function(){var t=this.parent.getPageOrigin();return{x:t.x+this.layout.origin.x,y:t.y+this.layout.origin.y}},this.initializeLayout(),this},e.Panel.DefaultLayout={title:null,description:null,y_index:null,width:0,height:0,origin:{x:0,y:0},min_width:1,min_height:1,proportional_width:null,proportional_height:null,proportional_origin:{x:0,y:0},margin:{top:0,right:0,bottom:0,left:0},controls:{description:!0,reposition:!0,remove:!0},cliparea:{height:0,width:0,origin:{x:0,y:0}},axes:{x:{},y1:{},y2:{}}},e.Panel.prototype.initializeLayout=function(){if(0==this.layout.width&&null==this.layout.proportional_width&&(this.layout.proportional_width=1),0==this.layout.height&&null==this.layout.proportional_height){var t=Object.keys(this.parent.panels).length;t>0?this.layout.proportional_height=1/t:this.layout.proportional_height=1}if(this.setDimensions(),this.setOrigin(),this.setMargin(),["x","y1","y2"].forEach(function(t){Object.keys(this.layout.axes[t]).length&&this.layout.axes[t].render!==!1?(this.layout.axes[t].render=!0,this.layout.axes[t].label=this.layout.axes[t].label||null,this.layout.axes[t].label_function=this.layout.axes[t].label_function||null):this.layout.axes[t].render=!1}.bind(this)),"object"==typeof this.layout.data_layers){var e;for(e in this.layout.data_layers)this.addDataLayer(e,this.layout.data_layers[e])}},e.Panel.prototype.setDimensions=function(t,e){return"undefined"!=typeof t&&"undefined"!=typeof e?!isNaN(t)&&t>=0&&!isNaN(e)&&e>=0&&(this.layout.width=Math.max(Math.round(+t),this.layout.min_width),this.layout.height=Math.max(Math.round(+e),this.layout.min_height)):(null!=this.layout.proportional_width&&(this.layout.width=Math.max(this.layout.proportional_width*this.parent.layout.width,this.layout.min_width)),null!=this.layout.proportional_height&&(this.layout.height=Math.max(this.layout.proportional_height*this.parent.layout.height,this.layout.min_height))),this.layout.cliparea.width=Math.max(this.layout.width-(this.layout.margin.left+this.layout.margin.right),0),this.layout.cliparea.height=Math.max(this.layout.height-(this.layout.margin.top+this.layout.margin.bottom),0),this.initialized&&this.render(),this},e.Panel.prototype.setOrigin=function(t,e){return!isNaN(t)&&t>=0&&(this.layout.origin.x=Math.max(Math.round(+t),0)),!isNaN(e)&&e>=0&&(this.layout.origin.y=Math.max(Math.round(+e),0)),this.initialized&&this.render(),this},e.Panel.prototype.setMargin=function(t,e,i,a){var s;return!isNaN(t)&&t>=0&&(this.layout.margin.top=Math.max(Math.round(+t),0)),!isNaN(e)&&e>=0&&(this.layout.margin.right=Math.max(Math.round(+e),0)),!isNaN(i)&&i>=0&&(this.layout.margin.bottom=Math.max(Math.round(+i),0)),!isNaN(a)&&a>=0&&(this.layout.margin.left=Math.max(Math.round(+a),0)),this.layout.margin.top+this.layout.margin.bottom>this.layout.height&&(s=Math.floor((this.layout.margin.top+this.layout.margin.bottom-this.layout.height)/2),
this.layout.margin.top-=s,this.layout.margin.bottom-=s),this.layout.margin.left+this.layout.margin.right>this.layout.width&&(s=Math.floor((this.layout.margin.left+this.layout.margin.right-this.layout.width)/2),this.layout.margin.left-=s,this.layout.margin.right-=s),["top","right","bottom","left"].forEach(function(t){this.layout.margin[t]=Math.max(this.layout.margin[t],0)}.bind(this)),this.layout.cliparea.width=Math.max(this.layout.width-(this.layout.margin.left+this.layout.margin.right),0),this.layout.cliparea.height=Math.max(this.layout.height-(this.layout.margin.top+this.layout.margin.bottom),0),this.layout.cliparea.origin.x=this.layout.margin.left,this.layout.cliparea.origin.y=this.layout.margin.top,this.initialized&&this.render(),this},e.Panel.prototype.initialize=function(){this.svg.container=this.parent.svg.insert("svg:g","#"+this.parent.id+"\\.ui").attr("id",this.getBaseId()+".panel_container");var t=this.svg.container.append("clipPath").attr("id",this.getBaseId()+".clip");this.svg.clipRect=t.append("rect"),this.svg.group=this.svg.container.append("g").attr("id",this.getBaseId()+".panel").attr("clip-path","url(#"+this.getBaseId()+".clip)");var e=this.svg.container.append("g").attr("id",this.getBaseId()+".curtain").attr("clip-path","url(#"+this.getBaseId()+".clip)").attr("class","lz-curtain").style("display","none");if(this.curtain={svg:e,drop:function(t){if(this.svg.style("display",null),"undefined"!=typeof t)try{this.svg.select("text").selectAll("tspan").remove(),t.split("\n").forEach(function(t){this.svg.select("text").append("tspan").attr("x","1em").attr("dy","1.5em").text(t)}.bind(this)),this.svg.select("text").append("tspan").attr("x","1em").attr("dy","2.5em").attr("class","dismiss").text("Dismiss").on("click",function(){this.raise()}.bind(this))}catch(e){console.error("LocusZoom tried to render an error message but it's not a string:",t)}},raise:function(){this.svg.style("display","none")}},this.curtain.svg.append("rect").attr("width","100%").attr("height","100%"),this.curtain.svg.append("text").attr("id",this.getBaseId()+".curtain_text").attr("x","1em").attr("y","0em"),this.controls={selector:null,hide_timeout:null,link_selectors:{},show:function(){this.layout.controls&&!this.controls.selector&&(this.controls.selector=d3.select(this.parent.svg.node().parentNode).append("div").attr("class","lz-locuszoom-controls lz-locuszoom-panel-controls").attr("id",this.getBaseId()+".controls").style({position:"absolute"}),this.layout.controls.reposition&&(this.controls.link_selectors.reposition_up=this.controls.selector.append("a").attr("class","lz-panel-controls-button-disabled").attr("title","Move panel up").style({"font-weight":"bold"}).text("▴").on("click",function(){this.parent.panel_ids_by_y_index[this.layout.y_index-1]&&(this.parent.panel_ids_by_y_index[this.layout.y_index]=this.parent.panel_ids_by_y_index[this.layout.y_index-1],this.parent.panel_ids_by_y_index[this.layout.y_index-1]=this.id,this.parent.applyPanelYIndexesToPanelLayouts(),this.parent.positionPanels())}.bind(this)),this.controls.link_selectors.reposition_down=this.controls.selector.append("a").attr("class","lz-panel-controls-button-disabled").attr("title","Move panel down").style({"font-weight":"bold"}).text("▾").on("click",function(){this.parent.panel_ids_by_y_index[this.layout.y_index+1]&&(this.parent.panel_ids_by_y_index[this.layout.y_index]=this.parent.panel_ids_by_y_index[this.layout.y_index+1],this.parent.panel_ids_by_y_index[this.layout.y_index+1]=this.id,this.parent.applyPanelYIndexesToPanelLayouts(),this.parent.positionPanels())}.bind(this))),this.layout.controls.description&&this.layout.description&&(this.controls.link_selectors.description=this.controls.selector.append("a").attr("class","lz-panel-controls-button").attr("title","View panel information").style({"font-weight":"bold"}).text("?").on("click",function(){this.controls.description.is_showing?this.controls.description.hide():(this.controls.description.show(),this.controls.description.position())}.bind(this)),this.controls.description={is_showing:!1,selector:null,show:function(){this.controls.link_selectors.description.attr("class","lz-panel-controls-button-selected"),this.controls.description.selector=d3.select(this.parent.svg.node().parentNode).append("div").attr("class","lz-panel-description").attr("id",this.getBaseId()+".description").html(this.layout.description),this.controls.description.is_showing=!0}.bind(this),position:function(){var t=4,e=this.getPageOrigin(),i=this.controls.selector.node().getBoundingClientRect(),a=this.controls.description.selector.node().getBoundingClientRect(),s=(e.y+i.height+t).toString()+"px",n=Math.max(e.x+this.layout.width-a.width-t,e.x+t).toString()+"px";this.controls.description.selector.style({top:s,left:n})}.bind(this),hide:function(){this.controls.link_selectors.description.attr("class","lz-panel-controls-button"),this.controls.description.selector.remove(),this.controls.description.is_showing=!1}.bind(this)}),this.layout.controls.remove&&(this.controls.link_selectors.remove=this.controls.selector.append("a").attr("class","lz-panel-controls-button").attr("title","Remove panel").style({"font-weight":"bold"}).text("×").on("click",function(){this.controls.description&&this.controls.description.is_showing&&this.controls.description.hide(),this.controls.hide(),d3.select(this.parent.svg.node().parentNode).on("mouseover."+this.getBaseId()+".controls",null),d3.select(this.parent.svg.node().parentNode).on("mouseout."+this.getBaseId()+".controls",null),this.parent.removePanel(this.id)}.bind(this))))}.bind(this),position:function(){var t=this.getPageOrigin(),e=this.controls.selector.node().getBoundingClientRect(),i=t.y.toString()+"px",a=(t.x+this.layout.width-e.width).toString()+"px";this.controls.selector.style({position:"absolute",top:i,left:a}),this.controls.description&&this.controls.description.is_showing&&this.controls.description.position(),this.controls.link_selectors.reposition_up&&this.controls.link_selectors.reposition_up.attr("class",0==this.layout.y_index?"lz-panel-controls-button-disabled":"lz-panel-controls-button"),this.controls.link_selectors.reposition_down&&this.controls.link_selectors.reposition_down.attr("class",this.layout.y_index==this.parent.panel_ids_by_y_index.length-1?"lz-panel-controls-button-disabled":"lz-panel-controls-button")}.bind(this),hide:function(){this.layout.controls&&this.controls.selector&&(this.controls.description&&this.controls.description.is_showing||this.parent.ui.dragging||this.parent.panel_boundaries.dragging||(this.controls.selector.remove(),this.controls.selector=null))}.bind(this)},this.layout.controls&&(d3.select(this.parent.svg.node().parentNode).on("mouseover."+this.getBaseId()+".controls",function(){clearTimeout(this.controls.hide_timeout),this.controls.show(),this.controls.position()}.bind(this)),d3.select(this.parent.svg.node().parentNode).on("mouseout."+this.getBaseId()+".controls",function(){this.controls.hide_timeout=setTimeout(function(){this.controls.hide()}.bind(this),300)}.bind(this))),this.layout.inner_border&&(this.inner_border=this.svg.group.append("rect")),this.layout.title){var i=10,a=22;"string"==typeof this.layout.title&&(this.layout.title={text:this.layout.title,x:i,y:a}),this.svg.group.append("text").attr("class","lz-panel-title").attr("x",parseFloat(this.layout.title.x)||i).attr("y",parseFloat(this.layout.title.y)||a).text(this.layout.title.text)}return this.svg.x_axis=this.svg.group.append("g").attr("id",this.getBaseId()+".x_axis").attr("class","lz-x lz-axis"),this.layout.axes.x.render&&(this.svg.x_axis_label=this.svg.x_axis.append("text").attr("class","lz-x lz-axis lz-label").attr("text-anchor","middle")),this.svg.y1_axis=this.svg.group.append("g").attr("id",this.getBaseId()+".y1_axis").attr("class","lz-y lz-y1 lz-axis"),this.layout.axes.y1.render&&(this.svg.y1_axis_label=this.svg.y1_axis.append("text").attr("class","lz-y1 lz-axis lz-label").attr("text-anchor","middle")),this.svg.y2_axis=this.svg.group.append("g").attr("id",this.getBaseId()+".y2_axis").attr("class","lz-y lz-y2 lz-axis"),this.layout.axes.y2.render&&(this.svg.y2_axis_label=this.svg.y2_axis.append("text").attr("class","lz-y2 lz-axis lz-label").attr("text-anchor","middle")),this.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].initialize()}.bind(this)),this},e.Panel.prototype.addDataLayer=function(t,i){if("string"!=typeof t)throw"Invalid data layer id passed to LocusZoom.Panel.prototype.addDataLayer()";if("object"!=typeof i)throw"Invalid data layer layout passed to LocusZoom.Panel.prototype.addDataLayer()";if("undefined"!=typeof this.data_layers[i.id])throw"Cannot create data layer with id ["+t+"]; data layer with that id already exists";if("string"!=typeof i.type)throw"Invalid data layer type in layout passed to LocusZoom.Panel.prototype.addDataLayer()";"object"!=typeof i.y_axis||"undefined"!=typeof i.y_axis.axis&&-1!=[1,2].indexOf(i.y_axis.axis)||(i.y_axis.axis=1);var a=e.DataLayers.get(i.type,t,i,this);if(this.data_layers[a.id]=a,null!=a.layout.z_index&&!isNaN(a.layout.z_index)&&this.data_layer_ids_by_z_index.length>0)a.layout.z_index<0&&(a.layout.z_index=Math.max(this.data_layer_ids_by_z_index.length+a.layout.z_index,0)),this.data_layer_ids_by_z_index.splice(a.layout.z_index,0,a.id),this.data_layer_ids_by_z_index.forEach(function(t,e){this.data_layers[t].layout.z_index=e}.bind(this));else{var s=this.data_layer_ids_by_z_index.push(a.id);this.data_layers[a.id].layout.z_index=s-1}return"undefined"==typeof this.layout.data_layers[a.id]&&(this.layout.data_layers[a.id]=this.data_layers[a.id].layout),this.data_layers[a.id]},e.Panel.prototype.reMap=function(){this.data_promises=[];for(var t in this.data_layers)try{this.data_promises.push(this.data_layers[t].reMap())}catch(e){console.log(e),this.curtain.drop(e)}return Q.all(this.data_promises).then(function(){this.initialized=!0,this.render()}.bind(this))["catch"](function(t){console.log(t),this.curtain.drop(t)}.bind(this))},e.Panel.prototype.generateExtents=function(){this.x_extent=null,this.y1_extent=null,this.y2_extent=null;for(var t in this.data_layers){var e=this.data_layers[t];if(e.layout.x_axis&&!e.layout.x_axis.decoupled&&(this.x_extent=d3.extent((this.x_extent||[]).concat(e.getAxisExtent("x")))),e.layout.y_axis&&!e.layout.y_axis.decoupled){var i="y"+e.layout.y_axis.axis;this[i+"_extent"]=d3.extent((this[i+"_extent"]||[]).concat(e.getAxisExtent("y")))}}},e.Panel.prototype.render=function(){this.svg.container.attr("transform","translate("+this.layout.origin.x+","+this.layout.origin.y+")"),this.svg.clipRect.attr("width",this.layout.width).attr("height",this.layout.height),this.layout.inner_border&&this.inner_border.attr("x",this.layout.margin.left).attr("y",this.layout.margin.top).attr("width",this.layout.width-(this.layout.margin.left+this.layout.margin.right)).attr("height",this.layout.height-(this.layout.margin.top+this.layout.margin.bottom)).style({fill:"none","stroke-width":1,stroke:this.layout.inner_border}),this.generateExtents(),this.x_extent&&(this.layout.axes.x.ticks?this.x_ticks=this.layout.axes.x.ticks:this.x_ticks=e.prettyTicks(this.x_extent,"both",this.layout.cliparea.width/120),this.x_scale=d3.scale.linear().domain([this.x_extent[0],this.x_extent[1]]).range([0,this.layout.cliparea.width])),this.y1_extent&&(this.layout.axes.y1.ticks?this.y1_ticks=this.layout.axes.y1.ticks:this.y1_ticks=e.prettyTicks(this.y1_extent),this.y1_extent=d3.extent(this.y1_extent.concat(this.y1_ticks)),this.y1_scale=d3.scale.linear().domain([this.y1_extent[0],this.y1_extent[1]]).range([this.layout.cliparea.height,0])),this.y2_extent&&(this.layout.axes.y2.ticks?this.y2_ticks=this.layout.axes.y2.ticks:this.y2_ticks=e.prettyTicks(this.y2_extent),this.y2_extent=d3.extent(this.y2_extent.concat(this.y2_ticks)),this.y2_scale=d3.scale.linear().domain([this.y2_extent[0],this.y2_extent[1]]).range([this.layout.cliparea.height,0]));var t=function(t){return"function"==typeof this[t+"_scale"]&&!isNaN(this[t+"_scale"](0))}.bind(this);return this.layout.axes.x.render&&t("x")&&this.renderAxis("x"),this.layout.axes.y1.render&&t("y1")&&this.renderAxis("y1"),this.layout.axes.y2.render&&t("y2")&&this.renderAxis("y2"),this.data_layer_ids_by_z_index.forEach(function(t){this.data_layers[t].draw().render()}.bind(this)),this},e.Panel.prototype.renderAxis=function(t){if(-1==["x","y1","y2"].indexOf(t))throw"Unable to render axis; invalid axis identifier: "+t;var i={x:{position:"translate("+this.layout.margin.left+","+(this.layout.height-this.layout.margin.bottom)+")",orientation:"bottom",label_x:this.layout.cliparea.width/2,label_y:this.layout.axes[t].label_offset||0,label_rotate:null},y1:{position:"translate("+this.layout.margin.left+","+this.layout.margin.top+")",orientation:"left",label_x:-1*(this.layout.axes[t].label_offset||0),label_y:this.layout.cliparea.height/2,label_rotate:-90},y2:{position:"translate("+(this.layout.width-this.layout.margin.right)+","+this.layout.margin.top+")",orientation:"right",label_x:this.layout.axes[t].label_offset||0,label_y:this.layout.cliparea.height/2,label_rotate:-90}},a=function(t){for(var e=0;e<t.length;e++)if(isNaN(t[e]))return!1;return!0}(this[t+"_ticks"]);if(this[t+"_axis"]=d3.svg.axis().scale(this[t+"_scale"]).orient(i[t].orientation),a)this[t+"_axis"].tickValues(this[t+"_ticks"]),"region"==this.layout.axes[t].tick_format&&this[t+"_axis"].tickFormat(function(t){return e.positionIntToString(t)});else{var s=this[t+"_ticks"].map(function(t){return t.x});this[t+"_axis"].tickValues(s).tickFormat(function(e,i){return this[t+"_ticks"][i].text}.bind(this))}if(this.svg[t+"_axis"].attr("transform",i[t].position).call(this[t+"_axis"]),!a){var n=d3.selectAll("g#"+this.getBaseId().replace(".","\\.")+"\\."+t+"_axis g.tick"),o=this;n.each(function(e,i){var a=d3.select(this).select("text");o[t+"_ticks"][i].style&&a.style(o[t+"_ticks"][i].style),o[t+"_ticks"][i].transform&&a.attr("transform",o[t+"_ticks"][i].transform)})}var r=this.layout.axes[t].label||null;this.layout.axes[t].label_function&&(r=e.LabelFunctions.get(this.layout.axes[t].label_function,this.state)),null!=r&&(this.svg[t+"_axis_label"].attr("x",i[t].label_x).attr("y",i[t].label_y).text(r),null!=i[t].label_rotate&&this.svg[t+"_axis_label"].attr("transform","rotate("+i[t].label_rotate+" "+i[t].label_x+","+i[t].label_y+")"))},e.DataLayer=function(t,i,a){return this.initialized=!1,this.id=t,this.parent=a||null,this.svg={},this.layout=e.mergeLayouts(i||{},e.DataLayer.DefaultLayout),this.parent?(this.state=this.parent.state,this.state_id=this.parent.id+"."+this.id,this.state[this.state_id]=this.state[this.state_id]||{},this.layout.selectable&&(this.state[this.state_id].selected=this.state[this.state_id].selected||null)):(this.state={},this.state_id=null),this.data=[],this.getBaseId=function(){return this.parent.parent.id+"."+this.parent.id+"."+this.id},this.onUpdate=function(){this.parent.onUpdate()},this.tooltips={},this.createTooltip=function(t,e){if("object"!=typeof this.layout.tooltip)throw"DataLayer ["+this.id+"] layout does not define a tooltip";if("string"!=typeof e)throw"Unable to create tooltip: id is not a string";return this.tooltips[e]?void this.positionTooltip(e):(this.tooltips[e]={data:t,arrow:null,selector:d3.select(this.parent.parent.svg.node().parentNode).append("div").attr("class","lz-data_layer-tooltip").attr("id",this.getBaseId()+".tooltip."+e)},void this.updateTooltip(t,e))},this.updateTooltip=function(t,i){if(this.tooltips[i].selector.html(""),this.tooltips[i].arrow=null,this.layout.tooltip.html)this.tooltips[i].selector.html(e.parseFields(t,this.layout.tooltip.html));else if(this.layout.tooltip.divs){var a,s,n;for(a in this.layout.tooltip.divs)s=this.layout.tooltip.divs[a],n=this.tooltips[i].selector.append("div"),s.id&&n.attr("id",s.id),s["class"]&&n.attr("class",s["class"]),s.style&&n.style(s.style),s.html&&n.html(e.parseFields(t,s.html))}this.positionTooltip(i)},this.destroyTooltip=function(t){if("string"!=typeof t)throw"Unable to destroy tooltip: id is not a string";this.tooltips[t]&&("object"==typeof this.tooltips[t].selector&&this.tooltips[t].selector.remove(),delete this.tooltips[t])},this.destroyAllTooltips=function(){var t;for(t in this.tooltips)this.destroyTooltip(t)},this.positionTooltip=function(t){if("string"!=typeof t)throw"Unable to position tooltip: id is not a string";this.tooltips[t].selector.style("left",d3.event.pageX+"px").style("top",d3.event.pageY+"px"),this.tooltips[t].arrow||(this.tooltips[t].arrow=this.tooltips[t].selector.append("div").style("position","absolute").attr("class","lz-data_layer-tooltip-arrow_top_left")),this.tooltips[t].arrow.style("left","-1px").style("top","-1px")},this.positionAllTooltips=function(){var t;for(t in this.tooltips)this.positionTooltip(t)},this.getPageOrigin=function(){var t=this.parent.getPageOrigin();return{x:t.x+this.parent.layout.margin.left,y:t.y+this.parent.layout.margin.top}},this},e.DataLayer.DefaultLayout={type:"",fields:[],x_axis:{},y_axis:{}},e.DataLayer.prototype.getAxisExtent=function(t){if(-1==["x","y"].indexOf(t))throw"Invalid dimension identifier passed to LocusZoom.DataLayer.getAxisExtent()";var e=t+"_axis";if(!isNaN(this.layout[e].floor)&&!isNaN(this.layout[e].ceiling))return[+this.layout[e].floor,+this.layout[e].ceiling];if(this.layout[e].field&&this.data&&this.data.length){var i=d3.extent(this.data,function(t){return+t[this.layout[e].field]}.bind(this)),a=i[1]-i[0];return isNaN(this.layout[e].lower_buffer)||i.push(i[0]-a*this.layout[e].lower_buffer),isNaN(this.layout[e].upper_buffer)||i.push(i[1]+a*this.layout[e].upper_buffer),"object"!=typeof this.layout[e].min_extent||isNaN(this.layout[e].min_extent[0])||isNaN(this.layout[e].min_extent[1])||i.push(this.layout[e].min_extent[0],this.layout[e].min_extent[1]),i=d3.extent(i),isNaN(this.layout[e].floor)||(i[0]=this.layout[e].floor),isNaN(this.layout[e].ceiling)||(i[1]=this.layout[e].ceiling),i}return"x"!=t||isNaN(this.state.start)||isNaN(this.state.end)?[]:[this.state.start,this.state.end]},e.DataLayer.prototype.initialize=function(){return this.svg.container=this.parent.svg.group.append("g").attr("id",this.getBaseId()+".data_layer_container"),this.svg.clipRect=this.svg.container.append("clipPath").attr("id",this.getBaseId()+".clip").append("rect"),this.svg.group=this.svg.container.append("g").attr("id",this.getBaseId()+".data_layer").attr("clip-path","url(#"+this.getBaseId()+".clip)"),this},e.DataLayer.prototype.draw=function(){return this.svg.container.attr("transform","translate("+this.parent.layout.cliparea.origin.x+","+this.parent.layout.cliparea.origin.y+")"),this.svg.clipRect.attr("width",this.parent.layout.cliparea.width).attr("height",this.parent.layout.cliparea.height),this.positionAllTooltips(),this},e.DataLayer.prototype.reMap=function(){this.destroyAllTooltips();var t=this.parent.parent.lzd.getData(this.state,this.layout.fields);return t.then(function(t){this.data=t.body,this.initialized=!0}.bind(this)),t},e.DataSources=function(){this.sources={}},e.DataSources.prototype.addSource=function(t,e){return console.warn("Warning: .addSource() is depricated. Use .add() instead"),this.add(t,e)},e.DataSources.prototype.add=function(t,e){return this.set(t,e)},e.DataSources.prototype.set=function(t,i){function a(t){if(!e.KnownDataSources)return null;for(var i=0;i<e.KnownDataSources.length;i++){if(!e.KnownDataSources[i].SOURCE_NAME)throw"KnownDataSource at position "+i+" does not have a 'SOURCE_NAME' static property";if(e.KnownDataSources[i].SOURCE_NAME==t)return e.KnownDataSources[i]}return null}if(Array.isArray(i)){var s=a(i[0]);if(!s)throw"Unable to resolve "+i[0]+" data source";this.sources[t]=new s(i[1])}else null!==i?this.sources[t]=i:delete this.sources[t];return this},e.DataSources.prototype.getSource=function(t){return console.warn("Warning: .getSource() is depricated. Use .get() instead"),this.get(t)},e.DataSources.prototype.get=function(t){return this.sources[t]},e.DataSources.prototype.removeSource=function(t){return console.warn("Warning: .removeSource() is depricated. Use .remove() instead"),this.remove(t)},e.DataSources.prototype.remove=function(t){return this.set(t,null)},e.DataSources.prototype.fromJSON=function(t){"string"==typeof t&&(t=JSON.parse(t));var e=this;return Object.keys(t).forEach(function(i){e.set(i,t[i])}),e},e.DataSources.prototype.keys=function(){return Object.keys(this.sources)},e.DataSources.prototype.toJSON=function(){return this.sources},e.LabelFunctions=function(){var t={},e={};return t.get=function(t,i){if(t){if(e[t])return"undefined"==typeof i?e[t]:e[t](i);throw"label function ["+t+"] not found"}return null},t.set=function(t,i){i?e[t]=i:delete e[t]},t.add=function(i,a){if(e[i])throw"label function already exists with name: "+i;t.set(i,a)},t.list=function(){return Object.keys(e)},t}(),e.LabelFunctions.add("chromosome",function(t){return isNaN(+t.chr)?"Chromosome (Mb)":"Chromosome "+t.chr+" (Mb)"}),e.TransformationFunctions=function(){var t={},e={},i=function(t){if(!t)return null;var i=e[t];if(i)return i;throw"transformation "+t+" not found"},a=function(t){return i(t)},s=function(t){for(var e,i=[],s=/\|([^\|]+)/g;null!=(e=s.exec(t));)i.push(e[1]);return 1==i.length?a(i[0]):i.length>1?function(t){for(var e=t,s=0;s<i.length;s++)e=a(i[s])(e);return e}:null};return t.get=function(t){return t&&"|"==t.substring(0,1)?s(t):a(t)},t.set=function(t,i){if("|"==t.substring(0,1))throw"transformation name should not start with a pipe";i?e[t]=i:delete e[t]},t.add=function(i,a){if(e[i])throw"transformation already exists with name: "+i;t.set(i,a)},t.list=function(){return Object.keys(e)},t}(),e.TransformationFunctions.add("neglog10",function(t){return-Math.log(t)/Math.LN10}),e.TransformationFunctions.add("scinotation",function(t){var e;return e=Math.abs(t)>1?Math.ceil(Math.log(t)/Math.LN10):Math.floor(Math.log(t)/Math.LN10),Math.abs(e)<=3?t.toFixed(3):t.toExponential(2).replace("+","").replace("e"," × 10^")}),e.ScaleFunctions=function(){var t={},e={};return t.get=function(t,i,a){if(t){if(e[t])return"undefined"==typeof i&&"undefined"==typeof a?e[t]:e[t](i,a);throw"scale function ["+t+"] not found"}return null},t.set=function(t,i){i?e[t]=i:delete e[t]},t.add=function(i,a){if(e[i])throw"scale function already exists with name: "+i;t.set(i,a)},t.list=function(){return Object.keys(e)},t}(),e.ScaleFunctions.add("numerical_bin",function(t,e){var i=t.breaks,a=t.values;if(null==e||isNaN(+e))return t.null_value?t.null_value:a[0];var s=i.reduce(function(t,i){return t>+e||+e>=t&&i>+e?t:i});return a[i.indexOf(s)]}),e.ScaleFunctions.add("categorical_bin",function(t,e){return-1!=t.categories.indexOf(e)?t.values[t.categories.indexOf(e)]:t.null_value?t.null_value:t.values[0]}),e.DataLayers=function(){var t={},i={};return t.get=function(t,e,a,s){if(t){if(i[t]){if("undefined"==typeof e||"undefined"==typeof a)throw"id or layout argument missing for data layer ["+t+"]";return new i[t](e,a,s)}throw"data layer ["+t+"] not found"}return null},t.set=function(t,a){if(a){if("function"!=typeof a)throw"unable to set data layer ["+t+"], argument provided is not a function";i[t]=a,i[t].prototype=new e.DataLayer}else delete i[t]},t.add=function(e,a){if(i[e])throw"data layer already exists with name: "+e;t.set(e,a)},t.list=function(){return Object.keys(i)},t}(),e.DataLayers.add("scatter",function(t,i,a){return this.DefaultLayout={point_size:40,point_shape:"circle",color:"#888888",y_axis:{axis:1},selectable:!0,id_field:"id"},i=e.mergeLayouts(i,this.DefaultLayout),e.DataLayer.apply(this,arguments),this.positionTooltip=function(t){if("string"!=typeof t)throw"Unable to position tooltip: id is not a string";if(!this.tooltips[t])throw"Unable to position tooltip: id does not point to a valid tooltip";var e,i,a,s=this.tooltips[t],n=7,o=1,r=6,l=this.getPageOrigin(),h=this.parent.x_scale(s.data[this.layout.x_axis.field]),d="y"+this.layout.y_axis.axis+"_scale",u=this.parent[d](s.data[this.layout.y_axis.field]),p=s.selector.node().getBoundingClientRect(),c=Math.sqrt(this.layout.point_size/Math.PI);h<=this.parent.layout.width/2?(e=l.x+h+c+n+o,i="left",a=-1*(n+o)):(e=l.x+h-p.width-c-n-o,i="right",a=p.width-o);var y,g,_=this.parent.layout.height-(this.parent.layout.margin.top+this.parent.layout.margin.bottom);u-p.height/2<=0?(y=l.y+u-1.5*n-r,g=r):u+p.height/2>=_?(y=l.y+u+n+r-p.height,g=p.height-2*n-r):(y=l.y+u-p.height/2,g=p.height/2-n),s.selector.style("left",e+"px").style("top",y+"px"),s.arrow||(s.arrow=s.selector.append("div").style("position","absolute")),s.arrow.attr("class","lz-data_layer-tooltip-arrow_"+i).style("left",a+"px").style("top",g+"px")},this.render=function(){var t=this.svg.group.selectAll("path.lz-data_layer-scatter").data(this.data,function(t){return t[this.layout.id_field]}.bind(this));t.enter().append("path").attr("class","lz-data_layer-scatter").attr("id",function(t){return this.parent.id+"_"+t[this.layout.id_field].replace(/\W/g,"")}.bind(this));var i,a=function(t){var e=this.parent.x_scale(t[this.layout.x_axis.field]),i="y"+this.layout.y_axis.axis+"_scale",a=this.parent[i](t[this.layout.y_axis.field]);return isNaN(e)&&(e=-1e3),isNaN(a)&&(a=-1e3),"translate("+e+","+a+")"}.bind(this);if(this.layout.color)switch(typeof this.layout.color){case"string":i=this.layout.color;break;case"object":this.layout.color.scale_function&&this.layout.color.field&&(i=function(t){return e.ScaleFunctions.get(this.layout.color.scale_function,this.layout.color.parameters||{},t[this.layout.color.field])}.bind(this))}var s=d3.svg.symbol().size(this.layout.point_size).type(this.layout.point_shape);if(this.layout.transition?t.transition().duration(this.layout.transition.duration||0).ease(this.layout.transition.ease||"cubic-in-out").attr("transform",a).attr("fill",i).attr("d",s):t.attr("transform",a).attr("fill",i).attr("d",s),this.layout.selectable&&-1!=this.layout.fields.indexOf(this.layout.id_field)&&(t.on("mouseover",function(t){var e=this.parent.id+"_"+t[this.layout.id_field].replace(/\W/g,"");this.state[this.state_id].selected!=e&&(d3.select("#"+e).attr("class","lz-data_layer-scatter lz-data_layer-scatter-hovered"),this.layout.tooltip&&this.createTooltip(t,e))}.bind(this)).on("mouseout",function(t){var e=this.parent.id+"_"+t[this.layout.id_field].replace(/\W/g,"");this.state[this.state_id].selected!=e&&(d3.select("#"+e).attr("class","lz-data_layer-scatter"),this.layout.tooltip&&this.destroyTooltip(e))}.bind(this)).on("click",function(t){var e=this.parent.id+"_"+t[this.layout.id_field].replace(/\W/g,"");this.state[this.state_id].selected==e?(this.state[this.state_id].selected=null,d3.select("#"+e).attr("class","lz-data_layer-scatter lz-data_layer-scatter-hovered")):(null!=this.state[this.state_id].selected&&(d3.select("#"+this.state[this.state_id].selected).attr("class","lz-data_layer-scatter"),this.layout.tooltip&&this.destroyTooltip(this.state[this.state_id].selected)),this.state[this.state_id].selected=e,d3.select("#"+e).attr("class","lz-data_layer-scatter lz-data_layer-scatter-selected")),this.onUpdate()}.bind(this)),null!=this.state[this.state_id].selected)){var n=this.state[this.state_id].selected;if(d3.select("#"+n).empty())console.warn("State elements for "+this.state_id+" contains an ID that is not or is no longer present on the plot: "+this.state[this.state_id].selected),this.state[this.state_id].selected=null;else if(this.tooltips[this.state[this.state_id].selected])this.positionTooltip(this.state[this.state_id].selected);else{this.state[this.state_id].selected=null;var o=d3.select("#"+n).datum();d3.select("#"+n).on("mouseover")(o),d3.select("#"+n).on("click")(o)}}t.exit().remove()},this}),e.DataLayers.add("line",function(t,i,a){return this.DefaultLayout={style:{fill:"transparent","stroke-width":"2px"},interpolate:"linear",x_axis:{field:"x"},y_axis:{field:"y",axis:1},hitarea_width:5,selectable:!1},i=e.mergeLayouts(i,this.DefaultLayout),this.mouse_event=null,this.line=null,this.tooltip_timeout=null,e.DataLayer.apply(this,arguments),this.getMouseDisplayAndData=function(){var t={display:{x:d3.mouse(this.mouse_event)[0],y:null},data:{},slope:null},e=this.layout.x_axis.field,i=this.layout.y_axis.field,a="x_scale",s="y"+this.layout.y_axis.axis+"_scale";t.data[e]=this.parent[a].invert(t.display.x);var n=d3.bisector(function(t){return+t[e]}).left,o=n(this.data,t.data[e])-1,r=this.data[o],l=this.data[o+1],h=d3.interpolateNumber(+r[i],+l[i]),d=+l[e]-+r[e];return t.data[i]=h(t.data[e]%d/d),t.display.y=this.parent[s](t.data[i]),this.layout.tooltip.x_precision&&(t.data[e]=t.data[e].toPrecision(this.layout.tooltip.x_precision)),this.layout.tooltip.y_precision&&(t.data[i]=t.data[i].toPrecision(this.layout.tooltip.y_precision)),t.slope=(this.parent[s](l[i])-this.parent[s](r[i]))/(this.parent[a](l[e])-this.parent[a](r[e])),t},this.positionTooltip=function(t){if("string"!=typeof t)throw"Unable to position tooltip: id is not a string";if(!this.tooltips[t])throw"Unable to position tooltip: id does not point to a valid tooltip";var e,i,a,s,n,o=this.tooltips[t],r=o.selector.node().getBoundingClientRect(),l=7,h=6,d=parseFloat(this.layout.style["stroke-width"])||1,u=this.getPageOrigin(),p=this.parent.layout.height-(this.parent.layout.margin.top+this.parent.layout.margin.bottom),c=this.parent.layout.width-(this.parent.layout.margin.left+this.parent.layout.margin.right),y=this.getMouseDisplayAndData();if(Math.abs(y.slope)>1)y.display.x<=this.parent.layout.width/2?(i=u.x+y.display.x+d+l+d,n="left",s=-1*(l+d)):(i=u.x+y.display.x-r.width-d-l-d,n="right",s=r.width-d),y.display.y-r.height/2<=0?(e=u.y+y.display.y-1.5*l-h,a=h):y.display.y+r.height/2>=p?(e=u.y+y.display.y+l+h-r.height,a=r.height-2*l-h):(e=u.y+y.display.y-r.height/2,a=r.height/2-l);else{var g=Math.max(r.width/2-y.display.x,0),_=Math.max(r.width/2+y.display.x-c,0);i=u.x+y.display.x-r.width/2-_+g;var f=l/2,x=r.width-2.5*l;s=r.width/2-l+_-g,s=Math.min(Math.max(s,f),x),r.height+d+l>y.display.y?(e=u.y+y.display.y+d+l,n="up",a=0-d-l):(e=u.y+y.display.y-(r.height+d+l),n="down",a=r.height-d)}o.selector.style({left:i+"px",top:e+"px"}),o.arrow||(o.arrow=o.selector.append("div").style("position","absolute")),o.arrow.attr("class","lz-data_layer-tooltip-arrow_"+n).style({left:s+"px",top:a+"px"})},this.render=function(){var t=this,e=this.parent,i=this.layout.x_axis.field,a=this.layout.y_axis.field,s="x_scale",n="y"+this.layout.y_axis.axis+"_scale",o=this.svg.group.selectAll("path.lz-data_layer-line").data([this.data]);if(o.enter().append("path").attr("class","lz-data_layer-line"),this.line=d3.svg.line().x(function(t){return e[s](t[i])}).y(function(t){return e[n](t[a])}).interpolate(this.layout.interpolate),this.layout.transition?o.transition().duration(this.layout.transition.duration||0).ease(this.layout.transition.ease||"cubic-in-out").attr("d",this.line).style(this.layout.style):o.attr("d",this.line).style(this.layout.style),this.layout.tooltip){var r=parseFloat(this.layout.hitarea_width).toString()+"px",l=this.svg.group.selectAll("path.lz-data_layer-line-hitarea").data([this.data]);l.enter().append("path").attr("class","lz-data_layer-line-hitarea").style("stroke-width",r);var h=d3.svg.line().x(function(t){return e[s](t[i])}).y(function(t){return e[n](t[a])}).interpolate(this.layout.interpolate);l.attr("d",h).on("mouseover",function(){clearTimeout(t.tooltip_timeout),t.mouse_event=this;var e=t.getMouseDisplayAndData();t.createTooltip(e.data,t.state_id)}).on("mousemove",function(){clearTimeout(t.tooltip_timeout),t.mouse_event=this;var e=t.getMouseDisplayAndData();t.updateTooltip(e.data,t.state_id),t.positionTooltip(t.state_id)}).on("mouseout",function(){t.tooltip_timeout=setTimeout(function(){t.mouse_event=null,t.destroyTooltip(t.state_id)},300)}),l.exit().remove()}o.exit().remove()},this}),e.DataLayers.add("genes",function(t,i,a){return this.DefaultLayout={label_font_size:12,label_exon_spacing:4,exon_height:16,bounding_box_padding:6,track_vertical_spacing:10,selectable:!0},i=e.mergeLayouts(i,this.DefaultLayout),e.DataLayer.apply(this,arguments),this.getTrackHeight=function(){return 2*this.layout.bounding_box_padding+this.layout.label_font_size+this.layout.label_exon_spacing+this.layout.exon_height+this.layout.track_vertical_spacing;
},this.transcript_idx=0,this.tracks=1,this.gene_track_index={1:[]},this.assignTracks=function(){return this.getLabelWidth=function(t,e){var i=this.svg.group.append("text").attr("x",0).attr("y",0).attr("class","lz-data_layer-gene lz-label").style("font-size",e).text(t+"→"),a=i.node().getBBox().width;return i.node().remove(),a},this.tracks=1,this.gene_track_index={1:[]},this.data.map(function(t,e){if(this.data[e].gene_id&&this.data[e].gene_id.indexOf(".")){var i=this.data[e].gene_id.split(".");this.data[e].gene_id=i[0],this.data[e].gene_version=i[1]}if(this.data[e].transcript_id=this.data[e].transcripts[this.transcript_idx].transcript_id,this.data[e].display_range={start:this.parent.x_scale(Math.max(t.start,this.state.start)),end:this.parent.x_scale(Math.min(t.end,this.state.end))},this.data[e].display_range.label_width=this.getLabelWidth(this.data[e].gene_name,this.layout.label_font_size),this.data[e].display_range.width=this.data[e].display_range.end-this.data[e].display_range.start,this.data[e].display_range.text_anchor="middle",this.data[e].display_range.width<this.data[e].display_range.label_width){if(t.start<this.state.start)this.data[e].display_range.end=this.data[e].display_range.start+this.data[e].display_range.label_width+this.layout.label_font_size,this.data[e].display_range.text_anchor="start";else if(t.end>this.state.end)this.data[e].display_range.start=this.data[e].display_range.end-this.data[e].display_range.label_width-this.layout.label_font_size,this.data[e].display_range.text_anchor="end";else{var a=(this.data[e].display_range.label_width-this.data[e].display_range.width)/2+this.layout.label_font_size;this.data[e].display_range.start-a<this.parent.x_scale(this.state.start)?(this.data[e].display_range.start=this.parent.x_scale(this.state.start),this.data[e].display_range.end=this.data[e].display_range.start+this.data[e].display_range.label_width,this.data[e].display_range.text_anchor="start"):this.data[e].display_range.end+a>this.parent.x_scale(this.state.end)?(this.data[e].display_range.end=this.parent.x_scale(this.state.end),this.data[e].display_range.start=this.data[e].display_range.end-this.data[e].display_range.label_width,this.data[e].display_range.text_anchor="end"):(this.data[e].display_range.start-=a,this.data[e].display_range.end+=a)}this.data[e].display_range.width=this.data[e].display_range.end-this.data[e].display_range.start}this.data[e].display_range.start-=this.layout.bounding_box_padding,this.data[e].display_range.end+=this.layout.bounding_box_padding,this.data[e].display_range.width+=2*this.layout.bounding_box_padding,this.data[e].display_domain={start:this.parent.x_scale.invert(this.data[e].display_range.start),end:this.parent.x_scale.invert(this.data[e].display_range.end)},this.data[e].display_domain.width=this.data[e].display_domain.end-this.data[e].display_domain.start,this.data[e].track=null;for(var s=1;null==this.data[e].track;){var n=!1;this.gene_track_index[s].map(function(t){if(!n){var e=Math.min(t.display_range.start,this.display_range.start),i=Math.max(t.display_range.end,this.display_range.end);i-e<t.display_range.width+this.display_range.width&&(n=!0)}}.bind(this.data[e])),n?(s++,s>this.tracks&&(this.tracks=s,this.gene_track_index[s]=[])):(this.data[e].track=s,this.gene_track_index[s].push(this.data[e]))}this.data[e].parent=this,this.data[e].transcripts.map(function(t,i){this.data[e].transcripts[i].parent=this.data[e],this.data[e].transcripts[i].exons.map(function(t,a){this.data[e].transcripts[i].exons[a].parent=this.data[e].transcripts[i]}.bind(this))}.bind(this))}.bind(this)),this},this.render=function(){this.assignTracks();var t=this.svg.group.selectAll("g.lz-data_layer-gene").data(this.data,function(t){return t.gene_name});t.enter().append("g").attr("class","lz-data_layer-gene"),t.attr("id",function(t){return"g"+t.gene_name.replace(/\W/g,"")}).each(function(t){var e=t.parent,i=d3.select(this).selectAll("rect.lz-data_layer-gene.lz-bounding_box").data([t],function(t){return t.gene_name+"_bbox"});i.enter().append("rect").attr("class","lz-data_layer-gene lz-bounding_box"),i.attr("id",function(t){return"g"+t.gene_name.replace(/\W/g,"")+"_bounding_box"}).attr("x",function(t){return t.display_range.start}).attr("y",function(t){return(t.track-1)*e.getTrackHeight()}).attr("width",function(t){return t.display_range.width}).attr("height",function(){return e.getTrackHeight()-e.layout.track_vertical_spacing}).attr("rx",function(){return e.layout.bounding_box_padding}).attr("ry",function(){return e.layout.bounding_box_padding}),i.exit().remove();var a=d3.select(this).selectAll("rect.lz-data_layer-gene.lz-boundary").data([t],function(t){return t.gene_name+"_boundary"});a.enter().append("rect").attr("class","lz-data_layer-gene lz-boundary"),a.attr("x",function(t){return e.parent.x_scale(t.start)}).attr("y",function(t){return(t.track-1)*e.getTrackHeight()+e.layout.bounding_box_padding+e.layout.label_font_size+e.layout.label_exon_spacing+Math.max(e.layout.exon_height,3)/2}).attr("width",function(t){return e.parent.x_scale(t.end)-e.parent.x_scale(t.start)}).attr("height",1),a.exit().remove();var s=d3.select(this).selectAll("text.lz-data_layer-gene.lz-label").data([t],function(t){return t.gene_name+"_label"});s.enter().append("text").attr("class","lz-data_layer-gene lz-label"),s.attr("x",function(t){return"middle"==t.display_range.text_anchor?t.display_range.start+t.display_range.width/2:"start"==t.display_range.text_anchor?t.display_range.start+e.layout.bounding_box_padding:"end"==t.display_range.text_anchor?t.display_range.end-e.layout.bounding_box_padding:void 0}).attr("y",function(t){return(t.track-1)*e.getTrackHeight()+e.layout.bounding_box_padding+e.layout.label_font_size}).attr("text-anchor",function(t){return t.display_range.text_anchor}).text(function(t){return"+"==t.strand?t.gene_name+"→":"←"+t.gene_name}).style("font-size",t.parent.layout.label_font_size),s.exit().remove();var n=d3.select(this).selectAll("rect.lz-data_layer-gene.lz-exon").data(t.transcripts[t.parent.transcript_idx].exons,function(t){return t.exon_id});n.enter().append("rect").attr("class","lz-data_layer-gene lz-exon"),n.attr("x",function(t){return e.parent.x_scale(t.start)}).attr("y",function(){return(t.track-1)*e.getTrackHeight()+e.layout.bounding_box_padding+e.layout.label_font_size+e.layout.label_exon_spacing}).attr("width",function(t){return e.parent.x_scale(t.end)-e.parent.x_scale(t.start)}).attr("height",function(){return e.layout.exon_height}),n.exit().remove();var o=d3.select(this).selectAll("rect.lz-data_layer-gene.lz-clickarea").data([t],function(t){return t.gene_name+"_clickarea"});if(o.enter().append("rect").attr("class","lz-data_layer-gene lz-clickarea"),o.attr("id",function(t){return"g"+t.gene_name.replace(/\W/g,"")+"_clickarea"}).attr("x",function(t){return t.display_range.start}).attr("y",function(t){return(t.track-1)*e.getTrackHeight()}).attr("width",function(t){return t.display_range.width}).attr("height",function(){return e.getTrackHeight()-e.layout.track_vertical_spacing}).attr("rx",function(){return e.layout.bounding_box_padding}).attr("ry",function(){return e.layout.bounding_box_padding}),o.exit().remove(),t.parent.layout.selectable&&(o.on("mouseover",function(t){var i="g"+t.gene_name.replace(/\W/g,"");e.state[e.state_id].selected!=i&&(d3.select("#"+i+"_bounding_box").attr("class","lz-data_layer-gene lz-bounding_box lz-bounding_box-hovered"),e.layout.tooltip&&e.createTooltip(t,i))}).on("mouseout",function(t){var i="g"+t.gene_name.replace(/\W/g,"");e.state[e.state_id].selected!=i&&(d3.select("#"+i+"_bounding_box").attr("class","lz-data_layer-gene lz-bounding_box"),e.layout.tooltip&&e.destroyTooltip(i))}).on("click",function(t){var i="g"+t.gene_name.replace(/\W/g,"");e.state[e.state_id].selected==i?(e.state[e.state_id].selected=null,d3.select("#"+i+"_bounding_box").attr("class","lz-data_layer-gene lz-bounding_box lz-bounding_box-hovered")):(null!=e.state[e.state_id].selected&&(d3.select("#"+e.state[e.state_id].selected+"_bounding_box").attr("class","lz-data_layer-gene lz-bounding_box"),e.layout.tooltip&&e.destroyTooltip(e.state[e.state_id].selected)),e.state[e.state_id].selected=i,d3.select("#"+i+"_bounding_box").attr("class","lz-data_layer-gene lz-bounding_box lz-bounding_box-selected")),e.onUpdate()}),null!=t.parent.state[t.parent.state_id].selected)){var r=t.parent.state[t.parent.state_id].selected+"_clickarea";if(d3.select("#"+r).empty())console.warn("Pre-defined state selection for "+t.parent.state_id+" contains an ID that is not or is no longer present on the plot: "+t.parent.state[t.parent.state_id].selected),t.parent.state[t.parent.state_id].selected=null;else if(t.parent.tooltips[t.parent.state[t.parent.state_id].selected])t.parent.positionTooltip(t.parent.state[t.parent.state_id].selected);else{t.parent.state[t.parent.state_id].selected=null;var l=d3.select("#"+r).datum();d3.select("#"+r).on("mouseover")(l),d3.select("#"+r).on("click")(l)}}}),t.exit().remove()},this.positionTooltip=function(t){if("string"!=typeof t)throw"Unable to position tooltip: id is not a string";if(!this.tooltips[t])throw"Unable to position tooltip: id does not point to a valid tooltip";var e,i,a,s=this.tooltips[t],n=7,o=1,r=this.getPageOrigin(),l=s.selector.node().getBoundingClientRect(),h=d3.select("#g"+s.data.gene_name.replace(/\W/g,"")).node().getBBox(),d=this.parent.layout.height-(this.parent.layout.margin.top+this.parent.layout.margin.bottom),u=this.parent.layout.width-(this.parent.layout.margin.left+this.parent.layout.margin.right),p=(s.data.display_range.start+s.data.display_range.end)/2-this.layout.bounding_box_padding/2,c=Math.max(l.width/2-p,0),y=Math.max(l.width/2+p-u,0),g=r.x+p-l.width/2-y+c,_=l.width/2-n/2+y-c;l.height+o+n>d-(h.y+h.height)?(e=r.y+h.y-(l.height+o+n),i="down",a=l.height-o):(e=r.y+h.y+h.height+o+n,i="up",a=0-o-n),s.selector.style("left",g+"px").style("top",e+"px"),s.arrow||(s.arrow=s.selector.append("div").style("position","absolute")),s.arrow.attr("class","lz-data_layer-tooltip-arrow_"+i).style("left",_+"px").style("top",a+"px")},this}),"function"==typeof define&&define.amd?(this.LocusZoom=e,define(e)):"object"==typeof module&&module.exports?module.exports=e:this.LocusZoom=e}catch(i){console.log("LocusZoom Plugin error: "+i)}}();